<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AMT Procurement Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link rel="icon" type="image/png" href="static/ICON.jpg">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* === PROFESSIONAL DESIGN SYSTEM === */
    :root {
      /* Palette */
      --primary: #0f172a;       /* Slate 900 */
      --primary-light: #334155; /* Slate 700 */
      --accent: #2563eb;        /* Royal Blue */
      --accent-hover: #1d4ed8;
      --success: #10b981;       /* Emerald */
      --warning: #f59e0b;       /* Amber */
      --danger: #ef4444;        /* Red */
      
      /* Backgrounds */
      --bg-body: #f1f5f9;       /* Slate 100 */
      --bg-card: #ffffff;
      --bg-header: #ffffff;
      
      /* Text */
      --text-main: #334155;     /* Slate 700 */
      --text-muted: #64748b;    /* Slate 500 */
      --text-header: #0f172a;
      
      /* Borders & Shadows */
      --border: #e2e8f0;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --radius: 8px;
    }

    /* Dark Mode Overrides */
    body.dark-mode {
      --primary: #f8fafc; 
      --bg-body: #0f172a;
      --bg-card: #1e293b;
      --bg-header: #1e293b;
      --text-main: #cbd5e1;
      --text-muted: #94a3b8;
      --text-header: #f1f5f9;
      --border: #334155;
      --shadow-sm: none;
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.5);
    }

    /* === RESET & BASE === */
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin:0; background: var(--bg-body); color: var(--text-main); padding-bottom: 80px; transition: background 0.3s, color 0.3s; font-size: 14px; line-height: 1.5; }
    * { box-sizing: border-box; }
    
    /* === LAYOUT === */
    header { background: var(--bg-header); border-bottom: 1px solid var(--border); padding: 0 24px; height: 64px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 50; box-shadow: var(--shadow-sm); }
    header h1 { margin:0; font-size: 20px; font-weight: 700; color: var(--text-header); letter-spacing: -0.5px; }
    .logo-area { display: flex; align-items: center; gap: 12px; }
    
    .container { max-width: 1400px; margin: 24px auto; padding: 0 20px; }
    
    /* === NAVIGATION TABS === */
    .tabs-wrapper { background: var(--primary); padding: 0 20px; box-shadow: var(--shadow-md); margin-bottom: 24px; border-radius: var(--radius); overflow: hidden; }
    .tabs { display:flex; overflow-x: auto; white-space: nowrap; }
    .tabs::-webkit-scrollbar { height: 0px; }
    .tab { padding: 16px 20px; color: #94a3b8; cursor: pointer; font-weight: 500; font-size: 14px; transition: all 0.2s; border-bottom: 3px solid transparent; }
    .tab:hover { color: #fff; background: rgba(255,255,255,0.05); }
    .tab.active { color: #fff; border-bottom-color: var(--accent); background: rgba(255,255,255,0.1); }

    /* === CARDS === */
    .card { background: var(--bg-card); padding: 24px; margin-bottom: 24px; border-radius: var(--radius); box-shadow: var(--shadow-sm); border: 1px solid var(--border); transition: transform 0.2s, box-shadow 0.2s; }
    .card h2 { margin-top:0; font-size: 18px; font-weight: 600; color: var(--text-header); margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; }
    .card h3 { font-size: 15px; font-weight: 600; color: var(--text-main); margin-bottom: 10px; margin-top: 0; }

    /* === FORMS & INPUTS === */
    label { display: block; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 6px; }
    input, select, textarea { width: 100%; padding: 10px 12px; font-size: 14px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-body); color: var(--text-header); transition: border 0.2s, box-shadow 0.2s; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
    
    /* === BUTTONS === */
    button { padding: 8px 16px; font-size: 14px; font-weight: 600; border-radius: 6px; border: none; cursor: pointer; background: var(--accent); color: white; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; justify-content: center; }
    button:hover { background: var(--accent-hover); transform: translateY(-1px); }
    
    button.secondary { background: var(--bg-body); color: var(--text-main); border: 1px solid var(--border); }
    button.secondary:hover { background: #e2e8f0; color: #0f172a; }
    
    button.danger { background: var(--danger); color: white; }
    button.danger:hover { background: #dc2626; }
    
    button.success { background: var(--success); color: white; }
    button.success:hover { background: #059669; }
    
    button.warning { background: var(--warning); color: #fff; }
    button.warning:hover { background: #d97706; }
    
    button.small-action { padding: 4px 8px; font-size: 11px; }

    /* === TABLES === */
    .table-container { overflow-x: auto; border: 1px solid var(--border); border-radius: var(--radius); }
    table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 900px; }
    
    th { background: var(--bg-body); font-weight: 600; color: var(--text-muted); text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px; padding: 12px 16px; text-align: left; border-bottom: 2px solid var(--border); cursor: pointer; user-select: none; position: relative; }
    th:hover { background: #e2e8f0; color: var(--text-header); }
    th::after { content: '‚Üï'; position: absolute; right: 8px; opacity: 0.3; font-size: 10px; }
    th.sort-asc::after { content: '‚Üë'; opacity: 1; color: var(--accent); }
    th.sort-desc::after { content: '‚Üì'; opacity: 1; color: var(--accent); }
    
    td { border-bottom: 1px solid var(--border); padding: 12px 16px; color: var(--text-main); vertical-align: middle; white-space: nowrap; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: rgba(37, 99, 235, 0.02); }
    .clickable-link { color: var(--accent); text-decoration: underline; cursor: pointer; }

    /* === STATUS BADGES & ICONS === */
    .tag { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .tag.green { background: #d1fae5; color: #065f46; }
    .tag.red { background: #fee2e2; color: #991b1b; }
    .tag.yellow { background: #fef3c7; color: #92400e; }
    .tag.gray { background: #f1f5f9; color: #475569; }

    .urgency-high { border-left: 3px solid var(--danger); }
    .overdue-icon { color: var(--danger); font-size: 14px; margin-right: 5px; }
    .high-icon { color: var(--danger); font-weight:bold; margin-right:5px; }

    /* === DASHBOARD === */
    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
    .summary-item { background: var(--bg-body); padding: 20px; border-radius: var(--radius); border: 1px solid var(--border); display: flex; flex-direction: column; }
    .summary-label { font-size: 12px; font-weight: 600; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px; }
    .summary-value { font-size: 28px; font-weight: 700; color: var(--text-header); letter-spacing: -1px; }

    /* List for Top 5 Suppliers */
    ul.top-list { list-style: none; padding: 0; margin: 0; }
    ul.top-list li { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
    ul.top-list li:last-child { border-bottom: none; }
    ul.top-list strong { color: var(--text-header); }

    /* === BULK BAR === */
    .bulk-bar { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 12px 24px; border-radius: 50px; box-shadow: var(--shadow-md); display: flex; gap: 16px; align-items: center; z-index: 100; opacity: 0; pointer-events: none; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .bulk-bar.visible { opacity: 1; pointer-events: auto; bottom: 40px; }
    .bulk-bar span { font-weight: 600; border-right: 1px solid rgba(255,255,255,0.2); padding-right: 16px; }

    /* === DROPDOWNS === */
    .action-menu { position: relative; }
    .drop-btn { background: transparent; color: var(--text-muted); border: 1px solid var(--border); padding: 4px 8px; font-size: 16px; }
    .drop-btn:hover { background: var(--bg-body); color: var(--accent); }
    .drop-content { display: none; position: absolute; right: 0; top: 100%; background: var(--bg-card); min-width: 170px; box-shadow: var(--shadow-md); border-radius: 6px; border: 1px solid var(--border); z-index: 10; overflow: hidden; margin-top: 4px; }
    .drop-content.show { display: block; animation: fadeIn 0.1s ease-out; }
    .drop-content button, .drop-content a { display: block; width: 100%; text-align: left; padding: 10px 16px; background: none; border: none; border-bottom: 1px solid var(--border); font-size: 13px; color: var(--text-main); font-weight: 500; }
    .drop-content button:hover { background: var(--bg-body); color: var(--accent); }

    /* === POPUPS === */
    .popup-backdrop { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); z-index: 40; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
    .popup-backdrop.visible { opacity: 1; pointer-events: auto; }
    .popup { background: var(--bg-card); width: 95%; max-width: 650px; max-height: 90vh; overflow-y: auto; border-radius: 12px; padding: 32px; box-shadow: var(--shadow-md); transform: scale(0.95); transition: transform 0.2s; }
    .popup-backdrop.visible .popup { transform: scale(1); }

    .hidden { display: none !important; }
    .flex-row { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 16px; }
    .flex-1 { flex: 1 1 200px; }
    .error { color: var(--danger); font-size: 13px; margin-top: 8px; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

<header>
  <div class="logo-area">
    <div style="width:32px; height:32px; background:var(--accent); border-radius:6px; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold;">A</div>
    <h1>AMT Procurement</h1>
  </div>
  <div style="display:flex; gap:16px; align-items:center;">
    <div id="userInfo" style="font-size:13px; font-weight:500;"></div>
    <button class="secondary" id="darkModeBtn" style="padding:6px 12px;" title="Toggle Theme">üåó</button>
  </div>
</header>

<div class="container">
  <div class="tabs-wrapper">
    <div class="tabs">
      <div class="tab active" data-tab="overview">Dashboard</div>
      <div class="tab" data-tab="requisitions">Orders</div>
      <div class="tab" data-tab="landings">Landings</div>
      <div class="tab" data-tab="directory">Directory</div>
      <div class="tab" data-tab="delivered">History</div>
      <div class="tab hidden" data-tab="admin" id="adminTab">Admin</div>
    </div>
  </div>

  <div id="bulkActionBar" class="bulk-bar">
    <span><strong id="bulkCount">0</strong> Selected</span>
    <button class="success" id="bulkMarkPaidBtn">Paid</button>
    <button class="warning" id="bulkMarkPartialBtn">Partial</button>
    <button class="success" id="bulkMarkDeliveredBtn">Full Delivery</button>
    <button class="secondary" id="bulkMarkUnpaidBtn">Unpaid</button>
    <button class="danger" id="bulkCancelBtn" style="margin-left:8px;">‚úï</button>
  </div>

  <div id="tab-overview" class="tab-content">
    <div class="card">
      <h2><span>üìä Performance Overview</span> <div style="display:flex; gap:10px;"><button id="showAgingBtn" class="warning">üïí Aging Report</button><button id="openChartBtn" class="secondary">üìà Analytics Studio</button></div></h2>
      <div class="summary-grid">
        <div class="summary-item"><div class="summary-label">Pending Orders</div><div class="summary-value" id="summaryOpenReqNotDel">0</div></div>
        <div class="summary-item"><div class="summary-label">Unpaid Orders</div><div class="summary-value" id="summaryOpenReqUnpaid" style="color:var(--danger)">0</div></div>
        <div class="summary-item"><div class="summary-label">Pending Landings</div><div class="summary-value" id="summaryOpenLandNotDel">0</div></div>
        <div class="summary-item"><div class="summary-label">Unpaid Landings</div><div class="summary-value" id="summaryOpenLandUnpaid" style="color:var(--danger)">0</div></div>
      </div>
    </div>
    
    <div class="card">
        <h2>Financial Summary</h2>
        <div class="flex-row" style="background:var(--bg-body); padding:16px; border-radius:8px; align-items:flex-end;">
          <div style="flex:1"><label>Type</label><select id="ovTypeFilter"><option value="">All</option><option value="req">Orders</option><option value="land">Landings</option></select></div>
          <div style="flex:1"><label>Vessel</label><select id="ovVesselFilter"><option value="">All</option></select></div>
          <div style="flex:1"><label>Month</label><select id="ovMonthFilter"><option value="">All</option></select></div>
          <div style="flex:1"><label>Year</label><select id="ovYearFilter"><option value="">All</option></select></div>
          <div><button id="ovApplyTotalsBtn">Apply Filter</button></div>
        </div>

        <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px; margin-top:20px;">
           <div class="summary-grid">
             <div class="summary-item"><div class="summary-label">Filtered Total</div><div class="summary-value" id="ovAllTotal">$0.00</div></div>
             <div class="summary-item"><div class="summary-label">Paid</div><div class="summary-value" id="ovPaidMonthTotal" style="color:var(--success)">$0.00</div></div>
             <div class="summary-item"><div class="summary-label">Unpaid</div><div class="summary-value" id="ovUnpaidMonthTotal" style="color:var(--danger)">$0.00</div></div>
           </div>
           
           <div style="background:var(--bg-body); padding:16px; border-radius:var(--radius); border:1px solid var(--border);">
              <h3>Top 5 Suppliers (by Amount)</h3>
              <ul id="ovTopSuppliers" class="top-list"><li>No data available</li></ul>
           </div>
        </div>
    </div>

    <div class="card">
      <h2>Recent Activity</h2>
      <div class="table-container">
        <table id="overviewReqTable">
          <thead><tr><th onclick="sortTable(this,0)">PO #</th><th onclick="sortTable(this,1)">Vessel</th><th onclick="sortTable(this,2)">Description</th><th onclick="sortTable(this,3)">Supplier</th><th onclick="sortTable(this,4)">Date</th><th onclick="sortTable(this,5)">Amount</th><th>Status</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="tab-requisitions" class="tab-content hidden">
    <div class="card" id="reqAddCard">
      <h2 id="reqFormTitle">New Requisition</h2>
      <div class="flex-row">
        <div class="flex-1"><label>PO Number</label><input type="text" id="reqPONumber" placeholder="Auto or Manual" /></div>
        <div class="flex-1"><label>Internal Ref</label><input type="text" id="reqNumber" placeholder="Req #" /></div>
        <div class="flex-1"><label>Vessel</label><select id="reqVessel"></select></div>
        <div class="flex-1"><label>Category</label><select id="reqCategory"></select></div>
      </div>
      <div class="flex-row">
         <div class="flex-1"><label>Description</label><input type="text" id="reqDescription" placeholder="Item details..." /></div>
         <div class="flex-1"><label>Supplier</label><div style="display:flex; gap:8px;"><select id="reqSupplierSelect" style="flex:1;"></select><button id="newSupplierBtn" type="button" class="secondary" title="Add New">+</button></div></div>
      </div>
      <div class="flex-row">
         <div class="flex-1"><label>Ordered Date</label><input type="date" id="reqDateOrdered" /></div>
         <div class="flex-1"><label>Expected Date</label><input type="date" id="reqExpected" /></div>
         <div class="flex-1"><label>Amount</label><input type="number" id="reqTotal" step="0.01" /></div>
         <div class="flex-1"><label>Currency</label><select id="reqCurrency"></select></div>
      </div>
      <div class="flex-row">
        <div class="flex-1"><label>Tracking URL</label><input type="text" id="reqTracking" placeholder="https://..." /></div>
        <div class="flex-1"><label>Urgency</label><select id="reqUrgency"><option value="normal">Normal</option><option value="high">High</option></select></div>
        <div class="flex-1"><label>Remarks / Delivery Note</label><input type="text" id="reqRemarks" placeholder="Notes..." /></div>
      </div>
      <div style="display:flex; justify-content: flex-end; gap:12px; margin-top:20px;">
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
          <input type="checkbox" id="reqPaid" style="width:auto; margin:0;"/> Mark as Paid
        </label>
        <button id="cancelReqEditBtn" class="secondary hidden" type="button">Cancel</button>
        <button id="saveReqBtn" class="success">Save Order</button>
      </div>
      <div id="reqError" class="error"></div>
    </div>

    <div class="card">
      <div style="display:flex; justify-content:space-between; margin-bottom:16px;">
        <h2 style="margin:0;">Orders List</h2>
        <button id="exportReqBtn" class="secondary">‚¨á Export CSV</button>
      </div>
      <div class="flex-row" style="background:var(--bg-body); padding:16px; border-radius:8px; align-items:flex-end;">
        <div style="flex:1;"><label>Status</label><select id="filterReqStatus"><option value="">All</option><option value="open">Open</option><option value="cancelled">Cancelled</option></select></div>
        <div style="flex:1;"><label>Payment</label><select id="filterReqPaid"><option value="">All</option><option value="1">Paid</option><option value="0">Unpaid</option></select></div>
        <div style="flex:1;"><label>Delivery</label><select id="filterReqDelivered"><option value="">All</option><option value="1">Full</option><option value="2">Partial</option><option value="0">None</option></select></div>
        <div style="flex:2;"><label>Search</label><input type="text" id="filterReqSearch" placeholder="Search PO, Vessel, Supplier..." /></div>
        <div style="display:flex; gap:8px;"><button id="applyReqFilterBtn">Filter</button><button id="clearReqFilterBtn" class="secondary">Clear</button></div>
      </div>
      <div class="table-container">
        <table id="reqTable">
          <thead>
            <tr>
              <th style="width:40px;"><input type="checkbox" id="reqSelectAll" /></th>
              <th onclick="sortTable(this,1)">PO #</th>
              <th onclick="sortTable(this,2)">Description</th>
              <th onclick="sortTable(this,3)">Vessel</th>
              <th onclick="sortTable(this,4)">Supplier</th>
              <th onclick="sortTable(this,5)">Ordered</th>
              <th onclick="sortTable(this,6)">Amount ($)</th>
              <th onclick="sortTable(this,7)">Payment</th>
              <th onclick="sortTable(this,8)">Delivery</th>
              <th style="width:80px;">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="tab-landings" class="tab-content hidden">
    <div class="card" id="landAddCard">
      <h2 id="landFormTitle">Add Landed Item</h2>
      <div class="flex-row">
        <div class="flex-1"><label>Vessel</label><select id="landVessel"></select></div>
        <div class="flex-1"><label>Workshop/Supplier</label><div style="display:flex; gap:8px;"><select id="landWorkshopSelect" style="flex:1;"></select><button id="newWorkshopBtn" class="secondary" title="Add New">+</button></div></div>
        <div class="flex-1"><label>Item Description</label><input type="text" id="landDescription" /></div>
      </div>
      <div class="flex-row">
         <div class="flex-1"><label>Expected Date</label><input type="date" id="landExpected" /></div>
         <div class="flex-1"><label>Landed Date</label><input type="date" id="landLanded" /></div>
         <div class="flex-1"><label>Amount</label><input type="number" id="landAmount" step="0.01" /></div>
         <div class="flex-1"><label>Currency</label><select id="landCurrency"></select></div>
      </div>
      <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:16px;">
        <label style="display:flex; align-items:center; gap:8px;"><input type="checkbox" id="landPaid" style="width:auto; margin:0;" /> Paid</label>
        <button id="cancelLandEditBtn" class="secondary hidden">Cancel</button>
        <button id="saveLandingBtn" class="success">Save Landing</button>
      </div>
    </div>

    <div class="card">
      <h2>Landed Items</h2>
      <div class="table-container">
        <table id="landingTable">
          <thead>
            <tr>
              <th style="width:40px;"><input type="checkbox" id="landSelectAll" /></th>
              <th onclick="sortTable(this,1)">Vessel</th>
              <th onclick="sortTable(this,2)">Item</th>
              <th onclick="sortTable(this,3)">Workshop</th>
              <th onclick="sortTable(this,4)">Expected</th>
              <th onclick="sortTable(this,5)">Amount ($)</th>
              <th onclick="sortTable(this,6)">Payment</th>
              <th onclick="sortTable(this,7)">Delivery</th>
              <th style="width:80px;">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="tab-directory" class="tab-content hidden">
    <div class="card">
      <div style="display:flex; justify-content:space-between;">
        <h2>Supplier Directory</h2>
        <div><button id="dirNewSupplierBtn">Add Supplier</button><button id="dirNewWorkshopBtn" class="secondary">Add Workshop</button></div>
      </div>
      <div class="table-container" style="margin-top:16px;">
        <table id="directoryTable"><thead><tr><th>Type</th><th>Name</th><th>Email</th><th>Phone</th><th>Rating</th><th>Actions</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </div>
  
  <div id="tab-delivered" class="tab-content hidden">
    <div class="card">
      <h2>History Log</h2>
      <div class="table-container">
        <table id="deliveredReqTable"><thead><tr><th>Type</th><th>Ref</th><th>Desc</th><th>Entity</th><th>Amount</th><th>Paid</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </div>

  <div id="tab-admin" class="tab-content hidden">
    <div class="card">
      <h2>Admin Panel</h2>
      <div class="flex-row">
        <button onclick="document.getElementById('adminCats').classList.toggle('hidden')" class="secondary">Manage Categories</button>
        <button onclick="document.getElementById('adminVessels').classList.toggle('hidden')" class="secondary">Manage Vessels</button>
        <button onclick="document.getElementById('adminUsers').classList.toggle('hidden')" class="secondary">Manage Users</button>
        <button onclick="document.getElementById('backupCard').classList.toggle('hidden')" class="secondary">Backups & Restore</button>
        <button onclick="document.getElementById('auditCard').classList.toggle('hidden')" class="secondary">Activity Logs</button>
      </div>
      
      <div id="adminCats" class="hidden" style="margin-top:15px; border-top:1px solid var(--border); padding-top:15px;">
        <h3>Categories</h3>
        <div class="flex-row"><input id="catName" placeholder="Name"><input id="catAbbr" placeholder="Abbr"><button id="addCatBtn">Add</button></div>
        <table id="catTable"><thead><tr><th>Name</th><th>Abbr</th><th>Action</th></tr></thead><tbody></tbody></table>
      </div>
      <div id="adminVessels" class="hidden" style="margin-top:15px; border-top:1px solid var(--border); padding-top:15px;">
         <h3>Vessels</h3>
         <div class="flex-row"><input id="vesselName" placeholder="Name"><button id="addVesselBtn">Add</button></div>
         <table id="vesselTable"><thead><tr><th>Name</th><th>Action</th></tr></thead><tbody></tbody></table>
      </div>
      <div id="adminUsers" class="hidden" style="margin-top:15px; border-top:1px solid var(--border); padding-top:15px;">
         <h3>Users</h3>
         <div class="flex-row"><input id="adminUsername" placeholder="User"><input type="password" id="adminPassword" placeholder="Pass"><select id="adminRole"><option value="user">User</option><option value="finance">Finance</option><option value="admin">Admin</option></select><button id="saveUserBtn">Add</button></div>
         <table id="userTable"><thead><tr><th>User</th><th>Role</th><th>Action</th></tr></thead><tbody></tbody></table>
      </div>

      <div id="auditCard" class="hidden" style="margin-top:15px; border-top:1px solid var(--border); padding-top:15px;">
         <h3>System Activity Logs</h3>
         <div class="flex-row">
             <div style="flex:1"><select id="auditFYear"><option value="">Year</option></select></div>
             <div style="flex:1"><select id="auditFMonth"><option value="">Month</option></select></div>
             <div style="flex:1"><button id="auditApplyBtn">Filter Logs</button></div>
         </div>
         <div class="table-container" style="max-height: 400px; overflow-y: auto;">
             <table id="auditTable"><thead><tr><th>User</th><th>Action</th><th>Target</th><th>Date</th></tr></thead><tbody></tbody></table>
         </div>
      </div>

      <div class="hidden" id="backupCard" style="margin-top:15px; border-top:1px solid var(--border); padding-top:15px;">
         <h3>System Backups</h3>
         <div class="flex-row"><button id="createBackupBtn" class="success">Create Backup Now</button><button id="downloadBackupBtn">Download Manual</button></div>
         
         <div style="background:#fff3cd; color:#854d0e; padding:10px; border-radius:6px; margin:10px 0;">
            <strong>Restore / Upload Database:</strong> Select an .xlsx file to overwrite the current database.
            <div style="display:flex; gap:10px; margin-top:8px;">
                <input type="file" id="uploadBackupInput" accept=".xlsx" style="border:1px solid #ccc; background:#fff;">
                <button id="uploadBackupBtn" class="danger">Upload & Restore</button>
            </div>
         </div>
         <table id="backupTable" style="margin-top:10px;"><thead><tr><th>Filename</th><th>Date</th><th>Size</th><th>Actions</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </div>
</div>

<div id="loginCard" class="popup-backdrop">
  <div class="popup" style="max-width:350px;">
    <h2>Login</h2>
    <label>Username</label><input type="text" id="loginUsername" />
    <label style="margin-top:10px;">Password</label><input type="password" id="loginPassword" />
    <button id="loginBtn" style="width:100%; margin-top:20px;">Login</button>
    <div id="loginError" class="error"></div>
  </div>
</div>

<div id="dirPopupBackdrop" class="popup-backdrop">
  <div id="dirPopup" class="popup">
    <h3 id="dirPopupTitle">Add Contact</h3>
    <input type="hidden" id="dirPopupId">
    <div class="flex-row">
      <div class="flex-1"><label>Type</label><select id="dirPopupType"><option value="supplier">Supplier</option><option value="workshop">Workshop</option></select></div>
      <div class="flex-1"><label>Name</label><input type="text" id="dirPopupName" /></div>
    </div>
    <div class="flex-row"><div class="flex-1"><label>Email</label><input type="email" id="dirPopupEmail" /></div><div class="flex-1"><label>Phone</label><input type="text" id="dirPopupPhone" /></div></div>
    <label>Address</label><input type="text" id="dirPopupAddress" />
    <div style="margin-top:20px; text-align:right; display:flex; gap:10px; justify-content:flex-end;">
      <button onclick="document.getElementById('dirPopupBackdrop').classList.remove('visible')" class="secondary">Cancel</button>
      <button id="dirPopupSaveBtn" class="success">Save</button>
    </div>
  </div>
</div>

<div id="ratePopupBackdrop" class="popup-backdrop">
  <div id="ratePopup" class="popup" style="max-width:400px;">
    <h3>Rate Supplier</h3>
    <input type="hidden" id="rateDirId">
    <label>Rating</label>
    <select id="rateScore">
      <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (Excellent)</option>
      <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (Good)</option>
      <option value="3">‚≠ê‚≠ê‚≠ê (Average)</option>
      <option value="2">‚≠ê‚≠ê (Poor)</option>
      <option value="1">‚≠ê (Terrible)</option>
    </select>
    <label>Comments</label>
    <textarea id="rateComment" rows="3"></textarea>
    <div style="margin-top:20px; text-align:right; display:flex; gap:10px; justify-content:flex-end;">
       <button onclick="document.getElementById('ratePopupBackdrop').classList.remove('visible')" class="secondary">Cancel</button>
       <button id="saveRateBtn" class="success">Save Rating</button>
    </div>
  </div>
</div>

<div id="docPopupBackdrop" class="popup-backdrop">
  <div id="docPopup" class="popup">
    <h3>Attached Documents</h3>
    <input type="hidden" id="docParentType">
    <input type="hidden" id="docParentId">
    <div style="margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid var(--border);">
       <label>Upload File</label>
       <div style="display:flex; gap:10px;"><input type="file" id="docUploadInput" /><button id="docUploadBtn" class="success">Upload</button></div>
    </div>
    <table id="docTable"><thead><tr><th>File</th><th>By</th><th>Date</th></tr></thead><tbody></tbody></table>
    <div style="text-align:right; margin-top:15px;"><button onclick="document.getElementById('docPopupBackdrop').classList.remove('visible')" class="secondary">Close</button></div>
  </div>
</div>

<div id="chartBackdrop" class="popup-backdrop">
  <div id="chartPopup" class="popup" style="max-width:800px;">
    <div style="display:flex; justify-content:space-between; margin-bottom:15px;"><h3>Analytics Studio</h3><button onclick="document.getElementById('chartBackdrop').classList.remove('visible')" class="secondary">‚úï</button></div>
    <div class="flex-row">
       <div class="flex-1"><label>X-Axis (Dimension)</label><select id="chartXAxis"><option value="vessel">Vessel</option><option value="supplier">Supplier</option><option value="category">Category</option></select></div>
       <div class="flex-1"><label>Y-Axis (Metric)</label><select id="chartMetric"><option value="amount">Total Spend ($)</option><option value="count">Count of Orders</option></select></div>
       <div class="flex-1"><label>Period</label><select id="chartPeriod"><option value="all">All Time</option><option value="this_year">This Year</option><option value="last_year">Last Year</option></select></div>
       <div class="flex-1"><label>Type</label><select id="chartType"><option value="bar">Bar</option><option value="doughnut">Doughnut</option></select></div>
       <div style="flex:0;"><label>&nbsp;</label><button id="refreshChartBtn">Refresh</button></div>
    </div>
    <div style="position:relative; height:400px; width:100%;"><canvas id="customChart"></canvas></div>
  </div>
</div>

<div id="agingPopupBackdrop" class="popup-backdrop">
  <div id="agingPopup" class="popup" style="max-width:800px;">
    <h3>Aging Report (Unpaid Invoices)</h3>
    <div class="table-container">
      <table id="agingTable"><thead><tr><th>PO #</th><th>Supplier</th><th>Amount</th><th>Days Unpaid</th><th>Group</th></tr></thead><tbody></tbody></table>
    </div>
    <div style="text-align:right; margin-top:15px;"><button onclick="document.getElementById('agingPopupBackdrop').classList.remove('visible')" class="secondary">Close</button></div>
  </div>
</div>

<div id="supHistBackdrop" class="popup-backdrop">
  <div id="supHistPopup" class="popup">
    <div style="display:flex; justify-content:space-between;">
        <h3 id="supHistTitle">Supplier History</h3>
        <div id="supScoreDisplay" style="font-weight:bold; color:var(--warning);"></div>
    </div>
    <div class="table-container">
      <table id="supHistTable"><thead><tr><th>Date</th><th>PO #</th><th>Item</th><th>Amount</th></tr></thead><tbody></tbody></table>
    </div>
    <div style="text-align:right; margin-top:15px;"><button onclick="document.getElementById('supHistBackdrop').classList.remove('visible')" class="secondary">Close</button></div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
async function apiFetch(url, options = {}) {
  const res = await fetch(url, { headers: { "Content-Type": "application/json" }, ...options });
  if (!res.ok) { let err; try { err = await res.json(); } catch { err = { error: "unknown" }; } throw err; }
  return res.json();
}

/* ================= STATE ================= */
let currentUser=null, allReqs=[], allLandings=[], vessels=[];
let editingReqId=null, editingLandId=null, dirPopupType=null, currencyList=["USD"];
let selectedIds = new Set(); let currentBulkType = null;
let myChart = null;
let allAuditLogs = []; 

/* ================= THEME ================= */
const darkModeBtn = document.getElementById("darkModeBtn");
if(localStorage.getItem("theme")==="dark") document.body.classList.add("dark-mode");
darkModeBtn.onclick = () => {
    document.body.classList.toggle("dark-mode");
    localStorage.setItem("theme", document.body.classList.contains("dark-mode") ? "dark" : "light");
};

/* ================= INITIALIZATION ================= */
async function afterDataLoad() {
    selectedIds.clear(); toggleBulkBar();
    await loadOptions(); await loadData(); 
    calculateOverviewTotals(); await updateDashboard(); await loadAdminData();
    if(currentUser && currentUser.username==='finance') if(document.getElementById('reqAddCard')) document.getElementById('reqAddCard').classList.add('hidden');
}

async function loadOptions(){
    try { const res = await apiFetch("/api/currencies"); currencyList = res.currencies || ["USD"]; } catch {}
    const fillSel = (id) => { const el = document.getElementById(id); if(!el)return; el.innerHTML=""; currencyList.forEach(c => el.add(new Option(c,c))); el.value="USD"; };
    fillSel("reqCurrency"); fillSel("landCurrency");
    
    try { vessels = await apiFetch("/api/vessels"); } catch { vessels=[]; }
    const fillVes = (id) => { const el=document.getElementById(id); if(!el)return; const cur=el.value; el.innerHTML='<option value="">Select Vessel</option>'; vessels.forEach(v=>el.add(new Option(v.name,v.name))); if(cur) el.value=cur; };
    fillVes("reqVessel"); fillVes("landVessel"); fillVes("ovVesselFilter");
    
    // Month/Year Options
    ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"].forEach((m,i)=> {
       document.getElementById("ovMonthFilter").add(new Option(m, i+1));
       document.getElementById("auditFMonth").add(new Option(m, i+1));
    });
    const y = new Date().getFullYear();
    for(let i=y; i>=y-3; i--) {
        document.getElementById("ovYearFilter").add(new Option(i, i));
        document.getElementById("auditFYear").add(new Option(i, i));
    }

    try { const cats=await apiFetch("/api/categories"); const cSel=document.getElementById("reqCategory"); 
       if(cSel){ cSel.innerHTML='<option value="">Select</option>'; cats.forEach(c=>cSel.add(new Option(c.abbr, c.abbr))); } 
       // Admin Table
       const t=document.querySelector("#catTable tbody"); t.innerHTML="";
       cats.forEach(c => t.innerHTML += `<tr><td>${c.name}</td><td>${c.abbr}</td><td><button class="small-action danger" onclick="delCat(${c.id})">Del</button></td></tr>`);
    } catch {}

    try { const dirs=await apiFetch("/api/directory"); 
       const sSel=document.getElementById("reqSupplierSelect"); if(sSel){ sSel.innerHTML='<option value="">Select</option>'; dirs.filter(d=>d.type==='supplier').forEach(d=>sSel.add(new Option(d.name, d.name))); }
       const wSel=document.getElementById("landWorkshopSelect"); if(wSel){ wSel.innerHTML='<option value="">Select</option>'; dirs.filter(d=>d.type==='workshop').forEach(d=>wSel.add(new Option(d.name, d.name))); }
       renderDirectory(dirs);
    } catch {}
}

async function loadData() {
    try { allReqs = await apiFetch("/api/requisitions"); } catch { allReqs=[]; }
    try { allLandings = await apiFetch("/api/landings"); } catch { allLandings=[]; }
    renderReqTable(); renderLandTable(); renderDelivered();
}

/* ================= RENDERING ================= */
function formatMoney(amount) { return parseFloat(amount || 0).toLocaleString('en-US', {style:'currency', currency:'USD'}); }
function parseDateSafe(d) { if(!d)return null; const dt=new Date(d); return isNaN(dt.getTime())?null:dt; }

async function updateDashboard() {
   // Calculate counts for summary boxes
   const openReq = allReqs.filter(r => (r.status||'open')!=='cancelled' && r.delivered!=1);
   const unpaidReq = allReqs.filter(r => (r.status||'open')!=='cancelled' && !r.paid);
   const openLand = allLandings.filter(r => (r.status||'open')!=='cancelled' && r.delivered!=1);
   const unpaidLand = allLandings.filter(r => (r.status||'open')!=='cancelled' && !r.paid);

   document.getElementById("summaryOpenReqNotDel").textContent = openReq.length;
   document.getElementById("summaryOpenReqUnpaid").textContent = unpaidReq.length;
   document.getElementById("summaryOpenLandNotDel").textContent = openLand.length;
   document.getElementById("summaryOpenLandUnpaid").textContent = unpaidLand.length;
   
   // Overview Table (Top 5 Recent)
   const t = document.querySelector("#overviewReqTable tbody"); t.innerHTML="";
   allReqs.sort((a,b)=> new Date(b.date_ordered) - new Date(a.date_ordered)).slice(0,5).forEach(r => {
      t.innerHTML += `<tr><td>${r.po_number||r.number}</td><td>${r.vessel}</td><td>${r.description}</td><td>${r.supplier}</td><td>${r.date_ordered}</td><td>${formatMoney(r.amount_usd)}</td><td>${r.paid?'<span class="tag green">Paid</span>':'<span class="tag red">Unpaid</span>'}</td></tr>`;
   });
}

function renderReqTable() {
    const tbody = document.querySelector("#reqTable tbody"); tbody.innerHTML="";
    const statusF=document.getElementById("filterReqStatus").value, paidF=document.getElementById("filterReqPaid").value, delF=document.getElementById("filterReqDelivered").value, search=document.getElementById("filterReqSearch").value.toLowerCase();
    
    const today = new Date();
    today.setHours(0,0,0,0);

    allReqs.forEach(r => {
        if((r.status||"open")==="cancelled") return; 
        if(statusF && (r.status||"open")!==statusF) return;
        if(paidF !== "" && (r.paid?1:0) != paidF) return;
        if(delF !== "" && r.delivered != delF) return;
        if(search && !`${r.po_number} ${r.description} ${r.vessel} ${r.supplier}`.toLowerCase().includes(search)) return;

        const tr = document.createElement("tr");
        if(r.urgency === 'high') tr.classList.add('urgency-high');
        const isChecked = selectedIds.has(r.id) && currentBulkType === 'req';
        let delBadge = r.delivered == 1 ? '<span class="tag green">Full</span>' : (r.delivered == 2 ? '<span class="tag yellow">Partial</span>' : '<span class="tag gray">Open</span>');

        // Overdue Check
        let dateDisplay = r.date_ordered;
        if(r.expected && r.delivered != 1) {
            const exp = new Date(r.expected);
            if(exp < today) dateDisplay += ` <br><span style="color:red; font-size:11px;">üïí Due: ${r.expected}</span>`;
        }
        
        // High Urgency Icon
        let poDisplay = r.po_number||r.number;
        if(r.urgency === 'high') poDisplay = `<span class="high-icon">üö©</span>` + poDisplay;

        const menu = `
          <div class="action-menu"><button class="drop-btn" onclick="toggleMenu(this)">‚Ä¢‚Ä¢‚Ä¢</button>
            <div class="drop-content">
               <button onclick="openDocPopup(${r.id}, 'req')">üìé Documents</button>
               <button onclick="editReq(${r.id})">‚úé Edit / Remarks</button>
               <button onclick="generatePO(${r.id})">üñ®Ô∏è Print PO</button>
               <button onclick="showSupplierHistory('${r.supplier}')">üìÖ Supplier History</button>
               ${!r.paid ? `<button onclick="singleAction(${r.id}, 'req', 'mark_paid')">üí≤ Mark Paid</button>` : ''}
               ${r.delivered!=1 ? `<button onclick="singleAction(${r.id}, 'req', 'mark_delivered')">‚úÖ Full Delivery</button>` : ''}
               ${r.delivered!=2 ? `<button onclick="singleAction(${r.id}, 'req', 'mark_partial')">üöß Mark Partial</button>` : ''}
               <button onclick="cancelReq(${r.id})" style="color:var(--danger)">‚úï Cancel</button>
            </div>
          </div>`;

        tr.innerHTML = `
            <td><input type="checkbox" class="row-select" data-id="${r.id}" ${isChecked?'checked':''}></td>
            <td><strong>${poDisplay}</strong></td>
            <td>${r.description}</td>
            <td>${r.vessel}</td>
            <td><span class="clickable-link" onclick="showSupplierHistory('${r.supplier}')">${r.supplier}</span></td>
            <td>${dateDisplay}</td>
            <td>${formatMoney(r.amount_usd)}</td>
            <td>${r.paid?'<span class="tag green">Paid</span>':'<span class="tag red">Unpaid</span>'}</td>
            <td>${delBadge}</td>
            <td>${menu}</td>`;
        tbody.appendChild(tr);
    });
    attachBulkListeners('req');
}

function renderLandTable() {
    const tbody = document.querySelector("#landingTable tbody"); tbody.innerHTML="";
    allLandings.forEach(r => {
        if((r.status||"open")==="cancelled") return;
        const tr = document.createElement("tr");
        const isChecked = selectedIds.has(r.id) && currentBulkType === 'land';
        let delBadge = r.delivered==1 ? '<span class="tag green">Received</span>' : (r.delivered==2 ? '<span class="tag yellow">Partial</span>':'<span class="tag gray">Pending</span>');
        const menu = `<div class="action-menu"><button class="drop-btn" onclick="toggleMenu(this)">‚Ä¢‚Ä¢‚Ä¢</button><div class="drop-content"><button onclick="openDocPopup(${r.id}, 'land')">Documents</button><button onclick="editLand(${r.id})">Edit</button><button onclick="singleAction(${r.id}, 'land', 'mark_paid')">Mark Paid</button><button onclick="deleteItem(${r.id}, 'land')" style="color:red">Delete</button></div></div>`;
        tr.innerHTML = `<td><input type="checkbox" class="row-select" data-id="${r.id}" ${isChecked?'checked':''}></td><td>${r.vessel}</td><td>${r.item}</td><td>${r.workshop}</td><td>${r.expected||""}</td><td>${formatMoney(r.amount_usd)}</td><td>${r.paid?'<span class="tag green">Paid</span>':'<span class="tag red">Unpaid</span>'}</td><td>${delBadge}</td><td>${menu}</td>`;
        tbody.appendChild(tr);
    });
    attachBulkListeners('land');
}

function renderDirectory(rows) {
  const t=document.querySelector("#directoryTable tbody"); t.innerHTML="";
  rows.forEach(r=>{ 
      t.innerHTML+=`<tr><td>${r.type}</td><td>${r.name}</td><td>${r.email||'-'}</td><td>${r.phone||'-'}</td><td>${"‚≠ê".repeat(r.rating||5)}</td><td><button class="small-action warning" onclick="openRatePopup(${r.id})">Rate</button> <button class="small-action secondary" onclick="editDir(${r.id})">Edit</button> <button class="small-action danger" onclick="delDir(${r.id})">Del</button></td></tr>`; 
  });
}
function renderDelivered() {
  const t=document.querySelector("#deliveredReqTable tbody"); t.innerHTML="";
  allReqs.filter(r=>r.delivered==1).sort((a,b)=>b.id-a.id).slice(0,50).forEach(r=>{ t.innerHTML+=`<tr><td>Order</td><td>${r.po_number}</td><td>${r.description}</td><td>${r.supplier}</td><td>${formatMoney(r.amount_usd)}</td><td>${r.paid?'Yes':'No'}</td></tr>`; });
}

/* ================= ACTIONS ================= */
async function editReq(id) {
    const r = allReqs.find(x=>x.id==id); if(!r) return;
    editingReqId = id;
    document.getElementById("reqFormTitle").textContent="Edit Order (" + r.po_number + ")"; 
    document.getElementById("saveReqBtn").textContent="Update Order";
    document.getElementById("cancelReqEditBtn").classList.remove("hidden");
    document.getElementById("reqPONumber").value=r.po_number||""; document.getElementById("reqNumber").value=r.number;
    document.getElementById("reqDescription").value=r.description; document.getElementById("reqVessel").value=r.vessel;
    document.getElementById("reqCategory").value=r.category; document.getElementById("reqSupplierSelect").value=r.supplier;
    document.getElementById("reqDateOrdered").value=r.date_ordered; document.getElementById("reqExpected").value=r.expected||"";
    document.getElementById("reqTotal").value=r.amount_original || r.amount_usd; document.getElementById("reqCurrency").value=r.currency;
    document.getElementById("reqTracking").value=r.tracking_url||""; document.getElementById("reqUrgency").value=r.urgency;
    document.getElementById("reqRemarks").value=r.remarks||""; document.getElementById("reqPaid").checked=!!r.paid;
    document.querySelector("[data-tab='requisitions']").click(); document.getElementById("reqAddCard").scrollIntoView({behavior:"smooth"});
}

document.getElementById("saveReqBtn").onclick = async () => {
    const valAmt = document.getElementById("reqTotal").value;
    const payload = {
        po_number: document.getElementById("reqPONumber").value, number: document.getElementById("reqNumber").value,
        description: document.getElementById("reqDescription").value, vessel: document.getElementById("reqVessel").value,
        category: document.getElementById("reqCategory").value, supplier: document.getElementById("reqSupplierSelect").value,
        date_ordered: document.getElementById("reqDateOrdered").value, expected: document.getElementById("reqExpected").value,
        amount_original: valAmt, amount: valAmt, currency: document.getElementById("reqCurrency").value,
        tracking_url: document.getElementById("reqTracking").value, urgency: document.getElementById("reqUrgency").value,
        remarks: document.getElementById("reqRemarks").value, paid: document.getElementById("reqPaid").checked
    };
    try {
        if(editingReqId) await apiFetch(`/api/requisitions/${editingReqId}`, {method:"PATCH", body:JSON.stringify(payload)});
        else await apiFetch("/api/requisitions", {method:"POST", body:JSON.stringify(payload)});
        resetReqForm(); await afterDataLoad();
    } catch(e) { console.error(e); alert("Error saving: " + (e.error || e)); }
};
function resetReqForm() { editingReqId=null; document.getElementById("reqFormTitle").textContent="New Requisition"; document.getElementById("saveReqBtn").textContent="Save Order"; document.getElementById("cancelReqEditBtn").classList.add("hidden"); document.querySelectorAll("#reqAddCard input").forEach(i=>i.value=""); }
document.getElementById("cancelReqEditBtn").onclick = resetReqForm;
async function singleAction(id, type, action) { await apiFetch(type==='req'?'/api/requisitions/bulk':'/api/landings/bulk', { method:"POST", body: JSON.stringify({ ids: [id], action }) }); await afterDataLoad(); }
async function cancelReq(id) { if(confirm("Cancel this order?")) { await apiFetch(`/api/requisitions/${id}`, {method:"PATCH", body:JSON.stringify({status:"cancelled"})}); await afterDataLoad(); } }

/* ================= DIRECTORY & POPUPS ================= */
// Add Supplier / Workshop Listeners
document.getElementById("dirNewSupplierBtn").onclick = () => openDirPopup('supplier');
document.getElementById("newSupplierBtn").onclick = () => openDirPopup('supplier');
document.getElementById("dirNewWorkshopBtn").onclick = () => openDirPopup('workshop');
document.getElementById("newWorkshopBtn").onclick = () => openDirPopup('workshop');

function openDirPopup(type, existingId=null) {
    document.getElementById("dirPopupBackdrop").classList.add("visible");
    document.getElementById("dirPopupId").value = existingId || "";
    document.getElementById("dirPopupType").value = type;
    document.getElementById("dirPopupTitle").textContent = existingId ? "Edit Contact" : ("Add " + (type==='supplier'?'Supplier':'Workshop'));
    
    if(existingId) {
        // Find existing
        const all = Array.from(document.querySelectorAll("#directoryTable tbody tr")).map(tr=>{/* logic to find from cache would be better but reloading... */});
        // Simpler: reload data or assume passed data. Let's fetch clean list
        apiFetch("/api/directory").then(dirs => {
            const d = dirs.find(x=>x.id == existingId);
            if(d) {
                document.getElementById("dirPopupName").value = d.name;
                document.getElementById("dirPopupEmail").value = d.email;
                document.getElementById("dirPopupPhone").value = d.phone;
                document.getElementById("dirPopupAddress").value = d.address||"";
            }
        });
    } else {
        document.getElementById("dirPopupName").value = "";
        document.getElementById("dirPopupEmail").value = "";
        document.getElementById("dirPopupPhone").value = "";
        document.getElementById("dirPopupAddress").value = "";
    }
}

function editDir(id) { openDirPopup('supplier', id); /* Type will be overwritten by fetch logic if sophisticated, here default to supplier but UI allows change */ }
async function delDir(id) { if(confirm("Delete?")) { await apiFetch(`/api/directory/${id}`, {method:"DELETE"}); await afterDataLoad(); } }

document.getElementById("dirPopupSaveBtn").onclick = async () => {
    const id = document.getElementById("dirPopupId").value;
    const payload = {
        type: document.getElementById("dirPopupType").value,
        name: document.getElementById("dirPopupName").value,
        email: document.getElementById("dirPopupEmail").value,
        phone: document.getElementById("dirPopupPhone").value,
        address: document.getElementById("dirPopupAddress").value
    };
    if(!payload.name) return alert("Name required");
    try {
        if(id) await apiFetch(`/api/directory/${id}`, {method:"PATCH", body:JSON.stringify(payload)});
        else await apiFetch("/api/directory", {method:"POST", body:JSON.stringify(payload)});
        document.getElementById("dirPopupBackdrop").classList.remove("visible");
        await afterDataLoad();
    } catch { alert("Error saving directory"); }
};

/* ================= LANDINGS ================= */
// Landing Save Logic
document.getElementById("saveLandingBtn").onclick = async () => {
   const valAmt = document.getElementById("landAmount").value;
   const payload = {
       vessel: document.getElementById("landVessel").value,
       workshop: document.getElementById("landWorkshopSelect").value,
       item: document.getElementById("landDescription").value,
       expected: document.getElementById("landExpected").value,
       landed_date: document.getElementById("landLanded").value,
       amount_original: valAmt, amount: valAmt,
       currency: document.getElementById("landCurrency").value,
       paid: document.getElementById("landPaid").checked
   };
   try {
       if(editingLandId) await apiFetch(`/api/landings/${editingLandId}`, {method:"PATCH", body:JSON.stringify(payload)});
       else await apiFetch("/api/landings", {method:"POST", body:JSON.stringify(payload)});
       editingLandId=null; document.getElementById("landAddCard").querySelectorAll("input").forEach(i=>i.value="");
       await afterDataLoad();
   } catch(e) { alert("Error saving landing"); }
};
async function deleteItem(id, type) { if(confirm("Delete?")) { await apiFetch(type==='req'?`/api/requisitions/${id}`:`/api/landings/${id}`, {method:"DELETE"}); await afterDataLoad(); } }
async function editLand(id) { 
    const l = allLandings.find(x=>x.id==id); if(!l)return; editingLandId=id;
    document.getElementById("landVessel").value=l.vessel; document.getElementById("landWorkshopSelect").value=l.workshop;
    document.getElementById("landDescription").value=l.item; document.getElementById("landExpected").value=l.expected||"";
    document.getElementById("landLanded").value=l.landed_date||""; document.getElementById("landAmount").value=l.amount_original;
    document.getElementById("landCurrency").value=l.currency; document.getElementById("landPaid").checked=!!l.paid;
    document.querySelector("[data-tab='landings']").click();
}

/* ================= FINANCIAL SUMMARY ================= */
document.getElementById("ovApplyTotalsBtn").onclick = calculateOverviewTotals;
function calculateOverviewTotals() {
    const typeF = document.getElementById("ovTypeFilter").value;
    const vesF = document.getElementById("ovVesselFilter").value;
    const monthF = document.getElementById("ovMonthFilter").value;
    const yearF = document.getElementById("ovYearFilter").value;

    let items = [];
    if(typeF === 'req') items = [...allReqs];
    else if(typeF === 'land') items = [...allLandings];
    else items = [...allReqs, ...allLandings];

    items = items.filter(i => {
        if((i.status||'open') === 'cancelled') return false;
        if(vesF && i.vessel !== vesF) return false;
        
        const d = parseDateSafe(i.date_ordered || i.landed_date);
        if(yearF && (!d || d.getFullYear() != yearF)) return false;
        if(monthF && (!d || (d.getMonth() + 1) != monthF)) return false;
        return true;
    });

    const total = items.reduce((acc, c) => acc + (c.amount_usd || 0), 0);
    const paid = items.filter(i => i.paid).reduce((acc, c) => acc + (c.amount_usd || 0), 0);
    const unpaid = items.filter(i => !i.paid).reduce((acc, c) => acc + (c.amount_usd || 0), 0);

    document.getElementById("ovAllTotal").textContent = formatMoney(total);
    document.getElementById("ovPaidMonthTotal").textContent = formatMoney(paid);
    document.getElementById("ovUnpaidMonthTotal").textContent = formatMoney(unpaid);

    // Top 5 Suppliers
    const supMap = {};
    items.forEach(r => {
        const s = r.supplier || r.workshop || "Unknown";
        supMap[s] = (supMap[s] || 0) + (r.amount_usd || 0);
    });
    const sorted = Object.entries(supMap).sort((a,b) => b[1] - a[1]).slice(0, 5);
    const ul = document.getElementById("ovTopSuppliers"); ul.innerHTML = "";
    if(sorted.length === 0) ul.innerHTML = "<li>No data available</li>";
    sorted.forEach(([k,v]) => {
        ul.innerHTML += `<li><span>${k}</span> <strong>$${v.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</strong></li>`;
    });
}

/* ================= PRINT PO ================= */
function generatePO(id) {
    const r = allReqs.find(x => x.id == id); if(!r) return;
    const w = window.open("", "_blank");
    w.document.write(`<html><head><title>PO ${r.po_number}</title><style>body{font-family:sans-serif;padding:40px;}.h{display:flex;justify-content:space-between;border-bottom:2px solid #000;margin-bottom:20px;}table{width:100%;border-collapse:collapse;margin-top:20px;}th,td{border:1px solid #ccc;padding:8px;}</style></head><body>
      <div class="h"><div><h1>Purchase Order</h1></div><div><h2>${r.po_number||r.number}</h2><p>Date: ${r.date_ordered}</p></div></div>
      <p><strong>Vendor:</strong> ${r.supplier}<br><strong>Ship To:</strong> ${r.vessel}</p>
      <table><thead><tr><th>Description</th><th>Amount (${r.currency})</th></tr></thead><tbody><tr><td>${r.description}</td><td>${r.amount_original}</td></tr></tbody></table>
      <script>window.print();<\/script></body></html>`);
    w.document.close();
}

/* ================= DOCUMENTS ================= */
async function openDocPopup(id, type) {
    document.getElementById("docPopupBackdrop").classList.add("visible");
    document.getElementById("docParentType").value = type;
    document.getElementById("docParentId").value = id;
    loadDocs(id, type);
}
async function loadDocs(id, type) {
    const tbody = document.querySelector("#docTable tbody"); tbody.innerHTML = "<tr><td colspan='3'>Loading...</td></tr>";
    try {
       const docs = await apiFetch(`/api/documents/${type}/${id}`);
       tbody.innerHTML = "";
       if(docs.length===0) tbody.innerHTML = "<tr><td colspan='3'>No documents found.</td></tr>";
       docs.forEach(d => {
           tbody.innerHTML += `<tr><td><a href="/static/uploads/${d.filename}" target="_blank">${d.filename}</a></td><td>${d.uploaded_by}</td><td>${d.uploaded_at}</td></tr>`;
       });
    } catch { tbody.innerHTML = "<tr><td colspan='3'>Error loading.</td></tr>"; }
}
document.getElementById("docUploadBtn").onclick = async () => {
    const file = document.getElementById("docUploadInput").files[0];
    const pid = document.getElementById("docParentId").value;
    const ptype = document.getElementById("docParentType").value;
    if(!file) return alert("Select file");
    
    const fd = new FormData();
    fd.append("file", file);
    fd.append("parent_id", pid);
    fd.append("parent_type", ptype);
    
    try {
        await fetch("/api/documents/upload", {method:"POST", body:fd});
        document.getElementById("docUploadInput").value = "";
        loadDocs(pid, ptype);
    } catch { alert("Upload failed"); }
};


/* ================= ANALYTICS ================= */
document.getElementById("openChartBtn").onclick = () => { document.getElementById("chartBackdrop").classList.add("visible"); updateChart(); };
document.getElementById("refreshChartBtn").onclick = updateChart;
function updateChart() {
    const ctx = document.getElementById('customChart').getContext('2d');
    const xKey = document.getElementById("chartXAxis").value;
    const yMetric = document.getElementById("chartMetric").value; // 'amount' or 'count'
    const period = document.getElementById("chartPeriod").value;
    
    const now = new Date();
    const currentYear = now.getFullYear();

    const map = {};
    allReqs.forEach(r => { 
        if((r.status||'open') === 'cancelled') return;
        
        // Time Filter
        const d = new Date(r.date_ordered);
        if(period === 'this_year' && d.getFullYear() !== currentYear) return;
        if(period === 'last_year' && d.getFullYear() !== currentYear - 1) return;

        const k = r[xKey] || "Unknown"; 
        const val = yMetric === 'count' ? 1 : (r.amount_usd || 0);
        map[k] = (map[k]||0) + val; 
    });

    if(myChart) myChart.destroy();
    myChart = new Chart(ctx, { 
        type: document.getElementById("chartType").value, 
        data: { 
            labels: Object.keys(map), 
            datasets: [{ 
                label: yMetric === 'count' ? 'Count of Orders' : 'Total Spend ($)', 
                data: Object.values(map), 
                backgroundColor:'#3b82f6' 
            }] 
        } 
    });
}

/* ================= AGING REPORT ================= */
document.getElementById("showAgingBtn").onclick = async () => {
    document.getElementById("agingPopupBackdrop").classList.add("visible");
    const t = document.querySelector("#agingTable tbody"); t.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";
    try { 
        const data = await apiFetch("/api/reports/aging"); 
        t.innerHTML = ""; 
        if(data.length === 0) t.innerHTML = "<tr><td colspan='5'>No overdue invoices found.</td></tr>";
        data.forEach(d => t.innerHTML += `<tr><td>${d.po}</td><td>${d.supplier}</td><td>$${d.amount}</td><td>${d.days}</td><td><span class="tag red">${d.group}</span></td></tr>`); 
    } catch { t.innerHTML="<tr><td colspan='5'>Error</td></tr>"; }
};

/* ================= SUPPLIER HISTORY & RATING ================= */
async function showSupplierHistory(supplierName) {
    const tbody = document.querySelector("#supHistTable tbody"); tbody.innerHTML="";
    document.getElementById("supHistTitle").textContent = "History: " + supplierName;
    document.getElementById("supScoreDisplay").textContent = "";
    // Attempt to get score from directory
    try { const d = (await apiFetch("/api/directory")).find(x=>x.name===supplierName); if(d) document.getElementById("supScoreDisplay").textContent = "Rating: " + "‚≠ê".repeat(d.rating||5); } catch {}
    allReqs.filter(r => r.supplier === supplierName).sort((a,b)=>b.id-a.id).slice(0, 10).forEach(i => {
        tbody.innerHTML += `<tr><td>${i.date_ordered}</td><td>${i.po_number||i.number}</td><td>${i.description}</td><td>$${i.amount_usd.toFixed(2)}</td></tr>`;
    });
    document.getElementById("supHistBackdrop").classList.add("visible");
}
function openRatePopup(id) { document.getElementById("rateDirId").value=id; document.getElementById("ratePopupBackdrop").classList.add("visible"); }
document.getElementById("saveRateBtn").onclick = async () => {
    await apiFetch(`/api/directory/${document.getElementById("rateDirId").value}`, {method:"PATCH", body:JSON.stringify({rating: document.getElementById("rateScore").value, rating_comment: document.getElementById("rateComment").value})});
    document.getElementById("ratePopupBackdrop").classList.remove("visible"); await loadData();
};

/* ================= ADMIN ================= */
// Add Listeners
document.getElementById("addCatBtn").onclick = async () => {
    const name = document.getElementById("catName").value;
    const abbr = document.getElementById("catAbbr").value;
    if(!name || !abbr) return alert("Fill all fields");
    try { await apiFetch("/api/categories", {method:"POST", body:JSON.stringify({name, abbr})}); loadAdminData(); loadOptions(); } catch(e){alert(e.error);}
};
document.getElementById("addVesselBtn").onclick = async () => {
    const name = document.getElementById("vesselName").value;
    if(!name) return alert("Fill name");
    try { await apiFetch("/api/vessels", {method:"POST", body:JSON.stringify({name})}); loadAdminData(); loadOptions(); } catch(e){alert(e.error);}
};
document.getElementById("saveUserBtn").onclick = async () => {
    const u = document.getElementById("adminUsername").value;
    const p = document.getElementById("adminPassword").value;
    const r = document.getElementById("adminRole").value;
    if(!u || !p) return alert("Fill fields");
    try { await apiFetch("/api/users", {method:"POST", body:JSON.stringify({username:u, password:p, role:r})}); loadAdminData(); } catch(e){alert(e.error);}
};

async function loadAdminData() {
    if(currentUser && currentUser.role === "admin") {
        try {
            // Vessels
            const ves = await apiFetch("/api/vessels");
            const vt = document.querySelector("#vesselTable tbody"); vt.innerHTML="";
            ves.forEach(v => vt.innerHTML += `<tr><td>${v.name}</td><td><button class="small-action danger" onclick="delVessel(${v.id})">Del</button></td></tr>`);
            
            // Users
            const usrs = await apiFetch("/api/users");
            const ut = document.querySelector("#userTable tbody"); ut.innerHTML="";
            usrs.forEach(u => ut.innerHTML += `<tr><td>${u.username}</td><td>${u.role}</td><td><button class="small-action danger" onclick="delUser('${u.username}')">Del</button></td></tr>`);

            // Backups
            const backs = await apiFetch("/api/backups");
            const bT=document.querySelector("#backupTable tbody"); bT.innerHTML="";
            backs.forEach(b => {
                bT.innerHTML += `<tr><td>${b.name}</td><td>${b.created_at}</td><td>${(b.size/1024).toFixed(0)}KB</td>
                <td><button class="small-action secondary" onclick="window.open('/api/backups/${b.name}/download')">DL</button> <button class="small-action warning" onclick="restoreBackup('${b.name}')">Restore</button></td></tr>`;
            });
            
            // Audit Logs
            allAuditLogs = await apiFetch("/api/audit");
            renderAuditLog();
        } catch(e) {}
    }
}
async function delCat(id){ if(confirm("Del?")) { await apiFetch(`/api/categories/${id}`, {method:"DELETE"}); loadAdminData(); loadOptions(); }}
async function delVessel(id){ if(confirm("Del?")) { await apiFetch(`/api/vessels/${id}`, {method:"DELETE"}); loadAdminData(); loadOptions(); }}
async function delUser(name){ if(confirm("Del?")) { await apiFetch(`/api/users/${name}`, {method:"DELETE"}); loadAdminData(); }}

async function restoreBackup(name) {
    if(!confirm("Restore this backup? Current data will be replaced.")) return;
    try { await apiFetch(`/api/backups/${name}/restore`, {method:"POST"}); alert("Restored! Page will reload."); window.location.reload(); } catch(e) { alert("Restore failed"); }
}
document.getElementById("uploadBackupBtn").onclick = async () => {
    const file = document.getElementById("uploadBackupInput").files[0];
    if(!file) return alert("Select a file first");
    if(!confirm("Overwrite database with this file?")) return;
    const fd = new FormData(); fd.append("file", file);
    try { await fetch("/api/upload", {method:"POST", body:fd}); alert("Uploaded & Restored! Reloading."); window.location.reload(); } catch(e) { alert("Upload failed"); }
};
document.getElementById("createBackupBtn").onclick = async () => { await apiFetch("/api/backup/create", {method:"POST"}); await loadAdminData(); };
document.getElementById("downloadBackupBtn").onclick = () => window.open("/api/backup/download", "_blank");

function renderAuditLog() {
    const tbody = document.querySelector("#auditTable tbody"); tbody.innerHTML = "";
    const fY = document.getElementById("auditFYear").value; const fM = document.getElementById("auditFMonth").value;
    const filtered = allAuditLogs.filter(log => {
        if(!log.date) return false;
        const d = new Date(log.date);
        if(fY && d.getFullYear() != fY) return false;
        if(fM && (d.getMonth()+1) != fM) return false;
        return true;
    });
    filtered.slice(0,100).forEach(log => tbody.innerHTML += `<tr><td>${log.user}</td><td>${log.action}</td><td>${log.target}</td><td>${log.date.replace("T"," ")}</td></tr>`);
}
document.getElementById("auditApplyBtn").onclick = renderAuditLog;

/* ================= BULK & SORT ================= */
function attachBulkListeners(type) {
    const tableId = type==='req'?'reqTable':'landingTable';
    document.querySelectorAll(`#${tableId} .row-select`).forEach(chk => {
        chk.addEventListener('change', (e) => { const id=+e.target.dataset.id; if(e.target.checked){selectedIds.add(id);currentBulkType=type;}else{selectedIds.delete(id);if(selectedIds.size===0)currentBulkType=null;} toggleBulkBar(); });
    });
}
document.getElementById("reqSelectAll").onclick = (e) => { const c=e.target.checked; document.querySelectorAll("#reqTable .row-select").forEach(k=>{k.checked=c; c?selectedIds.add(+k.dataset.id):selectedIds.delete(+k.dataset.id);}); if(c) currentBulkType='req'; else currentBulkType=null; toggleBulkBar(); };
function toggleBulkBar() { const bar=document.getElementById("bulkActionBar"); document.getElementById("bulkCount").textContent=selectedIds.size; if(selectedIds.size>0)bar.classList.add("visible"); else bar.classList.remove("visible"); }
document.getElementById("bulkMarkPartialBtn").onclick=()=>runBulk("mark_partial"); document.getElementById("bulkMarkPaidBtn").onclick=()=>runBulk("mark_paid"); document.getElementById("bulkMarkDeliveredBtn").onclick=()=>runBulk("mark_delivered"); document.getElementById("bulkMarkUnpaidBtn").onclick=()=>runBulk("mark_unpaid"); document.getElementById("bulkCancelBtn").onclick=()=>{selectedIds.clear(); toggleBulkBar(); loadData();};
async function runBulk(a){ await apiFetch(currentBulkType==='req'?'/api/requisitions/bulk':'/api/landings/bulk', {method:"POST", body:JSON.stringify({ids:Array.from(selectedIds), action:a})}); selectedIds.clear(); toggleBulkBar(); await afterDataLoad(); }

function sortTable(th, idx) {
    const t = th.closest("table").querySelector("tbody"); const rows = Array.from(t.querySelectorAll("tr")); const asc = !th.classList.contains("sort-asc");
    th.closest("tr").querySelectorAll("th").forEach(h=>h.classList.remove("sort-asc","sort-desc")); th.classList.add(asc?"sort-asc":"sort-desc");
    rows.sort((a,b) => { const vA=a.cells[idx].innerText.trim(), vB=b.cells[idx].innerText.trim(); return (parseFloat(vA.replace(/[^0-9.-]+/g,""))||vA).toString().localeCompare((parseFloat(vB.replace(/[^0-9.-]+/g,""))||vB).toString(), undefined, {numeric:true}) * (asc?1:-1); });
    t.append(...rows);
}

/* ================= AUTH & UTILS ================= */
function toggleMenu(btn) { const m=btn.nextElementSibling; document.querySelectorAll(".drop-content").forEach(d=>{if(d!==m)d.classList.remove("show")}); m.classList.toggle("show"); window.onclick=(e)=>{if(!e.target.matches('.drop-btn'))document.querySelectorAll(".drop-content").forEach(d=>d.classList.remove("show"))}; }
async function refreshSession() { try{currentUser=await apiFetch("/api/session");}catch{currentUser=null;} const ui=document.getElementById("userInfo"); if(currentUser&&currentUser.username){ ui.innerHTML=`Hi, ${currentUser.username} | <a href="#" id="logoutLnk">Logout</a>`; document.getElementById("logoutLnk").onclick=async()=>{await apiFetch("/api/logout",{method:"POST"});location.reload();}; document.getElementById("loginCard").classList.remove("visible"); if(currentUser.role==='admin')document.getElementById("adminTab").classList.remove("hidden"); } else { ui.innerHTML=`<a href="#" onclick="document.getElementById('loginCard').classList.add('visible')">Login</a>`; document.getElementById("loginCard").classList.add("visible"); } }
document.getElementById("loginBtn").onclick=async()=>{try{await apiFetch("/api/login",{method:"POST",body:JSON.stringify({username:document.getElementById("loginUsername").value,password:document.getElementById("loginPassword").value})});location.reload();}catch{document.getElementById("loginError").textContent="Invalid";}};

// TABS
document.querySelectorAll(".tab").forEach(t=>t.addEventListener("click",()=>{if(!t.classList.contains("hidden")){document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));document.querySelectorAll(".tab-content").forEach(d=>d.classList.add("hidden"));t.classList.add("active");document.getElementById(`tab-${t.dataset.tab}`).classList.remove("hidden");}}));
// Start
(async function(){ await refreshSession(); await afterDataLoad(); })();
</script>
</body>
</html>
