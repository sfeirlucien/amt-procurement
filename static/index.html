<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AMT Procurement</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="static/ICON.jpg">
  <script src="[https://cdn.jsdelivr.net/npm/chart.js](https://cdn.jsdelivr.net/npm/chart.js)"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f5f5f5; }
    header { background:#1f2937; color:#fff; padding:10px 16px; display:flex; justify-content:space-between; align-items:center; }
    header h1 { margin:0; font-size:20px; }
    header .user-info { font-size:14px; display:flex; align-items:center; gap:8px;}
    .tabs { display:flex; background:#111827; flex-wrap:wrap; }
    .tab { padding:10px 16px; color:#9ca3af; cursor:pointer; font-size:14px; user-select:none; }
    .tab.active { background:#1f2937; color:#fff; }
    .container { padding:16px; max-width:1200px; margin:0 auto; }
    .card { background:#fff; padding:16px; margin-bottom:16px; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
    
    /* Header with controls */
    .card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; flex-wrap:wrap; gap:10px; }
    .card h2 { margin:0; font-size:18px; }
    .sort-controls { display:flex; gap:5px; align-items:center; }
    .sort-select { padding:4px; font-size:12px; border:1px solid #ccc; border-radius:4px; }

    .flex-row { display:flex; gap:16px; flex-wrap:wrap; }
    .flex-1 { flex:1 1 0; min-width:200px; }
    
    /* Custom percentage widths for Landed Form (Desktop) */
    /* Mobile First: All 100% by default */
    .w-25, .w-50, .w-20 { flex: 1 1 100%; }

    /* Desktop: Apply specific percentages only when screen is wide enough */
    @media (min-width: 768px) {
        .w-25 { flex: 0 0 calc(25% - 12px); max-width: calc(25% - 12px); }
        .w-50 { flex: 0 0 calc(50% - 12px); max-width: calc(50% - 12px); }
        .w-20 { flex: 0 0 calc(20% - 12.8px); max-width: calc(20% - 12.8px); }
    }
    
    label { display:block; font-size:13px; margin-bottom:6px; }
    input, select { width:100%; padding:6px 8px; margin-top:2px; box-sizing:border-box; font-size:13px; }
    button { padding:6px 10px; font-size:13px; border-radius:4px; border:none; cursor:pointer; background:#2563eb; color:#fff; }
    button.secondary { background:#6b7280; }
    button.danger { background:#b91c1c; }
    button:disabled { opacity: 0.6; cursor:not-allowed; }
    
    table { width:100%; border-collapse:collapse; font-size:13px; }
    th, td { border:1px solid #e5e7eb; padding:6px 8px; text-align:left; }
    th { background:#f3f4f6; }
    .tag { display:inline-block; padding:2px 6px; border-radius:999px; font-size:11px; }
    .tag.green { background:#dcfce7; color:#166534; }
    .tag.red { background:#fee2e2; color:#b91c1c; }
    .tag.gray { background:#e5e7eb; color:#374151; }
    .text-red-bold { color:#b91c1c; font-weight:bold; }
    .error { color:#b91c1c; font-size:12px; margin-top:4px; }
    .hidden { display:none; }
    #loginCard { max-width:320px; margin:12px auto; position:relative; z-index:10; }
    .summary-grid { display:flex; flex-wrap:wrap; gap:10px; }
    .summary-item { flex:1 1 180px; background:#f9fafb; padding:10px; border-radius:8px; border:1px solid #e5e7eb; font-size:13px; }
    .summary-label { color:#6b7280; font-size:12px; }
    .summary-value { font-size:18px; font-weight:bold; margin-top:4px; }
    .filter-row { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:8px; align-items:flex-end; }
    .filter-row > div { min-width:120px; flex:1 1 100px; }
    .status-pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; }
    .status-open { background:#eef2ff; color:#4f46e5; }
    .status-cancelled { background:#fee2e2; color:#b91c1c; }
    .status-delivered { background:#dcfce7; color:#166534; }
    .popup { position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#fff; border-radius:6px; box-shadow:0 10px 25px rgba(0,0,0,0.2); padding:16px; max-width:400px; width:90%; z-index:50; }
    #dirPopupBackdrop { position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:40; }
  </style>
</head>
<body>

<header>
  <div style="display:flex; align-items:center; gap:12px;">
    <img src="static/logo.png" alt="AMT Logo" style="height:40px; width:auto; border-radius:4px;">
    <h1>AMT Procurement</h1>
  </div>
  <div class="user-info" id="userInfo"></div>
</header>

<div id="loginCard" class="card hidden">
  <h2>Login</h2>
  <label>Username
    <input type="text" id="loginUsername" />
  </label>
  <label>Password
    <input type="password" id="loginPassword" />
  </label>
  <button id="loginBtn">Login</button>
  <div id="loginError" class="error"></div>
</div>

<div id="dirPopupBackdrop" class="hidden"></div>
<div id="dirPopup" class="popup hidden">
  <h3 id="dirPopupTitle">New entry</h3>
  <label>Name
    <input type="text" id="dirPopupName" />
  </label>
  <label>Email
    <input type="email" id="dirPopupEmail" />
  </label>
  <label>Phone
    <input type="text" id="dirPopupPhone" />
  </label>
  <label>Location / Address
    <input type="text" id="dirPopupAddress" />
  </label>
  <div id="dirPopupError" class="error"></div>
  <div style="margin-top:10px; text-align:right;">
    <button id="dirPopupCancelBtn" class="secondary">Cancel</button>
    <button id="dirPopupSaveBtn">Save</button>
  </div>
</div>

<div id="app">
  <div class="tabs">
    <div class="tab active" data-tab="overview">Overview</div>
    <div class="tab" data-tab="requisitions">Requisitions</div>
    <div class="tab" data-tab="landings">Landings</div>
    <div class="tab" data-tab="directory">Directory</div>
    <div class="tab" data-tab="delivered">Delivered</div>
    <div class="tab hidden" data-tab="admin" id="adminTab">Admin</div>
  </div>

  <div class="container tab-content">

    <!-- OVERVIEW -->
    <div id="tab-overview">
      <div class="card">
        <h2>Dashboard</h2>
        <div class="summary-grid">
          <div class="summary-item">
            <div class="summary-label">Open POs (not delivered)</div>
            <div class="summary-value" id="summaryOpenReqNotDel">0</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Open POs (unpaid)</div>
            <div class="summary-value" id="summaryOpenReqUnpaid">0</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Open Landed Items (not delivered)</div>
            <div class="summary-value" id="summaryOpenLandNotDel">0</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Open Landed Items (unpaid)</div>
            <div class="summary-value" id="summaryOpenLandUnpaid">0</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Paid Totals (Filters)</h2>
        <div class="filter-row">
          <div>
            <label>Type
              <select id="ovTypeFilter">
                <option value="">All</option>
                <option value="req">Orders (POs)</option>
                <option value="land">Workshops (Landed)</option>
              </select>
            </label>
          </div>
          <div>
            <label>Vessel
              <select id="ovVesselFilter">
                <option value="">All</option>
              </select>
            </label>
          </div>
          <div>
            <label>Paid?
              <select id="ovPaidFilter">
                <option value="">All</option>
                <option value="1">Paid</option>
                <option value="0">Unpaid</option>
              </select>
            </label>
          </div>
          <div>
            <label>Month
              <select id="ovMonthFilter">
                <option value="">All months</option>
              </select>
            </label>
          </div>
          <div>
            <label>Quarter
              <select id="ovQuarterFilter">
                <option value="">All quarters</option>
                <option value="Q1">Q1</option>
                <option value="Q2">Q2</option>
                <option value="Q3">Q3</option>
                <option value="Q4">Q4</option>
              </select>
            </label>
          </div>
          <div>
            <label>Category
              <select id="ovCategoryFilter">
                <option value="">All categories</option>
              </select>
            </label>
          </div>
          <div>
            <label>Year
              <select id="ovYearFilter">
                <option value="">All years</option>
              </select>
            </label>
          </div>
          <div style="align-self:flex-end;">
            <button id="ovApplyTotalsBtn">Apply</button>
            <button id="ovClearTotalsBtn" class="secondary">Clear</button>
          </div>
        </div>

        <div class="summary-grid" style="margin-top:10px;">
          <div class="summary-item">
            <div class="summary-label">Total Paid (Selected Period)</div>
            <div class="summary-value" id="ovPaidMonthTotal">0</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Total Paid (Selected Year)</div>
            <div class="summary-value" id="ovPaidYearTotal">0</div>
          </div>
          <!-- NEW UNPAID SECTION -->
          <div class="summary-item">
            <div class="summary-label" style="color:#b91c1c;">Total Unpaid (Selected Period)</div>
            <div class="summary-value" id="ovUnpaidMonthTotal">0</div>
          </div>
          <div class="summary-item">
            <div class="summary-label" style="color:#b91c1c;">Total Unpaid (Selected Year)</div>
            <div class="summary-value" id="ovUnpaidYearTotal">0</div>
          </div>
          
          <div class="summary-item">
            <div class="summary-label">Total Amount (Filter Result)</div>
            <div class="summary-value" id="ovAllTotal">0</div>
          </div>
        </div>

        <h3 style="margin-top:16px;">Top 5 Suppliers (Selected Period)</h3>
        <ul id="ovTopSuppliers" style="padding-left:18px; margin-top:6px;">
          <li>—</li>
        </ul>
      </div>

      <!-- RECENT ORDERS (SPLIT SORT) -->
      <div class="card">
        <div class="card-header">
          <h2>Recent Orders (POs)</h2>
          <div class="sort-controls">
            <select id="ovReqSortKey" class="sort-select">
              <option value="date_ordered">Date</option>
              <option value="amount">Amount</option>
              <option value="number">Req #</option>
              <option value="po_number">PO #</option>
              <option value="vessel">Vessel</option>
              <option value="supplier">Supplier</option>
            </select>
            <select id="ovReqSortDir" class="sort-select">
              <option value="desc">Desc</option>
              <option value="asc">Asc</option>
            </select>
          </div>
        </div>
        <table id="overviewReqTable">
          <thead>
            <tr>
              <th>PO #</th>
              <th>Number</th>
              <th>Description</th><th>Vessel</th><th>Category</th><th>Supplier</th>
              <th>Ordered</th><th>Urgency</th><th>Amount (USD)</th><th>Paid</th><th>Delivered</th><th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      
      <!-- RECENT LANDED (SPLIT SORT) -->
      <div class="card">
        <div class="card-header">
            <h2>Recent Landed Items</h2>
            <div class="sort-controls">
                <select id="ovLandSortKey" class="sort-select">
                  <option value="landed_date">Date Landed</option>
                  <option value="amount">Amount</option>
                  <option value="vessel">Vessel</option>
                  <option value="workshop">Workshop</option>
                </select>
                <select id="ovLandSortDir" class="sort-select">
                  <option value="desc">Desc</option>
                  <option value="asc">Asc</option>
                </select>
            </div>
        </div>
        <table id="overviewLandTable">
          <thead>
            <tr>
              <th>Vessel</th><th>Description</th><th>Workshop</th>
              <th>Expected</th><th>Landed</th><th>Amount (USD)</th>
              <th>Paid</th><th>Delivered</th><th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- REQUISITIONS -->
    <div id="tab-requisitions" class="hidden">
      <div class="card">
        <h2 id="reqFormTitle">Add Ordered Requisition</h2>
        
        <!-- LINE 1: PO Number, Req Number, Description, Vessel -->
        <div class="flex-row">
          <div class="flex-1">
             <label>PO Number
               <input type="text" id="reqPONumber" placeholder="PO-XXXX" />
             </label>
          </div>
          <div class="flex-1">
            <label>Requisition Number
              <input type="text" id="reqNumber" />
            </label>
          </div>
          <div class="flex-1">
            <label>Description
              <input type="text" id="reqDescription" placeholder="Short description" />
            </label>
          </div>
          <div class="flex-1">
            <label>Vessel
              <select id="reqVessel"></select>
            </label>
          </div>
        </div>

        <!-- LINE 2: Category, Supplier, Date Ordered, Expected -->
        <div class="flex-row" style="margin-top:10px;">
           <div class="flex-1">
            <label>Category
              <select id="reqCategory"></select>
            </label>
          </div>
          <div class="flex-1">
            <label>Supplier
              <div style="display:flex; gap:8px;">
                <select id="reqSupplierSelect" style="flex:1;"></select>
                <button id="newSupplierBtn" type="button">New</button>
              </div>
            </label>
          </div>
          <div class="flex-1">
            <label>Date Ordered
              <input type="date" id="reqDateOrdered" />
            </label>
          </div>
          <div class="flex-1">
            <label>Expected Date
              <input type="date" id="reqExpected" />
            </label>
          </div>
        </div>

        <!-- LINE 3: Amount, Currency, Urgency, Paid -->
        <div class="flex-row" style="margin-top:10px;">
          <div class="flex-1">
            <label>Amount
              <input type="number" id="reqTotal" step="0.01" />
            </label>
          </div>
          <div class="flex-1">
            <label>Currency
              <select id="reqCurrency"></select>
            </label>
          </div>
          <div class="flex-1">
            <label>Urgency
              <select id="reqUrgency">
                <option value="normal">Normal</option>
                <option value="low">Low</option>
                <option value="high">High</option>
              </select>
            </label>
          </div>
          <div class="flex-1">
            <label style="margin-top:20px;">
              <input type="checkbox" id="reqPaid" /> Paid
            </label>
          </div>
        </div>

        <div style="margin-top:16px;">
          <button id="saveReqBtn">Save Order</button>
          <button id="cancelReqEditBtn" class="secondary hidden" type="button">Cancel Edit</button>
        </div>
        <div id="reqError" class="error"></div>
      </div>

      <div class="card">
        <h2>Filter Orders</h2>
        <div class="filter-row">
          <div>
            <label>Status
              <select id="filterReqStatus">
                <option value="">All</option>
                <option value="open">Open</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </label>
          </div>
          <div>
            <label>Paid
              <select id="filterReqPaid">
                <option value="">All</option>
                <option value="1">Paid</option>
                <option value="0">Unpaid</option>
              </select>
            </label>
          </div>
          <div>
            <label>Delivered
              <select id="filterReqDelivered">
                <option value="">All</option>
                <option value="1">Delivered</option>
                <option value="0">Not delivered</option>
              </select>
            </label>
          </div>
          <div>
            <label>Search (number / vessel / supplier)
              <input type="text" id="filterReqSearch" placeholder="Search..." />
            </label>
          </div>
          
          <!-- SPLIT SORT FOR ALL ORDERS -->
          <div>
            <label>Sort By
              <select id="filterReqSortKey">
                <option value="date_ordered">Date</option>
                <option value="amount">Amount</option>
                <option value="number">Req #</option>
                <option value="po_number">PO #</option>
                <option value="vessel">Vessel</option>
                <option value="supplier">Supplier</option>
              </select>
            </label>
          </div>
          <div>
            <label>Order
              <select id="filterReqSortDir">
                <option value="desc">Desc</option>
                <option value="asc">Asc</option>
              </select>
            </label>
          </div>

          <div style="align-self:flex-end;">
            <button id="applyReqFilterBtn">Apply</button>
            <button id="clearReqFilterBtn" class="secondary" type="button">Clear</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>All Orders</h2>
        <table id="reqTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>PO #</th>
              <th>Number</th>
              <th>Description</th><th>Vessel</th><th>Category</th><th>Supplier</th>
              <th>Ordered</th><th>Expected</th><th>Urgency</th><th>Amount (USD)</th>
              <th>Paid</th><th>Delivered</th><th>Status</th><th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <h2>Cancelled / Deleted Requisitions</h2>
        <table id="reqCancelledTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>PO #</th>
              <th>Number</th>
              <th>Description</th><th>Vessel</th><th>Category</th><th>Supplier</th>
              <th>Ordered</th><th>Expected</th><th>Amount (USD)</th><th>Paid</th><th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- LANDINGS -->
    <div id="tab-landings" class="hidden">
      <div class="card">
        <h2 id="landFormTitle">Add Landed Item</h2>
        
        <!-- LINE 1: Vessel 25%, Workshop 25%, Description 50% -->
        <div class="flex-row">
          <div class="w-25">
            <label>Vessel
              <select id="landVessel"></select>
            </label>
          </div>
          <div class="w-25">
             <label>Workshop
              <div style="display:flex; gap:8px;">
                <select id="landWorkshopSelect" style="flex:1;"></select>
                <button id="newWorkshopBtn" type="button">New</button>
              </div>
            </label>
          </div>
          <div class="w-50">
            <label>Description
              <input type="text" id="landDescription" />
            </label>
          </div>
        </div>

        <!-- LINE 2: Expected 20%, Landed 20%, Amount 20%, Currency 20%, Paid 20% -->
        <div class="flex-row" style="margin-top:10px;">
          <div class="w-20">
            <label>Expected Delivery
              <input type="date" id="landExpected" />
            </label>
          </div>
          <div class="w-20">
            <label>Landed Date
              <input type="date" id="landLanded" />
            </label>
          </div>
           <div class="w-20">
            <label>Amount
              <input type="number" id="landAmount" step="0.01" />
            </label>
          </div>
          <div class="w-20">
            <label>Currency
              <select id="landCurrency"></select>
            </label>
          </div>
          <div class="w-20">
            <label style="margin-top:20px;">
              <input type="checkbox" id="landPaid" /> Paid
            </label>
          </div>
        </div>

        <div style="margin-top:16px;">
          <button id="saveLandingBtn">Save Landed Item</button>
          <button id="cancelLandEditBtn" class="secondary hidden" type="button">Cancel Edit</button>
        </div>
        <div id="landError" class="error"></div>
      </div>

      <div class="card">
        <h2>Filter Landed Items</h2>
        <div class="filter-row">
          <div>
            <label>Status
              <select id="filterLandingStatus">
                <option value="">All</option>
                <option value="open">Open</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </label>
          </div>
          <div>
            <label>Paid
              <select id="filterLandingPaid">
                <option value="">All</option>
                <option value="1">Paid</option>
                <option value="0">Unpaid</option>
              </select>
            </label>
          </div>
          <div>
            <label>Delivered
              <select id="filterLandingDelivered">
                <option value="">All</option>
                <option value="1">Delivered</option>
                <option value="0">Not delivered</option>
              </select>
            </label>
          </div>
          <div>
            <label>Search (vessel / desc / workshop)
              <input type="text" id="filterLandingSearch" placeholder="Search..." />
            </label>
          </div>
          
          <!-- SPLIT SORT FOR ALL LANDED -->
          <div>
            <label>Sort By
              <select id="filterLandingSortKey">
                <option value="landed_date">Date Landed</option>
                <option value="amount">Amount</option>
                <option value="vessel">Vessel</option>
                <option value="workshop">Workshop</option>
              </select>
            </label>
          </div>
          <div>
            <label>Order
              <select id="filterLandingSortDir">
                <option value="desc">Desc</option>
                <option value="asc">Asc</option>
              </select>
            </label>
          </div>

          <div style="align-self:flex-end;">
            <button id="applyLandingFilterBtn">Apply</button>
            <button id="clearLandingFilterBtn" class="secondary" type="button">Clear</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>All Landed Items</h2>
        <table id="landingTable">
          <thead>
            <tr>
              <th>ID</th><th>Vessel</th><th>Description</th><th>Workshop</th>
              <th>Expected</th><th>Landed Date</th><th>Amount (USD)</th>
              <th>Paid</th><th>Delivered</th><th>Status</th><th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <h2>Cancelled / Deleted Landed Items</h2>
        <table id="landingCancelledTable">
          <thead>
            <tr>
              <th>ID</th><th>Vessel</th><th>Description</th><th>Workshop</th>
              <th>Expected</th><th>Landed Date</th><th>Amount (USD)</th><th>Paid</th><th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- DIRECTORY -->
    <div id="tab-directory" class="hidden">
      <div class="card">
        <h2>Suppliers & Workshops</h2>
        <div style="margin-bottom:8px;">
          <button id="dirNewSupplierBtn">Add Supplier</button>
          <button id="dirNewWorkshopBtn" class="secondary" type="button">Add Workshop</button>
        </div>
        <table id="directoryTable">
          <thead>
            <tr><th>ID</th><th>Type</th><th>Name</th><th>Email</th><th>Phone</th><th>Address</th><th>Actions</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- DELIVERED -->
    <div id="tab-delivered" class="hidden">
      <div class="card">
        <h2>Delivered Requisitions</h2>
        <div class="filter-row">
          <div>
            <label>Paid
              <select id="filterDeliveredReqPaid">
                <option value="">All</option>
                <option value="1">Paid</option>
                <option value="0">Unpaid</option>
              </select>
            </label>
          </div>
          <div>
            <label>Search (number / vessel / supplier)
              <input type="text" id="filterDeliveredReqSearch" placeholder="Search..." />
            </label>
          </div>
          <div style="align-self:flex-end;">
            <button id="applyDeliveredReqFilterBtn">Apply</button>
            <button id="clearDeliveredReqFilterBtn" class="secondary" type="button">Clear</button>
          </div>
        </div>
        <table id="deliveredReqTable">
          <thead>
            <tr>
              <th>ID</th><th>PO #</th><th>Number</th>
            <th>Description</th><th>Vessel</th><th>Category</th><th>Supplier</th>
              <th>Ordered</th><th>Expected</th><th>Amount (USD)</th><th>Paid</th><th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <h2>Delivered Landed Items</h2>
        <div class="filter-row">
          <div>
            <label>Paid
              <select id="filterDeliveredLandPaid">
                <option value="">All</option>
                <option value="1">Paid</option>
                <option value="0">Unpaid</option>
              </select>
            </label>
          </div>
          <div>
            <label>Search (vessel / description / workshop)
              <input type="text" id="filterDeliveredLandSearch" placeholder="Search..." />
            </label>
          </div>
          <div style="align-self:flex-end;">
            <button id="applyDeliveredLandFilterBtn">Apply</button>
            <button id="clearDeliveredLandFilterBtn" class="secondary" type="button">Clear</button>
          </div>
        </div>
        <table id="deliveredLandTable">
          <thead>
            <tr>
              <th>ID</th><th>Vessel</th><th>Description</th><th>Workshop</th>
              <th>Expected</th><th>Landed Date</th><th>Amount (USD)</th><th>Paid</th><th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- ADMIN -->
    <div id="tab-admin" class="hidden">
      <div class="card">
        <h2>Categories</h2>
        <div class="flex-row">
          <div class="flex-1">
            <label>Category Name
              <input type="text" id="catName" />
            </label>
          </div>
          <div class="flex-1">
            <label>Abbreviation
              <input type="text" id="catAbbr" />
            </label>
          </div>
        </div>
        <div style="margin-top:8px;">
          <button id="addCatBtn">Save Category</button>
          <button id="cancelCatEditBtn" class="secondary hidden" type="button">Cancel Edit</button>
        </div>
        <div class="error" id="catError"></div>
        <table id="catTable" style="margin-top:10px;">
          <thead><tr><th>ID</th><th>Name</th><th>Abbreviation</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <h2>Vessels</h2>
        <div class="flex-row">
          <div class="flex-1">
            <label>Vessel Name
              <input type="text" id="vesselName" />
            </label>
          </div>
        </div>
        <div style="margin-top:8px;">
          <button id="addVesselBtn">Save Vessel</button>
          <button id="cancelVesselEditBtn" class="secondary hidden" type="button">Cancel Edit</button>
        </div>
        <div class="error" id="vesselError"></div>
        <table id="vesselTable" style="margin-top:10px;">
          <thead><tr><th>ID</th><th>Name</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <h2>Users</h2>
        <div class="flex-row">
          <div class="flex-1">
            <label>Username
              <input type="text" id="adminUsername"/>
            </label>
          </div>
          <div class="flex-1">
            <label>Password
              <input type="password" id="adminPassword"/>
            </label>
          </div>
          <div class="flex-1">
            <label>Role
              <select id="adminRole">
                <option value="user">User</option>
                <option value="admin">Admin</option>
                <option value="viewer">Viewer</option>
                <option value="finance">Finance</option>
              </select>
            </label>
          </div>
        </div>
        <div style="margin-top:8px;">
          <button id="saveUserBtn">Save User</button>
        </div>
        <div id="adminUserError" class="error"></div>
        <table id="userTable" style="margin-top:10px;">
          <thead><tr><th>Username</th><th>Role</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card" id="backupCard">
        <h2>Backups</h2>

        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
          <button id="downloadBackupBtn">Download Backup</button>

          <label style="display:flex; align-items:center; gap:8px;">
            <input type="file" id="uploadBackupInput" accept=".xlsx" style="width:auto;" />
            <button id="uploadBackupBtn" class="secondary" type="button">Upload .xlsx (Overwrite)</button>
          </label>
        </div>

        <div id="backupError" class="error"></div>

        <table id="backupTable" style="margin-top:10px;">
          <thead>
            <tr><th>Name</th><th>Created</th><th>Size (KB)</th><th>Actions</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </div>

  </div>
</div>

<script>
/* ========= Helpers ========= */
async function apiFetch(url, options = {}) {
  const res = await fetch(url, {
    headers: { "Content-Type": "application/json" },
    credentials: "same-origin",
    ...options
  });
  if (!res.ok) {
    let err;
    try { err = await res.json(); } catch { err = { error: "unknown" }; }
    throw err;
  }
  return res.json();
}

let currentUser = null;
let allReqs = [];
let allLandings = [];
let vessels = [];
let editingReqId = null;
let editingLandId = null;
let editingCatId = null;
let editingVesselId = null;
let dirPopupType = null;
let currencyList = ["USD"];

function quarterOfMonth(m){
  if (m <= 3) return "Q1";
  if (m <= 6) return "Q2";
  if (m <= 9) return "Q3";
  return "Q4";
}
function parseDateSafe(d) {
  if (!d) return null;
  const dt = new Date(d);
  return isNaN(dt.getTime()) ? null : dt;
}

// GENERIC SORTER for any key + asc/desc
function sortGeneric(list, key, dir) {
  const sorted = list.slice();
  sorted.sort((a,b) => {
    let valA = a[key];
    let valB = b[key];
    
    // special handling for amount_usd alias
    if(key === "amount") { valA = a.amount_usd||0; valB = b.amount_usd||0; }
    
    // special handling for dates
    if(key.includes("date") || key==="expected") {
        valA = parseDateSafe(valA) || new Date(0);
        valB = parseDateSafe(valB) || new Date(0);
    } else {
        // Strings case insensitive
        if(typeof valA === "string") valA = valA.toLowerCase();
        if(typeof valB === "string") valB = valB.toLowerCase();
    }
    
    if (valA < valB) return dir === "asc" ? -1 : 1;
    if (valA > valB) return dir === "asc" ? 1 : -1;
    return 0;
  });
  return sorted;
}

/* ========= Currencies ========= */
async function loadCurrencies() {
  try {
    const res = await apiFetch("/api/currencies");
    currencyList = res.currencies || ["USD"];
  } catch (e) {
    console.warn("FX error, fallback to defaults", e);
    currencyList = ["USD","EUR","AED","GBP","LBP"];
  }
  const reqCurSel = document.getElementById("reqCurrency");
  const landCurSel = document.getElementById("landCurrency");
  reqCurSel.innerHTML = ""; landCurSel.innerHTML = "";
  currencyList.forEach(cur => {
    const o1 = document.createElement("option"); o1.value = cur; o1.textContent = cur; reqCurSel.appendChild(o1);
    const o2 = document.createElement("option"); o2.value = cur; o2.textContent = cur; landCurSel.appendChild(o2);
  });
  if (!reqCurSel.value) reqCurSel.value = "USD";
  if (!landCurSel.value) landCurSel.value = "USD";
}

/* ========= Session / Header / Login ========= */
async function refreshSession() {
  try {
    currentUser = await apiFetch("/api/session");
  } catch {
    currentUser = null;
  }

  const userInfo = document.getElementById("userInfo");
  const loginCard = document.getElementById("loginCard");

  if (currentUser && currentUser.username) {
    userInfo.innerHTML = `
      Logged in as <strong>${currentUser.username}</strong> (${currentUser.role})
      <button id="logoutBtn">Logout</button>
    `;
    document.getElementById("logoutBtn").onclick = async () => {
      await apiFetch("/api/logout", { method:"POST" });
      currentUser = null;
      loginCard.classList.add("hidden");
      await refreshSession();
      await afterDataLoad();
    };
    loginCard.classList.add("hidden");
  } else {
    userInfo.innerHTML = `
      Not logged in
      <button id="showLoginBtn">Login</button>
    `;
    document.getElementById("showLoginBtn").onclick = () => {
      loginCard.classList.toggle("hidden");
    };
  }

  // Show/hide Admin tab
  const isAdmin = currentUser && currentUser.role === "admin";
  const adminTab = document.getElementById("adminTab");
  if (adminTab) {
    if (isAdmin) adminTab.classList.remove("hidden");
    else adminTab.classList.add("hidden");
  }

  // Disable admin-only inputs for non-admin
  ["catName","catAbbr","addCatBtn","cancelCatEditBtn",
   "adminUsername","adminPassword","adminRole","saveUserBtn",
   "vesselName","addVesselBtn","cancelVesselEditBtn"].forEach(id=>{
    const el = document.getElementById(id);
    if (el) el.disabled = !isAdmin && (id!=="adminRole");
  });
}

document.getElementById("loginBtn").onclick = async () => {
  const u = document.getElementById("loginUsername").value.trim();
  const p = document.getElementById("loginPassword").value;
  const errDiv = document.getElementById("loginError");
  errDiv.textContent = "";
  try {
    await apiFetch("/api/login", {
      method:"POST",
      body: JSON.stringify({ username:u, password:p })
    });
    document.getElementById("loginCard").classList.add("hidden");
    document.getElementById("loginUsername").value = "";
    document.getElementById("loginPassword").value = "";
    await refreshSession();
    await afterDataLoad(true);
  } catch(e) {
    if (e.error === "invalid_credentials") errDiv.textContent = "Invalid username or password.";
    else errDiv.textContent = "Login failed.";
  }
};

/* ========= Tabs ========= */
document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    if (tab.classList.contains("hidden")) return;
    const t = tab.dataset.tab;
    document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
    document.querySelectorAll("[id^='tab-']").forEach(div => div.classList.add("hidden"));
    tab.classList.add("active");
    document.getElementById(`tab-${t}`).classList.remove("hidden");
  });
});

/* ========= Overview Totals Filters ========= */
async function loadOverviewTotalsFilters() {
  let reqs = allReqs, lands = allLandings;
  if (!reqs.length) { try { reqs = await apiFetch("/api/requisitions"); } catch { reqs=[]; } }
  if (!lands.length) { try { lands = await apiFetch("/api/landings"); } catch { lands=[]; } }

  // Month dropdown 1..12
  const monthSel = document.getElementById("ovMonthFilter");
  monthSel.innerHTML = `<option value="">All months</option>` +
    Array.from({length:12},(_,i)=>`<option value="${i+1}">${i+1}</option>`).join("");

  // Categories
  const cats = new Set();
  reqs.forEach(r => cats.add((r.category || "").trim()));
  lands.forEach(r => cats.add((r.category || "").trim()));
  const catSel = document.getElementById("ovCategoryFilter");
  catSel.innerHTML = `<option value="">All categories</option>` +
    [...cats].filter(Boolean).sort().map(c=>`<option value="${c}">${c}</option>`).join("");

  // Vessels
  const vset = new Set();
  reqs.forEach(r => vset.add((r.vessel || "").trim()));
  lands.forEach(r => vset.add((r.vessel || "").trim()));
  const vesselSel = document.getElementById("ovVesselFilter");
  vesselSel.innerHTML = `<option value="">All</option>` +
    [...vset].filter(Boolean).sort().map(v=>`<option value="${v}">${v}</option>`).join("");

  // Years
  const years = new Set();
  reqs.forEach(r => { const dt=parseDateSafe(r.date_ordered); if (dt) years.add(dt.getFullYear()); });
  lands.forEach(r => { const dt=parseDateSafe(r.landed_date); if (dt) years.add(dt.getFullYear()); });
  const yearSel = document.getElementById("ovYearFilter");
  yearSel.innerHTML = `<option value="">All years</option>` +
    [...years].sort((a,b)=>b-a).map(y=>`<option value="${y}">${y}</option>`).join("");

  updateOverviewPaidTotals(reqs, lands);
}

function updateOverviewPaidTotals(reqs, lands) {
  const typeF = document.getElementById("ovTypeFilter").value;
  const vesselF = document.getElementById("ovVesselFilter").value;
  const paidF = document.getElementById("ovPaidFilter").value;
  const monthF = document.getElementById("ovMonthFilter").value;
  const yearF = document.getElementById("ovYearFilter").value;
  const quarterF = document.getElementById("ovQuarterFilter").value;
  const categoryF = document.getElementById("ovCategoryFilter").value;

  let filtered = [];
  if (!typeF || typeF==="req") filtered = filtered.concat(reqs.map(r=>({
    _type:"req", vessel:r.vessel, category:r.category, supplier:r.supplier,
    paid:Number(r.paid||0), amount:Number(r.total_amount||0), date:r.date_ordered
  })));
  if (!typeF || typeF==="land") filtered = filtered.concat(lands.map(r=>({
    _type:"land", vessel:r.vessel, category:r.category, supplier:r.supplier||r.workshop,
    paid:Number(r.paid||0), amount:Number(r.amount||0), date:r.landed_date
  })));

  filtered = filtered.filter(x=>{
    if (vesselF && (x.vessel||"")!==vesselF) return false;
    if (paidF!=="" && String(x.paid)!==paidF) return false;
    const dt=parseDateSafe(x.date); if(!dt) return false;
    const mm=dt.getMonth()+1, yy=dt.getFullYear(), qq=quarterOfMonth(mm);
    if (yearF && String(yy)!==yearF) return false;
    if (monthF) { if(String(mm)!==monthF) return false; }
    else if (quarterF) { if(qq!==quarterF) return false; }
    if (categoryF && (x.category||"")!==categoryF) return false;
    return true;
  });

  const allTotal = filtered.reduce((s,x)=>s+x.amount,0);
  
  // Paid Math
  const paidOnly = filtered.filter(x=>x.paid===1);
  const paidMonthTotal = paidOnly.reduce((s,x)=>s+x.amount,0);
  let paidYearTotal = 0;
  if (yearF) {
    paidYearTotal = paidOnly.filter(x=>{
      const dt=parseDateSafe(x.date);
      return dt && String(dt.getFullYear())===yearF;
    }).reduce((s,x)=>s+x.amount,0);
  } else {
    paidYearTotal = paidMonthTotal;
  }

  // Unpaid Math (New)
  const unpaidOnly = filtered.filter(x=>x.paid===0);
  const unpaidMonthTotal = unpaidOnly.reduce((s,x)=>s+x.amount,0);
  let unpaidYearTotal = 0;
  if (yearF) {
    unpaidYearTotal = unpaidOnly.filter(x=>{
      const dt=parseDateSafe(x.date);
      return dt && String(dt.getFullYear())===yearF;
    }).reduce((s,x)=>s+x.amount,0);
  } else {
    unpaidYearTotal = unpaidMonthTotal;
  }

  document.getElementById("ovAllTotal").textContent = allTotal.toFixed(2);
  document.getElementById("ovPaidMonthTotal").textContent = paidMonthTotal.toFixed(2);
  document.getElementById("ovPaidYearTotal").textContent = paidYearTotal.toFixed(2);
  // Set new unpaid fields
  document.getElementById("ovUnpaidMonthTotal").textContent = unpaidMonthTotal.toFixed(2);
  document.getElementById("ovUnpaidYearTotal").textContent = unpaidYearTotal.toFixed(2);

  // Top suppliers
  const supMap = {};
  filtered.forEach(x=>{
    const sname=x.supplier||"Unknown";
    supMap[sname]=(supMap[sname]||0)+x.amount;
  });
  const topSup = Object.entries(supMap).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const ul=document.getElementById("ovTopSuppliers");
  ul.innerHTML = topSup.length ? topSup.map(([k,v])=>`<li>${k}: $${v.toFixed(2)}</li>`).join("") : "<li>—</li>";
}

document.getElementById("ovApplyTotalsBtn").onclick = async () => {
  let reqs = allReqs, lands = allLandings;
  if (!reqs.length) { try { reqs = await apiFetch("/api/requisitions"); } catch { reqs=[]; } }
  if (!lands.length) { try { lands = await apiFetch("/api/landings"); } catch { lands=[]; } }
  updateOverviewPaidTotals(reqs, lands);
};
document.getElementById("ovClearTotalsBtn").onclick = async () => {
  ["ovTypeFilter","ovVesselFilter","ovPaidFilter","ovMonthFilter","ovYearFilter","ovQuarterFilter","ovCategoryFilter"].forEach(id=>{
    document.getElementById(id).value="";
  });
  await loadOverviewTotalsFilters();
};

/* ========= Directory Options / Popup / Page ========= */
async function loadDirectoryOptions() {
  let suppliers=[], workshops=[];
  try { suppliers=await apiFetch("/api/directory?type=supplier"); } catch {}
  try { workshops=await apiFetch("/api/directory?type=workshop"); } catch {}
  const supSel=document.getElementById("reqSupplierSelect");
  const workSel=document.getElementById("landWorkshopSelect");
  supSel.innerHTML='<option value="">Select supplier</option>';
  workSel.innerHTML='<option value="">Select workshop</option>';
  suppliers.forEach(s=>{ const o=document.createElement("option"); o.value=s.name; o.textContent=s.name; supSel.appendChild(o); });
  workshops.forEach(w=>{ const o=document.createElement("option"); o.value=w.name; o.textContent=w.name; workSel.appendChild(o); });
}

function openDirPopup(type){
  dirPopupType=type;
  document.getElementById("dirPopupTitle").textContent=type==="supplier"?"New Supplier":"New Workshop";
  ["dirPopupName","dirPopupEmail","dirPopupPhone","dirPopupAddress"].forEach(id=>document.getElementById(id).value="");
  document.getElementById("dirPopupError").textContent="";
  document.getElementById("dirPopupBackdrop").classList.remove("hidden");
  document.getElementById("dirPopup").classList.remove("hidden");
  delete document.getElementById("dirPopup").dataset.editId; // Ensure not in edit mode
}
function closeDirPopup(){
  document.getElementById("dirPopupBackdrop").classList.add("hidden");
  document.getElementById("dirPopup").classList.add("hidden");
}
document.getElementById("dirPopupCancelBtn").onclick=closeDirPopup;

document.getElementById("dirPopupSaveBtn").onclick=async ()=>{
  const name=document.getElementById("dirPopupName").value.trim();
  const email=document.getElementById("dirPopupEmail").value.trim();
  const phone=document.getElementById("dirPopupPhone").value.trim();
  const address=document.getElementById("dirPopupAddress").value.trim();
  const editId = document.getElementById("dirPopup").dataset.editId; // Check if editing
  
  const err=document.getElementById("dirPopupError");
  err.textContent="";
  if(!dirPopupType){ err.textContent="Unknown type."; return; }
  if(!name){ err.textContent="Name is required."; return; }
  
  try{
    if(editId) {
        // Edit mode
        await apiFetch(`/api/directory/${editId}`, {
            method: "PATCH",
            body: JSON.stringify({type:dirPopupType, name, email, phone, address})
        });
        delete document.getElementById("dirPopup").dataset.editId; // clear edit mode
    } else {
        // Create mode
        await apiFetch("/api/directory/quick",{method:"POST",body:JSON.stringify({type:dirPopupType,name,email,phone,address})});
    }
    closeDirPopup();
    await loadDirectoryOptions();
    await loadDirectoryPage();
  }catch(e){ err.textContent=e.error==="login_required"?"You must be logged in.": "Error saving."; }
};

document.getElementById("newSupplierBtn").onclick=()=>openDirPopup("supplier");
document.getElementById("newWorkshopBtn").onclick=()=>openDirPopup("workshop");
document.getElementById("dirNewSupplierBtn").onclick=()=>openDirPopup("supplier");
document.getElementById("dirNewWorkshopBtn").onclick=()=>openDirPopup("workshop");

async function loadDirectoryPage(){
  let rows=[]; try{ rows=await apiFetch("/api/directory"); }catch{}
  const tbody=document.querySelector("#directoryTable tbody");
  tbody.innerHTML="";

  rows.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r.id}</td><td>${r.type}</td><td>${r.name}</td><td>${r.email||""}</td><td>${r.phone||""}</td><td>${r.address||""}</td>
    <td>
       <button class="secondary edit-dir" data-id="${r.id}" data-obj='${JSON.stringify(r).replace(/'/g, "&#39;")}'>Edit</button>
       <button class="danger delete-dir" data-id="${r.id}">Delete</button>
    </td>`;
    tbody.appendChild(tr);
  });

  // Attach handlers
  document.querySelectorAll(".delete-dir").forEach(btn=>{
    btn.onclick=async ()=>{
      const id=+btn.dataset.id;
      if(!confirm("Delete this directory entry?")) return;
      try {
        await apiFetch(`/api/directory/${id}`, {method:"DELETE"});
        await loadDirectoryPage(); 
        await loadDirectoryOptions(); // Refresh dropdowns too
      } catch(e) { 
        alert(e.error === "admin_required" ? "Only Admin can delete directory items." : "Error deleting."); 
      }
    };
  });
  
  document.querySelectorAll(".edit-dir").forEach(btn=>{
    btn.onclick=()=>{
      // Reuse the popup for editing
      const r = JSON.parse(btn.dataset.obj);
      openDirPopup(r.type); // Set type
      document.getElementById("dirPopupTitle").textContent = "Edit " + r.type;
      document.getElementById("dirPopupName").value = r.name;
      document.getElementById("dirPopupEmail").value = r.email||"";
      document.getElementById("dirPopupPhone").value = r.phone||"";
      document.getElementById("dirPopupAddress").value = r.address||"";
      
      // Mark as edit mode
      document.getElementById("dirPopup").dataset.editId = r.id;
    };
  });
}

/* ========= Vessels ========= */
async function loadVessels(){
  try { vessels=await apiFetch("/api/vessels"); } catch { vessels=[]; }
  const reqSel=document.getElementById("reqVessel");
  const landSel=document.getElementById("landVessel");
  if(reqSel){
    const cur=reqSel.value;
    reqSel.innerHTML='<option value="">Select vessel</option>';
    vessels.forEach(v=>{ const o=document.createElement("option"); o.value=v.name; o.textContent=v.name; reqSel.appendChild(o); });
    if(cur) reqSel.value=cur;
  }
  if(landSel){
    const cur=landSel.value;
    landSel.innerHTML='<option value="">Select vessel</option>';
    vessels.forEach(v=>{ const o=document.createElement("option"); o.value=v.name; o.textContent=v.name; landSel.appendChild(o); });
    if(cur) landSel.value=cur;
  }
  // admin table
  const tbody=document.querySelector("#vesselTable tbody");
  if(!tbody) return;
  tbody.innerHTML="";
  vessels.forEach(v=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${v.id}</td><td>${v.name}</td>
      <td>
        <button class="edit-vessel" data-id="${v.id}">Edit</button>
        <button class="danger delete-vessel" data-id="${v.id}">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });

  document.querySelectorAll(".edit-vessel").forEach(btn=>{
    btn.onclick=()=>{
      const id=+btn.dataset.id;
      const v=vessels.find(x=>x.id===id);
      if(!v) return;
      editingVesselId=id;
      document.getElementById("vesselName").value=v.name;
      document.getElementById("cancelVesselEditBtn").classList.remove("hidden");
    };
  });
  document.querySelectorAll(".delete-vessel").forEach(btn=>{
    btn.onclick=async ()=>{
      const id=+btn.dataset.id;
      if(!confirm("Delete this vessel?")) return;
      try{ await apiFetch(`/api/vessels/${id}`,{method:"DELETE"}); await loadVessels(); }catch{ alert("Error deleting vessel."); }
    };
  });
}

document.getElementById("addVesselBtn").onclick=async ()=>{
  const name=document.getElementById("vesselName").value.trim();
  const err=document.getElementById("vesselError");
  err.textContent="";
  if(!name){ err.textContent="Vessel name required."; return; }
  try{
    if(editingVesselId){
      await apiFetch(`/api/vessels/${editingVesselId}`,{method:"PATCH",body:JSON.stringify({name})});
    }else{
      await apiFetch("/api/vessels",{method:"POST",body:JSON.stringify({name})});
    }
    editingVesselId=null;
    document.getElementById("vesselName").value="";
    document.getElementById("cancelVesselEditBtn").classList.add("hidden");
    await loadVessels();
  }catch(e){
    if(e.error==="duplicate_name") err.textContent="This vessel already exists.";
    else if(e.error==="admin_required") err.textContent="Only admin can manage vessels.";
    else err.textContent="Error saving vessel.";
  }
};
document.getElementById("cancelVesselEditBtn").onclick=()=>{
  editingVesselId=null;
  document.getElementById("vesselName").value="";
  document.getElementById("cancelVesselEditBtn").classList.add("hidden");
};

/* ========= Categories ========= */
async function loadCategories(){
  let cats=[]; try{ cats=await apiFetch("/api/categories"); }catch{}
  const catSelect=document.getElementById("reqCategory");
  if(catSelect){
    catSelect.innerHTML='<option value="">Select category</option>';
    cats.forEach(c=>{ const o=document.createElement("option"); o.value=c.abbr; o.textContent=`${c.abbr} - ${c.name}`; catSelect.appendChild(o); });
  }
  const tbody=document.querySelector("#catTable tbody");
  tbody.innerHTML="";
  cats.forEach(c=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${c.id}</td><td>${c.name}</td><td>${c.abbr}</td>
      <td><button class="edit-cat" data-id="${c.id}">Edit</button>
          <button class="danger delete-cat" data-id="${c.id}">Delete</button></td>`;
    tbody.appendChild(tr);
  });
  document.querySelectorAll(".edit-cat").forEach(btn=>{
    btn.onclick=()=>{
      const id=+btn.dataset.id;
      const cat=cats.find(x=>x.id===id);
      if(!cat) return;
      editingCatId=id;
      document.getElementById("catName").value=cat.name;
      document.getElementById("catAbbr").value=cat.abbr;
      document.getElementById("cancelCatEditBtn").classList.remove("hidden");
    };
  });
  document.querySelectorAll(".delete-cat").forEach(btn=>{
    btn.onclick=async ()=>{
      const id=+btn.dataset.id;
      if(!confirm("Delete this category?")) return;
      try{ await apiFetch(`/api/categories/${id}`,{method:"DELETE"}); await loadCategories(); }catch{ alert("Error deleting category."); }
    };
  });
}
document.getElementById("addCatBtn").onclick=async ()=>{
  const name=document.getElementById("catName").value.trim();
  const abbr=document.getElementById("catAbbr").value.trim();
  const err=document.getElementById("catError"); err.textContent="";
  if(!name||!abbr){ err.textContent="Name and abbreviation are required."; return; }
  try{
    if(editingCatId){
      await apiFetch(`/api/categories/${editingCatId}`,{method:"PATCH",body:JSON.stringify({name,abbr})});
    }else{
      await apiFetch("/api/categories",{method:"POST",body:JSON.stringify({name,abbr})});
    }
    editingCatId=null;
    document.getElementById("catName").value="";
    document.getElementById("catAbbr").value="";
    document.getElementById("cancelCatEditBtn").classList.add("hidden");
    await loadCategories(); await loadOverviewTotalsFilters();
  }catch(e){
    if(e.error==="duplicate_abbr") err.textContent="Abbreviation already exists.";
    else if(e.error==="admin_required") err.textContent="Only admin can manage categories.";
    else err.textContent="Error saving category.";
  }
};
document.getElementById("cancelCatEditBtn").onclick=()=>{
  editingCatId=null;
  document.getElementById("catName").value="";
  document.getElementById("catAbbr").value="";
  document.getElementById("cancelCatEditBtn").classList.add("hidden");
};

/* ========= Users ========= */
async function loadUsersAdmin(){
  let users=[]; try{ users=await apiFetch("/api/users"); }catch{}
  const tbody=document.querySelector("#userTable tbody"); tbody.innerHTML="";
  users.forEach(u=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${u.username}</td><td>${u.role}</td>
      <td><button class="danger delete-user" data-username="${u.username}">Delete</button></td>`;
    tbody.appendChild(tr);
  });
  document.querySelectorAll(".delete-user").forEach(btn=>{
    btn.onclick=async ()=>{
      const username=btn.dataset.username;
      if(!confirm(`Delete user "${username}"?`)) return;
      try{ await apiFetch(`/api/users/${username}`,{method:"DELETE"}); await loadUsersAdmin(); }catch{ alert("Error deleting user.");}
    };
  });
}
document.getElementById("saveUserBtn").onclick=async ()=>{
  const username=document.getElementById("adminUsername").value.trim();
  const password=document.getElementById("adminPassword").value;
  const role=document.getElementById("adminRole").value;
  const err=document.getElementById("adminUserError"); err.textContent="";
  if(!username||!password){ err.textContent="Username and password are required."; return; }
  try{
    await apiFetch("/api/users",{method:"POST",body:JSON.stringify({username,password,role})});
    document.getElementById("adminUsername").value="";
    document.getElementById("adminPassword").value="";
    document.getElementById("adminRole").value="user";
    await loadUsersAdmin();
  }catch(e){
    if(e.error==="admin_required") err.textContent="Only admin can manage users.";
    else err.textContent="Error saving user.";
  }
};

/* ========= Requisitions ========= */
async function loadAllRequisitions(){
  let rows=[]; try{ rows=await apiFetch("/api/requisitions"); }catch{}
  allReqs=rows;
  const tbody=document.querySelector("#reqTable tbody"); tbody.innerHTML="";
  const statusFilter=document.getElementById("filterReqStatus").value;
  const paidFilter=document.getElementById("filterReqPaid").value;
  const delFilter=document.getElementById("filterReqDelivered").value;
  const search=document.getElementById("filterReqSearch").value.toLowerCase();
  
  // Sort params
  const sortKey = document.getElementById("filterReqSortKey").value;
  const sortDir = document.getElementById("filterReqSortDir").value;

  // Filter
  let filtered = rows.filter(r=>{
    const matchesStatus=!statusFilter||(r.status||"open")===statusFilter;
    const matchesPaid=paidFilter===""||String(r.paid||0)===paidFilter;
    const matchesDel=delFilter===""||String(r.delivered||0)===delFilter;
    const matchesSearch=!search||(r.number||"").toLowerCase().includes(search)||(r.vessel||"").toLowerCase().includes(search)||(r.supplier||"").toLowerCase().includes(search);
    return matchesStatus&&matchesPaid&&matchesDel&&matchesSearch;
  });

  // Sort
  filtered = sortGeneric(filtered, sortKey, sortDir);

  if(filtered.length === 0) {
      tbody.innerHTML = `<tr><td colspan="15" style="text-align:center; padding:12px; color:#666;">No records found.</td></tr>`;
      return;
  }

  const today = new Date();
  today.setHours(0,0,0,0); // Normalize today to midnight

  filtered.forEach(r=>{
    const tr=document.createElement("tr");
    const paidTag=r.paid?'<span class="tag green">Paid</span>':'<span class="tag red">Unpaid</span>';
    const delTag=r.delivered?'<span class="tag green">Delivered</span>':'<span class="tag gray">Open</span>';
    let statusClass="status-open";
    if((r.status||"open")==="cancelled") statusClass="status-cancelled";
    if(r.delivered) statusClass="status-delivered";

    // Urgency display
    const urgency = (r.urgency || "normal").toLowerCase();
    const urgDisplay = urgency==="high" ? `<span class="text-red-bold">High</span>` : (urgency.charAt(0).toUpperCase() + urgency.slice(1));

    // Overdue logic
    const expDate = parseDateSafe(r.expected);
    let overdueClass = "";
    // If expected exists, date is before today, NOT delivered, and NOT cancelled
    if(expDate && expDate < today && !r.delivered && (r.status||"open")!=="cancelled") {
        overdueClass = "text-red-bold";
    }
    const expDisplay = r.expected ? `<span class="${overdueClass}">${r.expected}</span>` : "";

    tr.innerHTML=`<td>${r.id}</td><td>${r.po_number||""}</td><td>${r.number}</td><td>${r.description || ""}</td><td>${r.vessel}</td><td>${r.category||""}</td><td>${r.supplier||""}</td>
      <td>${r.date_ordered||""}</td><td>${expDisplay}</td><td>${urgDisplay}</td>
      <td>${(r.total_amount||0).toFixed(2)}</td>
      <td>${paidTag}</td><td>${delTag}</td><td><span class="status-pill ${statusClass}">${r.status||"open"}</span></td>
      <td>
        <button class="edit-req" data-id="${r.id}">Edit</button>
        <button class="secondary copy-req" data-id="${r.id}">Copy</button>
        <button class="secondary toggle-paid-req" data-id="${r.id}">Paid</button>
        <button class="secondary mark-delivered-req" data-id="${r.id}">Delivered</button>
        <button class="danger cancel-req" data-id="${r.id}">Cancel</button>
        <button class="danger delete-req" data-id="${r.id}">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
  attachReqRowActions();
  
  // Update dashboard immediately
  await updateOverviewPaidTotals(allReqs, allLandings);
}

function attachReqRowActions(){
  document.querySelectorAll(".toggle-paid-req").forEach(btn=>{
    btn.onclick=async ()=>{
      const id=+btn.dataset.id;
      try{ 
          await apiFetch(`/api/requisitions/${id}/toggle_paid`,{method:"PATCH"}); 
          await afterDataLoad(); // This reloads all data and updates UI
      }
      catch{ alert("Error toggling paid."); }
    };
  });
  document.querySelectorAll(".mark-delivered-req").forEach(btn=>{
    btn.onclick=async ()=>{
      const id=+btn.dataset.id;
      try{ await apiFetch(`/api/requisitions/${id}`,{method:"PATCH",body:JSON.stringify({delivered:true})}); await afterDataLoad(); }
      catch{ alert("Error marking delivered."); }
    };
  });
  document.querySelectorAll(".cancel-req").forEach(btn=>{
    btn.onclick=async ()=>{
      const id=+btn.dataset.id;
      if(!confirm("Cancel this requisition?")) return;
      try{ await apiFetch(`/api/requisitions/${id}`,{method:"PATCH",body:JSON.stringify({status:"cancelled"})}); await afterDataLoad(); }
      catch{ alert("Error cancelling."); }
    };
  });
  document.querySelectorAll(".delete-req").forEach(btn=>{
    btn.onclick=async ()=>{
      const id=+btn.dataset.id;
      if(!confirm("Permanently delete this requisition?")) return;
      try{ await apiFetch(`/api/requisitions/${id}`,{method:"DELETE"}); await afterDataLoad(); }
      catch{ alert("Error deleting."); }
    };
  });
  
  // Edit
  document.querySelectorAll(".edit-req").forEach(btn=>{
    btn.onclick=()=>{
      const id=+btn.dataset.id;
      const row=allReqs.find(r=>r.id===id); if(!row) return;
      editingReqId=id;
      document.getElementById("reqFormTitle").textContent="Edit Order";
      document.getElementById("saveReqBtn").textContent="Update Order";
      document.getElementById("cancelReqEditBtn").classList.remove("hidden");
      
      // Populate form
      document.getElementById("reqNumber").value=row.number||"";
      document.getElementById("reqPONumber").value=row.po_number||"";
      document.getElementById("reqDescription").value=row.description||"";
      document.getElementById("reqVessel").value=row.vessel||"";
      document.getElementById("reqCategory").value=row.category||"";
      document.getElementById("reqSupplierSelect").value=row.supplier||"";
      document.getElementById("reqDateOrdered").value=row.date_ordered||"";
      document.getElementById("reqExpected").value=row.expected||"";
      const orig=(typeof row.original_amount==="number"?row.original_amount:row.total_amount)||0;
      document.getElementById("reqTotal").value=orig;
      document.getElementById("reqCurrency").value=row.currency||"USD";
      document.getElementById("reqPaid").checked=!!row.paid;
      document.getElementById("reqUrgency").value = row.urgency || "normal";
      
      // Scroll to top
      document.querySelector(".container").scrollIntoView({behavior: 'smooth'});
    };
  });

  // Copy
  document.querySelectorAll(".copy-req").forEach(btn=>{
    btn.onclick=()=>{
      const id=+btn.dataset.id;
      const row=allReqs.find(r=>r.id===id); if(!row) return;
      
      // We act like we are editing, but we clear the ID so it saves as NEW
      editingReqId=null; // Important: Null means create new
      document.getElementById("reqFormTitle").textContent="Add Ordered Requisition (Copy)";
      document.getElementById("saveReqBtn").textContent="Save Order"; // Reset text
      document.getElementById("cancelReqEditBtn").classList.remove("hidden");

      // Populate form but clear unique fields
      document.getElementById("reqNumber").value=""; // Clear Number to avoid duplicate error
      document.getElementById("reqPONumber").value=""; // Clear PO
      
      // Keep the rest
      document.getElementById("reqDescription").value=row.description||"";
      document.getElementById("reqVessel").value=row.vessel||"";
      document.getElementById("reqCategory").value=row.category||"";
      document.getElementById("reqSupplierSelect").value=row.supplier||"";
      document.getElementById("reqDateOrdered").value=row.date_ordered||"";
      document.getElementById("reqExpected").value=row.expected||"";
      const orig=(typeof row.original_amount==="number"?row.original_amount:row.total_amount)||0;
      document.getElementById("reqTotal").value=orig;
      document.getElementById("reqCurrency").value=row.currency||"USD";
      document.getElementById("reqPaid").checked=false; // Usually copies are unpaid
      document.getElementById("reqUrgency").value = row.urgency || "normal";

      // Scroll to top
      document.querySelector(".container").scrollIntoView({behavior: 'smooth'});
    };
  });
}
document.getElementById("cancelReqEditBtn").onclick=()=>{
  editingReqId=null;
  document.getElementById("reqFormTitle").textContent="Add Ordered Requisition";
  document.getElementById("saveReqBtn").textContent="Save Order";
  document.getElementById("cancelReqEditBtn").classList.add("hidden");
  ["reqNumber","reqPONumber","reqDescription","reqVessel","reqCategory","reqSupplierSelect","reqDateOrdered","reqExpected","reqTotal"].forEach(id=>document.getElementById(id).value="");
  document.getElementById("reqPaid").checked=false;
  document.getElementById("reqCurrency").value="USD";
  document.getElementById("reqUrgency").value="normal";
};
document.getElementById("applyReqFilterBtn").onclick=loadAllRequisitions;
document.getElementById("clearReqFilterBtn").onclick=async ()=>{
  ["filterReqStatus","filterReqPaid","filterReqDelivered","filterReqSearch"].forEach(id=>document.getElementById(id).value="");
  document.getElementById("filterReqSortKey").value = "date_ordered";
  document.getElementById("filterReqSortDir").value = "desc";
  await loadAllRequisitions();
};

document.getElementById("saveReqBtn").onclick=async (e)=>{
  const btn = e.target;
  btn.disabled = true;
  btn.textContent = "Saving...";
  
  const number=document.getElementById("reqNumber").value.trim();
  const po_number=document.getElementById("reqPONumber").value.trim(); 
  const description = document.getElementById("reqDescription").value.trim();
  const vessel=document.getElementById("reqVessel").value.trim();
  const category=document.getElementById("reqCategory").value.trim();
  const supplier=document.getElementById("reqSupplierSelect").value.trim();
  const date_ordered=document.getElementById("reqDateOrdered").value;
  const expected=document.getElementById("reqExpected").value;
  const total=document.getElementById("reqTotal").value;
  const currency=document.getElementById("reqCurrency").value||"USD";
  const paid=document.getElementById("reqPaid").checked;
  const urgency = document.getElementById("reqUrgency").value; 
  const err=document.getElementById("reqError"); err.textContent="";

  if(!number||!vessel||!category||!supplier||!date_ordered||!total){
    err.textContent="Please fill all required fields.";
    btn.disabled = false;
    btn.textContent = editingReqId ? "Update Order" : "Save Order";
    return;
  }
  try{
    const payload={number, po_number, description, vessel, category, supplier, date_ordered, expected, amount:parseFloat(total), currency, paid, urgency};
    
    if(editingReqId) await apiFetch(`/api/requisitions/${editingReqId}`,{method:"PATCH",body:JSON.stringify(payload)});
    else await apiFetch("/api/requisitions",{method:"POST",body:JSON.stringify(payload)});
    document.getElementById("cancelReqEditBtn").onclick();
    await afterDataLoad();
  }catch(e){
    if(e.error==="duplicate_number") err.textContent="This requisition number already exists.";
    else if(e.error==="unknown_category") err.textContent="Invalid category abbreviation.";
    else if(e.error==="login_required") err.textContent="You must be logged in to add / edit orders.";
    else err.textContent="Error saving order.";
  } finally {
     btn.disabled = false;
     // Reset button text if we finished (and cancel btn was clicked in try block so id is null)
     // But if error occurred, we stay on form.
     if(!editingReqId) btn.textContent = "Save Order";
     else btn.textContent = "Update Order";
  }
};

/* ========= Overview Reqs ========= */
async function loadOverviewRequisitions(){
  let rows=allReqs;
  if(!rows.length){ try{ rows=await apiFetch("/api/requisitions"); }catch{ rows=[]; } }
  
  const sortKey = document.getElementById("ovReqSortKey").value;
  const sortDir = document.getElementById("ovReqSortDir").value;
  
  rows = sortGeneric(rows, sortKey, sortDir);

  const tbody=document.querySelector("#overviewReqTable tbody"); tbody.innerHTML="";
  
  if(rows.length === 0) {
      tbody.innerHTML = `<tr><td colspan="12" style="text-align:center; padding:12px; color:#666;">No recent orders.</td></tr>`;
      return;
  }

  const today = new Date();
  today.setHours(0,0,0,0);

  rows.slice(0,10).forEach(r=>{
    const paidTag=r.paid?'<span class="tag green">Paid</span>':'<span class="tag red">Unpaid</span>';
    const delTag=r.delivered?'<span class="tag green">Delivered</span>':'<span class="tag gray">Open</span>';
    let statusClass="status-open"; if((r.status||"open")==="cancelled") statusClass="status-cancelled"; if(r.delivered) statusClass="status-delivered";
    
    const urgency = (r.urgency || "normal").toLowerCase();
    const urgDisplay = urgency==="high" ? `<span class="text-red-bold">High</span>` : (urgency.charAt(0).toUpperCase() + urgency.slice(1));

    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r.po_number||""}</td><td>${r.number}</td><td>${r.description || ""}</td><td>${r.vessel}</td><td>${r.category||""}</td><td>${r.supplier||""}</td>
      <td>${r.date_ordered||""}</td><td>${urgDisplay}</td><td>${(r.total_amount||0).toFixed(2)}</td><td>${paidTag}</td><td>${delTag}</td>
      <td><span class="status-pill ${statusClass}">${r.status||"open"}</span></td>`;
    tbody.appendChild(tr);
  });
}
document.getElementById("ovReqSortKey").onchange = loadOverviewRequisitions;
document.getElementById("ovReqSortDir").onchange = loadOverviewRequisitions;


/* ========= Landings ========= */
async function loadAllLandings(){
  let rows=[]; try{ rows=await apiFetch("/api/landings"); }catch{}
  allLandings=rows;
  const tbody=document.querySelector("#landingTable tbody"); tbody.innerHTML="";
  const statusFilter=document.getElementById("filterLandingStatus").value;
  const paidFilter=document.getElementById("filterLandingPaid").value;
  const delFilter=document.getElementById("filterLandingDelivered").value;
  const search=document.getElementById("filterLandingSearch").value.toLowerCase();
  
  const sortKey = document.getElementById("filterLandingSortKey").value;
  const sortDir = document.getElementById("filterLandingSortDir").value;

  let filtered = rows.filter(r=>{
    const matchesStatus=!statusFilter||(r.status||"open")===statusFilter;
    const matchesPaid=paidFilter===""||String(r.paid||0)===paidFilter;
    const matchesDel=delFilter===""||String(r.delivered||0)===delFilter;
    const matchesSearch=!search||(r.vessel||"").toLowerCase().includes(search)||(r.item||"").toLowerCase().includes(search)||(r.workshop||"").toLowerCase().includes(search);
    return matchesStatus&&matchesPaid&&matchesDel&&matchesSearch;
  });

  filtered = sortGeneric(filtered, sortKey, sortDir);
  
  if(filtered.length === 0) {
      tbody.innerHTML = `<tr><td colspan="11" style="text-align:center; padding:12px; color:#666;">No records found.</td></tr>`;
      return;
  }

  const today = new Date();
  today.setHours(0,0,0,0);

  filtered.forEach(r=>{
    const tr=document.createElement("tr");
    const paidTag=r.paid?'<span class="tag green">Paid</span>':'<span class="tag red">Unpaid</span>';
    const delTag=r.delivered?'<span class="tag green">Delivered</span>':'<span class="tag gray">Open</span>';
    let statusClass="status-open"; if((r.status||"open")==="cancelled") statusClass="status-cancelled"; if(r.delivered) statusClass="status-delivered";

    // Overdue logic
    const expDate = parseDateSafe(r.expected);
    let overdueClass = "";
    if(expDate && expDate < today && !r.delivered && (r.status||"open")!=="cancelled") {
        overdueClass = "text-red-bold";
    }
    const expDisplay = r.expected ? `<span class="${overdueClass}">${r.expected}</span>` : "";

    tr.innerHTML=`<td>${r.id}</td><td>${r.vessel}</td><td>${r.item||""}</td><td>${r.workshop||""}</td>
      <td>${expDisplay}</td><td>${r.landed_date||""}</td><td>${(r.amount||0).toFixed(2)}</td>
      <td>${paidTag}</td><td>${delTag}</td><td><span class="status-pill ${statusClass}">${r.status||"open"}</span></td>
      <td>
        <button class="edit-land" data-id="${r.id}">Edit</button>
        <button class="secondary copy-land" data-id="${r.id}">Copy</button>
        <button class="secondary toggle-paid-land" data-id="${r.id}">Paid</button>
        <button class="secondary mark-delivered-land" data-id="${r.id}">Delivered</button>
        <button class="danger cancel-land" data-id="${r.id}">Cancel</button>
        <button class="danger delete-land" data-id="${r.id}">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
  attachLandingActions();
  
  // Update dashboard immediately
  await updateOverviewPaidTotals(allReqs, allLandings);
}
function attachLandingActions(){
  document.querySelectorAll(".toggle-paid-land").forEach(btn=>{
    btn.onclick=async ()=>{
      const id=+btn.dataset.id;
      try{ 
          await apiFetch(`/api/landings/${id}/toggle_paid`,{method:"PATCH"}); 
          await afterDataLoad(); 
      }
      catch{ alert("Error toggling paid."); }
    };
  });
  document.querySelectorAll(".mark-delivered-land").forEach(btn=>{
    btn.onclick=async ()=>{
      const id=+btn.dataset.id;
      try{ await apiFetch(`/api/landings/${id}`,{method:"PATCH",body:JSON.stringify({delivered:true})}); await afterDataLoad(); }
      catch{ alert("Error marking delivered."); }
    };
  });
  document.querySelectorAll(".cancel-land").forEach(btn=>{
    btn.onclick=async ()=>{
      const id=+btn.dataset.id;
      if(!confirm("Cancel this landed item?")) return;
      try{ await apiFetch(`/api/landings/${id}`,{method:"PATCH",body:JSON.stringify({status:"cancelled"})}); await afterDataLoad(); }
      catch{ alert("Error cancelling landing."); }
    };
  });
  document.querySelectorAll(".delete-land").forEach(btn=>{
    btn.onclick=async ()=>{
      const id=+btn.dataset.id;
      if(!confirm("Permanently delete this landed item?")) return;
      try{ await apiFetch(`/api/landings/${id}`,{method:"DELETE"}); await afterDataLoad(); }
      catch{ alert("Error deleting landing."); }
    };
  });
  
  // Edit
  document.querySelectorAll(".edit-land").forEach(btn=>{
    btn.onclick=()=>{
      const id=+btn.dataset.id;
      const row=allLandings.find(l=>l.id===id); if(!row) return;
      editingLandId=id;
      document.getElementById("landFormTitle").textContent="Edit Landed Item";
      document.getElementById("saveLandingBtn").textContent="Update Landed Item";
      document.getElementById("cancelLandEditBtn").classList.remove("hidden");
      document.getElementById("landVessel").value=row.vessel||"";
      document.getElementById("landDescription").value=row.item||"";
      document.getElementById("landWorkshopSelect").value=row.workshop||"";
      document.getElementById("landExpected").value=row.expected||"";
      document.getElementById("landLanded").value=row.landed_date||"";
      const orig=(typeof row.amount_original==="number"?row.amount_original:row.amount)||0;
      document.getElementById("landAmount").value=orig;
      document.getElementById("landCurrency").value=row.currency||"USD";
      document.getElementById("landPaid").checked=!!row.paid;
      
      document.querySelector(".container").scrollIntoView({behavior: 'smooth'});
    };
  });

  // Copy
  document.querySelectorAll(".copy-land").forEach(btn=>{
    btn.onclick=()=>{
      const id=+btn.dataset.id;
      const row=allLandings.find(l=>l.id===id); if(!row) return;
      
      editingLandId=null; // Create new
      document.getElementById("landFormTitle").textContent="Add Landed Item (Copy)";
      document.getElementById("saveLandingBtn").textContent="Save Landed Item";
      document.getElementById("cancelLandEditBtn").classList.remove("hidden");
      
      // Populate form
      document.getElementById("landVessel").value=row.vessel||"";
      document.getElementById("landDescription").value=row.item||"";
      document.getElementById("landWorkshopSelect").value=row.workshop||"";
      document.getElementById("landExpected").value=row.expected||"";
      document.getElementById("landLanded").value=row.landed_date||"";
      const orig=(typeof row.amount_original==="number"?row.amount_original:row.amount)||0;
      document.getElementById("landAmount").value=orig;
      document.getElementById("landCurrency").value=row.currency||"USD";
      document.getElementById("landPaid").checked=false; // Usually copy is unpaid
      
      document.querySelector(".container").scrollIntoView({behavior: 'smooth'});
    };
  });
}
document.getElementById("cancelLandEditBtn").onclick=()=>{
  editingLandId=null;
  document.getElementById("landFormTitle").textContent="Add Landed Item";
  document.getElementById("saveLandingBtn").textContent="Save Landed Item";
  document.getElementById("cancelLandEditBtn").classList.add("hidden");
  ["landVessel","landDescription","landWorkshopSelect","landExpected","landLanded","landAmount"].forEach(id=>document.getElementById(id).value="");
  document.getElementById("landPaid").checked=false;
  document.getElementById("landCurrency").value="USD";
};
document.getElementById("applyLandingFilterBtn").onclick=loadAllLandings;
document.getElementById("clearLandingFilterBtn").onclick=async ()=>{
  ["filterLandingStatus","filterLandingPaid","filterLandingDelivered","filterLandingSearch"].forEach(id=>document.getElementById(id).value="");
  document.getElementById("filterLandingSortKey").value = "landed_date";
  document.getElementById("filterLandingSortDir").value = "desc";
  await loadAllLandings();
};
document.getElementById("saveLandingBtn").onclick=async (e)=>{
  const btn = e.target;
  btn.disabled = true;
  btn.textContent = "Saving...";
  
  const vessel=document.getElementById("landVessel").value.trim();
  const desc=document.getElementById("landDescription").value.trim();
  const workshop=document.getElementById("landWorkshopSelect").value.trim();
  const expected=document.getElementById("landExpected").value;
  const landed=document.getElementById("landLanded").value;
  const amount=document.getElementById("landAmount").value;
  const currency=document.getElementById("landCurrency").value||"USD";
  const paid=document.getElementById("landPaid").checked;
  const err=document.getElementById("landError"); err.textContent="";
  
  if(!vessel||!desc||!workshop||!amount){ 
      err.textContent="Vessel, description, workshop and amount are required."; 
      btn.disabled = false;
      btn.textContent = editingLandId ? "Update Landed Item" : "Save Landed Item";
      return; 
  }
  try{
    const payload={vessel,item:desc,workshop,amount:parseFloat(amount),currency,expected,landed_date:landed,paid};
    if(editingLandId) await apiFetch(`/api/landings/${editingLandId}`,{method:"PATCH",body:JSON.stringify(payload)});
    else await apiFetch("/api/landings",{method:"POST",body:JSON.stringify(payload)});
    document.getElementById("cancelLandEditBtn").onclick();
    await afterDataLoad();
  }catch(e){
    err.textContent=e.error==="login_required"?"You must be logged in.":"Error saving landed item.";
  } finally {
     btn.disabled = false;
     if(!editingLandId) btn.textContent = "Save Landed Item";
     else btn.textContent = "Update Landed Item";
  }
};

/* ========= Overview Landings ========= */
async function loadOverviewLandings(){
  let rows=allLandings;
  if(!rows.length){ try{ rows=await apiFetch("/api/landings"); }catch{ rows=[]; } }
  
  const sortKey = document.getElementById("ovLandSortKey").value;
  const sortDir = document.getElementById("ovLandSortDir").value;
  
  rows = sortGeneric(rows, sortKey, sortDir);

  const tbody=document.querySelector("#overviewLandTable tbody"); tbody.innerHTML="";
  
  if(rows.length === 0) {
      tbody.innerHTML = `<tr><td colspan="9" style="text-align:center; padding:12px; color:#666;">No recent items.</td></tr>`;
      return;
  }

  rows.slice(0,10).forEach(r=>{
    const paidTag=r.paid?'<span class="tag green">Paid</span>':'<span class="tag red">Unpaid</span>';
    const delTag=r.delivered?'<span class="tag green">Delivered</span>':'<span class="tag gray">Open</span>';
    let statusClass="status-open"; if((r.status||"open")==="cancelled") statusClass="status-cancelled"; if(r.delivered) statusClass="status-delivered";
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r.vessel}</td><td>${r.item||""}</td><td>${r.workshop||""}</td>
      <td>${r.expected||""}</td><td>${r.landed_date||""}</td><td>${(r.amount||0).toFixed(2)}</td>
      <td>${paidTag}</td><td>${delTag}</td><td><span class="status-pill ${statusClass}">${r.status||"open"}</span></td>`;
    tbody.appendChild(tr);
  });
}
document.getElementById("ovLandSortKey").onchange = loadOverviewLandings;
document.getElementById("ovLandSortDir").onchange = loadOverviewLandings;

/* ========= Delivered ========= */
async function loadDeliveredRequisitions(){
  let rows=allReqs; if(!rows.length){ try{ rows=await apiFetch("/api/requisitions"); }catch{ rows=[]; } }
  const paidFilter=document.getElementById("filterDeliveredReqPaid").value;
  const search=document.getElementById("filterDeliveredReqSearch").value.toLowerCase();
  const tbody=document.querySelector("#deliveredReqTable tbody"); tbody.innerHTML="";
  
  let filtered = rows.filter(r=>r.delivered).filter(r=>{
    const matchesPaid=paidFilter===""||String(r.paid||0)===paidFilter;
    const matchesSearch=!search||(r.number||"").toLowerCase().includes(search)||(r.vessel||"").toLowerCase().includes(search)||(r.supplier||"").toLowerCase().includes(search);
    return matchesPaid&&matchesSearch;
  });
  
  if(filtered.length === 0) {
      tbody.innerHTML = `<tr><td colspan="12" style="text-align:center; padding:12px; color:#666;">No records found.</td></tr>`;
      return;
  }

  filtered.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r.id}</td><td>${r.po_number||""}</td><td>${r.number}</td><td>${r.description || ""}</td><td>${r.vessel}</td><td>${r.category||""}</td><td>${r.supplier||""}</td>
      <td>${r.date_ordered||""}</td><td>${r.expected||""}</td><td>${(r.total_amount||0).toFixed(2)}</td>
      <td>${r.paid?"Paid":"Unpaid"}</td><td>${r.status||"open"}</td>`;
    tbody.appendChild(tr);
  });
}
document.getElementById("applyDeliveredReqFilterBtn").onclick=loadDeliveredRequisitions;
document.getElementById("clearDeliveredReqFilterBtn").onclick=async ()=>{
  ["filterDeliveredReqPaid","filterDeliveredReqSearch"].forEach(id=>document.getElementById(id).value="");
  await loadDeliveredRequisitions();
};

async function loadDeliveredLandings(){
  let rows=allLandings; if(!rows.length){ try{ rows=await apiFetch("/api/landings"); }catch{ rows=[]; } }
  const paidFilter=document.getElementById("filterDeliveredLandPaid").value;
  const search=document.getElementById("filterDeliveredLandSearch").value.toLowerCase();
  const tbody=document.querySelector("#deliveredLandTable tbody"); tbody.innerHTML="";
  
  let filtered = rows.filter(r=>r.delivered).filter(r=>{
    const matchesPaid=paidFilter===""||String(r.paid||0)===paidFilter;
    const matchesSearch=!search||(r.vessel||"").toLowerCase().includes(search)||(r.item||"").toLowerCase().includes(search)||(r.workshop||"").toLowerCase().includes(search);
    return matchesPaid&&matchesSearch;
  });
  
  if(filtered.length === 0) {
      tbody.innerHTML = `<tr><td colspan="9" style="text-align:center; padding:12px; color:#666;">No records found.</td></tr>`;
      return;
  }

  filtered.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r.id}</td><td>${r.vessel}</td><td>${r.item||""}</td><td>${r.workshop||""}</td>
      <td>${r.expected||""}</td><td>${r.landed_date||""}</td><td>${(r.amount||0).toFixed(2)}</td>
      <td>${r.paid?"Paid":"Unpaid"}</td><td>${r.status||"open"}</td>`;
    tbody.appendChild(tr);
  });
}
document.getElementById("applyDeliveredLandFilterBtn").onclick=loadDeliveredLandings;
document.getElementById("clearDeliveredLandFilterBtn").onclick=async ()=>{
  ["filterDeliveredLandPaid","filterDeliveredLandSearch"].forEach(id=>document.getElementById(id).value="");
  await loadDeliveredLandings();
};

/* ========= Summary counts ========= */
async function updateSummaryCounts(){
  let reqs=allReqs, lands=allLandings;
  if(!reqs.length){ try{ reqs=await apiFetch("/api/requisitions"); }catch{ reqs=[]; } }
  if(!lands.length){ try{ lands=await apiFetch("/api/landings"); }catch{ lands=[]; } }

  document.getElementById("summaryOpenReqNotDel").textContent=reqs.filter(r=>!r.delivered&&(r.status||"open")==="open").length;
  document.getElementById("summaryOpenReqUnpaid").textContent=reqs.filter(r=>!r.delivered&&!r.paid&&(r.status||"open")==="open").length;
  document.getElementById("summaryOpenLandNotDel").textContent=lands.filter(r=>!r.delivered&&(r.status||"open")==="open").length;
  document.getElementById("summaryOpenLandUnpaid").textContent=lands.filter(r=>!r.delivered&&!r.paid&&(r.status||"open")==="open").length;
}

/* ========= One place to reload everything ========= */
async function afterDataLoad() {
  await loadDirectoryOptions();
  await loadCategories();
  await loadVessels();
  await loadDirectoryPage();
  await loadUsersAdmin();
  await loadAllRequisitions();
  await loadAllLandings();
  await loadOverviewRequisitions();
  await loadOverviewLandings();
  await loadDeliveredRequisitions();
  await loadDeliveredLandings();
  await fillCancelledTables();
  await updateSummaryCounts();
  await loadOverviewTotalsFilters();
}


/* ========= Backups (Admin) ========= */
async function loadBackupsAdmin(){
  const err=document.getElementById("backupError");
  const tbody=document.querySelector("#backupTable tbody");
  if(!tbody) return;
  tbody.innerHTML="";
  err.textContent="";
  try{
    const backups=await apiFetch("/api/backups");
    backups.forEach(b=>{
      const tr=document.createElement("tr");
      const sizeKB=((b.size||0)/1024).toFixed(1);
      tr.innerHTML=`<td>${b.name}</td><td>${b.created_at||""}</td><td>${sizeKB}</td>
        <td>
          <button class="secondary dl-backup" data-name="${b.name}">Download</button>
          <button class="secondary restore-backup" data-name="${b.name}">Restore</button>
          <button class="danger delete-backup" data-name="${b.name}">Delete</button>
        </td>`;
      tbody.appendChild(tr);
    });

    document.querySelectorAll(".dl-backup").forEach(btn=>{
      btn.onclick=()=>{ window.open(`/api/backups/${encodeURIComponent(btn.dataset.name)}/download`, "_blank"); };
    });
    document.querySelectorAll(".restore-backup").forEach(btn=>{
      btn.onclick=async ()=>{
        const name=btn.dataset.name;
        if(!confirm(`Restore backup "${name}"? This will overwrite current data.`)) return;
        try{
          await apiFetch(`/api/backups/${encodeURIComponent(name)}/restore`, {method:"POST"});
          await afterDataLoad();
          alert("Backup restored.");
        }catch{ alert("Error restoring backup."); }
      };
    });
    document.querySelectorAll(".delete-backup").forEach(btn=>{
      btn.onclick=async ()=>{
        const name=btn.dataset.name;
        if(!confirm(`Delete backup "${name}"?`)) return;
        try{
          await apiFetch(`/api/backups/${encodeURIComponent(name)}`, {method:"DELETE"});
          await loadBackupsAdmin();
        }catch{ alert("Error deleting backup."); }
      };
    });
  }catch(e){
    if(e.error==="admin_required") err.textContent="Only admin can access backups.";
    else err.textContent="Error loading backups.";
  }
}

document.getElementById("downloadBackupBtn")?.addEventListener("click", ()=>{
  window.open("/api/backup", "_blank");
});

document.getElementById("uploadBackupBtn")?.addEventListener("click", async ()=>{
  const input=document.getElementById("uploadBackupInput");
  const err=document.getElementById("backupError");
  err.textContent="";
  if(!input || !input.files || !input.files.length){ err.textContent="Please choose a .xlsx file."; return; }
  const file=input.files[0];
  if(!file.name.toLowerCase().endsWith(".xlsx")){ err.textContent="Only .xlsx allowed."; return; }

  const fd=new FormData();
  fd.append("file", file);
  try{
    const res=await fetch("/api/upload", {method:"POST", body: fd, credentials:"same-origin"});
    if(!res.ok){
      let j={}; try{ j=await res.json(); }catch{}
      throw j;
    }
    input.value="";
    await afterDataLoad();
    await loadBackupsAdmin();
    alert("Uploaded and overwritten successfully.");
  }catch(e){
    if(e.error==="invalid_file_type") err.textContent="Only .xlsx allowed.";
    else if(e.error==="corrupt_excel") err.textContent="Excel file is not valid.";
    else if(e.error==="admin_required") err.textContent="Only admin can upload.";
    else err.textContent="Upload failed.";
  }
});


/* ========= Init ========= */
(async function init(){
  await loadCurrencies();
  await refreshSession();   // important due to admin tab visibility
  await afterDataLoad();
})();
</script>

</body>
</html>
