<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AMT Procurement</title>
  <link rel="icon" type="image/png" href="static/ICON.jpg">
  <style>
    :root{
      --bg:#f5f6f8; --card:#ffffff; --ink:#111827; --muted:#6b7280;
      --primary:#2563eb; --primary-dark:#1d4ed8; --danger:#b91c1c;
      --tab:#111827; --tab-active:#1f2937; --tab-text:#9ca3af; --tab-text-active:#fff;
      --border:#e5e7eb;
    }
    *{box-sizing:border-box;}
    body{margin:0;font-family:Arial, sans-serif;background:var(--bg);color:var(--ink);}
    header{
      background:var(--tab-active);color:#fff;padding:10px 16px;display:flex;
      justify-content:space-between;align-items:center;gap:12px;position:sticky;top:0;z-index:10;
    }
    header .left{display:flex;align-items:center;gap:12px;}
    header img{height:40px;border-radius:4px;}
    header h1{margin:0;font-size:20px;}
    header .user-info{font-size:14px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
    button{
      padding:7px 12px;font-size:13px;border-radius:6px;border:none;cursor:pointer;
      background:var(--primary);color:white;transition:0.15s;
    }
    button:hover{background:var(--primary-dark);}
    button.secondary{background:#6b7280;}
    button.secondary:hover{background:#4b5563;}
    button.danger{background:var(--danger);}
    button.danger:hover{filter:brightness(0.9);}

    .tabs{display:flex;background:var(--tab);flex-wrap:wrap;}
    .tab{
      padding:10px 16px;color:var(--tab-text);cursor:pointer;font-size:14px;
      user-select:none;border-bottom:2px solid transparent;
    }
    .tab.active{
      background:var(--tab-active);color:var(--tab-text-active);border-bottom:2px solid var(--primary);
    }
    .container{padding:16px;max-width:1200px;margin:0 auto;}
    .card{
      background:var(--card);padding:16px;margin-bottom:16px;border-radius:8px;
      box-shadow:0 1px 3px rgba(0,0,0,0.08);border:1px solid var(--border);
    }
    .card h2{margin:0 0 12px 0;font-size:18px;}
    .hidden{display:none !important;}
    label{display:block;font-size:13px;margin-bottom:6px;color:var(--ink);}
    input, select{
      width:100%;padding:8px 9px;font-size:13px;border-radius:6px;border:1px solid var(--border);
      background:#fff;
    }
    .error{color:var(--danger);font-size:12px;margin-top:6px;}

    /* login modal card */
    #loginCard{
      max-width:320px;margin:12px auto;position:relative;z-index:20;
    }
    .row{display:flex;gap:12px;flex-wrap:wrap;}
    .row > div{flex:1 1 140px;}

    /* tab panels */
    .tab-panel{display:none;}
    .tab-panel.active{display:block;}
  </style>
</head>
<body>

<header>
  <div class="left">
    <img src="static/logo.png" alt="AMT Logo">
    <h1>AMT Procurement</h1>
  </div>
  <div class="user-info" id="userInfo">
    <!-- filled by JS -->
  </div>
</header>

<!-- Login Card -->
<div id="loginCard" class="card hidden">
  <h2>Login</h2>
  <div class="row">
    <div>
      <label>Username</label>
      <input id="loginUsername" type="text" autocomplete="username">
    </div>
  </div>
  <div class="row">
    <div>
      <label>Password</label>
      <input id="loginPassword" type="password" autocomplete="current-password">
    </div>
  </div>
  <div style="margin-top:10px;display:flex;gap:8px;">
    <button id="loginBtn">Login</button>
    <button id="loginCancelBtn" class="secondary" type="button">Close</button>
  </div>
  <div id="loginError" class="error"></div>
</div>

<!-- Tabs -->
<div class="tabs">
  <div class="tab active" data-tab="overview">Overview</div>
  <div class="tab" data-tab="requisitions">Requisitions</div>
  <div class="tab" data-tab="landings">Landings</div>
  <div class="tab" data-tab="directory">Directory</div>
  <div class="tab" data-tab="delivered">Delivered</div>
  <div class="tab hidden" data-tab="admin" id="adminTab">Admin</div>
</div>

<div class="container">
  
  <!-- OVERVIEW -->
  <div id="tab-overview" class="tab-panel">
    <div class="card">
      <h2>Dashboard</h2>
      <div class="summary-grid">
        <div class="summary-item">
          <div class="summary-label">Open Requisitions (not delivered)</div>
          <div class="summary-value" id="summaryOpenReqNotDel">0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Open Requisitions (unpaid)</div>
          <div class="summary-value" id="summaryOpenReqUnpaid">0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Open Landed Items (not delivered)</div>
          <div class="summary-value" id="summaryOpenLandNotDel">0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Open Landed Items (unpaid)</div>
          <div class="summary-value" id="summaryOpenLandUnpaid">0</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Paid Totals (Filters)</h2>

      <div class="row">
        <div>
          <label>Type</label>
          <select id="ovTypeFilter">
            <option value="">All</option>
            <option value="req">Requisitions</option>
            <option value="land">Workshops (Landed Items)</option>
          </select>
        </div>

        <div>
          <label>Vessel</label>
          <select id="ovVesselFilter">
            <option value="">All</option>
          </select>
        </div>

        <div>
          <label>Paid?</label>
          <select id="ovPaidFilter">
            <option value="">All</option>
            <option value="1">Paid</option>
            <option value="0">Unpaid</option>
          </select>
        </div>

        <div>
          <label>Month</label>
          <select id="ovMonthFilter">
            <option value="">All months</option>
            <option value="1">Jan</option>
            <option value="2">Feb</option>
            <option value="3">Mar</option>
            <option value="4">Apr</option>
            <option value="5">May</option>
            <option value="6">Jun</option>
            <option value="7">Jul</option>
            <option value="8">Aug</option>
            <option value="9">Sep</option>
            <option value="10">Oct</option>
            <option value="11">Nov</option>
            <option value="12">Dec</option>
          </select>
        </div>

        <div>
          <label>Quarter</label>
          <select id="ovQuarterFilter">
            <option value="">All quarters</option>
            <option value="Q1">Q1</option>
            <option value="Q2">Q2</option>
            <option value="Q3">Q3</option>
            <option value="Q4">Q4</option>
          </select>
        </div>

        <div>
          <label>Category</label>
          <select id="ovCategoryFilter">
            <option value="">All categories</option>
          </select>
        </div>

        <div>
          <label>Year</label>
          <select id="ovYearFilter">
            <option value="">All years</option>
          </select>
        </div>
      </div>

      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
        <button id="ovApplyTotalsBtn" type="button">Apply</button>
        <button id="ovClearTotalsBtn" class="secondary" type="button">Clear</button>
      </div>

      <div class="summary-grid" style="margin-top:12px;">
        <div class="summary-item">
          <div class="summary-label">Total Paid (Selected Period)</div>
          <div class="summary-value" id="ovPaidPeriodTotal">0.00</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Total Amount (Filter Result)</div>
          <div class="summary-value" id="ovAllTotal">0.00</div>
        </div>
      </div>

      <h3 style="margin-top:14px;">Top 5 Suppliers (Selected Period)</h3>
      <ul id="ovTopSuppliers" style="padding-left:18px; margin-top:6px;">
        <li>â€”</li>
      </ul>
    </div>

    <div class="card">
      <h2>Recent Requisitions</h2>
      <div style="overflow:auto;">
        <table id="overviewReqTable"><thead>
          <tr>
            <th>Number</th><th>Vessel</th><th>Category</th><th>Supplier</th><th>Ordered</th><th>Amount (USD)</th><th>Paid</th><th>Delivered</th><th>Status</th>
          </tr>
        </thead><tbody></tbody></table>
      </div>
    </div>

    <div class="card">
      <h2>Recent Landed Items</h2>
      <div style="overflow:auto;">
        <table id="overviewLandTable"><thead>
          <tr>
            <th>Vessel</th><th>Description</th><th>Workshop</th><th>Landed</th><th>Amount (USD)</th><th>Paid</th><th>Delivered</th><th>Status</th>
          </tr>
        </thead><tbody></tbody></table>
      </div>
    </div>
  </div>


  <!-- REQUISITIONS -->
  <div id="tab-requisitions" class="tab-panel">
    <!-- Add / Edit form -->
    <div class="card">
      <h2 id="reqFormTitle">Add Requisition</h2>
      <div class="row">
        <div>
          <label>Requisition Number *</label>
          <input type="text" id="reqNumber" placeholder="e.g. GH.S.026.25">
        </div>
        <div>
          <label>Vessel *</label>
          <select id="reqVessel"></select>
        </div>
        <div>
          <label>Category (Abbreviation) *</label>
          <select id="reqCategory"></select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Supplier *</label>
          <select id="reqSupplier"></select>
        </div>
        <div>
          <label>Date Ordered *</label>
          <input type="date" id="reqDateOrdered">
        </div>
        <div>
          <label>Expected Date</label>
          <input type="date" id="reqExpected">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Amount *</label>
          <input type="number" id="reqAmount" step="0.01" min="0">
        </div>
        <div>
          <label>Currency *</label>
          <select id="reqCurrency"></select>
        </div>
        <div style="display:flex;align-items:center;gap:8px;margin-top:22px;">
          <input type="checkbox" id="reqPaid" style="width:auto;">
          <label for="reqPaid" style="margin:0;">Paid</label>
        </div>
      </div>

      <div class="row">
        <div>
          <label>PO #</label>
          <input type="text" id="reqPO">
        </div>
        <div>
          <label>Urgency</label>
          <select id="reqUrgency">
            <option value="normal">Normal</option>
            <option value="urgent">Urgent</option>
          </select>
        </div>
        <div>
          <label>Remarks</label>
          <input type="text" id="reqRemarks" placeholder="optional">
        </div>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
        <button id="saveReqBtn">Save Requisition</button>
        <button id="cancelReqEditBtn" class="secondary hidden" type="button">Cancel Edit</button>
      </div>
      <div id="reqError" class="error"></div>
    </div>

    <!-- Filters -->
    <div class="card">
      <h2>Filter Requisitions</h2>
      <div class="row">
        <div>
          <label>Status</label>
          <select id="filterReqStatus">
            <option value="">All</option>
            <option value="open">Open</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
        <div>
          <label>Paid</label>
          <select id="filterReqPaid">
            <option value="">All</option>
            <option value="1">Paid</option>
            <option value="0">Unpaid</option>
          </select>
        </div>
        <div>
          <label>Delivered</label>
          <select id="filterReqDelivered">
            <option value="">All</option>
            <option value="1">Delivered</option>
            <option value="0">Not delivered</option>
          </select>
        </div>
        <div>
          <label>Search (number / vessel / supplier)</label>
          <input type="text" id="filterReqSearch" placeholder="Search...">
        </div>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px;">
        <button id="applyReqFilterBtn" type="button">Apply</button>
        <button id="clearReqFilterBtn" class="secondary" type="button">Clear</button>
      </div>
    </div>

    <!-- Main Table -->
    <div class="card">
      <h2>All Requisitions</h2>
      <div style="overflow:auto;">
        <table id="reqTable" style="width:100%; border-collapse:collapse; font-size:13px;">
          <thead>
            <tr>
              <th>ID</th>
              <th>Number</th>
              <th>Vessel</th>
              <th>Category</th>
              <th>Supplier</th>
              <th>Ordered</th>
              <th>Expected</th>
              <th>Amount (USD)</th>
              <th>Paid</th>
              <th>Delivered</th>
              <th>Status</th>
              <th>PO #</th>
              <th>Urgency</th>
              <th>Remarks</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div style="color:var(--muted);font-size:12px;margin-top:6px;">
        * Non-admin users can edit only their own rows and cannot delete.
      </div>
    </div>
  </div>


  
  <!-- LANDINGS -->
  <div id="tab-landings" class="tab-panel">
    <!-- Add / Edit form -->
    <div class="card">
      <h2 id="landFormTitle">Add Landed Item</h2>
      <div class="row">
        <div>
          <label>Vessel *</label>
          <select id="landVessel"></select>
        </div>
        <div>
          <label>Description / Item *</label>
          <input type="text" id="landItem" placeholder="e.g. LO pump overhaul">
        </div>
        <div>
          <label>Workshop *</label>
          <select id="landWorkshop"></select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Expected Delivery Date</label>
          <input type="date" id="landExpected">
        </div>
        <div>
          <label>Landed Date</label>
          <input type="date" id="landLanded">
        </div>
        <div></div>
      </div>

      <div class="row">
        <div>
          <label>Amount *</label>
          <input type="number" id="landAmount" step="0.01" min="0">
        </div>
        <div>
          <label>Currency *</label>
          <select id="landCurrency"></select>
        </div>
        <div style="display:flex;align-items:center;gap:8px;margin-top:22px;">
          <input type="checkbox" id="landPaid" style="width:auto;">
          <label for="landPaid" style="margin:0;">Paid</label>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Remarks</label>
          <input type="text" id="landRemarks" placeholder="optional">
        </div>
        <div></div><div></div>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
        <button id="saveLandBtn">Save Landed Item</button>
        <button id="cancelLandEditBtn" class="secondary hidden" type="button">Cancel Edit</button>
      </div>
      <div id="landError" class="error"></div>
    </div>

    <!-- Filters -->
    <div class="card">
      <h2>Filter Landed Items</h2>
      <div class="row">
        <div>
          <label>Status</label>
          <select id="filterLandStatus">
            <option value="">All</option>
            <option value="open">Open</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
        <div>
          <label>Paid</label>
          <select id="filterLandPaid">
            <option value="">All</option>
            <option value="1">Paid</option>
            <option value="0">Unpaid</option>
          </select>
        </div>
        <div>
          <label>Delivered</label>
          <select id="filterLandDelivered">
            <option value="">All</option>
            <option value="1">Delivered</option>
            <option value="0">Not delivered</option>
          </select>
        </div>
        <div>
          <label>Search (vessel / item / workshop)</label>
          <input type="text" id="filterLandSearch" placeholder="Search...">
        </div>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px;">
        <button id="applyLandFilterBtn" type="button">Apply</button>
        <button id="clearLandFilterBtn" class="secondary" type="button">Clear</button>
      </div>
    </div>

    <!-- Main Table -->
    <div class="card">
      <h2>All Landed Items</h2>
      <div style="overflow:auto;">
        <table id="landTable" style="width:100%; border-collapse:collapse; font-size:13px;">
          <thead>
            <tr>
              <th>ID</th>
              <th>Vessel</th>
              <th>Description</th>
              <th>Workshop</th>
              <th>Expected</th>
              <th>Landed Date</th>
              <th>Amount (USD)</th>
              <th>Paid</th>
              <th>Delivered</th>
              <th>Status</th>
              <th>Remarks</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div style="color:var(--muted);font-size:12px;margin-top:6px;">
        * Non-admin users can edit only their own rows and cannot delete.
      </div>
    </div>
  </div>


  
  <!-- DIRECTORY -->
  <div id="tab-directory" class="tab-panel">
    <div class="card">
      <h2>Suppliers & Workshops</h2>

      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
        <button id="dirAddSupplierBtn" type="button">Add Supplier</button>
        <button id="dirAddWorkshopBtn" class="secondary" type="button">Add Workshop</button>
      </div>

      <div style="overflow:auto;">
        <table id="dirTable" style="width:100%; border-collapse:collapse; font-size:13px;">
          <thead>
            <tr>
              <th>ID</th>
              <th>Type</th>
              <th>Name</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Address</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div style="color:var(--muted);font-size:12px;margin-top:6px;">
        * Non-admin users can add/edit their own entries. Delete is admin only.
      </div>
    </div>

    <!-- Popup / modal -->
    <div id="dirBackdrop" class="hidden" style="position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:40;"></div>
    <div id="dirPopup" class="card hidden" 
         style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
                width:92%; max-width:420px; z-index:50;">
      <h2 id="dirPopupTitle" style="margin-bottom:10px;">New Entry</h2>

      <div class="row">
        <div>
          <label>Name *</label>
          <input type="text" id="dirName">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Email</label>
          <input type="email" id="dirEmail">
        </div>
        <div>
          <label>Phone</label>
          <input type="text" id="dirPhone">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Location / Address</label>
          <input type="text" id="dirAddress">
        </div>
      </div>

      <div id="dirError" class="error"></div>

      <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end;">
        <button id="dirCancelBtn" class="secondary" type="button">Cancel</button>
        <button id="dirSaveBtn" type="button">Save</button>
      </div>
    </div>
  </div>


  
  <!-- DELIVERED -->
  <div id="tab-delivered" class="tab-panel">
    <div class="card">
      <h2>Delivered Requisitions</h2>
      <div class="row">
        <div>
          <label>Paid</label>
          <select id="filterDelReqPaid">
            <option value="">All</option>
            <option value="1">Paid</option>
            <option value="0">Unpaid</option>
          </select>
        </div>
        <div>
          <label>Search (number / vessel / supplier)</label>
          <input type="text" id="filterDelReqSearch" placeholder="Search...">
        </div>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px;">
        <button id="applyDelReqFilterBtn" type="button">Apply</button>
        <button id="clearDelReqFilterBtn" class="secondary" type="button">Clear</button>
      </div>

      <div style="overflow:auto;margin-top:10px;">
        <table id="delReqTable" style="width:100%; border-collapse:collapse; font-size:13px;">
          <thead>
            <tr>
              <th>ID</th>
              <th>Number</th>
              <th>Vessel</th>
              <th>Category</th>
              <th>Supplier</th>
              <th>Ordered</th>
              <th>Expected</th>
              <th>Amount (USD)</th>
              <th>Paid</th>
              <th>Status</th>
              <th>PO #</th>
              <th>Urgency</th>
              <th>Remarks</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h2>Delivered Landed Items</h2>
      <div class="row">
        <div>
          <label>Paid</label>
          <select id="filterDelLandPaid">
            <option value="">All</option>
            <option value="1">Paid</option>
            <option value="0">Unpaid</option>
          </select>
        </div>
        <div>
          <label>Search (vessel / item / workshop)</label>
          <input type="text" id="filterDelLandSearch" placeholder="Search...">
        </div>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px;">
        <button id="applyDelLandFilterBtn" type="button">Apply</button>
        <button id="clearDelLandFilterBtn" class="secondary" type="button">Clear</button>
      </div>

      <div style="overflow:auto;margin-top:10px;">
        <table id="delLandTable" style="width:100%; border-collapse:collapse; font-size:13px;">
          <thead>
            <tr>
              <th>ID</th>
              <th>Vessel</th>
              <th>Description</th>
              <th>Workshop</th>
              <th>Expected</th>
              <th>Landed Date</th>
              <th>Amount (USD)</th>
              <th>Paid</th>
              <th>Status</th>
              <th>Remarks</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>


  <!-- ADMIN -->
  <div id="tab-admin" class="tab-panel">
    <div class="card">
      <h2>Admin</h2>
      <p style="color:var(--muted);margin:0;">
        Admin UI (categories, vessels, users) will be added in Step 7.
      </p>
    </div>
  </div>
</div>

<script>
/* ================== API helper ================== */
async function apiFetch(url, options = {}) {
  const res = await fetch(url, {
    headers: {"Content-Type":"application/json"},
    credentials: "same-origin",
    ...options
  });
  if (!res.ok) {
    let err = {error:"unknown"};
    try { err = await res.json(); } catch {}
    throw err;
  }
  return res.json();
}

let currentUser = null;

/* ================== Session / Login UI ================== */
async function refreshSession() {
  try {
    currentUser = await apiFetch("/api/session");
  } catch(e) {
    currentUser = null;
  }

  const userInfo = document.getElementById("userInfo");
  const loginCard = document.getElementById("loginCard");
  const adminTab = document.getElementById("adminTab");

  if (currentUser && currentUser.username) {
    userInfo.innerHTML = `
      Logged in as <strong>${currentUser.username}</strong> (${currentUser.role})
      <button id="logoutBtn" class="secondary" type="button">Logout</button>
    `;
    document.getElementById("logoutBtn").onclick = async () => {
      await apiFetch("/api/logout", {method:"POST"});
      currentUser = null;
      await refreshSession();
    };
    loginCard.classList.add("hidden");
  } else {
    userInfo.innerHTML = `
      Not logged in
      <button id="showLoginBtn" type="button">Login</button>
    `;
    document.getElementById("showLoginBtn").onclick = () => {
      loginCard.classList.toggle("hidden");
      document.getElementById("loginError").textContent = "";
    };
  }

  // Admin tab visibility
  if (adminTab) {
    if (currentUser && currentUser.role === "admin") {
      adminTab.classList.remove("hidden");
    } else {
      adminTab.classList.add("hidden");
      // if user was on admin tab, kick them to overview
      const activeTab = document.querySelector(".tab.active");
      if (activeTab && activeTab.dataset.tab === "admin") {
        switchTab("overview");
      }
    }
  }

  // enable/disable admin inputs
  if (typeof setAdminInputsEnabled === 'function') setAdminInputsEnabled();
  // if admin tab visible, load admin tables
  if (currentUser && currentUser.role === 'admin') {
    if (typeof renderCategories === 'function') renderCategories();
    if (typeof renderVessels === 'function') renderVessels();
    if (typeof renderUsers === 'function') renderUsers();
  }

}

document.getElementById("loginBtn").onclick = async () => {
  const u = document.getElementById("loginUsername").value.trim();
  const p = document.getElementById("loginPassword").value;
  const err = document.getElementById("loginError");
  err.textContent = "";

  if (!u || !p) {
    err.textContent = "Enter username and password.";
    return;
  }

  try {
    await apiFetch("/api/login", {
      method:"POST",
      body: JSON.stringify({username:u, password:p})
    });
    document.getElementById("loginUsername").value = "";
    document.getElementById("loginPassword").value = "";
    document.getElementById("loginCard").classList.add("hidden");
    await refreshSession();
  } catch(e) {
    err.textContent = (e.error === "invalid_credentials") ?
      "Invalid username or password." : "Login failed.";
  }
};

document.getElementById("loginCancelBtn").onclick = () => {
  document.getElementById("loginCard").classList.add("hidden");
};

/* ================== Tabs ================== */
function switchTab(tabName){
  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));

  const tabBtn = document.querySelector(`.tab[data-tab="${tabName}"]`);
  const tabPanel = document.getElementById(`tab-${tabName}`);
  if (!tabBtn || !tabPanel) return;

  tabBtn.classList.add("active");
  tabPanel.classList.add("active");
}

document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    if (tab.classList.contains("hidden")) return;
    switchTab(tab.dataset.tab);
  });
});


/* =========================================================
   STEP 3: REQUISITIONS UI + LOGIC
   ========================================================= */

let allReqs = [];
let editingReqId = null;
let currencyList = ["USD"];
let categories = [];
let vessels = [];
let suppliers = [];

// currency + dropdowns
async function loadCurrencies() {
  try {
    const res = await apiFetch("/api/currencies");
    currencyList = res.currencies || ["USD"];
  } catch {
    currencyList = ["USD", "EUR", "AED", "GBP", "LBP"];
  }
  const sel = document.getElementById("reqCurrency");
  if (!sel) return;
  sel.innerHTML = currencyList.map(c=>`<option value="${c}">${c}</option>`).join("");
  sel.value = "USD";
}

// categories dropdown (from backend)
async function loadCategories() {
  try { categories = await apiFetch("/api/categories"); }
  catch { categories = []; }
  const sel = document.getElementById("reqCategory");
  if (!sel) return;
  sel.innerHTML = '<option value="">Select category</option>' +
    categories.map(c=>`<option value="${c.abbr}">${c.abbr} - ${c.name}</option>`).join("");
}

// vessels dropdown (from backend)
async function loadVessels() {
  try { vessels = await apiFetch("/api/vessels"); }
  catch { vessels = []; }
  const sel = document.getElementById("reqVessel");
  if (!sel) return;
  sel.innerHTML = '<option value="">Select vessel</option>' +
    vessels.map(v=>`<option value="${v.name}">${v.name}</option>`).join("");
}

// suppliers dropdown (directory suppliers)
async function loadSuppliers() {
  try { suppliers = await apiFetch("/api/directory?type=supplier"); }
  catch { suppliers = []; }
  const sel = document.getElementById("reqSupplier");
  if (!sel) return;
  sel.innerHTML = '<option value="">Select supplier</option>' +
    suppliers.map(s=>`<option value="${s.name}">${s.name}</option>`).join("");
}

function paidTag(v){
  return v ? '<span style="padding:2px 6px;border-radius:999px;font-size:11px;background:#dcfce7;color:#166534;">Paid</span>'
           : '<span style="padding:2px 6px;border-radius:999px;font-size:11px;background:#fee2e2;color:#b91c1c;">Unpaid</span>';
}
function deliveredTag(v){
  return v ? '<span style="padding:2px 6px;border-radius:999px;font-size:11px;background:#dcfce7;color:#166534;">Delivered</span>'
           : '<span style="padding:2px 6px;border-radius:999px;font-size:11px;background:#e5e7eb;color:#374151;">Open</span>';
}

// Load + render requisitions
async function loadAllRequisitions() {
  try { allReqs = await apiFetch("/api/requisitions"); }
  catch { allReqs = []; }

  const statusF = document.getElementById("filterReqStatus").value;
  const paidF = document.getElementById("filterReqPaid").value;
  const delF = document.getElementById("filterReqDelivered").value;
  const search = document.getElementById("filterReqSearch").value.toLowerCase().trim();

  const tbody = document.querySelector("#reqTable tbody");
  tbody.innerHTML = "";

  allReqs.forEach(r => {
    const matchesStatus = !statusF || (r.status || "open") === statusF;
    const matchesPaid = paidF === "" || String(r.paid || 0) === paidF;
    const matchesDel = delF === "" || String(r.delivered || 0) === delF;
    const matchesSearch =
      !search ||
      (r.number || "").toLowerCase().includes(search) ||
      (r.vessel || "").toLowerCase().includes(search) ||
      (r.supplier || "").toLowerCase().includes(search);

    if (!(matchesStatus && matchesPaid && matchesDel && matchesSearch)) return;

    const canEdit = currentUser && (currentUser.role === "admin" || r.created_by === currentUser.username);
    const canDelete = currentUser && currentUser.role === "admin";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.id}</td>
      <td>${r.number || ""}</td>
      <td>${r.vessel || ""}</td>
      <td>${r.category || ""}</td>
      <td>${r.supplier || ""}</td>
      <td>${r.date_ordered || ""}</td>
      <td>${r.expected || ""}</td>
      <td>${Number(r.amount_usd || 0).toFixed(2)}</td>
      <td>${paidTag(r.paid)}</td>
      <td>${deliveredTag(r.delivered)}</td>
      <td>${r.status || "open"}</td>
      <td>${r.po_number || ""}</td>
      <td>${r.urgency || "normal"}</td>
      <td>${r.remarks || ""}</td>
      <td style="white-space:nowrap;">
        <button class="secondary edit-req" data-id="${r.id}" ${!canEdit?'disabled':''}>Edit</button>
        <button class="secondary toggle-paid-req" data-id="${r.id}" ${!canEdit?'disabled':''}>Paid</button>
        <button class="secondary toggle-del-req" data-id="${r.id}" ${!canEdit?'disabled':''}>Delivered</button>
        <button class="danger cancel-req" data-id="${r.id}" ${!canEdit?'disabled':''}>Cancel</button>
        <button class="danger delete-req" data-id="${r.id}" ${!canDelete?'disabled':''}>Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  attachReqActions();
}

function attachReqActions(){
  document.querySelectorAll(".edit-req").forEach(btn=>{
    btn.onclick = () => {
      const id = Number(btn.dataset.id);
      const row = allReqs.find(x=>Number(x.id)===id);
      if (!row) return;
      editingReqId = id;

      document.getElementById("reqFormTitle").textContent = "Edit Requisition";
      document.getElementById("saveReqBtn").textContent = "Update Requisition";
      document.getElementById("cancelReqEditBtn").classList.remove("hidden");

      document.getElementById("reqNumber").value = row.number || "";
      document.getElementById("reqVessel").value = row.vessel || "";
      document.getElementById("reqCategory").value = row.category || "";
      document.getElementById("reqSupplier").value = row.supplier || "";
      document.getElementById("reqDateOrdered").value = row.date_ordered || "";
      document.getElementById("reqExpected").value = row.expected || "";
      document.getElementById("reqAmount").value = row.amount_original || 0;
      document.getElementById("reqCurrency").value = row.currency || "USD";
      document.getElementById("reqPaid").checked = !!row.paid;
      document.getElementById("reqPO").value = row.po_number || "";
      document.getElementById("reqUrgency").value = row.urgency || "normal";
      document.getElementById("reqRemarks").value = row.remarks || "";
      window.scrollTo({top:0, behavior:"smooth"});
    };
  });

  document.querySelectorAll(".toggle-paid-req").forEach(btn=>{
    btn.onclick = async () => {
      const id = Number(btn.dataset.id);
      try{
        await apiFetch(`/api/requisitions/${id}/toggle_paid`, {method:"PATCH"});
        await loadAllRequisitions();
      }catch{ alert("Error toggling paid"); }
    };
  });

  document.querySelectorAll(".toggle-del-req").forEach(btn=>{
    btn.onclick = async () => {
      const id = Number(btn.dataset.id);
      try{
        await apiFetch(`/api/requisitions/${id}`, {
          method:"PATCH",
          body: JSON.stringify({ delivered: true })
        });
        await loadAllRequisitions();
      }catch{ alert("Error marking delivered"); }
    };
  });

  document.querySelectorAll(".cancel-req").forEach(btn=>{
    btn.onclick = async () => {
      const id = Number(btn.dataset.id);
      if (!confirm("Cancel this requisition?")) return;
      try{
        await apiFetch(`/api/requisitions/${id}`, {
          method:"PATCH",
          body: JSON.stringify({ status:"cancelled" })
        });
        await loadAllRequisitions();
      }catch{ alert("Error cancelling"); }
    };
  });

  document.querySelectorAll(".delete-req").forEach(btn=>{
    btn.onclick = async () => {
      const id = Number(btn.dataset.id);
      if (!confirm("Delete this requisition permanently?")) return;
      try{
        await apiFetch(`/api/requisitions/${id}`, {method:"DELETE"});
        await loadAllRequisitions();
      }catch{ alert("Error deleting (admin only)"); }
    };
  });
}

// cancel edit
document.getElementById("cancelReqEditBtn").onclick = () => {
  editingReqId = null;
  document.getElementById("reqFormTitle").textContent = "Add Requisition";
  document.getElementById("saveReqBtn").textContent = "Save Requisition";
  document.getElementById("cancelReqEditBtn").classList.add("hidden");

  ["reqNumber","reqAmount","reqPO","reqRemarks"].forEach(id=>document.getElementById(id).value="");
  ["reqVessel","reqCategory","reqSupplier"].forEach(id=>document.getElementById(id).value="");
  document.getElementById("reqDateOrdered").value="";
  document.getElementById("reqExpected").value="";
  document.getElementById("reqCurrency").value="USD";
  document.getElementById("reqPaid").checked=false;
  document.getElementById("reqUrgency").value="normal";
};

// save requisition
document.getElementById("saveReqBtn").onclick = async () => {
  const err = document.getElementById("reqError");
  err.textContent = "";

  const payload = {
    number: document.getElementById("reqNumber").value.trim(),
    vessel: document.getElementById("reqVessel").value.trim(),
    category: document.getElementById("reqCategory").value.trim(),
    supplier: document.getElementById("reqSupplier").value.trim(),
    date_ordered: document.getElementById("reqDateOrdered").value,
    expected: document.getElementById("reqExpected").value,
    amount: parseFloat(document.getElementById("reqAmount").value || "0"),
    currency: document.getElementById("reqCurrency").value || "USD",
    paid: document.getElementById("reqPaid").checked,
    po_number: document.getElementById("reqPO").value.trim(),
    urgency: document.getElementById("reqUrgency").value,
    remarks: document.getElementById("reqRemarks").value.trim(),
  };

  if (!payload.number || !payload.vessel || !payload.category || !payload.supplier || !payload.date_ordered || !payload.amount){
    err.textContent = "Please fill all required fields (*)";
    return;
  }

  try{
    if (editingReqId){
      await apiFetch(`/api/requisitions/${editingReqId}`, {
        method:"PATCH",
        body: JSON.stringify(payload)
      });
    } else {
      await apiFetch("/api/requisitions", {
        method:"POST",
        body: JSON.stringify(payload)
      });
    }
    document.getElementById("cancelReqEditBtn").onclick();
    await loadAllRequisitions();
  }catch(e){
    if (e.error==="duplicate_number") err.textContent="This requisition number already exists.";
    else if (e.error==="unknown_category") err.textContent="Unknown category.";
    else if (e.error==="login_required") err.textContent="Please login first.";
    else if (e.error==="not_allowed") err.textContent="You can edit only your own rows.";
    else err.textContent="Error saving requisition.";
  }
};

// filter buttons
document.getElementById("applyReqFilterBtn").onclick = loadAllRequisitions;
document.getElementById("clearReqFilterBtn").onclick = async () => {
  document.getElementById("filterReqStatus").value="";
  document.getElementById("filterReqPaid").value="";
  document.getElementById("filterReqDelivered").value="";
  document.getElementById("filterReqSearch").value="";
  await loadAllRequisitions();
};



/* =========================================================
   STEP 4: LANDINGS UI + LOGIC
   ========================================================= */

let allLandings = [];
let editingLandId = null;
let workshops = [];

// reuse vessels list from Step 3. fill landing vessel select
function fillLandingVessels(){
  const sel = document.getElementById("landVessel");
  if (!sel) return;
  sel.innerHTML = '<option value="">Select vessel</option>' +
    vessels.map(v=>`<option value="${v.name}">${v.name}</option>`).join("");
}

// workshops dropdown (directory workshops)
async function loadWorkshops() {
  try { workshops = await apiFetch("/api/directory?type=workshop"); }
  catch { workshops = []; }
  const sel = document.getElementById("landWorkshop");
  if (!sel) return;
  sel.innerHTML = '<option value="">Select workshop</option>' +
    workshops.map(w=>`<option value="${w.name}">${w.name}</option>`).join("");
}

// landing currency dropdown uses same currencyList
function fillLandingCurrencies(){
  const sel = document.getElementById("landCurrency");
  if (!sel) return;
  sel.innerHTML = currencyList.map(c=>`<option value="${c}">${c}</option>`).join("");
  sel.value = "USD";
}

// Load + render landed items
async function loadAllLandings() {
  try { allLandings = await apiFetch("/api/landings"); }
  catch { allLandings = []; }

  const statusF = document.getElementById("filterLandStatus").value;
  const paidF = document.getElementById("filterLandPaid").value;
  const delF = document.getElementById("filterLandDelivered").value;
  const search = document.getElementById("filterLandSearch").value.toLowerCase().trim();

  const tbody = document.querySelector("#landTable tbody");
  tbody.innerHTML = "";

  allLandings.forEach(r => {
    const matchesStatus = !statusF || (r.status || "open") === statusF;
    const matchesPaid = paidF === "" || String(r.paid || 0) === paidF;
    const matchesDel = delF === "" || String(r.delivered || 0) === delF;
    const matchesSearch =
      !search ||
      (r.vessel || "").toLowerCase().includes(search) ||
      (r.item || "").toLowerCase().includes(search) ||
      (r.workshop || "").toLowerCase().includes(search);

    if (!(matchesStatus && matchesPaid && matchesDel && matchesSearch)) return;

    const canEdit = currentUser && (currentUser.role === "admin" || r.created_by === currentUser.username);
    const canDelete = currentUser && currentUser.role === "admin";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.id}</td>
      <td>${r.vessel || ""}</td>
      <td>${r.item || ""}</td>
      <td>${r.workshop || ""}</td>
      <td>${r.expected || ""}</td>
      <td>${r.landed_date || ""}</td>
      <td>${Number(r.amount_usd || 0).toFixed(2)}</td>
      <td>${paidTag(r.paid)}</td>
      <td>${deliveredTag(r.delivered)}</td>
      <td>${r.status || "open"}</td>
      <td>${r.remarks || ""}</td>
      <td style="white-space:nowrap;">
        <button class="secondary edit-land" data-id="${r.id}" ${!canEdit?'disabled':''}>Edit</button>
        <button class="secondary toggle-paid-land" data-id="${r.id}" ${!canEdit?'disabled':''}>Paid</button>
        <button class="secondary toggle-del-land" data-id="${r.id}" ${!canEdit?'disabled':''}>Delivered</button>
        <button class="danger cancel-land" data-id="${r.id}" ${!canEdit?'disabled':''}>Cancel</button>
        <button class="danger delete-land" data-id="${r.id}" ${!canDelete?'disabled':''}>Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  attachLandActions();
}

function attachLandActions(){
  document.querySelectorAll(".edit-land").forEach(btn=>{
    btn.onclick = () => {
      const id = Number(btn.dataset.id);
      const row = allLandings.find(x=>Number(x.id)===id);
      if (!row) return;
      editingLandId = id;

      document.getElementById("landFormTitle").textContent = "Edit Landed Item";
      document.getElementById("saveLandBtn").textContent = "Update Landed Item";
      document.getElementById("cancelLandEditBtn").classList.remove("hidden");

      document.getElementById("landVessel").value = row.vessel || "";
      document.getElementById("landItem").value = row.item || "";
      document.getElementById("landWorkshop").value = row.workshop || "";
      document.getElementById("landExpected").value = row.expected || "";
      document.getElementById("landLanded").value = row.landed_date || "";
      document.getElementById("landAmount").value = row.amount_original || row.amount || 0;
      document.getElementById("landCurrency").value = row.currency || "USD";
      document.getElementById("landPaid").checked = !!row.paid;
      document.getElementById("landRemarks").value = row.remarks || "";
      window.scrollTo({top:0, behavior:"smooth"});
    };
  });

  document.querySelectorAll(".toggle-paid-land").forEach(btn=>{
    btn.onclick = async () => {
      const id = Number(btn.dataset.id);
      try{
        await apiFetch(`/api/landings/${id}/toggle_paid`, {method:"PATCH"});
        await loadAllLandings();
      }catch{ alert("Error toggling paid"); }
    };
  });

  document.querySelectorAll(".toggle-del-land").forEach(btn=>{
    btn.onclick = async () => {
      const id = Number(btn.dataset.id);
      try{
        await apiFetch(`/api/landings/${id}`, {
          method:"PATCH",
          body: JSON.stringify({ delivered: true })
        });
        await loadAllLandings();
      }catch{ alert("Error marking delivered"); }
    };
  });

  document.querySelectorAll(".cancel-land").forEach(btn=>{
    btn.onclick = async () => {
      const id = Number(btn.dataset.id);
      if (!confirm("Cancel this landed item?")) return;
      try{
        await apiFetch(`/api/landings/${id}`, {
          method:"PATCH",
          body: JSON.stringify({ status:"cancelled" })
        });
        await loadAllLandings();
      }catch{ alert("Error cancelling"); }
    };
  });

  document.querySelectorAll(".delete-land").forEach(btn=>{
    btn.onclick = async () => {
      const id = Number(btn.dataset.id);
      if (!confirm("Delete this landed item permanently?")) return;
      try{
        await apiFetch(`/api/landings/${id}`, {method:"DELETE"});
        await loadAllLandings();
      }catch{ alert("Error deleting (admin only)"); }
    };
  });
}

// cancel edit
document.getElementById("cancelLandEditBtn").onclick = () => {
  editingLandId = null;
  document.getElementById("landFormTitle").textContent = "Add Landed Item";
  document.getElementById("saveLandBtn").textContent = "Save Landed Item";
  document.getElementById("cancelLandEditBtn").classList.add("hidden");

  ["landItem","landAmount","landRemarks"].forEach(id=>document.getElementById(id).value="");
  ["landVessel","landWorkshop"].forEach(id=>document.getElementById(id).value="");
  document.getElementById("landExpected").value="";
  document.getElementById("landLanded").value="";
  document.getElementById("landCurrency").value="USD";
  document.getElementById("landPaid").checked=false;
};

// save landed item
document.getElementById("saveLandBtn").onclick = async () => {
  const err = document.getElementById("landError");
  err.textContent = "";

  const payload = {
    vessel: document.getElementById("landVessel").value.trim(),
    item: document.getElementById("landItem").value.trim(),
    workshop: document.getElementById("landWorkshop").value.trim(),
    expected: document.getElementById("landExpected").value,
    landed_date: document.getElementById("landLanded").value,
    amount: parseFloat(document.getElementById("landAmount").value || "0"),
    currency: document.getElementById("landCurrency").value || "USD",
    paid: document.getElementById("landPaid").checked,
    remarks: document.getElementById("landRemarks").value.trim(),
  };

  if (!payload.vessel || !payload.item || !payload.workshop || !payload.amount){
    err.textContent = "Please fill all required fields (*)";
    return;
  }

  try{
    if (editingLandId){
      await apiFetch(`/api/landings/${editingLandId}`, {
        method:"PATCH",
        body: JSON.stringify(payload)
      });
    } else {
      await apiFetch("/api/landings", {
        method:"POST",
        body: JSON.stringify(payload)
      });
    }
    document.getElementById("cancelLandEditBtn").onclick();
    await loadAllLandings();
  }catch(e){
    if (e.error==="login_required") err.textContent="Please login first.";
    else if (e.error==="not_allowed") err.textContent="You can edit only your own rows.";
    else err.textContent="Error saving landed item.";
  }
};

// filter buttons
document.getElementById("applyLandFilterBtn").onclick = loadAllLandings;
document.getElementById("clearLandFilterBtn").onclick = async () => {
  document.getElementById("filterLandStatus").value="";
  document.getElementById("filterLandPaid").value="";
  document.getElementById("filterLandDelivered").value="";
  document.getElementById("filterLandSearch").value="";
  await loadAllLandings();
};



/* =========================================================
   STEP 5: DIRECTORY UI + LOGIC
   ========================================================= */

let directoryRows = [];
let editingDirId = null;
let dirPopupType = null; // "supplier" or "workshop"

function showDirPopup(type, row=null){
  dirPopupType = type;
  editingDirId = row ? Number(row.id) : null;

  document.getElementById("dirPopupTitle").textContent =
    (editingDirId ? "Edit " : "New ") + (type === "supplier" ? "Supplier" : "Workshop");

  document.getElementById("dirName").value = row?.name || "";
  document.getElementById("dirEmail").value = row?.email || "";
  document.getElementById("dirPhone").value = row?.phone || "";
  document.getElementById("dirAddress").value = row?.address || "";
  document.getElementById("dirError").textContent = "";

  document.getElementById("dirBackdrop").classList.remove("hidden");
  document.getElementById("dirPopup").classList.remove("hidden");
}

function hideDirPopup(){
  document.getElementById("dirBackdrop").classList.add("hidden");
  document.getElementById("dirPopup").classList.add("hidden");
  dirPopupType = null;
  editingDirId = null;
}

document.getElementById("dirBackdrop").onclick = hideDirPopup;
document.getElementById("dirCancelBtn").onclick = hideDirPopup;

document.getElementById("dirAddSupplierBtn").onclick = ()=>showDirPopup("supplier");
document.getElementById("dirAddWorkshopBtn").onclick = ()=>showDirPopup("workshop");

// Load + render directory
async function loadDirectory(){
  try { directoryRows = await apiFetch("/api/directory"); }
  catch { directoryRows = []; }

  const tbody = document.querySelector("#dirTable tbody");
  tbody.innerHTML = "";

  directoryRows.forEach(r=>{
    const canEdit = currentUser && (currentUser.role === "admin" || r.created_by === currentUser.username);
    const canDelete = currentUser && currentUser.role === "admin";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.id}</td>
      <td>${r.type}</td>
      <td>${r.name}</td>
      <td>${r.email || ""}</td>
      <td>${r.phone || ""}</td>
      <td>${r.address || ""}</td>
      <td style="white-space:nowrap;">
        <button class="secondary edit-dir" data-id="${r.id}" ${!canEdit?'disabled':''}>Edit</button>
        <button class="danger delete-dir" data-id="${r.id}" ${!canDelete?'disabled':''}>Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  document.querySelectorAll(".edit-dir").forEach(btn=>{
    btn.onclick = ()=>{
      const id = Number(btn.dataset.id);
      const row = directoryRows.find(x=>Number(x.id)===id);
      if (!row) return;
      showDirPopup(row.type, row);
    };
  });

  document.querySelectorAll(".delete-dir").forEach(btn=>{
    btn.onclick = async ()=>{
      const id = Number(btn.dataset.id);
      if (!confirm("Delete this entry?")) return;
      try{
        await apiFetch(`/api/directory/${id}`, {method:"DELETE"});
        await loadDirectory();
        // refresh form dropdowns too
        await loadSuppliers();
        await loadWorkshops();
      }catch{
        alert("Delete failed (admin only).");
      }
    };
  });
}

// Save popup
document.getElementById("dirSaveBtn").onclick = async ()=>{
  const err = document.getElementById("dirError");
  err.textContent = "";

  const payload = {
    type: dirPopupType,
    name: document.getElementById("dirName").value.trim(),
    email: document.getElementById("dirEmail").value.trim(),
    phone: document.getElementById("dirPhone").value.trim(),
    address: document.getElementById("dirAddress").value.trim(),
  };

  if (!payload.type || !payload.name){
    err.textContent = "Name is required.";
    return;
  }

  try{
    if (editingDirId){
      await apiFetch(`/api/directory/${editingDirId}`, {
        method:"PATCH",
        body: JSON.stringify(payload)
      });
    }else{
      await apiFetch("/api/directory", {
        method:"POST",
        body: JSON.stringify(payload)
      });
    }
    hideDirPopup();
    await loadDirectory();
    await loadSuppliers();
    await loadWorkshops();
  }catch(e){
    if (e.error==="login_required") err.textContent="Please login first.";
    else if (e.error==="not_allowed") err.textContent="You can edit only your own entries.";
    else err.textContent="Error saving entry.";
  }
};



/* =========================================================
   STEP 6: DELIVERED UI + LOGIC
   ========================================================= */

// Delivered Requisitions
async function loadDeliveredRequisitions(){
  let rows = allReqs;
  if (!rows || !rows.length){
    try{ rows = await apiFetch("/api/requisitions"); }
    catch{ rows = []; }
  }
  const paidF = document.getElementById("filterDelReqPaid").value;
  const search = document.getElementById("filterDelReqSearch").value.toLowerCase().trim();

  const tbody = document.querySelector("#delReqTable tbody");
  tbody.innerHTML = "";

  rows.filter(r=>!!r.delivered).forEach(r=>{
    const matchesPaid = paidF === "" || String(r.paid || 0) === paidF;
    const matchesSearch =
      !search ||
      (r.number||"").toLowerCase().includes(search) ||
      (r.vessel||"").toLowerCase().includes(search) ||
      (r.supplier||"").toLowerCase().includes(search);
    if(!(matchesPaid && matchesSearch)) return;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.id}</td>
      <td>${r.number||""}</td>
      <td>${r.vessel||""}</td>
      <td>${r.category||""}</td>
      <td>${r.supplier||""}</td>
      <td>${r.date_ordered||""}</td>
      <td>${r.expected||""}</td>
      <td>${Number(r.amount_usd||0).toFixed(2)}</td>
      <td>${paidTag(r.paid)}</td>
      <td>${r.status||"open"}</td>
      <td>${r.po_number||""}</td>
      <td>${r.urgency||"normal"}</td>
      <td>${r.remarks||""}</td>
    `;
    tbody.appendChild(tr);
  });
}

document.getElementById("applyDelReqFilterBtn").onclick = loadDeliveredRequisitions;
document.getElementById("clearDelReqFilterBtn").onclick = async ()=>{
  document.getElementById("filterDelReqPaid").value="";
  document.getElementById("filterDelReqSearch").value="";
  await loadDeliveredRequisitions();
};

// Delivered Landings
async function loadDeliveredLandings(){
  let rows = allLandings;
  if (!rows || !rows.length){
    try{ rows = await apiFetch("/api/landings"); }
    catch{ rows = []; }
  }
  const paidF = document.getElementById("filterDelLandPaid").value;
  const search = document.getElementById("filterDelLandSearch").value.toLowerCase().trim();

  const tbody = document.querySelector("#delLandTable tbody");
  tbody.innerHTML = "";

  rows.filter(r=>!!r.delivered).forEach(r=>{
    const matchesPaid = paidF === "" || String(r.paid || 0) === paidF;
    const matchesSearch =
      !search ||
      (r.vessel||"").toLowerCase().includes(search) ||
      (r.item||"").toLowerCase().includes(search) ||
      (r.workshop||"").toLowerCase().includes(search);
    if(!(matchesPaid && matchesSearch)) return;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.id}</td>
      <td>${r.vessel||""}</td>
      <td>${r.item||""}</td>
      <td>${r.workshop||""}</td>
      <td>${r.expected||""}</td>
      <td>${r.landed_date||""}</td>
      <td>${Number(r.amount_usd||0).toFixed(2)}</td>
      <td>${paidTag(r.paid)}</td>
      <td>${r.status||"open"}</td>
      <td>${r.remarks||""}</td>
    `;
    tbody.appendChild(tr);
  });
}

document.getElementById("applyDelLandFilterBtn").onclick = loadDeliveredLandings;
document.getElementById("clearDelLandFilterBtn").onclick = async ()=>{
  document.getElementById("filterDelLandPaid").value="";
  document.getElementById("filterDelLandSearch").value="";
  await loadDeliveredLandings();
};



/* =========================================================
   STEP 7: ADMIN UI + LOGIC (categories, vessels, users)
   ========================================================= */

let editingCatId = null;
let editingVesselId = null;

/* ---------- Admin gate helper ---------- */
function isAdmin(){
  return currentUser && currentUser.role === "admin";
}
function guardAdmin(){
  if (!isAdmin()){
    alert("Admin only.");
    return false;
  }
  return true;
}

/* ---------- Categories ---------- */
async function renderCategories(){
  let cats = [];
  try { cats = await apiFetch("/api/categories"); }
  catch { cats = []; }

  const tbody = document.querySelector("#catTable tbody");
  tbody.innerHTML = "";
  cats.forEach(c=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${c.id}</td>
      <td>${c.name}</td>
      <td>${c.abbr}</td>
      <td style="white-space:nowrap;">
        <button class="secondary edit-cat" data-id="${c.id}">Edit</button>
        <button class="danger delete-cat" data-id="${c.id}">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  // disable if not admin
  if (!isAdmin()){
    document.querySelectorAll(".edit-cat,.delete-cat").forEach(b=>b.disabled=true);
  }

  document.querySelectorAll(".edit-cat").forEach(btn=>{
    btn.onclick = ()=>{
      if (!guardAdmin()) return;
      const id = Number(btn.dataset.id);
      const c = cats.find(x=>Number(x.id)===id);
      if (!c) return;
      editingCatId = id;
      document.getElementById("catName").value = c.name;
      document.getElementById("catAbbr").value = c.abbr;
      document.getElementById("cancelCatEditBtn").classList.remove("hidden");
      document.getElementById("saveCatBtn").textContent = "Update Category";
      window.scrollTo({top:0, behavior:"smooth"});
    };
  });

  document.querySelectorAll(".delete-cat").forEach(btn=>{
    btn.onclick = async ()=>{
      if (!guardAdmin()) return;
      const id = Number(btn.dataset.id);
      if (!confirm("Delete this category?")) return;
      try{
        await apiFetch(`/api/categories/${id}`, {method:"DELETE"});
        await renderCategories();
        await loadCategories(); // refresh req dropdown
      }catch(e){
        alert("Delete failed.");
      }
    };
  });
}

document.getElementById("saveCatBtn").onclick = async ()=>{
  if (!guardAdmin()) return;
  const err = document.getElementById("catError");
  err.textContent = "";

  const name = document.getElementById("catName").value.trim();
  const abbr = document.getElementById("catAbbr").value.trim();

  if (!name || !abbr){
    err.textContent = "Name and abbreviation required.";
    return;
  }

  try{
    if (editingCatId){
      await apiFetch(`/api/categories/${editingCatId}`, {
        method:"PATCH", body: JSON.stringify({name, abbr})
      });
    }else{
      await apiFetch("/api/categories", {
        method:"POST", body: JSON.stringify({name, abbr})
      });
    }
    editingCatId = null;
    document.getElementById("catName").value="";
    document.getElementById("catAbbr").value="";
    document.getElementById("cancelCatEditBtn").classList.add("hidden");
    document.getElementById("saveCatBtn").textContent = "Save Category";
    await renderCategories();
    await loadCategories();
  }catch(e){
    if (e.error==="duplicate_abbr") err.textContent="Abbreviation already exists.";
    else if (e.error==="admin_required") err.textContent="Admin only.";
    else err.textContent="Error saving category.";
  }
};

document.getElementById("cancelCatEditBtn").onclick = ()=>{
  editingCatId = null;
  document.getElementById("catName").value="";
  document.getElementById("catAbbr").value="";
  document.getElementById("cancelCatEditBtn").classList.add("hidden");
  document.getElementById("saveCatBtn").textContent = "Save Category";
};

/* ---------- Vessels ---------- */
async function renderVessels(){
  let vs = [];
  try { vs = await apiFetch("/api/vessels"); }
  catch { vs = []; }

  vessels = vs; // keep global list updated for dropdowns

  const tbody = document.querySelector("#vesselTable tbody");
  tbody.innerHTML = "";
  vs.forEach(v=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${v.id}</td>
      <td>${v.name}</td>
      <td style="white-space:nowrap;">
        <button class="secondary edit-vessel" data-id="${v.id}">Edit</button>
        <button class="danger delete-vessel" data-id="${v.id}">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  if (!isAdmin()){
    document.querySelectorAll(".edit-vessel,.delete-vessel").forEach(b=>b.disabled=true);
  }

  document.querySelectorAll(".edit-vessel").forEach(btn=>{
    btn.onclick = ()=>{
      if (!guardAdmin()) return;
      const id = Number(btn.dataset.id);
      const v = vs.find(x=>Number(x.id)===id);
      if (!v) return;
      editingVesselId = id;
      document.getElementById("vesselName").value = v.name;
      document.getElementById("cancelVesselEditBtn").classList.remove("hidden");
      document.getElementById("saveVesselBtn").textContent = "Update Vessel";
      window.scrollTo({top:0, behavior:"smooth"});
    };
  });

  document.querySelectorAll(".delete-vessel").forEach(btn=>{
    btn.onclick = async ()=>{
      if (!guardAdmin()) return;
      const id = Number(btn.dataset.id);
      if (!confirm("Delete this vessel?")) return;
      try{
        await apiFetch(`/api/vessels/${id}`, {method:"DELETE"});
        await renderVessels();
        await loadVessels();
        fillLandingVessels();
      }catch{
        alert("Delete failed.");
      }
    };
  });
}

document.getElementById("saveVesselBtn").onclick = async ()=>{
  if (!guardAdmin()) return;
  const err = document.getElementById("vesselError");
  err.textContent = "";
  const name = document.getElementById("vesselName").value.trim();
  if (!name){
    err.textContent = "Vessel name required.";
    return;
  }
  try{
    if (editingVesselId){
      await apiFetch(`/api/vessels/${editingVesselId}`, {
        method:"PATCH", body: JSON.stringify({name})
      });
    }else{
      await apiFetch("/api/vessels", {
        method:"POST", body: JSON.stringify({name})
      });
    }
    editingVesselId = null;
    document.getElementById("vesselName").value="";
    document.getElementById("cancelVesselEditBtn").classList.add("hidden");
    document.getElementById("saveVesselBtn").textContent = "Save Vessel";
    await renderVessels();
    await loadVessels();
    fillLandingVessels();
  }catch(e){
    if (e.error==="duplicate_name") err.textContent="This vessel already exists.";
    else if (e.error==="admin_required") err.textContent="Admin only.";
    else err.textContent="Error saving vessel.";
  }
};

document.getElementById("cancelVesselEditBtn").onclick = ()=>{
  editingVesselId = null;
  document.getElementById("vesselName").value="";
  document.getElementById("cancelVesselEditBtn").classList.add("hidden");
  document.getElementById("saveVesselBtn").textContent = "Save Vessel";
};

/* ---------- Users ---------- */
async function renderUsers(){
  let users = [];
  try { users = await apiFetch("/api/users"); }
  catch { users = []; }

  const tbody = document.querySelector("#userTable tbody");
  tbody.innerHTML = "";

  users.forEach(u=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${u.username}</td>
      <td>${u.role}</td>
      <td style="white-space:nowrap;">
        <button class="danger delete-user" data-username="${u.username}">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  if (!isAdmin()){
    document.querySelectorAll(".delete-user").forEach(b=>b.disabled=true);
  }

  document.querySelectorAll(".delete-user").forEach(btn=>{
    btn.onclick = async ()=>{
      if (!guardAdmin()) return;
      const username = btn.dataset.username;
      if (!confirm(`Delete user "${username}"?`)) return;
      try{
        await apiFetch(`/api/users/${username}`, {method:"DELETE"});
        await renderUsers();
      }catch{
        alert("Delete failed.");
      }
    };
  });
}

document.getElementById("saveUserBtn").onclick = async ()=>{
  if (!guardAdmin()) return;
  const err = document.getElementById("userError");
  err.textContent = "";

  const username = document.getElementById("adminUsername").value.trim();
  const password = document.getElementById("adminPassword").value;
  const role = document.getElementById("adminRole").value;

  if (!username || !password){
    err.textContent = "Username and password required.";
    return;
  }

  try{
    await apiFetch("/api/users", {
      method:"POST",
      body: JSON.stringify({username, password, role})
    });
    document.getElementById("adminUsername").value="";
    document.getElementById("adminPassword").value="";
    document.getElementById("adminRole").value="user";
    await renderUsers();
  }catch(e){
    if (e.error==="admin_required") err.textContent="Admin only.";
    else err.textContent="Error saving user.";
  }
};

/* ---------- Enable/disable admin inputs on session refresh ---------- */
function setAdminInputsEnabled(){
  const enabled = isAdmin();
  ["catName","catAbbr","saveCatBtn","cancelCatEditBtn",
   "vesselName","saveVesselBtn","cancelVesselEditBtn",
   "adminUsername","adminPassword","adminRole","saveUserBtn"].forEach(id=>{
     const el = document.getElementById(id);
     if (el) el.disabled = !enabled;
   });
}



/* =========================================================
   STEP 8: OVERVIEW TOTALS FILTERS + TOP 5 SUPPLIERS (NO CHARTS)
   ========================================================= */

function parseDateSafe(d){
  if(!d) return null;
  const dt = new Date(d);
  return isNaN(dt.getTime()) ? null : dt;
}
function quarterOfMonth(m){
  if (m<=3) return "Q1";
  if (m<=6) return "Q2";
  if (m<=9) return "Q3";
  return "Q4";
}

async function loadOverviewTotalsFilters(){
  // Ensure data
  let reqs = allReqs;
  let lands = allLandings;
  if (!reqs || !reqs.length){
    try{ reqs = await apiFetch("/api/requisitions"); } catch { reqs=[]; }
  }
  if (!lands || !lands.length){
    try{ lands = await apiFetch("/api/landings"); } catch { lands=[]; }
  }

  // Categories from reqs only (landings don't have category in your spec)
  const catSet = new Set(reqs.map(r=>(r.category||"").trim()).filter(Boolean));
  const catSel = document.getElementById("ovCategoryFilter");
  if (catSel){
    catSel.innerHTML = `<option value="">All categories</option>` +
      [...catSet].sort().map(c=>`<option value="${c}">${c}</option>`).join("");
  }

  // Vessels from both
  const vesselSet = new Set();
  reqs.forEach(r=>vesselSet.add((r.vessel||"").trim()));
  lands.forEach(r=>vesselSet.add((r.vessel||"").trim()));
  const vesselSel = document.getElementById("ovVesselFilter");
  if (vesselSel){
    vesselSel.innerHTML = `<option value="">All</option>` +
      [...vesselSet].filter(Boolean).sort().map(v=>`<option value="${v}">${v}</option>`).join("");
  }

  // Years from both
  const yearSet = new Set();
  reqs.forEach(r=>{
    const dt = parseDateSafe(r.date_ordered);
    if (dt) yearSet.add(dt.getFullYear());
  });
  lands.forEach(r=>{
    const dt = parseDateSafe(r.landed_date);
    if (dt) yearSet.add(dt.getFullYear());
  });
  const yearSel = document.getElementById("ovYearFilter");
  if (yearSel){
    yearSel.innerHTML = `<option value="">All years</option>` +
      [...yearSet].sort((a,b)=>b-a).map(y=>`<option value="${y}">${y}</option>`).join("");
  }

  updateOverviewPaidTotals(reqs, lands);
}

function updateOverviewPaidTotals(reqs, lands){
  const typeF = document.getElementById("ovTypeFilter").value;      // "", "req", "land"
  const vesselF = document.getElementById("ovVesselFilter").value;  // vessel or ""
  const paidF = document.getElementById("ovPaidFilter").value;      // "", "1", "0"
  const monthF = document.getElementById("ovMonthFilter").value;    // "", "1".."12"
  const quarterF = document.getElementById("ovQuarterFilter").value; 
  const yearF = document.getElementById("ovYearFilter").value;      // "", "2025"...
  const categoryF = document.getElementById("ovCategoryFilter").value;

  let filtered = [];

  if (!typeF || typeF==="req"){
    filtered = filtered.concat(reqs.map(r=>({
      _type:"req",
      vessel:r.vessel,
      category:r.category,
      supplier:r.supplier,
      paid:Number(r.paid||0),
      amount:Number(r.amount_usd||0),
      date:r.date_ordered
    })));
  }
  if (!typeF || typeF==="land"){
    filtered = filtered.concat(lands.map(r=>({
      _type:"land",
      vessel:r.vessel,
      category:"", // no category for landings
      supplier:r.workshop || r.supplier,
      paid:Number(r.paid||0),
      amount:Number(r.amount_usd||0),
      date:r.landed_date
    })));
  }

  filtered = filtered.filter(x=>{
    if (vesselF && (x.vessel||"") !== vesselF) return false;
    if (paidF!=="" && String(x.paid)!==paidF) return false;

    const dt = parseDateSafe(x.date);
    if (!dt) return false;

    const mm = dt.getMonth()+1;
    const yy = dt.getFullYear();
    const qq = quarterOfMonth(mm);

    if (yearF && String(yy)!==yearF) return false;

    if (monthF){
      if (String(mm)!==monthF) return false;
    } else if (quarterF){
      if (qq!==quarterF) return false;
    }

    if (categoryF && (x.category||"")!==categoryF) return false;

    return true;
  });

  const allTotal = filtered.reduce((s,x)=>s + x.amount, 0);
  const paidOnly = filtered.filter(x=>x.paid===1);
  const paidPeriodTotal = paidOnly.reduce((s,x)=>s + x.amount, 0);

  document.getElementById("ovAllTotal").textContent = allTotal.toFixed(2);
  document.getElementById("ovPaidPeriodTotal").textContent = paidPeriodTotal.toFixed(2);

  // Top 5 suppliers
  const supMap = {};
  filtered.forEach(x=>{
    const name = x.supplier || "Unknown";
    supMap[name] = (supMap[name]||0) + x.amount;
  });
  const topSup = Object.entries(supMap).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const ul = document.getElementById("ovTopSuppliers");
  ul.innerHTML = topSup.length
    ? topSup.map(([k,v])=>`<li>${k}: $${v.toFixed(2)}</li>`).join("")
    : "<li>â€”</li>";
}

document.getElementById("ovApplyTotalsBtn").onclick = async ()=>{
  let reqs = allReqs, lands = allLandings;
  if (!reqs.length){ try{ reqs = await apiFetch("/api/requisitions"); } catch{ reqs=[]; } }
  if (!lands.length){ try{ lands = await apiFetch("/api/landings"); } catch{ lands=[]; } }
  updateOverviewPaidTotals(reqs, lands);
};
document.getElementById("ovClearTotalsBtn").onclick = async ()=>{
  document.getElementById("ovTypeFilter").value="";
  document.getElementById("ovVesselFilter").value="";
  document.getElementById("ovPaidFilter").value="";
  document.getElementById("ovMonthFilter").value="";
  document.getElementById("ovQuarterFilter").value="";
  document.getElementById("ovCategoryFilter").value="";
  document.getElementById("ovYearFilter").value="";
  await loadOverviewTotalsFilters();
};


/* ================== Init ================== */
(async function init(){
  await refreshSession();
  await loadCurrencies();
  await loadCategories();
  await loadVessels();
  await loadSuppliers();
  fillLandingVessels();
  await loadWorkshops();
  fillLandingCurrencies();
  await loadAllRequisitions();
  await loadAllLandings();
  await loadDeliveredRequisitions();
  await loadDeliveredLandings();
  await loadOverviewTotalsFilters();
  await loadDirectory();
  if (currentUser && currentUser.role === 'admin') {
    await renderCategories();
    await renderVessels();
    await renderUsers();
  }
  setAdminInputsEnabled();
})();
</script>

</body>
</html>
