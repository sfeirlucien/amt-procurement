<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AMT Procurement Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link rel="icon" type="image/png" href="static/ICON.jpg">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* === PROFESSIONAL DESIGN SYSTEM === */
    :root {
      --primary: #0f172a;       /* Slate 900 */
      --primary-light: #334155; /* Slate 700 */
      --accent: #2563eb;        /* Royal Blue */
      --accent-hover: #1d4ed8;
      --success: #10b981;       /* Emerald */
      --warning: #f59e0b;       /* Amber */
      --danger: #ef4444;        /* Red */
      
      --bg-body: #f1f5f9;       /* Slate 100 */
      --bg-card: #ffffff;
      --bg-header: #ffffff;
      
      --text-main: #334155;     /* Slate 700 */
      --text-muted: #64748b;    /* Slate 500 */
      --text-header: #0f172a;
      
      --border: #e2e8f0;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --radius: 8px;
    }

    body.dark-mode {
      --primary: #f8fafc; 
      --bg-body: #0f172a;
      --bg-card: #1e293b;
      --bg-header: #1e293b;
      --text-main: #cbd5e1;
      --text-muted: #94a3b8;
      --text-header: #f1f5f9;
      --border: #334155;
      --shadow-sm: none;
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.5);
    }

    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin:0; background: var(--bg-body); color: var(--text-main); padding-bottom: 80px; transition: background 0.3s, color 0.3s; font-size: 14px; line-height: 1.5; }
    * { box-sizing: border-box; }
    
    header { background: var(--bg-header); border-bottom: 1px solid var(--border); padding: 0 24px; height: 64px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 50; box-shadow: var(--shadow-sm); }
    header h1 { margin:0; font-size: 20px; font-weight: 700; color: var(--text-header); letter-spacing: -0.5px; }
    .logo-area { display: flex; align-items: center; gap: 12px; }
    .logo-img { height: 40px; width: auto; border-radius: 4px; }
    
    .container { max-width: 1400px; margin: 24px auto; padding: 0 20px; }
    
    .tabs-wrapper { background: var(--primary); padding: 0 20px; box-shadow: var(--shadow-md); margin-bottom: 24px; border-radius: var(--radius); overflow: hidden; }
    .tabs { display:flex; overflow-x: auto; white-space: nowrap; }
    .tabs::-webkit-scrollbar { height: 0px; }
    .tab { padding: 16px 20px; color: #94a3b8; cursor: pointer; font-weight: 500; font-size: 14px; transition: all 0.2s; border-bottom: 3px solid transparent; }
    .tab:hover { color: #fff; background: rgba(255,255,255,0.05); }
    .tab.active { color: #fff; border-bottom-color: var(--accent); background: rgba(255,255,255,0.1); }

    .card { background: var(--bg-card); padding: 24px; margin-bottom: 24px; border-radius: var(--radius); box-shadow: var(--shadow-sm); border: 1px solid var(--border); transition: transform 0.2s, box-shadow 0.2s; }
    .card h2 { margin-top:0; font-size: 18px; font-weight: 600; color: var(--text-header); margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; }
    .card h3 { font-size: 15px; font-weight: 600; color: var(--text-main); margin-bottom: 10px; margin-top: 0; }

    label { display: block; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 6px; }
    input, select, textarea { width: 100%; padding: 10px 12px; font-size: 14px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-body); color: var(--text-header); transition: border 0.2s, box-shadow 0.2s; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
    
    button { padding: 8px 16px; font-size: 14px; font-weight: 600; border-radius: 6px; border: none; cursor: pointer; background: var(--accent); color: white; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; justify-content: center; }
    button:hover { background: var(--accent-hover); transform: translateY(-1px); }
    
    button.secondary { background: var(--bg-body); color: var(--text-main); border: 1px solid var(--border); }
    button.secondary:hover { background: #e2e8f0; color: #0f172a; }
    
    button.danger { background: var(--danger); color: white; }
    button.danger:hover { background: #dc2626; }
    
    button.success { background: var(--success); color: white; }
    button.success:hover { background: #059669; }
    
    button.warning { background: var(--warning); color: #fff; }
    button.warning:hover { background: #d97706; }
    
    button.small-action { padding: 4px 8px; font-size: 11px; }

    .table-container { overflow-x: auto; border: 1px solid var(--border); border-radius: var(--radius); }
    table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 900px; }
    
    th { background: var(--bg-body); font-weight: 600; color: var(--text-muted); text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px; padding: 12px 16px; text-align: left; border-bottom: 2px solid var(--border); cursor: pointer; user-select: none; position: relative; }
    th:hover { background: #e2e8f0; color: var(--text-header); }
    
    td { border-bottom: 1px solid var(--border); padding: 12px 16px; color: var(--text-main); vertical-align: middle; white-space: nowrap; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: rgba(37, 99, 235, 0.02); }
    .clickable-link { color: var(--accent); text-decoration: underline; cursor: pointer; }

    .tag { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .tag.green { background: #d1fae5; color: #065f46; }
    .tag.red { background: #fee2e2; color: #991b1b; }
    .tag.yellow { background: #fef3c7; color: #92400e; }
    .tag.gray { background: #f1f5f9; color: #475569; }

    .urgency-high { border-left: 3px solid var(--danger); }
    .high-icon { color: var(--danger); font-weight:bold; margin-right:5px; }

    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
    .summary-item { background: var(--bg-body); padding: 20px; border-radius: var(--radius); border: 1px solid var(--border); display: flex; flex-direction: column; }
    .summary-label { font-size: 12px; font-weight: 600; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px; }
    .summary-value { font-size: 28px; font-weight: 700; color: var(--text-header); letter-spacing: -1px; }

    ul.top-list { list-style: none; padding: 0; margin: 0; }
    ul.top-list li { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
    ul.top-list li:last-child { border-bottom: none; }
    ul.top-list strong { color: var(--text-header); }

    .bulk-bar { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 12px 24px; border-radius: 50px; box-shadow: var(--shadow-md); display: flex; gap: 16px; align-items: center; z-index: 100; opacity: 0; pointer-events: none; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .bulk-bar.visible { opacity: 1; pointer-events: auto; bottom: 40px; }
    .bulk-bar span { font-weight: 600; border-right: 1px solid rgba(255,255,255,0.2); padding-right: 16px; }

    /* === GLOBAL FLOATING DROPDOWN === */
    .drop-btn { background: transparent; color: var(--text-muted); border: 1px solid var(--border); padding: 4px 8px; font-size: 16px; }
    .drop-btn:hover { background: var(--bg-body); color: var(--accent); }
    
    #globalActionMenu {
        display: none;
        position: fixed; 
        background: var(--bg-card);
        min-width: 180px;
        box-shadow: var(--shadow-md);
        border-radius: 6px;
        border: 1px solid var(--border);
        z-index: 9999;
        /* SCROLL FIX */
        max-height: 300px;
        overflow-y: auto;
    }
    #globalActionMenu.show { display: block; animation: fadeIn 0.1s ease-out; }
    #globalActionMenu button { 
        display: block; width: 100%; text-align: left; padding: 12px 16px; 
        background: none; border: none; border-bottom: 1px solid var(--border); 
        font-size: 13px; color: var(--text-main); font-weight: 500; 
    }
    #globalActionMenu button:hover { background: var(--bg-body); color: var(--accent); }
    #globalActionMenu button:last-child { border-bottom: none; }

    .popup-backdrop { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); z-index: 40; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
    .popup-backdrop.visible { opacity: 1; pointer-events: auto; }
    .popup { background: var(--bg-card); width: 95%; max-width: 650px; max-height: 90vh; overflow-y: auto; border-radius: 12px; padding: 32px; box-shadow: var(--shadow-md); transform: scale(0.95); transition: transform 0.2s; }
    .popup-backdrop.visible .popup { transform: scale(1); }

    .hidden { display: none !important; }
    .flex-row { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 16px; }
    .flex-1 { flex: 1 1 200px; }
    .error { color: var(--danger); font-size: 13px; margin-top: 8px; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

<div id="globalActionMenu" onclick="event.stopPropagation()"></div>

<header>
  <div class="logo-area">
    <img src="static/ICON.jpg" alt="Logo" class="logo-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
    <div style="width:32px; height:32px; background:var(--accent); border-radius:6px; display:none; align-items:center; justify-content:center; color:white; font-weight:bold;">A</div>
    <h1>AMT Procurement</h1>
  </div>
  <div style="display:flex; gap:16px; align-items:center;">
    <div id="userInfo" style="font-size:13px; font-weight:500;"></div>
    <button class="secondary" id="darkModeBtn" style="padding:6px 12px;" title="Toggle Theme">üåó</button>
  </div>
</header>

<div class="container">
  <div class="tabs-wrapper">
    <div class="tabs">
      <div class="tab active" data-tab="overview">Dashboard</div>
      <div class="tab" data-tab="requisitions">Orders</div>
      <div class="tab" data-tab="landings" id="tabLinkLandings">Landings</div>
      <div class="tab" data-tab="directory" id="tabLinkDirectory">Directory</div>
      <div class="tab" data-tab="delivered" id="tabLinkHistory">History</div>
      <div class="tab hidden" data-tab="admin" id="adminTab">Admin</div>
    </div>
  </div>

  <div id="bulkActionBar" class="bulk-bar">
    <span><strong id="bulkCount">0</strong> Selected</span>
    <button class="success" id="bulkMarkPaidBtn">Paid</button>
    <button class="warning" id="bulkMarkPartialBtn">Partial</button>
    <button class="success" id="bulkMarkDeliveredBtn">Full Delivery</button>
    <button class="secondary" id="bulkMarkUnpaidBtn">Unpaid</button>
    <button class="danger" id="bulkCancelBtn" style="margin-left:8px;">‚úï</button>
  </div>

  <div id="tab-overview" class="tab-content">
    <div class="card">
      <h2><span>üìä Performance Overview</span> <div style="display:flex; gap:10px;"><button id="showAgingBtn" class="warning">üïí Aging Report</button><button id="openChartBtn" class="secondary">üìà Analytics Studio</button></div></h2>
      <div class="summary-grid">
        <div class="summary-item"><div class="summary-label">Pending Orders</div><div class="summary-value" id="summaryOpenReqNotDel">0</div></div>
        <div class="summary-item"><div class="summary-label">Unpaid Orders</div><div class="summary-value" id="summaryOpenReqUnpaid" style="color:var(--danger)">0</div></div>
        <div class="summary-item"><div class="summary-label">Pending Landings</div><div class="summary-value" id="summaryOpenLandNotDel">0</div></div>
        <div class="summary-item"><div class="summary-label">Unpaid Landings</div><div class="summary-value" id="summaryOpenLandUnpaid" style="color:var(--danger)">0</div></div>
      </div>
    </div>
    
    <div class="card">
        <h2>Financial Summary</h2>
        <div class="flex-row" style="background:var(--bg-body); padding:16px; border-radius:8px; align-items:flex-end;">
          <div style="flex:1"><label>Type</label><select id="ovTypeFilter"><option value="">All</option><option value="req">Orders</option><option value="land">Landings</option></select></div>
          <div style="flex:1"><label>Vessel</label><select id="ovVesselFilter"><option value="">All</option></select></div>
          <div style="flex:1"><label>Payment Status</label><select id="ovPaidFilter"><option value="">All</option><option value="1">Paid</option><option value="0">Unpaid</option></select></div>
          <div style="flex:1"><label>Month</label><select id="ovMonthFilter"><option value="">All</option></select></div>
          <div style="flex:1"><label>Year</label><select id="ovYearFilter"><option value="">All</option></select></div>
          <div><button id="ovApplyTotalsBtn">Apply Filter</button></div>
        </div>

        <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px; margin-top:20px;">
           <div class="summary-grid">
             <div class="summary-item"><div class="summary-label">Filtered Total</div><div class="summary-value" id="ovAllTotal">$0.00</div></div>
             <div class="summary-item"><div class="summary-label">Paid (Filtered)</div><div class="summary-value" id="ovPaidMonthTotal" style="color:var(--success)">$0.00</div></div>
             <div class="summary-item"><div class="summary-label">Unpaid (Filtered)</div><div class="summary-value" id="ovUnpaidMonthTotal" style="color:var(--danger)">$0.00</div></div>
           </div>
           
           <div style="background:var(--bg-body); padding:16px; border-radius:var(--radius); border:1px solid var(--border);">
              <h3>Top 5 Suppliers (by Amount)</h3>
              <ul id="ovTopSuppliers" class="top-list"><li>No data available</li></ul>
           </div>
        </div>
    </div>
  </div>

  <div id="tab-requisitions" class="tab-content hidden">
    <div class="card" id="reqAddCard">
      <h2 id="reqFormTitle">New Requisition</h2>
      <div class="flex-row">
        <div class="flex-1"><label>PO Number</label><input type="text" id="reqPONumber" placeholder="Auto or Manual" /></div>
        <div class="flex-1"><label>Internal Ref</label><input type="text" id="reqNumber" placeholder="Req #" /></div>
        <div class="flex-1"><label>Vessel</label><select id="reqVessel"></select></div>
        <div class="flex-1"><label>Category</label><select id="reqCategory"></select></div>
      </div>
      <div class="flex-row">
         <div class="flex-1"><label>Description</label><input type="text" id="reqDescription" placeholder="Item details..." /></div>
         <div class="flex-1"><label>Supplier / Workshop</label><div style="display:flex; gap:8px;"><select id="reqSupplierSelect" style="flex:1;"></select><button id="newSupplierBtn" type="button" class="secondary" title="Add New">+</button></div></div>
      </div>
      <div class="flex-row">
         <div class="flex-1"><label>Ordered Date</label><input type="date" id="reqDateOrdered" /></div>
         <div class="flex-1"><label>Expected Date</label><input type="date" id="reqExpected" /></div>
         <div class="flex-1"><label>Amount</label><input type="number" id="reqTotal" step="0.01" /></div>
         <div class="flex-1"><label>Currency</label><select id="reqCurrency"></select></div>
      </div>
      <div class="flex-row">
        <div class="flex-1"><label>Tracking URL</label><input type="text" id="reqTracking" placeholder="https://..." /></div>
        <div class="flex-1"><label>Urgency</label><select id="reqUrgency"><option value="normal">Normal</option><option value="high">High</option></select></div>
        <div class="flex-1"><label>Remarks / Delivery Note</label><input type="text" id="reqRemarks" placeholder="Notes..." /></div>
      </div>
      <div style="display:flex; justify-content: flex-end; gap:12px; margin-top:20px;">
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
          <input type="checkbox" id="reqPaid" style="width:auto; margin:0;"/> Mark as Paid
        </label>
        <button id="cancelReqEditBtn" class="secondary hidden" type="button">Cancel</button>
        <button id="saveReqBtn" class="success">Save Order</button>
      </div>
      <div id="reqError" class="error"></div>
    </div>

    <div class="card">
      <div style="display:flex; justify-content:space-between; margin-bottom:16px;">
        <h2 style="margin:0;">Orders List (Active)</h2>
        <button id="exportReqBtn" class="secondary">‚¨á Export CSV</button>
      </div>
      <div class="flex-row" style="background:var(--bg-body); padding:16px; border-radius:8px; align-items:flex-end;">
        <div style="flex:1;"><label>Status</label><select id="filterReqStatus"><option value="">All</option><option value="open">Open</option><option value="cancelled">Cancelled</option></select></div>
        <div style="flex:1;"><label>Payment</label><select id="filterReqPaid"><option value="">All</option><option value="1">Paid</option><option value="0">Unpaid</option></select></div>
        <div style="flex:2;"><label>Search</label><input type="text" id="filterReqSearch" placeholder="Search PO, Vessel, Supplier..." /></div>
        <div style="display:flex; gap:8px;"><button id="applyReqFilterBtn">Filter</button><button id="clearReqFilterBtn" class="secondary">Clear</button></div>
      </div>
      <div class="table-container">
        <table id="reqTable">
          <thead>
            <tr>
              <th style="width:40px;"><input type="checkbox" id="reqSelectAll" /></th>
              <th onclick="sortTable(this,1)">PO #</th>
              <th onclick="sortTable(this,2)">Category</th>
              <th onclick="sortTable(this,3)">Description</th>
              <th onclick="sortTable(this,4)">Vessel</th>
              <th onclick="sortTable(this,5)">Supplier</th>
              <th onclick="sortTable(this,6)">Ordered</th>
              <th onclick="sortTable(this,7)">Amount ($)</th>
              <th onclick="sortTable(this,8)">Payment</th>
              <th onclick="sortTable(this,9)">Delivery</th>
              <th style="width:50px;"></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h2>Delivered History</h2>
      <div class="flex-row" style="background:var(--bg-body); padding:16px; border-radius:8px; align-items:flex-end;">
         <div style="flex:1;"><label>Vessel</label><select id="filterDelVessel"><option value="">All</option></select></div>
         <div style="flex:2;"><label>Search</label><input type="text" id="filterDelSearch" placeholder="Search PO, Description..." /></div>
         <div style="display:flex; gap:8px;"><button id="applyDelFilterBtn">Filter</button></div>
      </div>
      <div class="table-container" style="max-height:500px; overflow-y:auto;">
        <table id="deliveredHistoryTable">
           <thead>
              <tr>
                 <th onclick="sortTable(this,0)">PO #</th>
                 <th onclick="sortTable(this,1)">Description</th>
                 <th onclick="sortTable(this,2)">Vessel</th>
                 <th onclick="sortTable(this,3)">Supplier</th>
                 <th onclick="sortTable(this,4)">Ordered</th>
                 <th onclick="sortTable(this,5)">Amount ($)</th>
                 <th onclick="sortTable(this,6)">Payment</th>
                 <th style="width:50px;"></th>
              </tr>
           </thead>
           <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card" style="border-top: 4px solid var(--danger);">
      <h2>Cancelled Orders (Bin)</h2>
      <div class="table-container">
        <table id="cancelledReqTable">
          <thead>
            <tr>
              <th>PO #</th>
              <th>Description</th>
              <th>Vessel</th>
              <th>Supplier</th>
              <th>Cancelled Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="tab-landings" class="tab-content hidden">
    <div class="card" id="landAddCard">
      <h2 id="landFormTitle">Add Landed Item</h2>
      <div class="flex-row">
        <div class="flex-1"><label>Vessel</label><select id="landVessel"></select></div>
        <div class="flex-1"><label>Workshop/Supplier</label><div style="display:flex; gap:8px;"><select id="landWorkshopSelect" style="flex:1;"></select><button id="newWorkshopBtn" class="secondary" title="Add New">+</button></div></div>
        <div class="flex-1"><label>Item Description</label><input type="text" id="landDescription" /></div>
      </div>
      <div class="flex-row">
         <div class="flex-1"><label>Expected Date</label><input type="date" id="landExpected" /></div>
         <div class="flex-1"><label>Landed Date</label><input type="date" id="landLanded" /></div>
         <div class="flex-1"><label>Amount</label><input type="number" id="landAmount" step="0.01" /></div>
         <div class="flex-1"><label>Currency</label><select id="landCurrency"></select></div>
      </div>
      <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:16px;">
        <label style="display:flex; align-items:center; gap:8px;"><input type="checkbox" id="landPaid" style="width:auto; margin:0;" /> Paid</label>
        <button id="cancelLandEditBtn" class="secondary hidden">Cancel</button>
        <button id="saveLandingBtn" class="success">Save Landing</button>
      </div>
    </div>

    <div class="card">
      <h2>Landed Items</h2>
      <div class="table-container">
        <table id="landingTable">
          <thead>
            <tr>
              <th style="width:40px;"><input type="checkbox" id="landSelectAll" /></th>
              <th onclick="sortTable(this,1)">Vessel</th>
              <th onclick="sortTable(this,2)">Item</th>
              <th onclick="sortTable(this,3)">Workshop</th>
              <th onclick="sortTable(this,4)">Expected</th>
              <th onclick="sortTable(this,5)">Amount ($)</th>
              <th onclick="sortTable(this,6)">Payment</th>
              <th onclick="sortTable(this,7)">Delivery</th>
              <th style="width:50px;"></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="tab-directory" class="tab-content hidden">
    <div class="card">
      <div style="display:flex; justify-content:space-between;">
        <h2>Supplier Directory</h2>
        <div><button id="dirNewSupplierBtn">Add Supplier</button><button id="dirNewWorkshopBtn" class="secondary">Add Workshop</button></div>
      </div>
      <div class="table-container" style="margin-top:16px;">
        <table id="directoryTable"><thead><tr><th>Type</th><th>Name</th><th>Email</th><th>Phone</th><th>Rating</th><th>Actions</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </div>
  
  <div id="tab-delivered" class="tab-content hidden">
    <div class="card">
      <h2>Global History Log (ReadOnly)</h2>
      <div class="table-container">
        <table id="deliveredReqTable"><thead><tr><th>Type</th><th>Ref</th><th>Desc</th><th>Entity</th><th>Amount</th><th>Paid</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </div>

  <div id="tab-admin" class="tab-content hidden">
    <div class="card">
      <h2>Admin Panel</h2>
      <div class="flex-row">
        <button onclick="document.getElementById('adminCats').classList.toggle('hidden')" class="secondary">Manage Categories</button>
        <button onclick="document.getElementById('adminVessels').classList.toggle('hidden')" class="secondary">Manage Vessels</button>
        <button onclick="document.getElementById('adminUsers').classList.toggle('hidden')" class="secondary">Manage Users</button>
        <button onclick="document.getElementById('backupCard').classList.toggle('hidden')" class="secondary">Backups & Restore</button>
        <button onclick="document.getElementById('auditCard').classList.toggle('hidden')" class="secondary">Activity Logs</button>
      </div>
      
      <div id="adminCats" class="hidden" style="margin-top:15px; border-top:1px solid var(--border); padding-top:15px;">
        <h3>Categories</h3>
        <div class="flex-row"><input id="catName" placeholder="Name"><input id="catAbbr" placeholder="Abbr"><button id="addCatBtn">Add</button></div>
        <table id="catTable"><thead><tr><th>Name</th><th>Abbr</th><th>Action</th></tr></thead><tbody></tbody></table>
      </div>
      <div id="adminVessels" class="hidden" style="margin-top:15px; border-top:1px solid var(--border); padding-top:15px;">
         <h3>Vessels</h3>
         <div class="flex-row"><input id="vesselName" placeholder="Name"><button id="addVesselBtn">Add</button></div>
         <table id="vesselTable"><thead><tr><th>Name</th><th>Action</th></tr></thead><tbody></tbody></table>
      </div>
      <div id="adminUsers" class="hidden" style="margin-top:15px; border-top:1px solid var(--border); padding-top:15px;">
         <h3>Users</h3>
         <div class="flex-row"><input id="adminUsername" placeholder="User"><input type="password" id="adminPassword" placeholder="Pass"><select id="adminRole"><option value="user">User</option><option value="finance">Finance</option><option value="admin">Admin</option></select><button id="saveUserBtn">Add</button></div>
         <table id="userTable"><thead><tr><th>User</th><th>Role</th><th>Action</th></tr></thead><tbody></tbody></table>
      </div>

      <div id="auditCard" class="hidden" style="margin-top:15px; border-top:1px solid var(--border); padding-top:15px;">
         <h3>System Activity Logs</h3>
         <div class="flex-row">
             <div style="flex:1"><select id="auditFYear"><option value="">Year</option></select></div>
             <div style="flex:1"><select id="auditFMonth"><option value="">Month</option></select></div>
             <div style="flex:1"><button id="auditApplyBtn">Filter Logs</button> <button id="auditRefreshBtn" class="secondary">Refresh</button></div>
         </div>
         <div class="table-container" style="max-height: 400px; overflow-y: auto;">
             <table id="auditTable"><thead><tr><th>User</th><th>Action</th><th>Target</th><th>Details</th><th>Date</th></tr></thead><tbody></tbody></table>
         </div>
      </div>

      <div class="hidden" id="backupCard" style="margin-top:15px; border-top:1px solid var(--border); padding-top:15px;">
         <h3>System Backups</h3>
         <div class="flex-row"><button id="createBackupBtn" class="success">Create Backup Now</button><button id="downloadBackupBtn">Download Manual</button></div>
         
         <div style="background:#fff3cd; color:#854d0e; padding:10px; border-radius:6px; margin:10px 0;">
            <strong>Restore / Upload Database:</strong> Select an .xlsx file to overwrite the current database.
            <div style="display:flex; gap:10px; margin-top:8px;">
                <input type="file" id="uploadBackupInput" accept=".xlsx" style="border:1px solid #ccc; background:#fff;">
                <button id="uploadBackupBtn" class="danger">Upload & Restore</button>
            </div>
         </div>
         <table id="backupTable" style="margin-top:10px;"><thead><tr><th>Filename</th><th>Date</th><th>Size</th><th>Actions</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </div>
</div>

<div id="loginCard" class="popup-backdrop">
  <div class="popup" style="max-width:350px;">
    <h2>Login</h2>
    <label>Username</label><input type="text" id="loginUsername" />
    <label style="margin-top:10px;">Password</label><input type="password" id="loginPassword" />
    <button id="loginBtn" style="width:100%; margin-top:20px;">Login</button>
    <div id="loginError" class="error"></div>
  </div>
</div>

<div id="dirPopupBackdrop" class="popup-backdrop">
  <div id="dirPopup" class="popup">
    <h3 id="dirPopupTitle">Add Contact</h3>
    <input type="hidden" id="dirPopupId">
    <div class="flex-row">
      <div class="flex-1"><label>Type</label><select id="dirPopupType"><option value="supplier">Supplier</option><option value="workshop">Workshop</option></select></div>
      <div class="flex-1"><label>Name</label><input type="text" id="dirPopupName" /></div>
    </div>
    <div class="flex-row"><div class="flex-1"><label>Email</label><input type="email" id="dirPopupEmail" /></div><div class="flex-1"><label>Phone</label><input type="text" id="dirPopupPhone" /></div></div>
    <label>Address</label><input type="text" id="dirPopupAddress" />
    <div style="margin-top:20px; text-align:right; display:flex; gap:10px; justify-content:flex-end;">
      <button onclick="document.getElementById('dirPopupBackdrop').classList.remove('visible')" class="secondary">Cancel</button>
      <button id="dirPopupSaveBtn" class="success">Save</button>
    </div>
  </div>
</div>

<div id="ratePopupBackdrop" class="popup-backdrop">
  <div id="ratePopup" class="popup" style="max-width:400px;">
    <h3>Rate Supplier</h3>
    <input type="hidden" id="rateDirId">
    <label>Rating</label>
    <select id="rateScore">
      <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (Excellent)</option>
      <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (Good)</option>
      <option value="3">‚≠ê‚≠ê‚≠ê (Average)</option>
      <option value="2">‚≠ê‚≠ê (Poor)</option>
      <option value="1">‚≠ê (Terrible)</option>
    </select>
    <label>Comments</label>
    <textarea id="rateComment" rows="3"></textarea>
    <div style="margin-top:20px; text-align:right; display:flex; gap:10px; justify-content:flex-end;">
       <button onclick="document.getElementById('ratePopupBackdrop').classList.remove('visible')" class="secondary">Cancel</button>
       <button id="saveRateBtn" class="success">Save Rating</button>
    </div>
  </div>
</div>

<div id="docPopupBackdrop" class="popup-backdrop">
  <div id="docPopup" class="popup">
    <h3>Attached Documents</h3>
    <input type="hidden" id="docParentType">
    <input type="hidden" id="docParentId">
    <div style="margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid var(--border);">
       <label>Upload File</label>
       <div style="display:flex; gap:10px;"><input type="file" id="docUploadInput" /><button id="docUploadBtn" class="success">Upload</button></div>
    </div>
    <table id="docTable"><thead><tr><th>File</th><th>By</th><th>Date</th></tr></thead><tbody></tbody></table>
    <div style="text-align:right; margin-top:15px;"><button onclick="document.getElementById('docPopupBackdrop').classList.remove('visible')" class="secondary">Close</button></div>
  </div>
</div>

<div id="chartBackdrop" class="popup-backdrop">
  <div id="chartPopup" class="popup" style="max-width:800px;">
    <div style="display:flex; justify-content:space-between; margin-bottom:15px;"><h3>Analytics Studio</h3><button onclick="document.getElementById('chartBackdrop').classList.remove('visible')" class="secondary">‚úï</button></div>
    <div class="flex-row">
       <div class="flex-1"><label>X-Axis (Dimension)</label><select id="chartXAxis"><option value="vessel">Vessel</option><option value="supplier">Supplier</option><option value="category">Category</option></select></div>
       <div class="flex-1"><label>Y-Axis (Metric)</label><select id="chartMetric"><option value="amount">Total Spend ($)</option><option value="count">Count of Orders</option></select></div>
       <div class="flex-1"><label>Period</label><select id="chartPeriod"><option value="all">All Time</option><option value="this_year">This Year</option><option value="last_year">Last Year</option><option value="monthly">Specific Month</option></select></div>
    </div>
    <div class="flex-row" id="chartExtraFilters">
       <div class="flex-1"><label>Filter Vessel</label><select id="chartVesselFilter"><option value="">All Vessels</option></select></div>
       <div class="flex-1"><label>Specific Month</label><select id="chartSpecificMonth"><option value="">Select Month</option></select></div>
       <div class="flex-1"><label>Type</label><select id="chartType"><option value="bar">Bar</option><option value="doughnut">Doughnut</option></select></div>
       <div style="flex:0;"><label>&nbsp;</label><button id="refreshChartBtn">Refresh</button></div>
    </div>
    <div style="position:relative; height:400px; width:100%;"><canvas id="customChart"></canvas></div>
  </div>
</div>

<div id="agingPopupBackdrop" class="popup-backdrop">
  <div id="agingPopup" class="popup" style="max-width:800px;">
    <h3>Aging Report (Unpaid Invoices)</h3>
    <div class="table-container">
      <table id="agingTable"><thead><tr><th>PO #</th><th>Supplier</th><th>Amount</th><th>Days Unpaid</th><th>Group</th></tr></thead><tbody></tbody></table>
    </div>
    <div style="text-align:right; margin-top:15px;"><button onclick="document.getElementById('agingPopupBackdrop').classList.remove('visible')" class="secondary">Close</button></div>
  </div>
</div>

<div id="supHistBackdrop" class="popup-backdrop">
  <div id="supHistPopup" class="popup">
    <div style="display:flex; justify-content:space-between;">
        <h3 id="supHistTitle">Supplier History</h3>
        <div id="supScoreDisplay" style="font-weight:bold; color:var(--warning);"></div>
    </div>
    <div class="table-container">
      <table id="supHistTable"><thead><tr><th>Date</th><th>PO #</th><th>Item</th><th>Amount</th></tr></thead><tbody></tbody></table>
    </div>
    <div style="text-align:right; margin-top:15px;"><button onclick="document.getElementById('supHistBackdrop').classList.remove('visible')" class="secondary">Close</button></div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
async function apiFetch(url, options = {}) {
  const res = await fetch(url, { headers: { "Content-Type": "application/json" }, ...options });
  if (!res.ok) { let err; try { err = await res.json(); } catch { err = { error: "unknown" }; } throw err; }
  return res.json();
}

/* ================= STATE ================= */
let currentUser=null, allReqs=[], allLandings=[], vessels=[];
let editingReqId=null, editingLandId=null, dirPopupType=null, currencyList=["USD"];
let selectedIds = new Set(); let currentBulkType = null;
let myChart = null;
let allAuditLogs = []; 

/* ================= THEME ================= */
const darkModeBtn = document.getElementById("darkModeBtn");
if(localStorage.getItem("theme")==="dark") document.body.classList.add("dark-mode");
darkModeBtn.onclick = () => {
    document.body.classList.toggle("dark-mode");
    localStorage.setItem("theme", document.body.classList.contains("dark-mode") ? "dark" : "light");
};

/* ================= INITIALIZATION ================= */
async function afterDataLoad() {
    selectedIds.clear(); toggleBulkBar();
    await loadOptions(); await loadData(); 
    calculateOverviewTotals(); await updateDashboard(); await loadAdminData();
    if(currentUser && currentUser.username==='finance') {
        if(document.getElementById('reqAddCard')) document.getElementById('reqAddCard').classList.add('hidden');
    }
}

async function loadOptions(){
    try { const res = await apiFetch("/api/currencies"); currencyList = res.currencies || ["USD"]; } catch {}
    const fillSel = (id) => { const el = document.getElementById(id); if(!el)return; el.innerHTML=""; currencyList.forEach(c => el.add(new Option(c,c))); el.value="USD"; };
    fillSel("reqCurrency"); fillSel("landCurrency");
    
    try { vessels = await apiFetch("/api/vessels"); } catch { vessels=[]; }
    const fillVes = (id) => { const el=document.getElementById(id); if(!el)return; const cur=el.value; el.innerHTML='<option value="">Select Vessel</option>'; vessels.forEach(v=>el.add(new Option(v.name,v.name))); if(cur) el.value=cur; };
    fillVes("reqVessel"); fillVes("landVessel"); fillVes("ovVesselFilter"); fillVes("filterDelVessel"); fillVes("chartVesselFilter");
    
    // Month/Year Options
    ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"].forEach((m,i)=> {
       document.getElementById("ovMonthFilter").add(new Option(m, i+1));
       document.getElementById("auditFMonth").add(new Option(m, i+1));
    });
    const y = new Date().getFullYear();
    for(let i=y; i>=y-3; i--) {
        document.getElementById("ovYearFilter").add(new Option(i, i));
        document.getElementById("auditFYear").add(new Option(i, i));
    }

    // Chart Month Select (Last 24 Months) - Local Time Fix
    const chartM = document.getElementById("chartSpecificMonth");
    if(chartM) {
        chartM.innerHTML = '<option value="">Select Month</option>';
        const d = new Date(); // Local time
        for(let i=0; i<24; i++) {
            // Manually construct year/month to avoid UTC shift
            let year = d.getFullYear();
            let month = d.getMonth() - i;
            // Adjust for month rollover
            while(month < 0) { month += 12; year -= 1; }
            
            // Format YYYY-MM
            const val = `${year}-${String(month+1).padStart(2, '0')}`;
            
            // Label
            const tempDate = new Date(year, month, 1);
            const txt = tempDate.toLocaleString('default', { month: 'long', year: 'numeric' });
            
            chartM.add(new Option(txt, val));
        }
    }

    try { const cats=await apiFetch("/api/categories"); const cSel=document.getElementById("reqCategory"); 
       if(cSel){ cSel.innerHTML='<option value="">Select</option>'; cats.forEach(c=>cSel.add(new Option(c.abbr, c.abbr))); } 
       // Admin Table
       const t=document.querySelector("#catTable tbody"); t.innerHTML="";
       cats.forEach(c => t.innerHTML += `<tr><td>${c.name}</td><td>${c.abbr}</td><td><button class="small-action danger" onclick="delCat(${c.id})">Del</button></td></tr>`);
    } catch {}

try { 
       const dirs = await apiFetch("/api/directory"); 
       
       // 1. Setup 'Supplier' dropdown in Orders (Requisitions)
       const sSel = document.getElementById("reqSupplierSelect"); 
       if(sSel){ 
           sSel.innerHTML = '<option value="">Select</option>'; 
           // Allow BOTH Supplier and Workshop
           dirs.filter(d => d.type === 'supplier' || d.type === 'workshop')
               .sort((a, b) => a.name.localeCompare(b.name)) 
               .forEach(d => sSel.add(new Option(d.name, d.name))); 
       }

       // 2. Setup 'Workshop' dropdown in Landings
       const wSel = document.getElementById("landWorkshopSelect"); 
       if(wSel){ 
           wSel.innerHTML = '<option value="">Select</option>'; 
           // Allow BOTH Supplier and Workshop here too
           dirs.filter(d => d.type === 'supplier' || d.type === 'workshop')
               .sort((a, b) => a.name.localeCompare(b.name))
               .forEach(d => wSel.add(new Option(d.name, d.name))); 
       }
       
       renderDirectory(dirs);
    } catch {}
}

async function loadData() {
    try { allReqs = await apiFetch("/api/requisitions"); } catch { allReqs=[]; }
    try { allLandings = await apiFetch("/api/landings"); } catch { allLandings=[]; }
    renderReqTable(); renderDeliveredHistory(); renderLandTable(); renderDelivered();
    renderCancelledTable(); // <--- NEW RENDER
}

/* ================= RENDERING ================= */
function formatMoney(amount) { return parseFloat(amount || 0).toLocaleString('en-US', {style:'currency', currency:'USD'}); }
function parseDateSafe(d) { if(!d)return null; const dt=new Date(d); return isNaN(dt.getTime())?null:dt; }

async function updateDashboard() {
   // Calculate counts for summary boxes
   const openReq = allReqs.filter(r => (r.status||'open')!=='cancelled' && r.delivered!=1);
   const unpaidReq = allReqs.filter(r => (r.status||'open')!=='cancelled' && !r.paid);
   const openLand = allLandings.filter(r => (r.status||'open')!=='cancelled' && r.delivered!=1);
   const unpaidLand = allLandings.filter(r => (r.status||'open')!=='cancelled' && !r.paid);

   document.getElementById("summaryOpenReqNotDel").textContent = openReq.length;
   document.getElementById("summaryOpenReqUnpaid").textContent = unpaidReq.length;
   document.getElementById("summaryOpenLandNotDel").textContent = openLand.length;
   document.getElementById("summaryOpenLandUnpaid").textContent = unpaidLand.length;
}

function checkUrgency(r) {
    if (r.delivered == 1) return ""; // No urgency if delivered
    if (!r.expected) return "";
    
    const exp = new Date(r.expected);
    const today = new Date();
    today.setHours(0,0,0,0);
    
    // If expected date is passed
    if (exp < today) return `<br><span style="color:var(--danger); font-size:11px; font-weight:bold;">‚ö†Ô∏è Overdue: ${r.expected}</span>`;
    
    // If expected within next 15 days
    const next15 = new Date();
    next15.setDate(today.getDate() + 15);
    if (exp <= next15) return `<br><span style="color:#b45309; font-size:11px; font-weight:bold;">‚ö†Ô∏è Due Soon: ${r.expected}</span>`;
    
    return "";
}

function renderReqTable() {
    const tbody = document.querySelector("#reqTable tbody"); tbody.innerHTML="";
    
    // Filters
    const statusF = document.getElementById("filterReqStatus").value;
    const paidF = document.getElementById("filterReqPaid").value; 
    const search = document.getElementById("filterReqSearch").value.toLowerCase();
    
    // Active orders only (Not delivered fully, NOT CANCELLED)
    const activeReqs = allReqs.filter(r => r.delivered != 1);

    activeReqs.forEach(r => {
        // Apply Filters
        if (r.status === 'cancelled') return; // Hide cancelled items
        if(statusF && (r.status||"open") !== statusF) return;
        if(paidF !== "") {
            const isPaid = r.paid ? 1 : 0;
            if (isPaid != parseInt(paidF)) return;
        }
        if(search && !`${r.po_number} ${r.description} ${r.vessel} ${r.supplier}`.toLowerCase().includes(search)) return;

        const tr = document.createElement("tr");
        if(r.urgency === 'high') tr.classList.add('urgency-high');
        const isChecked = selectedIds.has(r.id) && currentBulkType === 'req';
        
        let delBadge = r.delivered == 2 ? '<span class="tag yellow">Partial</span>' : '<span class="tag gray">Open</span>';
        
        // Due Date Logic
        let dateDisplay = r.date_ordered + checkUrgency(r);
        
        let poDisplay = r.po_number||r.number;
        if(r.urgency === 'high') poDisplay = `<span class="high-icon">üö©</span>` + poDisplay;

        // STOP PROPAGATION ADDED
        const btnHtml = `<button class="drop-btn" onclick="event.stopPropagation(); toggleMenu(this, ${r.id}, 'req')">‚Ä¢‚Ä¢‚Ä¢</button>`;

        tr.innerHTML = `
            <td><input type="checkbox" class="row-select" data-id="${r.id}" ${isChecked?'checked':''}></td>
            <td><strong>${poDisplay}</strong></td>
            <td>${r.category||'-'}</td>
            <td>${r.description}</td>
            <td>${r.vessel}</td>
            <td><span class="clickable-link" onclick="showSupplierHistory('${r.supplier}')">${r.supplier}</span></td>
            <td>${dateDisplay}</td>
            <td>${formatMoney(r.amount_usd)}</td>
            <td>${r.paid?'<span class="tag green">Paid</span>':'<span class="tag red">Unpaid</span>'}</td>
            <td>${delBadge}</td>
            <td>${btnHtml}</td>`;
        tbody.appendChild(tr);
    });
    attachBulkListeners('req');
}

function renderDeliveredHistory() {
    const tbody = document.querySelector("#deliveredHistoryTable tbody"); tbody.innerHTML="";
    
    const vesF = document.getElementById("filterDelVessel").value;
    const search = document.getElementById("filterDelSearch").value.toLowerCase();
    
    // Delivered orders only
    const delReqs = allReqs.filter(r => r.delivered == 1);

    delReqs.forEach(r => {
        if(vesF && r.vessel !== vesF) return;
        if(search && !`${r.po_number} ${r.description} ${r.supplier}`.toLowerCase().includes(search)) return;

        const tr = document.createElement("tr");
        // STOP PROPAGATION ADDED
        const btnHtml = `<button class="drop-btn" onclick="event.stopPropagation(); toggleMenu(this, ${r.id}, 'req_del')">‚Ä¢‚Ä¢‚Ä¢</button>`;
        
        tr.innerHTML = `
            <td><strong>${r.po_number||r.number}</strong></td>
            <td>${r.description}</td>
            <td>${r.vessel}</td>
            <td>${r.supplier}</td>
            <td>${r.date_ordered}</td>
            <td>${formatMoney(r.amount_usd)}</td>
            <td>${r.paid?'<span class="tag green">Paid</span>':'<span class="tag red">Unpaid</span>'}</td>
            <td>${btnHtml}</td>`;
        tbody.appendChild(tr);
    });
}

// === NEW FUNCTION: RENDER CANCELLED ===
function renderCancelledTable() {
    const tbody = document.querySelector("#cancelledReqTable tbody"); 
    tbody.innerHTML = "";
    
    const cancelled = allReqs.filter(r => r.status === 'cancelled');

    if (cancelled.length === 0) {
        tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; color:var(--text-muted); padding:20px;'>No cancelled orders.</td></tr>";
        return;
    }

    cancelled.forEach(r => {
        const tr = document.createElement("tr");
        const dateStr = r.updated_at ? r.updated_at.split('T')[0] : r.date_ordered;
        
        tr.innerHTML = `
            <td><strong>${r.po_number || r.number}</strong></td>
            <td>${r.description}</td>
            <td>${r.vessel}</td>
            <td>${r.supplier}</td>
            <td>${dateStr}</td>
            <td>
                <div style="display:flex; gap:10px;">
                    <button class="success small-action" onclick="recoverReq(${r.id})">‚ôª Recover</button>
                    <button class="danger small-action" onclick="permanentDeleteReq(${r.id})">üóë Delete Forever</button>
                </div>
            </td>`;
        tbody.appendChild(tr);
    });
}

async function recoverReq(id) {
    if(!confirm("Recover this order back to the active list?")) return;
    try {
        await apiFetch(`/api/requisitions/${id}`, {method: "PATCH", body: JSON.stringify({status: "open"})});
        await afterDataLoad();
    } catch(e) { alert("Error recovering: " + e.error); }
}

async function permanentDeleteReq(id) {
    if(!confirm("Are you sure? This will DELETE the record permanently.")) return;
    try {
        await apiFetch(`/api/requisitions/${id}`, { method: "DELETE" });
        await afterDataLoad();
    } catch(e) { alert("Error deleting: " + e.error); }
}
// ======================================

function renderLandTable() {
    const tbody = document.querySelector("#landingTable tbody"); tbody.innerHTML="";
    allLandings.forEach(r => {
        if((r.status||"open")==="cancelled") return;
        const tr = document.createElement("tr");
        const isChecked = selectedIds.has(r.id) && currentBulkType === 'land';
        let delBadge = r.delivered==1 ? '<span class="tag green">Received</span>' : (r.delivered==2 ? '<span class="tag yellow">Partial</span>':'<span class="tag gray">Pending</span>');
        
        // STOP PROPAGATION ADDED
        const btnHtml = `<button class="drop-btn" onclick="event.stopPropagation(); toggleMenu(this, ${r.id}, 'land')">‚Ä¢‚Ä¢‚Ä¢</button>`;
        
        tr.innerHTML = `<td><input type="checkbox" class="row-select" data-id="${r.id}" ${isChecked?'checked':''}></td><td>${r.vessel}</td><td>${r.item}</td><td>${r.workshop}</td><td>${r.expected||""}</td><td>${formatMoney(r.amount_usd)}</td><td>${r.paid?'<span class="tag green">Paid</span>':'<span class="tag red">Unpaid</span>'}</td><td>${delBadge}</td><td>${btnHtml}</td>`;
        tbody.appendChild(tr);
    });
    attachBulkListeners('land');
}

/* ================= EXPORT CSV ================= */
document.getElementById("exportReqBtn").onclick = () => {
    if(!allReqs.length) return alert("No data");
    
    // CSV Header
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "ID,PO Number,Vessel,Description,Supplier,Category,Ordered,Expected,Amount USD,Paid,Delivered,Status\n";
    
    allReqs.forEach(r => {
        const row = [
            r.id, 
            `"${r.po_number||r.number}"`, 
            `"${r.vessel}"`, 
            `"${r.description}"`, 
            `"${r.supplier}"`,
            `"${r.category}"`,
            r.date_ordered,
            r.expected,
            r.amount_usd,
            r.paid ? "Yes" : "No",
            r.delivered == 1 ? "Full" : (r.delivered == 2 ? "Partial" : "No"),
            r.status
        ].join(",");
        csvContent += row + "\n";
    });
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `orders_export_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
};

/* ================= MENU SYSTEM (Fixed Positioning) ================= */
function toggleMenu(btn, id, type) {
    const menu = document.getElementById("globalActionMenu");
    
    // If clicking the same button while menu is open, close it
    if(menu.style.display === 'block' && menu.dataset.triggerId === `${type}-${id}`) {
        menu.style.display = 'none';
        return;
    }

    // Build Menu Content
    let html = "";
    
    if(type === 'req' || type === 'req_del') {
        const r = allReqs.find(x => x.id == id);
        if(r) {
            html += `<button onclick="copyToWhatsApp(${r.id})">üì± Copy for WhatsApp</button>`;
            html += `<button onclick="openDocPopup(${r.id}, 'req')">üìé Documents</button>`;
            
            // Edit allowed if not delivered, or logic depends on user
            html += `<button onclick="editReq(${r.id})">‚úé Edit / Remarks</button>`;
            html += `<button onclick="duplicateReq(${r.id})">üìã Duplicate</button>`;
            html += `<button onclick="generatePO(${r.id})">üñ®Ô∏è Print PO</button>`;
            html += `<button onclick="showSupplierHistory('${r.supplier}')">üìÖ Supplier History</button>`;
            
            if(!r.paid) html += `<button onclick="singleAction(${r.id}, 'req', 'mark_paid')">üí≤ Mark Paid</button>`;
            
            if(type === 'req') { // Only for active list
                if(r.delivered!=1) html += `<button onclick="singleAction(${r.id}, 'req', 'mark_delivered')">‚úÖ Full Delivery</button>`;
                if(r.delivered!=2) html += `<button onclick="singleAction(${r.id}, 'req', 'mark_partial')">üöß Mark Partial</button>`;
                html += `<button onclick="cancelReq(${r.id})" style="color:var(--danger)">‚úï Cancel</button>`;
            }
        }
    } else if (type === 'land') {
        html += `<button onclick="openDocPopup(${id}, 'land')">Documents</button>`;
        html += `<button onclick="editLand(${id})">Edit</button>`;
        html += `<button onclick="singleAction(${id}, 'land', 'mark_paid')">Mark Paid</button>`;
        html += `<button onclick="deleteItem(${id}, 'land')" style="color:red">Delete</button>`;
    }
    
    menu.innerHTML = html;
    menu.dataset.triggerId = `${type}-${id}`;
    
// Calculate Position
    const rect = btn.getBoundingClientRect();
    
    menu.style.display = 'block';
    
    // Check if it fits below (using viewport coordinates)
    if(rect.bottom + menu.offsetHeight > window.innerHeight) {
        // Open upwards
        // Fixed position uses viewport coordinates, so rect.top is correct as is
        menu.style.top = (rect.top - menu.offsetHeight - 2) + "px";
    } else {
        // Open downwards
        // REMOVED "+ window.scrollY" here because position is fixed
        menu.style.top = (rect.bottom + 2) + "px"; 
    }
    
    // Check right edge
    if(rect.left + 180 > window.innerWidth) {
        menu.style.left = (rect.right - 180) + "px";
    } else {
        menu.style.left = rect.left + "px";
    }

    // Click outside listener
    setTimeout(() => {
        const closeFn = (e) => {
            if(!menu.contains(e.target) && e.target !== btn) {
                menu.style.display = 'none';
                window.removeEventListener('click', closeFn);
            }
        };
        window.addEventListener('click', closeFn);
    }, 0);
}

/* ================= ACTIONS ================= */
async function editReq(id) {
    const r = allReqs.find(x=>x.id==id); if(!r) return;
    editingReqId = id;
    document.getElementById("reqFormTitle").textContent="Edit Order (" + (r.po_number||r.number) + ")"; 
    document.getElementById("saveReqBtn").textContent="Update Order";
    document.getElementById("cancelReqEditBtn").classList.remove("hidden");
    document.getElementById("reqPONumber").value=r.po_number||""; document.getElementById("reqNumber").value=r.number;
    document.getElementById("reqDescription").value=r.description; document.getElementById("reqVessel").value=r.vessel;
    document.getElementById("reqCategory").value=r.category; document.getElementById("reqSupplierSelect").value=r.supplier;
    document.getElementById("reqDateOrdered").value=r.date_ordered; document.getElementById("reqExpected").value=r.expected||"";
    document.getElementById("reqTotal").value=r.amount_original || r.amount_usd; document.getElementById("reqCurrency").value=r.currency;
    document.getElementById("reqTracking").value=r.tracking_url||""; document.getElementById("reqUrgency").value=r.urgency;
    document.getElementById("reqRemarks").value=r.remarks||""; document.getElementById("reqPaid").checked=!!r.paid;
    document.querySelector("[data-tab='requisitions']").click(); document.getElementById("reqAddCard").scrollIntoView({behavior:"smooth"});
}

// DUPLICATE/COPY FEATURE
async function duplicateReq(id) {
    const r = allReqs.find(x => x.id == id); if(!r) return;
    if(!confirm("Create a copy of this order?")) return;
    
    const payload = {
        number: (r.number || "") + " (Copy)",
        po_number: "", // clear PO so user/system assigns new
        description: r.description,
        vessel: r.vessel,
        category: r.category,
        supplier: r.supplier,
        date_ordered: new Date().toISOString().split('T')[0], // Today
        expected: "",
        amount_original: r.amount_original,
        amount: r.amount_original,
        currency: r.currency,
        urgency: r.urgency,
        remarks: r.remarks,
        paid: false,
        delivered: 0
    };

    try {
        await apiFetch("/api/requisitions", {method:"POST", body:JSON.stringify(payload)});
        await afterDataLoad();
        alert("Order duplicated!");
    } catch(e) { alert("Error duplicating: " + e.error); }
}

function copyToWhatsApp(id) {
    const r = allReqs.find(x => x.id == id);
    if (!r) return;
    const text = `*NEW ORDER*\nPO: ${r.po_number || r.number || 'Pending'}\nVessel: ${r.vessel}\nSupplier: ${r.supplier}\nItem: ${r.description}\nExpected: ${r.expected || 'ASAP'}\nUrgency: ${r.urgency || 'Normal'}`;
    navigator.clipboard.writeText(text).then(() => alert("Copied to clipboard!")).catch(err => alert("Failed to copy"));
}

document.getElementById("saveReqBtn").onclick = async () => {
    const valAmt = document.getElementById("reqTotal").value;
    const payload = {
        po_number: document.getElementById("reqPONumber").value, number: document.getElementById("reqNumber").value,
        description: document.getElementById("reqDescription").value, vessel: document.getElementById("reqVessel").value,
        category: document.getElementById("reqCategory").value, supplier: document.getElementById("reqSupplierSelect").value,
        date_ordered: document.getElementById("reqDateOrdered").value, expected: document.getElementById("reqExpected").value,
        amount_original: valAmt, amount: valAmt, currency: document.getElementById("reqCurrency").value,
        tracking_url: document.getElementById("reqTracking").value, urgency: document.getElementById("reqUrgency").value,
        remarks: document.getElementById("reqRemarks").value, paid: document.getElementById("reqPaid").checked
    };
    try {
        if(editingReqId) await apiFetch(`/api/requisitions/${editingReqId}`, {method:"PATCH", body:JSON.stringify(payload)});
        else await apiFetch("/api/requisitions", {method:"POST", body:JSON.stringify(payload)});
        resetReqForm(); await afterDataLoad();
    } catch(e) { console.error(e); alert("Error saving: " + (e.error || e)); }
};
function resetReqForm() { editingReqId=null; document.getElementById("reqFormTitle").textContent="New Requisition"; document.getElementById("saveReqBtn").textContent="Save Order"; document.getElementById("cancelReqEditBtn").classList.add("hidden"); document.querySelectorAll("#reqAddCard input").forEach(i=>i.value=""); }
document.getElementById("cancelReqEditBtn").onclick = resetReqForm;
async function singleAction(id, type, action) { await apiFetch(type.startsWith('req')?'/api/requisitions/bulk':'/api/landings/bulk', { method:"POST", body: JSON.stringify({ ids: [id], action }) }); await afterDataLoad(); }
async function cancelReq(id) { if(confirm("Cancel this order?")) { await apiFetch(`/api/requisitions/${id}`, {method:"PATCH", body:JSON.stringify({status:"cancelled"})}); await afterDataLoad(); } }

// FILTERS LISTENERS
document.getElementById("applyReqFilterBtn").onclick = renderReqTable;
document.getElementById("clearReqFilterBtn").onclick = () => { document.getElementById("filterReqStatus").value=""; document.getElementById("filterReqPaid").value=""; document.getElementById("filterReqSearch").value=""; renderReqTable(); };
document.getElementById("applyDelFilterBtn").onclick = renderDeliveredHistory;

/* ================= DIRECTORY & POPUPS ================= */
document.getElementById("dirNewSupplierBtn").onclick = () => openDirPopup('supplier');
document.getElementById("newSupplierBtn").onclick = () => openDirPopup('supplier');
document.getElementById("dirNewWorkshopBtn").onclick = () => openDirPopup('workshop');
document.getElementById("newWorkshopBtn").onclick = () => openDirPopup('workshop');

function openDirPopup(type, existingId=null) {
    document.getElementById("dirPopupBackdrop").classList.add("visible");
    document.getElementById("dirPopupId").value = existingId || "";
    document.getElementById("dirPopupType").value = type;
    document.getElementById("dirPopupTitle").textContent = existingId ? "Edit Contact" : ("Add " + (type==='supplier'?'Supplier':'Workshop'));
    
    if(existingId) {
        apiFetch("/api/directory").then(dirs => {
            const d = dirs.find(x=>x.id == existingId);
            if(d) {
                document.getElementById("dirPopupName").value = d.name;
                document.getElementById("dirPopupEmail").value = d.email;
                document.getElementById("dirPopupPhone").value = d.phone;
                document.getElementById("dirPopupAddress").value = d.address||"";
            }
        });
    } else {
        document.getElementById("dirPopupName").value = "";
        document.getElementById("dirPopupEmail").value = "";
        document.getElementById("dirPopupPhone").value = "";
        document.getElementById("dirPopupAddress").value = "";
    }
}

function editDir(id) { openDirPopup('supplier', id); }
async function delDir(id) { if(confirm("Delete?")) { await apiFetch(`/api/directory/${id}`, {method:"DELETE"}); await afterDataLoad(); } }

document.getElementById("dirPopupSaveBtn").onclick = async () => {
    const id = document.getElementById("dirPopupId").value;
    const payload = {
        type: document.getElementById("dirPopupType").value,
        name: document.getElementById("dirPopupName").value,
        email: document.getElementById("dirPopupEmail").value,
        phone: document.getElementById("dirPopupPhone").value,
        address: document.getElementById("dirPopupAddress").value
    };
    if(!payload.name) return alert("Name required");
    try {
        if(id) await apiFetch(`/api/directory/${id}`, {method:"PATCH", body:JSON.stringify(payload)});
        else await apiFetch("/api/directory", {method:"POST", body:JSON.stringify(payload)});
        document.getElementById("dirPopupBackdrop").classList.remove("visible");
        await afterDataLoad();
    } catch { alert("Error saving directory"); }
};

/* ================= LANDINGS ================= */
document.getElementById("saveLandingBtn").onclick = async () => {
   const valAmt = document.getElementById("landAmount").value;
   const payload = {
       vessel: document.getElementById("landVessel").value,
       workshop: document.getElementById("landWorkshopSelect").value,
       item: document.getElementById("landDescription").value,
       expected: document.getElementById("landExpected").value,
       landed_date: document.getElementById("landLanded").value,
       amount_original: valAmt, amount: valAmt,
       currency: document.getElementById("landCurrency").value,
       paid: document.getElementById("landPaid").checked
   };
   try {
       if(editingLandId) await apiFetch(`/api/landings/${editingLandId}`, {method:"PATCH", body:JSON.stringify(payload)});
       else await apiFetch("/api/landings", {method:"POST", body:JSON.stringify(payload)});
       editingLandId=null; document.getElementById("landAddCard").querySelectorAll("input").forEach(i=>i.value="");
       await afterDataLoad();
   } catch(e) { alert("Error saving landing"); }
};
async function deleteItem(id, type) { if(confirm("Delete?")) { await apiFetch(type==='req'?`/api/requisitions/${id}`:`/api/landings/${id}`, {method:"DELETE"}); await afterDataLoad(); } }
async function editLand(id) { 
    const l = allLandings.find(x=>x.id==id); if(!l)return; editingLandId=id;
    document.getElementById("landVessel").value=l.vessel; document.getElementById("landWorkshopSelect").value=l.workshop;
    document.getElementById("landDescription").value=l.item; document.getElementById("landExpected").value=l.expected||"";
    document.getElementById("landLanded").value=l.landed_date||""; document.getElementById("landAmount").value=l.amount_original;
    document.getElementById("landCurrency").value=l.currency; document.getElementById("landPaid").checked=!!l.paid;
    document.querySelector("[data-tab='landings']").click();
}

/* ================= FINANCIAL SUMMARY ================= */
document.getElementById("ovApplyTotalsBtn").onclick = calculateOverviewTotals;
function calculateOverviewTotals() {
    const typeF = document.getElementById("ovTypeFilter").value;
    const vesF = document.getElementById("ovVesselFilter").value;
    const paidF = document.getElementById("ovPaidFilter").value;
    const monthF = document.getElementById("ovMonthFilter").value;
    const yearF = document.getElementById("ovYearFilter").value;

    let items = [];
    if(typeF === 'req') items = [...allReqs];
    else if(typeF === 'land') items = [...allLandings];
    else items = [...allReqs, ...allLandings];

    items = items.filter(i => {
        if((i.status||'open') === 'cancelled') return false;
        if(vesF && i.vessel !== vesF) return false;
        if(paidF !== "" && (i.paid?1:0) != paidF) return false;
        
        const d = parseDateSafe(i.date_ordered || i.landed_date);
        if(yearF && (!d || d.getFullYear() != yearF)) return false;
        if(monthF && (!d || (d.getMonth() + 1) != monthF)) return false;
        return true;
    });

    const total = items.reduce((acc, c) => acc + (c.amount_usd || 0), 0);
    const paid = items.filter(i => i.paid).reduce((acc, c) => acc + (c.amount_usd || 0), 0);
    const unpaid = items.filter(i => !i.paid).reduce((acc, c) => acc + (c.amount_usd || 0), 0);

    document.getElementById("ovAllTotal").textContent = formatMoney(total);
    document.getElementById("ovPaidMonthTotal").textContent = formatMoney(paid);
    document.getElementById("ovUnpaidMonthTotal").textContent = formatMoney(unpaid);

    const supMap = {};
    items.forEach(r => {
        const s = r.supplier || r.workshop || "Unknown";
        supMap[s] = (supMap[s] || 0) + (r.amount_usd || 0);
    });
    const sorted = Object.entries(supMap).sort((a,b) => b[1] - a[1]).slice(0, 5);
    const ul = document.getElementById("ovTopSuppliers"); ul.innerHTML = "";
    if(sorted.length === 0) ul.innerHTML = "<li>No data available</li>";
    sorted.forEach(([k,v]) => {
        ul.innerHTML += `<li><span>${k}</span> <strong>$${v.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</strong></li>`;
    });
}

function renderDirectory(rows) {
  const t=document.querySelector("#directoryTable tbody"); t.innerHTML="";
  rows.forEach(r=>{ 
      t.innerHTML+=`<tr><td>${r.type}</td><td>${r.name}</td><td>${r.email||'-'}</td><td>${r.phone||'-'}</td><td>${"‚≠ê".repeat(r.rating||5)}</td><td><button class="small-action warning" onclick="openRatePopup(${r.id})">Rate</button> <button class="small-action secondary" onclick="editDir(${r.id})">Edit</button> <button class="small-action danger" onclick="delDir(${r.id})">Del</button></td></tr>`; 
  });
}
function renderDelivered() {
  const t=document.querySelector("#deliveredReqTable tbody"); t.innerHTML="";
  allReqs.filter(r=>r.delivered==1).sort((a,b)=>b.id-a.id).slice(0,50).forEach(r=>{ t.innerHTML+=`<tr><td>Order</td><td>${r.po_number}</td><td>${r.description}</td><td>${r.supplier}</td><td>${formatMoney(r.amount_usd)}</td><td>${r.paid?'Yes':'No'}</td></tr>`; });
}

/* ================= PRINT PO ================= */
/* ================= PRINT PO (FIXED) ================= */
function generatePO(id) {
    const r = allReqs.find(x => x.id == id); 
    if(!r) return;

    const companyName = "AMT FZE";
    const companyAddress = "Fujairah, UAE";
    const companyPhone = "+971 9 233 3232";
    const companyEmail = "technical@amfuj.com";
    
    // Get logo from current page to ensure it works
    const headerLogo = document.querySelector('.logo-img');
    const logoSrc = headerLogo ? headerLogo.src : "static/ICON.jpg"; 

    const w = window.open("", "_blank");
    
    const htmlContent = `
    <html>
    <head>
      <title>PO ${r.po_number || r.number}</title>
      <style>
        body { font-family: 'Helvetica', 'Arial', sans-serif; padding: 40px; color: #333; max-width: 900px; margin: 0 auto; }
        .header-top { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 20px; }
        .logo-section { display: flex; align-items: center; gap: 15px; }
        .logo-img { height: 80px; width: auto; border-radius: 4px; }
        .company-details h1 { margin: 0; color: #0f172a; font-size: 24px; text-transform: uppercase; }
        .company-details p { margin: 2px 0; font-size: 12px; color: #64748b; }
        .po-title-box { text-align: right; }
        .po-title-box h2 { margin: 0; color: #ef4444; font-size: 32px; }
        .po-meta { margin-top: 10px; font-size: 14px; font-weight: bold; }
        hr.divider { border: none; border-top: 2px solid #0f172a; margin: 20px 0 30px 0; }
        .info-grid { display: flex; gap: 40px; margin-bottom: 30px; }
        .info-box { flex: 1; border: 1px solid #e2e8f0; padding: 15px; border-radius: 6px; background: #f8fafc; }
        .info-label { font-size: 11px; text-transform: uppercase; font-weight: bold; color: #64748b; margin-bottom: 5px; }
        .info-content { font-size: 14px; line-height: 1.4; font-weight: 500; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
        th { background: #0f172a; color: white; padding: 12px; text-align: left; font-size: 12px; text-transform: uppercase; }
        td { border-bottom: 1px solid #e2e8f0; padding: 12px; font-size: 14px; }
        tr:nth-child(even) { background-color: #f8fafc; }
        .totals { float: right; width: 300px; }
        .total-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
        .total-row.final { border-bottom: 3px solid #0f172a; font-weight: bold; font-size: 18px; margin-top: 10px; padding-bottom: 5px; }
        .footer { margin-top: 100px; border-top: 1px solid #ccc; padding-top: 20px; font-size: 11px; color: #94a3b8; text-align: center; }
        .signature-area { display: flex; justify-content: space-between; margin-top: 60px; page-break-inside: avoid; }
        .sign-box { border-top: 1px solid #000; width: 35%; padding-top: 10px; text-align: center; font-weight: bold; font-size: 13px; }
      </style>
    </head>
    <body>
    
      <div class="header-top">
        <div class="logo-section">
            <img src="${logoSrc}" class="logo-img" alt="Amt Marine" onerror="this.style.display='none'">
            <div class="company-details">
                <h1>${companyName}</h1>
                <p>${companyAddress}</p>
                <p>${companyPhone}</p>
                <p>${companyEmail}</p>
            </div>
        </div>
        
        <div class="po-title-box">
            <h2>PURCHASE ORDER</h2>
            <div class="po-meta">
                <div>PO #: ${r.po_number || r.number}</div>
                <div style="margin-top:4px; font-weight:500; font-size:13px;">Date: ${r.date_ordered}</div>
            </div>
        </div>
      </div>

      <hr class="divider">

      <div class="info-grid">
        <div class="info-box">
          <div class="info-label">Vendor / Supplier</div>
          <div class="info-content">
            <strong style="font-size:16px;">${r.supplier}</strong><br>
            (See Supplier Directory for full details)
          </div>
        </div>
        <div class="info-box">
          <div class="info-label">Ship To / Vessel</div>
          <div class="info-content">
            <strong style="font-size:16px;">Vessel: ${r.vessel}</strong><br>
            c/o AMT Marine Services<br>
            Sharjah, United Arab Emirates
          </div>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width: 50%;">Description / Item</th>
            <th style="width: 20%;">Category</th>
            <th style="width: 15%;">Urgency</th>
            <th style="width: 15%; text-align:right;">Amount (${r.currency})</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>
                <strong style="font-size:15px;">${r.description}</strong>
                <div style="font-size:13px; color:#64748b; margin-top:6px; font-style:italic;">${r.remarks ? 'Note: ' + r.remarks : ''}</div>
            </td>
            <td>${r.category || '-'}</td>
            <td>${r.urgency || 'Normal'}</td>
            <td style="text-align:right;">${parseFloat(r.amount_original).toLocaleString(undefined, {minimumFractionDigits:2})}</td>
          </tr>
        </tbody>
      </table>

      <div class="totals">
        <div class="total-row final">
          <span>Total:</span>
          <span>${r.currency} ${parseFloat(r.amount_original).toLocaleString(undefined, {minimumFractionDigits:2})}</span>
        </div>
      </div>
      <div style="clear:both;"></div>

      <div class="signature-area">
        <div class="sign-box">Prepared By</div>
        <div class="sign-box">Authorized Signature</div>
      </div>

      <div class="footer">
        <p>This is a computer-generated document. Please confirm receipt within 24 hours.</p>
        <p>AMT Marine Services | Procurement Division | Sharjah, UAE</p>
      </div>

      <script>
        // Use backslash to escape the script tag so it doesn't break the HTML file
        setTimeout(function() { window.print(); }, 500);
      <\/script>
    </body>
    </html>`;

    w.document.write(htmlContent);
    w.document.close();
}

/* ================= DOCUMENTS ================= */
async function openDocPopup(id, type) {
    document.getElementById("docPopupBackdrop").classList.add("visible");
    document.getElementById("docParentType").value = type;
    document.getElementById("docParentId").value = id;
    loadDocs(id, type);
}
async function loadDocs(id, type) {
    const tbody = document.querySelector("#docTable tbody"); tbody.innerHTML = "<tr><td colspan='3'>Loading...</td></tr>";
    try {
       const docs = await apiFetch(`/api/documents/${type}/${id}`);
       tbody.innerHTML = "";
       if(docs.length===0) tbody.innerHTML = "<tr><td colspan='3'>No documents found.</td></tr>";
       docs.forEach(d => {
           tbody.innerHTML += `<tr><td><a href="/static/uploads/${d.filename}" target="_blank">${d.filename}</a></td><td>${d.uploaded_by}</td><td>${d.uploaded_at}</td></tr>`;
       });
    } catch { tbody.innerHTML = "<tr><td colspan='3'>Error loading.</td></tr>"; }
}
document.getElementById("docUploadBtn").onclick = async () => {
    const file = document.getElementById("docUploadInput").files[0];
    const pid = document.getElementById("docParentId").value;
    const ptype = document.getElementById("docParentType").value;
    if(!file) return alert("Select file");
    
    const fd = new FormData();
    fd.append("file", file);
    fd.append("parent_id", pid);
    fd.append("parent_type", ptype);
    
    try {
        await fetch("/api/documents/upload", {method:"POST", body:fd});
        document.getElementById("docUploadInput").value = "";
        loadDocs(pid, ptype);
    } catch { alert("Upload failed"); }
};


/* ================= ANALYTICS ================= */
document.getElementById("openChartBtn").onclick = () => { document.getElementById("chartBackdrop").classList.add("visible"); updateChart(); };
document.getElementById("refreshChartBtn").onclick = updateChart;
function updateChart() {
    const ctx = document.getElementById('customChart').getContext('2d');
    const xKey = document.getElementById("chartXAxis").value;
    const yMetric = document.getElementById("chartMetric").value; 
    const period = document.getElementById("chartPeriod").value;
    const vesselFilter = document.getElementById("chartVesselFilter").value;
    const specificMonth = document.getElementById("chartSpecificMonth").value; // Format YYYY-MM
    
    const now = new Date();
    const currentYear = now.getFullYear();

    const map = {};
    allReqs.forEach(r => { 
        if((r.status||'open') === 'cancelled') return;
        
        // Vessel Filter
        if(vesselFilter && r.vessel !== vesselFilter) return;

        // Time Filter
        const d = new Date(r.date_ordered);
        if(period === 'this_year' && d.getFullYear() !== currentYear) return;
        if(period === 'last_year' && d.getFullYear() !== currentYear - 1) return;
        if(period === 'monthly') {
            if(!specificMonth) return; // Wait for input
            const [yr, mn] = specificMonth.split('-');
            if(d.getFullYear() != yr || (d.getMonth() + 1) != mn) return;
        }

        const k = r[xKey] || "Unknown"; 
        const val = yMetric === 'count' ? 1 : (r.amount_usd || 0);
        map[k] = (map[k]||0) + val; 
    });

    if(myChart) myChart.destroy();
    myChart = new Chart(ctx, { 
        type: document.getElementById("chartType").value, 
        data: { 
            labels: Object.keys(map), 
            datasets: [{ 
                label: yMetric === 'count' ? 'Count of Orders' : 'Total Spend ($)', 
                data: Object.values(map), 
                backgroundColor:'#3b82f6' 
            }] 
        } 
    });
}

/* ================= AGING REPORT ================= */
document.getElementById("showAgingBtn").onclick = async () => {
    document.getElementById("agingPopupBackdrop").classList.add("visible");
    const t = document.querySelector("#agingTable tbody"); t.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";
    try { 
        const data = await apiFetch("/api/reports/aging"); 
        t.innerHTML = ""; 
        if(data.length === 0) t.innerHTML = "<tr><td colspan='5'>No overdue invoices found.</td></tr>";
        data.forEach(d => t.innerHTML += `<tr><td>${d.po}</td><td>${d.supplier}</td><td>$${d.amount}</td><td>${d.days}</td><td><span class="tag red">${d.group}</span></td></tr>`); 
    } catch { t.innerHTML="<tr><td colspan='5'>Error</td></tr>"; }
};

/* ================= SUPPLIER HISTORY & RATING ================= */
async function showSupplierHistory(supplierName) {
    const tbody = document.querySelector("#supHistTable tbody"); tbody.innerHTML="";
    document.getElementById("supHistTitle").textContent = "History: " + supplierName;
    document.getElementById("supScoreDisplay").textContent = "";
    try { const d = (await apiFetch("/api/directory")).find(x=>x.name===supplierName); if(d) document.getElementById("supScoreDisplay").textContent = "Rating: " + "‚≠ê".repeat(d.rating||5); } catch {}
    allReqs.filter(r => r.supplier === supplierName).sort((a,b)=>b.id-a.id).slice(0, 10).forEach(i => {
        tbody.innerHTML += `<tr><td>${i.date_ordered}</td><td>${i.po_number||i.number}</td><td>${i.description}</td><td>$${i.amount_usd.toFixed(2)}</td></tr>`;
    });
    document.getElementById("supHistBackdrop").classList.add("visible");
}
function openRatePopup(id) { document.getElementById("rateDirId").value=id; document.getElementById("ratePopupBackdrop").classList.add("visible"); }
document.getElementById("saveRateBtn").onclick = async () => {
    await apiFetch(`/api/directory/${document.getElementById("rateDirId").value}`, {method:"PATCH", body:JSON.stringify({rating: document.getElementById("rateScore").value, rating_comment: document.getElementById("rateComment").value})});
    document.getElementById("ratePopupBackdrop").classList.remove("visible"); await loadData();
};

/* ================= ADMIN ================= */
// Add Listeners
document.getElementById("addCatBtn").onclick = async () => {
    const name = document.getElementById("catName").value;
    const abbr = document.getElementById("catAbbr").value;
    if(!name || !abbr) return alert("Fill all fields");
    try { await apiFetch("/api/categories", {method:"POST", body:JSON.stringify({name, abbr})}); loadAdminData(); loadOptions(); } catch(e){alert(e.error);}
};
document.getElementById("addVesselBtn").onclick = async () => {
    const name = document.getElementById("vesselName").value;
    if(!name) return alert("Fill name");
    try { await apiFetch("/api/vessels", {method:"POST", body:JSON.stringify({name})}); loadAdminData(); loadOptions(); } catch(e){alert(e.error);}
};
document.getElementById("saveUserBtn").onclick = async () => {
    const u = document.getElementById("adminUsername").value;
    const p = document.getElementById("adminPassword").value;
    const r = document.getElementById("adminRole").value;
    if(!u || !p) return alert("Fill fields");
    try { await apiFetch("/api/users", {method:"POST", body:JSON.stringify({username:u, password:p, role:r})}); loadAdminData(); } catch(e){alert(e.error);}
};

async function loadAdminData() {
    if(currentUser && currentUser.role === "admin") {
        try {
            const ves = await apiFetch("/api/vessels");
            const vt = document.querySelector("#vesselTable tbody"); vt.innerHTML="";
            ves.forEach(v => vt.innerHTML += `<tr><td>${v.name}</td><td><button class="small-action danger" onclick="delVessel(${v.id})">Del</button></td></tr>`);
            
            const usrs = await apiFetch("/api/users");
            const ut = document.querySelector("#userTable tbody"); ut.innerHTML="";
            usrs.forEach(u => ut.innerHTML += `<tr><td>${u.username}</td><td>${u.role}</td><td><button class="small-action danger" onclick="delUser('${u.username}')">Del</button></td></tr>`);

            const backs = await apiFetch("/api/backups");
            const bT=document.querySelector("#backupTable tbody"); bT.innerHTML="";
            backs.forEach(b => {
                bT.innerHTML += `<tr><td>${b.name}</td><td>${b.created_at}</td><td>${(b.size/1024).toFixed(0)}KB</td>
                <td><button class="small-action secondary" onclick="window.open('/api/backups/${b.name}/download')">DL</button> <button class="small-action warning" onclick="restoreBackup('${b.name}')">Restore</button></td></tr>`;
            });
            
            allAuditLogs = await apiFetch("/api/audit");
            renderAuditLog(true);
        } catch(e) {}
    }
}
async function delCat(id){ if(confirm("Del?")) { await apiFetch(`/api/categories/${id}`, {method:"DELETE"}); loadAdminData(); loadOptions(); }}
async function delVessel(id){ if(confirm("Del?")) { await apiFetch(`/api/vessels/${id}`, {method:"DELETE"}); loadAdminData(); loadOptions(); }}
async function delUser(name){ if(confirm("Del?")) { await apiFetch(`/api/users/${name}`, {method:"DELETE"}); loadAdminData(); }}

async function restoreBackup(name) {
    if(!confirm("Restore this backup? Current data will be replaced.")) return;
    try { await apiFetch(`/api/backups/${name}/restore`, {method:"POST"}); alert("Restored! Page will reload."); window.location.reload(); } catch(e) { alert("Restore failed"); }
}
document.getElementById("uploadBackupBtn").onclick = async () => {
    const file = document.getElementById("uploadBackupInput").files[0];
    if(!file) return alert("Select a file first");
    if(!confirm("Overwrite database with this file?")) return;
    const fd = new FormData(); fd.append("file", file);
    try { await fetch("/api/upload", {method:"POST", body:fd}); alert("Uploaded & Restored! Reloading."); window.location.reload(); } catch(e) { alert("Upload failed"); }
};
document.getElementById("createBackupBtn").onclick = async () => { await apiFetch("/api/backup/create", {method:"POST"}); await loadAdminData(); };
document.getElementById("downloadBackupBtn").onclick = () => window.open("/api/backup/download", "_blank");

document.getElementById("auditRefreshBtn").onclick = async () => { allAuditLogs = await apiFetch("/api/audit"); renderAuditLog(true); };

function renderAuditLog(showAll = false) {
    const tbody = document.querySelector("#auditTable tbody"); tbody.innerHTML = "";
    const fY = document.getElementById("auditFYear").value; const fM = document.getElementById("auditFMonth").value;
    
    const filtered = allAuditLogs.filter(log => {
        if(showAll && !fY && !fM) return true;
        if(!log.date) return false;
        const d = new Date(log.date);
        if(fY && d.getFullYear() != fY) return false;
        if(fM && (d.getMonth()+1) != fM) return false;
        return true;
    });
    
    if(filtered.length === 0) tbody.innerHTML = "<tr><td colspan='5'>No logs found.</td></tr>";

    filtered.slice(0,100).forEach(log => {
        let dateStr = log.date || "-";
        try { dateStr = log.date.replace("T"," "); } catch {}
        tbody.innerHTML += `<tr><td>${log.user}</td><td>${log.action}</td><td>${log.target||'-'}</td><td>${log.details||'-'}</td><td>${dateStr}</td></tr>`;
    });
}
document.getElementById("auditApplyBtn").onclick = () => renderAuditLog(false);

/* ================= BULK & SORT ================= */
function attachBulkListeners(type) {
    const tableId = type==='req'?'reqTable':'landingTable';
    document.querySelectorAll(`#${tableId} .row-select`).forEach(chk => {
        chk.addEventListener('change', (e) => { const id=+e.target.dataset.id; if(e.target.checked){selectedIds.add(id);currentBulkType=type;}else{selectedIds.delete(id);if(selectedIds.size===0)currentBulkType=null;} toggleBulkBar(); });
    });
}
document.getElementById("reqSelectAll").onclick = (e) => { const c=e.target.checked; document.querySelectorAll("#reqTable .row-select").forEach(k=>{k.checked=c; c?selectedIds.add(+k.dataset.id):selectedIds.delete(+k.dataset.id);}); if(c) currentBulkType='req'; else currentBulkType=null; toggleBulkBar(); };
function toggleBulkBar() { const bar=document.getElementById("bulkActionBar"); document.getElementById("bulkCount").textContent=selectedIds.size; if(selectedIds.size>0)bar.classList.add("visible"); else bar.classList.remove("visible"); }
document.getElementById("bulkMarkPartialBtn").onclick=()=>runBulk("mark_partial"); document.getElementById("bulkMarkPaidBtn").onclick=()=>runBulk("mark_paid"); document.getElementById("bulkMarkDeliveredBtn").onclick=()=>runBulk("mark_delivered"); document.getElementById("bulkMarkUnpaidBtn").onclick=()=>runBulk("mark_unpaid"); document.getElementById("bulkCancelBtn").onclick=()=>{selectedIds.clear(); toggleBulkBar(); loadData();};
async function runBulk(a){ await apiFetch(currentBulkType==='req'?'/api/requisitions/bulk':'/api/landings/bulk', {method:"POST", body:JSON.stringify({ids:Array.from(selectedIds), action:a})}); selectedIds.clear(); toggleBulkBar(); await afterDataLoad(); }

function sortTable(th, idx) {
    const t = th.closest("table").querySelector("tbody"); const rows = Array.from(t.querySelectorAll("tr")); const asc = !th.classList.contains("sort-asc");
    th.closest("tr").querySelectorAll("th").forEach(h=>h.classList.remove("sort-asc","sort-desc")); th.classList.add(asc?"sort-asc":"sort-desc");
    rows.sort((a,b) => { const vA=a.cells[idx].innerText.trim(), vB=b.cells[idx].innerText.trim(); return (parseFloat(vA.replace(/[^0-9.-]+/g,""))||vA).toString().localeCompare((parseFloat(vB.replace(/[^0-9.-]+/g,""))||vB).toString(), undefined, {numeric:true}) * (asc?1:-1); });
    t.append(...rows);
}

/* ================= AUTH & UTILS ================= */
async function refreshSession() { 
    try{currentUser=await apiFetch("/api/session");}catch{currentUser=null;} 
    const ui=document.getElementById("userInfo"); 
    
    if(currentUser && currentUser.username){ 
        ui.innerHTML=`Hi, ${currentUser.username} | <a href="#" id="logoutLnk">Logout</a>`; 
        document.getElementById("logoutLnk").onclick=async()=>{await apiFetch("/api/logout",{method:"POST"});location.reload();}; 
        document.getElementById("loginCard").classList.remove("visible"); 
        
        if(currentUser.role==='admin') document.getElementById("adminTab").classList.remove("hidden"); 
        
        // Finance Role Restrictions
        if(currentUser.role==='finance') {
            document.getElementById("tabLinkLandings").classList.add("hidden");
            document.getElementById("tabLinkDirectory").classList.add("hidden");
            document.getElementById("tabLinkHistory").classList.add("hidden");
        }
    } else { 
        ui.innerHTML=`<a href="#" onclick="document.getElementById('loginCard').classList.add('visible')">Login</a>`; 
        document.getElementById("loginCard").classList.add("visible"); 
    } 
}
document.getElementById("loginBtn").onclick=async()=>{try{await apiFetch("/api/login",{method:"POST",body:JSON.stringify({username:document.getElementById("loginUsername").value,password:document.getElementById("loginPassword").value})});location.reload();}catch{document.getElementById("loginError").textContent="Invalid";}};

// TABS
document.querySelectorAll(".tab").forEach(t=>t.addEventListener("click",()=>{if(!t.classList.contains("hidden")){document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));document.querySelectorAll(".tab-content").forEach(d=>d.classList.add("hidden"));t.classList.add("active");document.getElementById(`tab-${t.dataset.tab}`).classList.remove("hidden");}}));
// Start
(async function(){ await refreshSession(); await afterDataLoad(); })();
</script>
</body>
</html>
