<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AMT Procurement</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="static/ICON.jpg">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f5f5f5; }
    header { background:#1f2937; color:#fff; padding:10px 16px; display:flex; justify-content:space-between; align-items:center; }
    header h1 { margin:0; font-size:20px; }
    header .user-info { font-size:14px; display:flex; align-items:center; gap:8px;}
    .tabs { display:flex; background:#111827; flex-wrap:wrap; }
    .tab { padding:10px 16px; color:#9ca3af; cursor:pointer; font-size:14px; user-select:none; }
    .tab.active { background:#1f2937; color:#fff; }
    .container { padding:16px; max-width:1200px; margin:0 auto; }
    .card { background:#fff; padding:16px; margin-bottom:16px; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
    .card h2 { margin-top:0; font-size:18px; }
    .flex-row { display:flex; gap:16px; flex-wrap:wrap; }
    .flex-1 { flex:1 1 0; min-width:260px; }
    label { display:block; font-size:13px; margin-bottom:6px; }
    input, select { width:100%; padding:6px 8px; margin-top:2px; box-sizing:border-box; font-size:13px; }
    button { padding:6px 10px; font-size:13px; border-radius:4px; border:none; cursor:pointer; background:#2563eb; color:#fff; }
    button.secondary { background:#6b7280; }
    button.danger { background:#b91c1c; }
    table { width:100%; border-collapse:collapse; font-size:13px; }
    th, td { border:1px solid #e5e7eb; padding:6px 8px; text-align:left; }
    th { background:#f3f4f6; }
    .tag { display:inline-block; padding:2px 6px; border-radius:999px; font-size:11px; }
    .tag.green { background:#dcfce7; color:#166534; }
    .tag.red { background:#fee2e2; color:#b91c1c; }
    .tag.gray { background:#e5e7eb; color:#374151; }
    .error { color:#b91c1c; font-size:12px; margin-top:4px; }
    .hidden { display:none; }
    #loginCard { max-width:320px; margin:12px auto; position:relative; z-index:10; }
    .summary-grid { display:flex; flex-wrap:wrap; gap:10px; }
    .summary-item { flex:1 1 180px; background:#f9fafb; padding:10px; border-radius:8px; border:1px solid #e5e7eb; font-size:13px; }
    .summary-label { color:#6b7280; font-size:12px; }
    .summary-value { font-size:18px; font-weight:bold; margin-top:4px; }
    .filter-row { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:8px; align-items:flex-end; }
    .filter-row > div { min-width:140px; flex:1 1 120px; }
    .status-pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; }
    .status-open { background:#eef2ff; color:#4f46e5; }
    .status-cancelled { background:#fee2e2; color:#b91c1c; }
    .status-delivered { background:#dcfce7; color:#166534; }
    .popup { position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#fff; border-radius:6px; box-shadow:0 10px 25px rgba(0,0,0,0.2); padding:16px; max-width:400px; width:90%; z-index:50; }
    #dirPopupBackdrop { position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:40; }
  </style>
</head>
<body>

<header>
  <div style="display:flex; align-items:center; gap:12px;">
    <img src="static/logo.png" alt="AMT Logo" style="height:40px; width:auto; border-radius:4px;">
    <h1>AMT Procurement</h1>
  </div>
  <div class="user-info" id="userInfo"></div>
</header>

<div id="loginCard" class="card hidden">
  <h2>Login</h2>
  <label>Username
    <input type="text" id="loginUsername" />
  </label>
  <label>Password
    <input type="password" id="loginPassword" />
  </label>
  <button id="loginBtn">Login</button>
  <div id="loginError" class="error"></div>
</div>

<div id="dirPopupBackdrop" class="hidden"></div>
<div id="dirPopup" class="popup hidden">
  <h3 id="dirPopupTitle">New entry</h3>
  <label>Name
    <input type="text" id="dirPopupName" />
  </label>
  <label>Email
    <input type="email" id="dirPopupEmail" />
  </label>
  <label>Phone
    <input type="text" id="dirPopupPhone" />
  </label>
  <label>Location / Address
    <input type="text" id="dirPopupAddress" />
  </label>
  <div id="dirPopupError" class="error"></div>
  <div style="margin-top:10px; text-align:right;">
    <button id="dirPopupCancelBtn" class="secondary">Cancel</button>
    <button id="dirPopupSaveBtn">Save</button>
  </div>
</div>

<div id="app">
  <div class="tabs">
    <div class="tab active" data-tab="overview">Overview</div>
    <div class="tab" data-tab="requisitions">Requisitions</div>
    <div class="tab" data-tab="landings">Landings</div>
    <div class="tab" data-tab="directory">Directory</div>
    <div class="tab" data-tab="delivered">Delivered</div>
    <div class="tab hidden" data-tab="admin" id="adminTab">Admin</div>
  </div>

  <div class="container tab-content">

    <!-- OVERVIEW -->
    <div id="tab-overview">
      <div class="card">
        <h2>Dashboard</h2>
        <div class="summary-grid">
          <div class="summary-item">
            <div class="summary-label">Open Requisitions (not delivered)</div>
            <div class="summary-value" id="summaryOpenReqNotDel">0</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Open Requisitions (unpaid)</div>
            <div class="summary-value" id="summaryOpenReqUnpaid">0</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Open Landed Items (not delivered)</div>
            <div class="summary-value" id="summaryOpenLandNotDel">0</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Open Landed Items (unpaid)</div>
            <div class="summary-value" id="summaryOpenLandUnpaid">0</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Paid Totals (Filters)</h2>
        <div class="filter-row">
          <div>
            <label>Type
              <select id="ovTypeFilter">
                <option value="">All</option>
                <option value="req">Requisitions</option>
                <option value="land">Workshops (Landed Items)</option>
              </select>
            </label>
          </div>
          <div>
            <label>Vessel
              <select id="ovVesselFilter">
                <option value="">All</option>
              </select>
            </label>
          </div>
          <div>
            <label>Paid?
              <select id="ovPaidFilter">
                <option value="">All</option>
                <option value="1">Paid</option>
                <option value="0">Unpaid</option>
              </select>
            </label>
          </div>
          <div>
            <label>Month
              <select id="ovMonthFilter">
                <option value="">All months</option>
              </select>
            </label>
          </div>
          <div>
            <label>Quarter
              <select id="ovQuarterFilter">
                <option value="">All quarters</option>
                <option value="Q1">Q1</option>
                <option value="Q2">Q2</option>
                <option value="Q3">Q3</option>
                <option value="Q4">Q4</option>
              </select>
            </label>
          </div>
          <div>
            <label>Category
              <select id="ovCategoryFilter">
                <option value="">All categories</option>
              </select>
            </label>
          </div>
          <div>
            <label>Year
              <select id="ovYearFilter">
                <option value="">All years</option>
              </select>
            </label>
          </div>
          <div style="align-self:flex-end;">
            <button id="ovApplyTotalsBtn">Apply</button>
            <button id="ovClearTotalsBtn" class="secondary">Clear</button>
          </div>
        </div>

        <div class="summary-grid" style="margin-top:10px;">
          <div class="summary-item">
            <div class="summary-label">Total Paid (Selected Period)</div>
            <div class="summary-value" id="ovPaidMonthTotal">0</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Total Paid (Selected Year)</div>
            <div class="summary-value" id="ovPaidYearTotal">0</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Total Amount (Filter Result)</div>
            <div class="summary-value" id="ovAllTotal">0</div>
          </div>
        </div>

        <h3 style="margin-top:16px;">Top 5 Suppliers (Selected Period)</h3>
        <ul id="ovTopSuppliers" style="padding-left:18px; margin-top:6px;">
          <li>—</li>
        </ul>
      </div>

      <div class="flex-row">
        <div class="card flex-1">
          <h2>Recent Requisitions</h2>
          <table id="overviewReqTable">
            <thead>
              <tr>
                <th>Number</th><th>Vessel</th><th>Category</th><th>Supplier</th>
                <th>Ordered</th><th>Amount (USD)</th><th>Paid</th><th>Delivered</th><th>Status</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="card flex-1">
          <h2>Recent Landed Items</h2>
          <table id="overviewLandTable">
            <thead>
              <tr>
                <th>Vessel</th><th>Description</th><th>Workshop</th>
                <th>Expected</th><th>Landed</th><th>Amount (USD)</th>
                <th>Paid</th><th>Delivered</th><th>Status</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- REQUISITIONS -->
    <div id="tab-requisitions" class="hidden">
      <div class="card">
        <h2 id="reqFormTitle">Add Requisition</h2>
        <div class="flex-row">
          <div class="flex-1">
            <label>Requisition Number
              <input type="text" id="reqNumber" />
            </label>
          </div>
          <div class="flex-1">
            <label>Vessel
              <select id="reqVessel"></select>
            </label>
          </div>
          <div class="flex-1">
            <label>Category (Abbreviation)
              <select id="reqCategory"></select>
            </label>
          </div>
        </div>

        <div class="flex-row">
          <div class="flex-1">
            <label>Supplier
              <div style="display:flex; gap:8px;">
                <select id="reqSupplierSelect" style="flex:1;"></select>
                <button id="newSupplierBtn" type="button">New</button>
              </div>
            </label>
          </div>
          <div class="flex-1">
            <label>Date Ordered
              <input type="date" id="reqDateOrdered" />
            </label>
          </div>
          <div class="flex-1">
            <label>Expected Date
              <input type="date" id="reqExpected" />
            </label>
          </div>
        </div>

        <div class="flex-row">
          <div class="flex-1">
            <label>Amount
              <input type="number" id="reqTotal" step="0.01" />
            </label>
          </div>
          <div class="flex-1">
            <label>Currency
              <select id="reqCurrency"></select>
            </label>
          </div>
          <div class="flex-1">
            <label>
              <input type="checkbox" id="reqPaid" /> Paid
            </label>
          </div>
        </div>

        <div style="margin-top:8px;">
          <button id="saveReqBtn">Save Requisition</button>
          <button id="cancelReqEditBtn" class="secondary hidden" type="button">Cancel Edit</button>
        </div>
        <div id="reqError" class="error"></div>
      </div>

      <div class="card">
        <h2>Filter Requisitions</h2>
        <div class="filter-row">
          <div>
            <label>Status
              <select id="filterReqStatus">
                <option value="">All</option>
                <option value="open">Open</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </label>
          </div>
          <div>
            <label>Paid
              <select id="filterReqPaid">
                <option value="">All</option>
                <option value="1">Paid</option>
                <option value="0">Unpaid</option>
              </select>
            </label>
          </div>
          <div>
            <label>Delivered
              <select id="filterReqDelivered">
                <option value="">All</option>
                <option value="1">Delivered</option>
                <option value="0">Not delivered</option>
              </select>
            </label>
          </div>
          <div>
            <label>Search (number / vessel / supplier)
              <input type="text" id="filterReqSearch" placeholder="Search..." />
            </label>
          </div>
          <div style="align-self:flex-end;">
            <button id="applyReqFilterBtn">Apply</button>
            <button id="clearReqFilterBtn" class="secondary" type="button">Clear</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>All Requisitions</h2>
        <table id="reqTable">
          <thead>
            <tr>
              <th>ID</th><th>Number</th><th>Vessel</th><th>Category</th><th>Supplier</th>
              <th>Ordered</th><th>Expected</th><th>Amount (USD)</th>
              <th>Paid</th><th>Delivered</th><th>Status</th><th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <h2>Cancelled / Deleted Requisitions</h2>
        <table id="reqCancelledTable">
          <thead>
            <tr>
              <th>ID</th><th>Number</th><th>Vessel</th><th>Category</th><th>Supplier</th>
              <th>Ordered</th><th>Expected</th><th>Amount (USD)</th><th>Paid</th><th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- LANDINGS -->
    <div id="tab-landings" class="hidden">
      <div class="card">
        <h2 id="landFormTitle">Add Landed Item</h2>
        <div class="flex-row">
          <div class="flex-1">
            <label>Vessel
              <select id="landVessel"></select>
            </label>
          </div>
          <div class="flex-1">
            <label>Description
              <input type="text" id="landDescription" />
            </label>
          </div>
          <div class="flex-1">
            <label>Workshop
              <div style="display:flex; gap:8px;">
                <select id="landWorkshopSelect" style="flex:1;"></select>
                <button id="newWorkshopBtn" type="button">New</button>
              </div>
            </label>
          </div>
        </div>

        <div class="flex-row">
          <div class="flex-1">
            <label>Expected Delivery Date
              <input type="date" id="landExpected" />
            </label>
          </div>
          <div class="flex-1">
            <label>Landed Date
              <input type="date" id="landLanded" />
            </label>
          </div>
        </div>

        <div class="flex-row">
          <div class="flex-1">
            <label>Amount
              <input type="number" id="landAmount" step="0.01" />
            </label>
          </div>
          <div class="flex-1">
            <label>Currency
              <select id="landCurrency"></select>
            </label>
          </div>
          <div class="flex-1">
            <label>
              <input type="checkbox" id="landPaid" /> Paid
            </label>
          </div>
        </div>

        <div style="margin-top:8px;">
          <button id="saveLandingBtn">Save Landed Item</button>
          <button id="cancelLandEditBtn" class="secondary hidden" type="button">Cancel Edit</button>
        </div>
        <div id="landError" class="error"></div>
      </div>

      <div class="card">
        <h2>Filter Landed Items</h2>
        <div class="filter-row">
          <div>
            <label>Status
              <select id="filterLandingStatus">
                <option value="">All</option>
                <option value="open">Open</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </label>
          </div>
          <div>
            <label>Paid
              <select id="filterLandingPaid">
                <option value="">All</option>
                <option value="1">Paid</option>
                <option value="0">Unpaid</option>
              </select>
            </label>
          </div>
          <div>
            <label>Delivered
              <select id="filterLandingDelivered">
                <option value="">All</option>
                <option value="1">Delivered</option>
                <option value="0">Not delivered</option>
              </select>
            </label>
          </div>
          <div>
            <label>Search (vessel / description / workshop)
              <input type="text" id="filterLandingSearch" placeholder="Search..." />
            </label>
          </div>
          <div style="align-self:flex-end;">
            <button id="applyLandingFilterBtn">Apply</button>
            <button id="clearLandingFilterBtn" class="secondary" type="button">Clear</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>All Landed Items</h2>
        <table id="landingTable">
          <thead>
            <tr>
              <th>ID</th><th>Vessel</th><th>Description</th><th>Workshop</th>
              <th>Expected</th><th>Landed Date</th><th>Amount (USD)</th>
              <th>Paid</th><th>Delivered</th><th>Status</th><th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <h2>Cancelled / Deleted Landed Items</h2>
        <table id="landingCancelledTable">
          <thead>
            <tr>
              <th>ID</th><th>Vessel</th><th>Description</th><th>Workshop</th>
              <th>Expected</th><th>Landed Date</th><th>Amount (USD)</th><th>Paid</th><th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- DIRECTORY -->
    <div id="tab-directory" class="hidden">
      <div class="card">
        <h2>Suppliers & Workshops</h2>
        <div style="margin-bottom:8px;">
          <button id="dirNewSupplierBtn">Add Supplier</button>
          <button id="dirNewWorkshopBtn" class="secondary" type="button">Add Workshop</button>
        </div>
        <table id="directoryTable">
          <thead>
            <tr><th>ID</th><th>Type</th><th>Name</th><th>Email</th><th>Phone</th><th>Address</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- DELIVERED -->
    <div id="tab-delivered" class="hidden">
      <div class="card">
        <h2>Delivered Requisitions</h2>
        <div class="filter-row">
          <div>
            <label>Paid
              <select id="filterDeliveredReqPaid">
                <option value="">All</option>
                <option value="1">Paid</option>
                <option value="0">Unpaid</option>
              </select>
            </label>
          </div>
          <div>
            <label>Search (number / vessel / supplier)
              <input type="text" id="filterDeliveredReqSearch" placeholder="Search..." />
            </label>
          </div>
          <div style="align-self:flex-end;">
            <button id="applyDeliveredReqFilterBtn">Apply</button>
            <button id="clearDeliveredReqFilterBtn" class="secondary" type="button">Clear</button>
          </div>
        </div>
        <table id="deliveredReqTable">
          <thead>
            <tr>
              <th>ID</th><th>Number</th><th>Vessel</th><th>Category</th><th>Supplier</th>
              <th>Ordered</th><th>Expected</th><th>Amount (USD)</th><th>Paid</th><th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <h2>Delivered Landed Items</h2>
        <div class="filter-row">
          <div>
            <label>Paid
              <select id="filterDeliveredLandPaid">
                <option value="">All</option>
                <option value="1">Paid</option>
                <option value="0">Unpaid</option>
              </select>
            </label>
          </div>
          <div>
            <label>Search (vessel / description / workshop)
              <input type="text" id="filterDeliveredLandSearch" placeholder="Search..." />
            </label>
          </div>
          <div style="align-self:flex-end;">
            <button id="applyDeliveredLandFilterBtn">Apply</button>
            <button id="clearDeliveredLandFilterBtn" class="secondary" type="button">Clear</button>
          </div>
        </div>
        <table id="deliveredLandTable">
          <thead>
            <tr>
              <th>ID</th><th>Vessel</th><th>Description</th><th>Workshop</th>
              <th>Expected</th><th>Landed Date</th><th>Amount (USD)</th><th>Paid</th><th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- ADMIN -->
    <div id="tab-admin" class="hidden">
      <div class="card">
        <h2>Categories</h2>
        <div class="flex-row">
          <div class="flex-1">
            <label>Category Name
              <input type="text" id="catName" />
            </label>
          </div>
          <div class="flex-1">
            <label>Abbreviation
              <input type="text" id="catAbbr" />
            </label>
          </div>
        </div>
        <div style="margin-top:8px;">
          <button id="addCatBtn">Save Category</button>
          <button id="cancelCatEditBtn" class="secondary hidden" type="button">Cancel Edit</button>
        </div>
        <div class="error" id="catError"></div>
        <table id="catTable" style="margin-top:10px;">
          <thead><tr><th>ID</th><th>Name</th><th>Abbreviation</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <h2>Vessels</h2>
        <div class="flex-row">
          <div class="flex-1">
            <label>Vessel Name
              <input type="text" id="vesselName" />
            </label>
          </div>
        </div>
        <div style="margin-top:8px;">
          <button id="addVesselBtn">Save Vessel</button>
          <button id="cancelVesselEditBtn" class="secondary hidden" type="button">Cancel Edit</button>
        </div>
        <div class="error" id="vesselError"></div>
        <table id="vesselTable" style="margin-top:10px;">
          <thead><tr><th>ID</th><th>Name</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <h2>Users</h2>
        <div class="flex-row">
          <div class="flex-1">
            <label>Username
              <input type="text" id="adminUsername"/>
            </label>
          </div>
          <div class="flex-1">
            <label>Password
              <input type="password" id="adminPassword"/>
            </label>
          </div>
          <div class="flex-1">
            <label>Role
              <select id="adminRole">
                <option value="user">User</option>
                <option value="admin">Admin</option>
                <option value="viewer">Viewer</option>
                <option value="finance">Finance</option>
              </select>
            </label>
          </div>
        </div>
        <div style="margin-top:8px;">
          <button id="saveUserBtn">Save User</button>
        </div>
        <div id="adminUserError" class="error"></div>
        <table id="userTable" style="margin-top:10px;">
          <thead><tr><th>Username</th><th>Role</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script>
/* ========= Helpers ========= */
async function apiFetch(url, options = {}) {
  const res = await fetch(url, {
    headers: { "Content-Type": "application/json" },
    credentials: "same-origin",
    ...options
  });
  if (!res.ok) {
    let err;
    try { err = await res.json(); } catch { err = { error: "unknown" }; }
    throw err;
  }
  return res.json();
}

let currentUser = null;
let allReqs = [];
let allLandings = [];
let vessels = [];
let editingReqId = null;
let editingLandId = null;
let editingCatId = null;
let editingVesselId = null;
let dirPopupType = null;
let currencyList = ["USD"];

function quarterOfMonth(m){
  if (m <= 3) return "Q1";
  if (m <= 6) return "Q2";
  if (m <= 9) return "Q3";
  return "Q4";
}
function parseDateSafe(d) {
  if (!d) return null;
  const dt = new Date(d);
  return isNaN(dt.getTime()) ? null : dt;
}

/* ========= Currencies ========= */
async function loadCurrencies() {
  try {
    const res = await apiFetch("/api/currencies");
    currencyList = res.currencies || ["USD"];
  } catch (e) {
    console.warn("FX error, fallback to defaults", e);
    currencyList = ["USD","EUR","AED","GBP","LBP"];
  }
  const reqCurSel = document.getElementById("reqCurrency");
  const landCurSel = document.getElementById("landCurrency");
  reqCurSel.innerHTML = ""; landCurSel.innerHTML = "";
  currencyList.forEach(cur => {
    const o1 = document.createElement("option"); o1.value = cur; o1.textContent = cur; reqCurSel.appendChild(o1);
    const o2 = document.createElement("option"); o2.value = cur; o2.textContent = cur; landCurSel.appendChild(o2);
  });
  if (!reqCurSel.value) reqCurSel.value = "USD";
  if (!landCurSel.value) landCurSel.value = "USD";
}

/* ========= Session / Header / Login ========= */
async function refreshSession() {
  try {
    currentUser = await apiFetch("/api/session");
  } catch {
    currentUser = null;
  }

  const userInfo = document.getElementById("userInfo");
  const loginCard = document.getElementById("loginCard");

  if (currentUser && currentUser.username) {
    userInfo.innerHTML = `
      Logged in as <strong>${currentUser.username}</strong> (${currentUser.role})
      <button id="logoutBtn">Logout</button>
    `;
    document.getElementById("logoutBtn").onclick = async () => {
      await apiFetch("/api/logout", { method:"POST" });
      currentUser = null;
      loginCard.classList.add("hidden");
      await refreshSession();
      await afterDataLoad();
    };
    loginCard.classList.add("hidden");
  } else {
    userInfo.innerHTML = `
      Not logged in
      <button id="showLoginBtn">Login</button>
    `;
    document.getElementById("showLoginBtn").onclick = () => {
      loginCard.classList.toggle("hidden");
    };
  }

  // Show/hide Admin tab
  const isAdmin = currentUser && currentUser.role === "admin";
  const adminTab = document.getElementById("adminTab");
  if (adminTab) {
    if (isAdmin) adminTab.classList.remove("hidden");
    else adminTab.classList.add("hidden");
  }

  // Disable admin-only inputs for non-admin
  ["catName","catAbbr","addCatBtn","cancelCatEditBtn",
   "adminUsername","adminPassword","adminRole","saveUserBtn",
   "vesselName","addVesselBtn","cancelVesselEditBtn"].forEach(id=>{
    const el = document.getElementById(id);
    if (el) el.disabled = !isAdmin && (id!=="adminRole");
  });
}

document.getElementById("loginBtn").onclick = async () => {
  const u = document.getElementById("loginUsername").value.trim();
  const p = document.getElementById("loginPassword").value;
  const errDiv = document.getElementById("loginError");
  errDiv.textContent = "";
  try {
    await apiFetch("/api/login", {
      method:"POST",
      body: JSON.stringify({ username:u, password:p })
    });
    document.getElementById("loginCard").classList.add("hidden");
    document.getElementById("loginUsername").value = "";
    document.getElementById("loginPassword").value = "";
    await refreshSession();
    await afterDataLoad(true);
  } catch(e) {
    if (e.error === "invalid_credentials") errDiv.textContent = "Invalid username or password.";
    else errDiv.textContent = "Login failed.";
  }
};

/* ========= Tabs ========= */
document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    if (tab.classList.contains("hidden")) return;
    const t = tab.dataset.tab;
    document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
    document.querySelectorAll("[id^='tab-']").forEach(div => div.classList.add("hidden"));
    tab.classList.add("active");
    document.getElementById(`tab-${t}`).classList.remove("hidden");
  });
});

/* ========= Overview Totals Filters ========= */
async function loadOverviewTotalsFilters() {
  let reqs = allReqs, lands = allLandings;
  if (!reqs.length) { try { reqs = await apiFetch("/api/requisitions"); } catch { reqs=[]; } }
  if (!lands.length) { try { lands = await apiFetch("/api/landings"); } catch { lands=[]; } }

  // Month dropdown 1..12
  const monthSel = document.getElementById("ovMonthFilter");
  monthSel.innerHTML = `<option value="">All months</option>` +
    Array.from({length:12},(_,i)=>`<option value="${i+1}">${i+1}</option>`).join("");

  // Categories
  const cats = new Set();
  reqs.forEach(r => cats.add((r.category || "").trim()));
  lands.forEach(r => cats.add((r.category || "").trim()));
  const catSel = document.getElementById("ovCategoryFilter");
  catSel.innerHTML = `<option value="">All categories</option>` +
    [...cats].filter(Boolean).sort().map(c=>`<option value="${c}">${c}</option>`).join("");

  // Vessels
  const vset = new Set();
  reqs.forEach(r => vset.add((r.vessel || "").trim()));
  lands.forEach(r => vset.add((r.vessel || "").trim()));
  const vesselSel = document.getElementById("ovVesselFilter");
  vesselSel.innerHTML = `<option value="">All</option>` +
    [...vset].filter(Boolean).sort().map(v=>`<option value="${v}">${v}</option>`).join("");

  // Years
  const years = new Set();
  reqs.forEach(r => { const dt=parseDateSafe(r.date_ordered); if (dt) years.add(dt.getFullYear()); });
  lands.forEach(r => { const dt=parseDateSafe(r.landed_date); if (dt) years.add(dt.getFullYear()); });
  const yearSel = document.getElementById("ovYearFilter");
  yearSel.innerHTML = `<option value="">All years</option>` +
    [...years].sort((a,b)=>b-a).map(y=>`<option value="${y}">${y}</option>`).join("");

  updateOverviewPaidTotals(reqs, lands);
}

function updateOverviewPaidTotals(reqs, lands) {
  const typeF = document.getElementById("ovTypeFilter").value;
  const vesselF = document.getElementById("ovVesselFilter").value;
  const paidF = document.getElementById("ovPaidFilter").value;
  const monthF = document.getElementById("ovMonthFilter").value;
  const yearF = document.getElementById("ovYearFilter").value;
  const quarterF = document.getElementById("ovQuarterFilter").value;
  const categoryF = document.getElementById("ovCategoryFilter").value;

  let filtered = [];
  if (!typeF || typeF==="req") filtered = filtered.concat(reqs.map(r=>({
    _type:"req", vessel:r.vessel, category:r.category, supplier:r.supplier,
    paid:Number(r.paid||0), amount:Number(r.total_amount||0), date:r.date_ordered
  })));
  if (!typeF || typeF==="land") filtered = filtered.concat(lands.map(r=>({
    _type:"land", vessel:r.vessel, category:r.category, supplier:r.supplier||r.workshop,
    paid:Number(r.paid||0), amount:Number(r.amount||0), date:r.landed_date
  })));

  filtered = filtered.filter(x=>{
    if (vesselF && (x.vessel||"")!==vesselF) return false;
    if (paidF!=="" && String(x.paid)!==paidF) return false;
    const dt=parseDateSafe(x.date); if(!dt) return false;
    const mm=dt.getMonth()+1, yy=dt.getFullYear(), qq=quarterOfMonth(mm);
    if (yearF && String(yy)!==yearF) return false;
    if (monthF) { if(String(mm)!==monthF) return false; }
    else if (quarterF) { if(qq!==quarterF) return false; }
    if (categoryF && (x.category||"")!==categoryF) return false;
    return true;
  });

  const allTotal = filtered.reduce((s,x)=>s+x.amount,0);
  const paidOnly = filtered.filter(x=>x.paid===1);
  const paidMonthTotal = paidOnly.reduce((s,x)=>s+x.amount,0);

  let paidYearTotal = 0;
  if (yearF) {
    paidYearTotal = paidOnly.filter(x=>{
      const dt=parseDateSafe(x.date);
      return dt && String(dt.getFullYear())===yearF;
    }).reduce((s,x)=>s+x.amount,0);
  } else {
    paidYearTotal = paidMonthTotal;
  }

  document.getElementById("ovAllTotal").textContent = allTotal.toFixed(2);
  document.getElementById("ovPaidMonthTotal").textContent = paidMonthTotal.toFixed(2);
  document.getElementById("ovPaidYearTotal").textContent = paidYearTotal.toFixed(2);

  // Top suppliers
  const supMap = {};
  filtered.forEach(x=>{
    const sname=x.supplier||"Unknown";
    supMap[sname]=(supMap[sname]||0)+x.amount;
  });
  const topSup = Object.entries(supMap).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const ul=document.getElementById("ovTopSuppliers");
  ul.innerHTML = topSup.length ? topSup.map(([k,v])=>`<li>${k}: $${v.toFixed(2)}</li>`).join("") : "<li>—</li>";
}

document.getElementById("ovApplyTotalsBtn").onclick = async () => {
  let reqs = allReqs, lands = allLandings;
  if (!reqs.length) { try { reqs = await apiFetch("/api/requisitions"); } catch { reqs=[]; } }
  if (!lands.length) { try { lands = await apiFetch("/api/landings"); } catch { lands=[]; } }
  updateOverviewPaidTotals(reqs, lands);
};
document.getElementById("ovClearTotalsBtn").onclick = async () => {
  ["ovTypeFilter","ovVesselFilter","ovPaidFilter","ovMonthFilter","ovYearFilter","ovQuarterFilter","ovCategoryFilter"].forEach(id=>{
    document.getElementById(id).value="";
  });
  await loadOverviewTotalsFilters();
};

/* ========= Directory Options / Popup / Page ========= */
async function loadDirectoryOptions() {
  let suppliers=[], workshops=[];
  try { suppliers=await apiFetch("/api/directory?type=supplier"); } catch {}
  try { workshops=await apiFetch("/api/directory?type=workshop"); } catch {}
  const supSel=document.getElementById("reqSupplierSelect");
  const workSel=document.getElementById("landWorkshopSelect");
  supSel.innerHTML='<option value="">Select supplier</option>';
  workSel.innerHTML='<option value="">Select workshop</option>';
  suppliers.forEach(s=>{ const o=document.createElement("option"); o.value=s.name; o.textContent=s.name; supSel.appendChild(o); });
  workshops.forEach(w=>{ const o=document.createElement("option"); o.value=w.name; o.textContent=w.name; workSel.appendChild(o); });
}

function openDirPopup(type){
  dirPopupType=type;
  document.getElementById("dirPopupTitle").textContent=type==="supplier"?"New Supplier":"New Workshop";
  ["dirPopupName","dirPopupEmail","dirPopupPhone","dirPopupAddress"].forEach(id=>document.getElementById(id).value="");
  document.getElementById("dirPopupError").textContent="";
  document.getElementById("dirPopupBackdrop").classList.remove("hidden");
  document.getElementById("dirPopup").classList.remove("hidden");
}
function closeDirPopup(){
  document.getElementById("dirPopupBackdrop").classList.add("hidden");
  document.getElementById("dirPopup").classList.add("hidden");
}
document.getElementById("dirPopupCancelBtn").onclick=closeDirPopup;
document.getElementById("dirPopupSaveBtn").onclick=async ()=>{
  const name=document.getElementById("dirPopupName").value.trim();
  const email=document.getElementById("dirPopupEmail").value.trim();
  const phone=document.getElementById("dirPopupPhone").value.trim();
  const address=document.getElementById("dirPopupAddress").value.trim();
  const err=document.getElementById("dirPopupError");
  err.textContent="";
  if(!dirPopupType){ err.textContent="Unknown type."; return; }
  if(!name){ err.textContent="Name is required."; return; }
  try{
    await apiFetch("/api/directory/quick",{method:"POST",body:JSON.stringify({type:dirPopupType,name,email,phone,address})});
    closeDirPopup();
    await loadDirectoryOptions();
    await loadDirectoryPage();
  }catch(e){ err.textContent=e.error==="login_required"?"You must be logged in.":"Error saving."; }
};
document.getElementById("newSupplierBtn").onclick=()=>openDirPopup("supplier");
document.getElementById("newWorkshopBtn").onclick=()=>openDirPopup("workshop");
document.getElementById("dirNewSupplierBtn").onclick=()=>openDirPopup("supplier");
document.getElementById("dirNewWorkshopBtn").onclick=()=>openDirPopup("workshop");

async function loadDirectoryPage(){
  let rows=[]; try{ rows=await apiFetch("/api/directory"); }catch{}
  const tbody=document.querySelector("#directoryTable tbody");
  tbody.innerHTML="";
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r.id}</td><td>${r.type}</td><td>${r.name}</td><td>${r.email||""}</td><td>${r.phone||""}</td><td>${r.address||""}</td>`;
    tbody.appendChild(tr);
  });
}

/* ========= Vessels ========= */
async function loadVessels(){
  try { vessels=await apiFetch("/api/vessels"); } catch { vessels=[]; }
  const reqSel=document.getElementById("reqVessel");
  const landSel=document.getElementById("landVessel");
  if(reqSel){
    const cur=reqSel.value;
    reqSel.innerHTML='<option value="">Select vessel</option>';
    vessels.forEach(v=>{ const o=document.createElement("option"); o.value=v.name; o.textContent=v.name; reqSel.appendChild(o); });
    if(cur) reqSel.value=cur;
  }
  if(landSel){
    const cur=landSel.value;
    landSel.innerHTML='<option value="">Select vessel</option>';
    vessels.forEach(v=>{ const o=document.createElement("option"); o.value=v.name; o.textContent=v.name; landSel.appendChild(o); });
    if(cur) landSel.value=cur;
  }
  // admin table
  const tbody=document.querySelector("#vesselTable tbody");
  if(!tbody) return;
  tbody.innerHTML="";
  vessels.forEach(v=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${v.id}</td><td>${v.name}</td>
      <td>
        <button class="edit-vessel" data-id="${v.id}">Edit</button>
        <button class="danger delete-vessel" data-id="${v.id}">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });

  document.querySelectorAll(".edit-vessel").forEach(btn=>{
    btn.onclick=()=>{
      const id=+btn.dataset.id;
      const v=vessels.find(x=>x.id===id);
      if(!v) return;
      editingVesselId=id;
      document.getElementById("vesselName").value=v.name;
      document.getElementById("cancelVesselEditBtn").classList.remove("hidden");
    };
  });
  document.querySelectorAll(".delete-vessel").forEach(btn=>{
    btn.onclick=async ()=>{
      const id=+btn.dataset.id;
      if(!confirm("Delete this vessel?")) return;
      try{ await apiFetch(`/api/vessels/${id}`,{method:"DELETE"}); await loadVessels(); }catch{ alert("Error deleting vessel."); }
    };
  });
}

document.getElementById("addVesselBtn").onclick=async ()=>{
  const name=document.getElementById("vesselName").value.trim();
  const err=document.getElementById("vesselError");
  err.textContent="";
  if(!name){ err.textContent="Vessel name required."; return; }
  try{
    if(editingVesselId){
      await apiFetch(`/api/vessels/${editingVesselId}`,{method:"PATCH",body:JSON.stringify({name})});
    }else{
      await apiFetch("/api/vessels",{method:"POST",body:JSON.stringify({name})});
    }
    editingVesselId=null;
    document.getElementById("vesselName").value="";
    document.getElementById("cancelVesselEditBtn").classList.add("hidden");
    await loadVessels();
  }catch(e){
    if(e.error==="duplicate_name") err.textContent="This vessel already exists.";
    else if(e.error==="admin_required") err.textContent="Only admin can manage vessels.";
    else err.textContent="Error saving vessel.";
  }
};
document.getElementById("cancelVesselEditBtn").onclick=()=>{
  editingVesselId=null;
  document.getElementById("vesselName").value="";
  document.getElementById("cancelVesselEditBtn").classList.add("hidden");
};

/* ========= Categories ========= */
async function loadCategories(){
  let cats=[]; try{ cats=await apiFetch("/api/categories"); }catch{}
  const catSelect=document.getElementById("reqCategory");
  if(catSelect){
    catSelect.innerHTML='<option value="">Select category</option>';
    cats.forEach(c=>{ const o=document.createElement("option"); o.value=c.abbr; o.textContent=`${c.abbr} - ${c.name}`; catSelect.appendChild(o); });
  }
  const tbody=document.querySelector("#catTable tbody");
  tbody.innerHTML="";
  cats.forEach(c=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${c.id}</td><td>${c.name}</td><td>${c.abbr}</td>
      <td><button class="edit-cat" data-id="${c.id}">Edit</button>
          <button class="danger delete-cat" data-id="${c.id}">Delete</button></td>`;
    tbody.appendChild(tr);
  });
  document.querySelectorAll(".edit-cat").forEach(btn=>{
    btn.onclick=()=>{
      const id=+btn.dataset.id;
      const cat=cats.find(x=>x.id===id);
      if(!cat) return;
      editingCatId=id;
      document.getElementById("catName").value=cat.name;
      document.getElementById("catAbbr").value=cat.abbr;
      document.getElementById("cancelCatEditBtn").classList.remove("hidden");
    };
  });
  document.querySelectorAll(".delete-cat").forEach(btn=>{
    btn.onclick=async ()=>{
      const id=+btn.dataset.id;
      if(!confirm("Delete this category?")) return;
      try{ await apiFetch(`/api/categories/${id}`,{method:"DELETE"}); await loadCategories(); }catch{ alert("Error deleting category."); }
    };
  });
}
document.getElementById("addCatBtn").onclick=async ()=>{
  const name=document.getElementById("catName").value.trim();
  const abbr=document.getElementById("catAbbr").value.trim();
  const err=document.getElementById("catError"); err.textContent="";
  if(!name||!abbr){ err.textContent="Name and abbreviation are required."; return; }
  try{
    if(editingCatId){
      await apiFetch(`/api/categories/${editingCatId}`,{method:"PATCH",body:JSON.stringify({name,abbr})});
    }else{
      await apiFetch("/api/categories",{method:"POST",body:JSON.stringify({name,abbr})});
    }
    editingCatId=null;
    document.getElementById("catName").value="";
    document.getElementById("catAbbr").value="";
    document.getElementById("cancelCatEditBtn").classList.add("hidden");
    await loadCategories(); await loadOverviewTotalsFilters();
  }catch(e){
    if(e.error==="duplicate_abbr") err.textContent="Abbreviation already exists.";
    else if(e.error==="admin_required") err.textContent="Only admin can manage categories.";
    else err.textContent="Error saving category.";
  }
};
document.getElementById("cancelCatEditBtn").onclick=()=>{
  editingCatId=null;
  document.getElementById("catName").value="";
  document.getElementById("catAbbr").value="";
  document.getElementById("cancelCatEditBtn").classList.add("hidden");
};

/* ========= Users ========= */
async function loadUsersAdmin(){
  let users=[]; try{ users=await apiFetch("/api/users"); }catch{}
  const tbody=document.querySelector("#userTable tbody"); tbody.innerHTML="";
  users.forEach(u=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${u.username}</td><td>${u.role}</td>
      <td><button class="danger delete-user" data-username="${u.username}">Delete</button></td>`;
    tbody.appendChild(tr);
  });
  document.querySelectorAll(".delete-user").forEach(btn=>{
    btn.onclick=async ()=>{
      const username=btn.dataset.username;
      if(!confirm(`Delete user "${username}"?`)) return;
      try{ await apiFetch(`/api/users/${username}`,{method:"DELETE"}); await loadUsersAdmin(); }catch{ alert("Error deleting user.");}
    };
  });
}
document.getElementById("saveUserBtn").onclick=async ()=>{
  const username=document.getElementById("adminUsername").value.trim();
  const password=document.getElementById("adminPassword").value;
  const role=document.getElementById("adminRole").value;
  const err=document.getElementById("adminUserError"); err.textContent="";
  if(!username||!password){ err.textContent="Username and password are required."; return; }
  try{
    await apiFetch("/api/users",{method:"POST",body:JSON.stringify({username,password,role})});
    document.getElementById("adminUsername").value="";
    document.getElementById("adminPassword").value="";
    document.getElementById("adminRole").value="user";
    await loadUsersAdmin();
  }catch(e){
    if(e.error==="admin_required") err.textContent="Only admin can manage users.";
    else err.textContent="Error saving user.";
  }
};

/* ========= Requisitions ========= */
async function loadAllRequisitions(){
  let rows=[]; try{ rows=await apiFetch("/api/requisitions"); }catch{}
  allReqs=rows;
  const tbody=document.querySelector("#reqTable tbody"); tbody.innerHTML="";
  const statusFilter=document.getElementById("filterReqStatus").value;
  const paidFilter=document.getElementById("filterReqPaid").value;
  const delFilter=document.getElementById("filterReqDelivered").value;
  const search=document.getElementById("filterReqSearch").value.toLowerCase();

  rows.forEach(r=>{
    const matchesStatus=!statusFilter||(r.status||"open")===statusFilter;
    const matchesPaid=paidFilter===""||String(r.paid||0)===paidFilter;
    const matchesDel=delFilter===""||String(r.delivered||0)===delFilter;
    const matchesSearch=!search||(r.number||"").toLowerCase().includes(search)||(r.vessel||"").toLowerCase().includes(search)||(r.supplier||"").toLowerCase().includes(search);
    if(!(matchesStatus&&matchesPaid&&matchesDel&&matchesSearch)) return;

    const tr=document.createElement("tr");
    const paidTag=r.paid?'<span class="tag green">Paid</span>':'<span class="tag red">Unpaid</span>';
    const delTag=r.delivered?'<span class="tag green">Delivered</span>':'<span class="tag gray">Open</span>';
    let statusClass="status-open";
    if((r.status||"open")==="cancelled") statusClass="status-cancelled";
    if(r.delivered) statusClass="status-delivered";

    tr.innerHTML=`<td>${r.id}</td><td>${r.number}</td><td>${r.vessel}</td><td>${r.category||""}</td><td>${r.supplier||""}</td>
      <td>${r.date_ordered||""}</td><td>${r.expected||""}</td><td>${(r.total_amount||0).toFixed(2)}</td>
      <td>${paidTag}</td><td>${delTag}</td><td><span class="status-pill ${statusClass}">${r.status||"open"}</span></td>
      <td>
        <button class="edit-req" data-id="${r.id}">Edit</button>
        <button class="secondary toggle-paid-req" data-id="${r.id}">Paid</button>
        <button class="secondary mark-delivered-req" data-id="${r.id}">Delivered</button>
        <button class="danger cancel-req" data-id="${r.id}">Cancel</button>
        <button class="danger delete-req" data-id="${r.id}">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
  attachReqRowActions();
}

function attachReqRowActions(){
  document.querySelectorAll(".toggle-paid-req").forEach(btn=>{
    btn.onclick=async ()=>{
      const id=+btn.dataset.id;
      try{ await apiFetch(`/api/requisitions/${id}/toggle_paid`,{method:"PATCH"}); await afterDataLoad(); }
      catch{ alert("Error toggling paid."); }
    };
  });
  document.querySelectorAll(".mark-delivered-req").forEach(btn=>{
    btn.onclick=async ()=>{
      const id=+btn.dataset.id;
      try{ await apiFetch(`/api/requisitions/${id}`,{method:"PATCH",body:JSON.stringify({delivered:true})}); await afterDataLoad(); }
      catch{ alert("Error marking delivered."); }
    };
  });
  document.querySelectorAll(".cancel-req").forEach(btn=>{
    btn.onclick=async ()=>{
      const id=+btn.dataset.id;
      if(!confirm("Cancel this requisition?")) return;
      try{ await apiFetch(`/api/requisitions/${id}`,{method:"PATCH",body:JSON.stringify({status:"cancelled"})}); await afterDataLoad(); }
      catch{ alert("Error cancelling."); }
    };
  });
  document.querySelectorAll(".delete-req").forEach(btn=>{
    btn.onclick=async ()=>{
      const id=+btn.dataset.id;
      if(!confirm("Permanently delete this requisition?")) return;
      try{ await apiFetch(`/api/requisitions/${id}`,{method:"DELETE"}); await afterDataLoad(); }
      catch{ alert("Error deleting."); }
    };
  });
  document.querySelectorAll(".edit-req").forEach(btn=>{
    btn.onclick=()=>{
      const id=+btn.dataset.id;
      const row=allReqs.find(r=>r.id===id); if(!row) return;
      editingReqId=id;
      document.getElementById("reqFormTitle").textContent="Edit Requisition";
      document.getElementById("saveReqBtn").textContent="Update Requisition";
      document.getElementById("cancelReqEditBtn").classList.remove("hidden");
      document.getElementById("reqNumber").value=row.number||"";
      document.getElementById("reqVessel").value=row.vessel||"";
      document.getElementById("reqCategory").value=row.category||"";
      document.getElementById("reqSupplierSelect").value=row.supplier||"";
      document.getElementById("reqDateOrdered").value=row.date_ordered||"";
      document.getElementById("reqExpected").value=row.expected||"";
      const orig=(typeof row.original_amount==="number"?row.original_amount:row.total_amount)||0;
      document.getElementById("reqTotal").value=orig;
      document.getElementById("reqCurrency").value=row.currency||"USD";
      document.getElementById("reqPaid").checked=!!row.paid;
    };
  });
}
document.getElementById("cancelReqEditBtn").onclick=()=>{
  editingReqId=null;
  document.getElementById("reqFormTitle").textContent="Add Requisition";
  document.getElementById("saveReqBtn").textContent="Save Requisition";
  document.getElementById("cancelReqEditBtn").classList.add("hidden");
  ["reqNumber","reqVessel","reqCategory","reqSupplierSelect","reqDateOrdered","reqExpected","reqTotal"].forEach(id=>document.getElementById(id).value="");
  document.getElementById("reqPaid").checked=false;
  document.getElementById("reqCurrency").value="USD";
};
document.getElementById("applyReqFilterBtn").onclick=loadAllRequisitions;
document.getElementById("clearReqFilterBtn").onclick=async ()=>{
  ["filterReqStatus","filterReqPaid","filterReqDelivered","filterReqSearch"].forEach(id=>document.getElementById(id).value="");
  await loadAllRequisitions();
};

document.getElementById("saveReqBtn").onclick=async ()=>{
  const number=document.getElementById("reqNumber").value.trim();
  const vessel=document.getElementById("reqVessel").value.trim();
  const category=document.getElementById("reqCategory").value.trim();
  const supplier=document.getElementById("reqSupplierSelect").value.trim();
  const date_ordered=document.getElementById("reqDateOrdered").value;
  const expected=document.getElementById("reqExpected").value;
  const total=document.getElementById("reqTotal").value;
  const currency=document.getElementById("reqCurrency").value||"USD";
  const paid=document.getElementById("reqPaid").checked;
  const err=document.getElementById("reqError"); err.textContent="";

  if(!number||!vessel||!category||!supplier||!date_ordered||!total){
    err.textContent="Please fill all required fields."; return;
  }
  try{
    const payload={number,vessel,category,supplier,date_ordered,expected,amount:parseFloat(total),currency,paid};
    if(editingReqId) await apiFetch(`/api/requisitions/${editingReqId}`,{method:"PATCH",body:JSON.stringify(payload)});
    else await apiFetch("/api/requisitions",{method:"POST",body:JSON.stringify(payload)});
    document.getElementById("cancelReqEditBtn").onclick();
    await afterDataLoad();
  }catch(e){
    if(e.error==="duplicate_number") err.textContent="This requisition number already exists.";
    else if(e.error==="unknown_category") err.textContent="Invalid category abbreviation.";
    else if(e.error==="login_required") err.textContent="You must be logged in to add / edit requisitions.";
    else err.textContent="Error saving requisition.";
  }
};

/* ========= Overview Reqs ========= */
async function loadOverviewRequisitions(){
  let rows=allReqs;
  if(!rows.length){ try{ rows=await apiFetch("/api/requisitions"); }catch{ rows=[]; } }
  const tbody=document.querySelector("#overviewReqTable tbody"); tbody.innerHTML="";
  rows.slice().sort((a,b)=>(b.id||0)-(a.id||0)).slice(0,10).forEach(r=>{
    const paidTag=r.paid?'<span class="tag green">Paid</span>':'<span class="tag red">Unpaid</span>';
    const delTag=r.delivered?'<span class="tag green">Delivered</span>':'<span class="tag gray">Open</span>';
    let statusClass="status-open"; if((r.status||"open")==="cancelled") statusClass="status-cancelled"; if(r.delivered) statusClass="status-delivered";
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r.number}</td><td>${r.vessel}</td><td>${r.category||""}</td><td>${r.supplier||""}</td>
      <td>${r.date_ordered||""}</td><td>${(r.total_amount||0).toFixed(2)}</td><td>${paidTag}</td><td>${delTag}</td>
      <td><span class="status-pill ${statusClass}">${r.status||"open"}</span></td>`;
    tbody.appendChild(tr);
  });
}

/* ========= Landings ========= */
async function loadAllLandings(){
  let rows=[]; try{ rows=await apiFetch("/api/landings"); }catch{}
  allLandings=rows;
  const tbody=document.querySelector("#landingTable tbody"); tbody.innerHTML="";
  const statusFilter=document.getElementById("filterLandingStatus").value;
  const paidFilter=document.getElementById("filterLandingPaid").value;
  const delFilter=document.getElementById("filterLandingDelivered").value;
  const search=document.getElementById("filterLandingSearch").value.toLowerCase();

  rows.forEach(r=>{
    const matchesStatus=!statusFilter||(r.status||"open")===statusFilter;
    const matchesPaid=paidFilter===""||String(r.paid||0)===paidFilter;
    const matchesDel=delFilter===""||String(r.delivered||0)===delFilter;
    const matchesSearch=!search||(r.vessel||"").toLowerCase().includes(search)||(r.item||"").toLowerCase().includes(search)||(r.workshop||"").toLowerCase().includes(search);
    if(!(matchesStatus&&matchesPaid&&matchesDel&&matchesSearch)) return;

    const tr=document.createElement("tr");
    const paidTag=r.paid?'<span class="tag green">Paid</span>':'<span class="tag red">Unpaid</span>';
    const delTag=r.delivered?'<span class="tag green">Delivered</span>':'<span class="tag gray">Open</span>';
    let statusClass="status-open"; if((r.status||"open")==="cancelled") statusClass="status-cancelled"; if(r.delivered) statusClass="status-delivered";

    tr.innerHTML=`<td>${r.id}</td><td>${r.vessel}</td><td>${r.item||""}</td><td>${r.workshop||""}</td>
      <td>${r.expected||""}</td><td>${r.landed_date||""}</td><td>${(r.amount||0).toFixed(2)}</td>
      <td>${paidTag}</td><td>${delTag}</td><td><span class="status-pill ${statusClass}">${r.status||"open"}</span></td>
      <td>
        <button class="edit-land" data-id="${r.id}">Edit</button>
        <button class="secondary toggle-paid-land" data-id="${r.id}">Paid</button>
        <button class="secondary mark-delivered-land" data-id="${r.id}">Delivered</button>
        <button class="danger cancel-land" data-id="${r.id}">Cancel</button>
        <button class="danger delete-land" data-id="${r.id}">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
  attachLandingActions();
}
function attachLandingActions(){
  document.querySelectorAll(".toggle-paid-land").forEach(btn=>{
    btn.onclick=async ()=>{
      const id=+btn.dataset.id;
      try{ await apiFetch(`/api/landings/${id}/toggle_paid`,{method:"PATCH"}); await afterDataLoad(); }
      catch{ alert("Error toggling paid."); }
    };
  });
  document.querySelectorAll(".mark-delivered-land").forEach(btn=>{
    btn.onclick=async ()=>{
      const id=+btn.dataset.id;
      try{ await apiFetch(`/api/landings/${id}`,{method:"PATCH",body:JSON.stringify({delivered:true})}); await afterDataLoad(); }
      catch{ alert("Error marking delivered."); }
    };
  });
  document.querySelectorAll(".cancel-land").forEach(btn=>{
    btn.onclick=async ()=>{
      const id=+btn.dataset.id;
      if(!confirm("Cancel this landed item?")) return;
      try{ await apiFetch(`/api/landings/${id}`,{method:"PATCH",body:JSON.stringify({status:"cancelled"})}); await afterDataLoad(); }
      catch{ alert("Error cancelling landing."); }
    };
  });
  document.querySelectorAll(".delete-land").forEach(btn=>{
    btn.onclick=async ()=>{
      const id=+btn.dataset.id;
      if(!confirm("Permanently delete this landed item?")) return;
      try{ await apiFetch(`/api/landings/${id}`,{method:"DELETE"}); await afterDataLoad(); }
      catch{ alert("Error deleting landing."); }
    };
  });
  document.querySelectorAll(".edit-land").forEach(btn=>{
    btn.onclick=()=>{
      const id=+btn.dataset.id;
      const row=allLandings.find(l=>l.id===id); if(!row) return;
      editingLandId=id;
      document.getElementById("landFormTitle").textContent="Edit Landed Item";
      document.getElementById("saveLandingBtn").textContent="Update Landed Item";
      document.getElementById("cancelLandEditBtn").classList.remove("hidden");
      document.getElementById("landVessel").value=row.vessel||"";
      document.getElementById("landDescription").value=row.item||"";
      document.getElementById("landWorkshopSelect").value=row.workshop||"";
      document.getElementById("landExpected").value=row.expected||"";
      document.getElementById("landLanded").value=row.landed_date||"";
      const orig=(typeof row.amount_original==="number"?row.amount_original:row.amount)||0;
      document.getElementById("landAmount").value=orig;
      document.getElementById("landCurrency").value=row.currency||"USD";
      document.getElementById("landPaid").checked=!!row.paid;
    };
  });
}
document.getElementById("cancelLandEditBtn").onclick=()=>{
  editingLandId=null;
  document.getElementById("landFormTitle").textContent="Add Landed Item";
  document.getElementById("saveLandingBtn").textContent="Save Landed Item";
  document.getElementById("cancelLandEditBtn").classList.add("hidden");
  ["landVessel","landDescription","landWorkshopSelect","landExpected","landLanded","landAmount"].forEach(id=>document.getElementById(id).value="");
  document.getElementById("landPaid").checked=false;
  document.getElementById("landCurrency").value="USD";
};
document.getElementById("applyLandingFilterBtn").onclick=loadAllLandings;
document.getElementById("clearLandingFilterBtn").onclick=async ()=>{
  ["filterLandingStatus","filterLandingPaid","filterLandingDelivered","filterLandingSearch"].forEach(id=>document.getElementById(id).value="");
  await loadAllLandings();
};
document.getElementById("saveLandingBtn").onclick=async ()=>{
  const vessel=document.getElementById("landVessel").value.trim();
  const desc=document.getElementById("landDescription").value.trim();
  const workshop=document.getElementById("landWorkshopSelect").value.trim();
  const expected=document.getElementById("landExpected").value;
  const landed=document.getElementById("landLanded").value;
  const amount=document.getElementById("landAmount").value;
  const currency=document.getElementById("landCurrency").value||"USD";
  const paid=document.getElementById("landPaid").checked;
  const err=document.getElementById("landError"); err.textContent="";
  if(!vessel||!desc||!workshop||!amount){ err.textContent="Vessel, description, workshop and amount are required."; return; }
  try{
    const payload={vessel,item:desc,workshop,amount:parseFloat(amount),currency,expected,landed_date:landed,paid};
    if(editingLandId) await apiFetch(`/api/landings/${editingLandId}`,{method:"PATCH",body:JSON.stringify(payload)});
    else await apiFetch("/api/landings",{method:"POST",body:JSON.stringify(payload)});
    document.getElementById("cancelLandEditBtn").onclick();
    await afterDataLoad();
  }catch(e){
    err.textContent=e.error==="login_required"?"You must be logged in.":"Error saving landed item.";
  }
};

/* ========= Cancelled tables ========= */
async function fillCancelledTables(){
  const reqBody=document.querySelector("#reqCancelledTable tbody");
  const landBody=document.querySelector("#landingCancelledTable tbody");
  reqBody.innerHTML=""; landBody.innerHTML="";
  allReqs.filter(r=>(r.status||"open")==="cancelled").forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r.id}</td><td>${r.number}</td><td>${r.vessel}</td><td>${r.category||""}</td><td>${r.supplier||""}</td>
      <td>${r.date_ordered||""}</td><td>${r.expected||""}</td><td>${(r.total_amount||0).toFixed(2)}</td>
      <td>${r.paid?"Paid":"Unpaid"}</td><td>${r.status||"open"}</td>`;
    reqBody.appendChild(tr);
  });
  allLandings.filter(r=>(r.status||"open")==="cancelled").forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r.id}</td><td>${r.vessel}</td><td>${r.item||""}</td><td>${r.workshop||""}</td>
      <td>${r.expected||""}</td><td>${r.landed_date||""}</td><td>${(r.amount||0).toFixed(2)}</td>
      <td>${r.paid?"Paid":"Unpaid"}</td><td>${r.status||"open"}</td>`;
    landBody.appendChild(tr);
  });
}

/* ========= Overview Landings ========= */
async function loadOverviewLandings(){
  let rows=allLandings;
  if(!rows.length){ try{ rows=await apiFetch("/api/landings"); }catch{ rows=[]; } }
  const tbody=document.querySelector("#overviewLandTable tbody"); tbody.innerHTML="";
  rows.slice().sort((a,b)=>(b.id||0)-(a.id||0)).slice(0,10).forEach(r=>{
    const paidTag=r.paid?'<span class="tag green">Paid</span>':'<span class="tag red">Unpaid</span>';
    const delTag=r.delivered?'<span class="tag green">Delivered</span>':'<span class="tag gray">Open</span>';
    let statusClass="status-open"; if((r.status||"open")==="cancelled") statusClass="status-cancelled"; if(r.delivered) statusClass="status-delivered";
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r.vessel}</td><td>${r.item||""}</td><td>${r.workshop||""}</td>
      <td>${r.expected||""}</td><td>${r.landed_date||""}</td><td>${(r.amount||0).toFixed(2)}</td>
      <td>${paidTag}</td><td>${delTag}</td><td><span class="status-pill ${statusClass}">${r.status||"open"}</span></td>`;
    tbody.appendChild(tr);
  });
}

/* ========= Delivered ========= */
async function loadDeliveredRequisitions(){
  let rows=allReqs; if(!rows.length){ try{ rows=await apiFetch("/api/requisitions"); }catch{ rows=[]; } }
  const paidFilter=document.getElementById("filterDeliveredReqPaid").value;
  const search=document.getElementById("filterDeliveredReqSearch").value.toLowerCase();
  const tbody=document.querySelector("#deliveredReqTable tbody"); tbody.innerHTML="";
  rows.filter(r=>r.delivered).forEach(r=>{
    const matchesPaid=paidFilter===""||String(r.paid||0)===paidFilter;
    const matchesSearch=!search||(r.number||"").toLowerCase().includes(search)||(r.vessel||"").toLowerCase().includes(search)||(r.supplier||"").toLowerCase().includes(search);
    if(!(matchesPaid&&matchesSearch)) return;
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r.id}</td><td>${r.number}</td><td>${r.vessel}</td><td>${r.category||""}</td><td>${r.supplier||""}</td>
      <td>${r.date_ordered||""}</td><td>${r.expected||""}</td><td>${(r.total_amount||0).toFixed(2)}</td>
      <td>${r.paid?"Paid":"Unpaid"}</td><td>${r.status||"open"}</td>`;
    tbody.appendChild(tr);
  });
}
document.getElementById("applyDeliveredReqFilterBtn").onclick=loadDeliveredRequisitions;
document.getElementById("clearDeliveredReqFilterBtn").onclick=async ()=>{
  ["filterDeliveredReqPaid","filterDeliveredReqSearch"].forEach(id=>document.getElementById(id).value="");
  await loadDeliveredRequisitions();
};

async function loadDeliveredLandings(){
  let rows=allLandings; if(!rows.length){ try{ rows=await apiFetch("/api/landings"); }catch{ rows=[]; } }
  const paidFilter=document.getElementById("filterDeliveredLandPaid").value;
  const search=document.getElementById("filterDeliveredLandSearch").value.toLowerCase();
  const tbody=document.querySelector("#deliveredLandTable tbody"); tbody.innerHTML="";
  rows.filter(r=>r.delivered).forEach(r=>{
    const matchesPaid=paidFilter===""||String(r.paid||0)===paidFilter;
    const matchesSearch=!search||(r.vessel||"").toLowerCase().includes(search)||(r.item||"").toLowerCase().includes(search)||(r.workshop||"").toLowerCase().includes(search);
    if(!(matchesPaid&&matchesSearch)) return;
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r.id}</td><td>${r.vessel}</td><td>${r.item||""}</td><td>${r.workshop||""}</td>
      <td>${r.expected||""}</td><td>${r.landed_date||""}</td><td>${(r.amount||0).toFixed(2)}</td>
      <td>${r.paid?"Paid":"Unpaid"}</td><td>${r.status||"open"}</td>`;
    tbody.appendChild(tr);
  });
}
document.getElementById("applyDeliveredLandFilterBtn").onclick=loadDeliveredLandings;
document.getElementById("clearDeliveredLandFilterBtn").onclick=async ()=>{
  ["filterDeliveredLandPaid","filterDeliveredLandSearch"].forEach(id=>document.getElementById(id).value="");
  await loadDeliveredLandings();
};

/* ========= Summary counts ========= */
async function updateSummaryCounts(){
  let reqs=allReqs, lands=allLandings;
  if(!reqs.length){ try{ reqs=await apiFetch("/api/requisitions"); }catch{ reqs=[]; } }
  if(!lands.length){ try{ lands=await apiFetch("/api/landings"); }catch{ lands=[]; } }

  document.getElementById("summaryOpenReqNotDel").textContent=reqs.filter(r=>!r.delivered&&(r.status||"open")==="open").length;
  document.getElementById("summaryOpenReqUnpaid").textContent=reqs.filter(r=>!r.delivered&&!r.paid&&(r.status||"open")==="open").length;
  document.getElementById("summaryOpenLandNotDel").textContent=lands.filter(r=>!r.delivered&&(r.status||"open")==="open").length;
  document.getElementById("summaryOpenLandUnpaid").textContent=lands.filter(r=>!r.delivered&&!r.paid&&(r.status||"open")==="open").length;
}

/* ========= One place to reload everything ========= */
async function afterDataLoad() {
  await loadDirectoryOptions();
  await loadCategories();
  await loadVessels();
  await loadDirectoryPage();
  await loadUsersAdmin();
  await loadAllRequisitions();
  await loadAllLandings();
  await loadOverviewRequisitions();
  await loadOverviewLandings();
  await loadDeliveredRequisitions();
  await loadDeliveredLandings();
  await fillCancelledTables();
  await updateSummaryCounts();
  await loadOverviewTotalsFilters();
}

/* ========= Init ========= */
(async function init(){
  await loadCurrencies();
  await refreshSession();   // important due to admin tab visibility
  await afterDataLoad();
})();
</script>

</body>
</html>
