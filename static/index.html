<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="icon" type="image/png" href="static/ICON.jpg">
  <meta charset="UTF-8" />
  <title>AMT Procurement</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background:#f5f5f5; }
    header { background:#1f2937; color:#fff; padding:10px 16px; display:flex; justify-content:space-between; align-items:center; }
    header h1 { margin:0; font-size:20px; }
    header .user-info { font-size:14px; }
    header button { margin-left:8px; }

    .tabs { display:flex; background:#111827; flex-wrap:wrap; }
    .tab { padding:10px 16px; color:#9ca3af; cursor:pointer; font-size:14px; }
    .tab.active { background:#1f2937; color:#fff; }

    .container { padding:16px; max-width:1200px; margin:0 auto; }

    .card {
      background:#fff;
      padding:16px;
      margin-bottom:16px;
      border-radius:6px;
      box-shadow:0 1px 3px rgba(0,0,0,0.1);
    }

    .card h2 { margin-top:0; font-size:18px; }

    .flex-row { display:flex; gap:16px; flex-wrap:wrap; }
    .flex-1 { flex:1 1 0; min-width:260px; }

    label { display:block; font-size:13px; margin-bottom:6px; }
    input, select {
      width:100%; padding:6px 8px; margin-top:2px;
      box-sizing:border-box; font-size:13px;
    }
    button {
      padding:6px 10px;
      font-size:13px;
      border-radius:4px;
      border:none;
      cursor:pointer;
      background:#2563eb;
      color:#fff;
    }
    button.secondary { background:#6b7280; }
    button.danger { background:#b91c1c; }

    table { width:100%; border-collapse:collapse; font-size:13px; }
    th, td { border:1px solid #e5e7eb; padding:6px 8px; text-align:left; }
    th { background:#f3f4f6; }

    .tag { display:inline-block; padding:2px 6px; border-radius:999px; font-size:11px; }
    .tag.green { background:#dcfce7; color:#166534; }
    .tag.red { background:#fee2e2; color:#b91c1c; }
    .tag.gray { background:#e5e7eb; color:#374151; }

    .error { color:#b91c7c; font-size:12px; margin-top:4px; }
    .hidden { display:none; }

    #loginCard {
      max-width:320px;
      margin:12px auto;
      position:relative;
      z-index:10;
    }

    .summary-grid { display:flex; flex-wrap:wrap; gap:10px; }
    .summary-item {
      flex:1 1 120px;
      background:#f9fafb;
      padding:8px;
      border-radius:6px;
      border:1px solid #e5e7eb;
      font-size:13px;
    }
    .summary-label { color:#6b7280; font-size:12px; }
    .summary-value { font-size:16px; font-weight:bold; }

    .filter-row { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:8px; align-items:flex-end; }
    .filter-row > div { min-width:140px; flex:1 1 120px; }

    .status-pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; }
    .status-open { background:#eef2ff; color:#4f46e5; }
    .status-cancelled { background:#fee2e2; color:#b91c1c; }
    .status-delivered { background:#dcfce7; color:#166534; }

    .popup {
      position:fixed; top:50%; left:50%;
      transform:translate(-50%, -50%);
      background:#fff; border-radius:6px;
      box-shadow:0 10px 25px rgba(0,0,0,0.2);
      padding:16px; max-width:400px; width:90%; z-index:50;
    }
    #dirPopupBackdrop { position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:40; }
  </style>
</head>
<body>

<header style="display:flex; align-items:center; justify-content:space-between;">
  <div style="display:flex; align-items:center; gap:12px;">
    <img src="static/logo.png" alt="AMT Logo" style="height:40px; width:auto; border-radius:4px;">
    <h1>AMT Procurement</h1>
  </div>
  <div class="user-info" id="userInfo"></div>
</header>

<!-- Login card -->
<div id="loginCard" class="card hidden">
  <h2>Login</h2>
  <label>Username
    <input type="text" id="loginUsername" />
  </label>
  <label>Password
    <input type="password" id="loginPassword" />
  </label>
  <button id="loginBtn">Login</button>
  <div id="loginError" class="error"></div>
</div>

<!-- Directory popup -->
<div id="dirPopupBackdrop" class="hidden"></div>
<div id="dirPopup" class="popup hidden">
  <h3 id="dirPopupTitle">New entry</h3>
  <label>Name
    <input type="text" id="dirPopupName" />
  </label>
  <label>Email
    <input type="email" id="dirPopupEmail" />
  </label>
  <label>Phone
    <input type="text" id="dirPopupPhone" />
  </label>
  <label>Location / Address
    <input type="text" id="dirPopupAddress" />
  </label>
  <div id="dirPopupError" class="error"></div>
  <div style="margin-top:10px; text-align:right;">
    <button id="dirPopupCancelBtn" class="secondary">Cancel</button>
    <button id="dirPopupSaveBtn">Save</button>
  </div>
</div>

<div id="app">
  <div class="tabs">
    <div class="tab active" data-tab="overview">Overview</div>
    <div class="tab" data-tab="requisitions">Requisitions</div>
    <div class="tab" data-tab="landings">Landings</div>
    <div class="tab" data-tab="directory">Directory</div>
    <div class="tab" data-tab="delivered">Delivered</div>
    <div class="tab hidden" data-tab="admin" id="adminTab">Admin</div>
    <div class="tab hidden" data-tab="backups" id="backupsTab">Backups</div>
  </div>

  <div class="tab-content">

    <!-- OVERVIEW -->
    <div id="tab-overview">
      <!-- (UNCHANGED overview HTML from your file) -->
      <!-- ... your overview section exactly as before ... -->
    </div>

    <!-- REQUISITIONS -->
    <div id="tab-requisitions" class="hidden">
      <!-- (UNCHANGED requisitions HTML from your file) -->
      <!-- ... your requisitions section exactly as before ... -->
    </div>

    <!-- LANDINGS -->
    <div id="tab-landings" class="hidden">
      <!-- (UNCHANGED landings HTML from your file) -->
      <!-- ... your landings section exactly as before ... -->
    </div>

    <!-- DIRECTORY -->
    <div id="tab-directory" class="hidden">
      <!-- (UNCHANGED directory HTML from your file) -->
      <!-- ... your directory section exactly as before ... -->
    </div>

    <!-- DELIVERED -->
    <div id="tab-delivered" class="hidden">
      <!-- (UNCHANGED delivered HTML from your file) -->
      <!-- ... your delivered section exactly as before ... -->
    </div>

    <!-- ADMIN -->
    <div id="tab-admin" class="hidden">
      <!-- (UNCHANGED admin HTML from your file) -->
      <!-- ... your admin section exactly as before ... -->
    </div>

    <!-- BACKUPS (NEW) -->
    <div id="tab-backups" class="hidden">
      <div class="card">
        <h2>Backups Manager</h2>
        <p style="font-size:13px;color:#6b7280;">
          List of automatic backups. You can download or restore any backup.
        </p>
        <button id="refreshBackupsBtn">Refresh Backups</button>
        <div id="backupsError" class="error" style="margin-top:6px;"></div>

        <table id="backupsTable" style="margin-top:10px;">
          <thead>
            <tr>
              <th>Filename</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script>
/* ============================
   ✅ FIXED SCRIPT CORE
   ============================ */

const API_BASE = "https://amt-procurement.onrender.com";

async function apiFetch(url, options = {}) {
  const fullUrl = url.startsWith("http") ? url : (API_BASE + url);
  const res = await fetch(fullUrl, {
    headers: { "Content-Type": "application/json" },
    credentials: "include",
    ...options
  });
  if (!res.ok) {
    let err;
    try { err = await res.json(); } catch { err = { error: "unknown" }; }
    throw err;
  }
  return res.json();
}

let currentUser = null;
let allReqs = [];
let allLandings = [];
let editingReqId = null;
let editingLandId = null;
let editingCatId = null;
let dirPopupType = null;
let currencyList = ["USD"];
let chartPaidUnpaid = null;
let chartVessel = null;
let chartCategory = null;
let vessels = [];
let editingVesselId = null;

function quarterOfMonth(m){ if (m<=3) return "Q1"; if (m<=6) return "Q2"; if (m<=9) return "Q3"; return "Q4"; }
function parseDateSafe(d){ if(!d) return null; const dt=new Date(d); return isNaN(dt.getTime())?null:dt; }

/* ============================
   Currencies (now backend supports it)
   ============================ */
async function loadCurrencies() {
  try {
    const res = await apiFetch("/api/currencies");
    currencyList = res.currencies || ["USD"];
  } catch {
    currencyList = ["USD","EUR","AED","GBP","LBP"];
  }
  const reqCurSel=document.getElementById("reqCurrency");
  const landCurSel=document.getElementById("landCurrency");
  if(reqCurSel && landCurSel){
    reqCurSel.innerHTML=""; landCurSel.innerHTML="";
    currencyList.forEach(cur=>{
      reqCurSel.insertAdjacentHTML("beforeend",`<option value="${cur}">${cur}</option>`);
      landCurSel.insertAdjacentHTML("beforeend",`<option value="${cur}">${cur}</option>`);
    });
  }
}

/* ============================
   Session + Role visibility
   ============================ */
async function refreshSession(){
  try{ currentUser=await apiFetch("/api/session"); }catch{ currentUser=null; }
  const userInfo=document.getElementById("userInfo");
  const loginCard=document.getElementById("loginCard");

  if(currentUser && currentUser.username){
    userInfo.innerHTML=`Logged in as <strong>${currentUser.username}</strong> (${currentUser.role})
    <button id="logoutBtn">Logout</button>`;
    document.getElementById("logoutBtn").onclick=async()=>{
      await apiFetch("/api/logout",{method:"POST"});
      currentUser=null; loginCard.classList.add("hidden");
      await refreshSession(); await afterAnySessionChange();
    };
    loginCard.classList.add("hidden");
  }else{
    userInfo.innerHTML=`Not logged in <button id="showLoginBtn">Login</button>`;
    document.getElementById("showLoginBtn").onclick=()=>loginCard.classList.toggle("hidden");
  }
  await applyRoleVisibility();
}

async function applyRoleVisibility(){
  const isAdmin=currentUser && currentUser.role==="admin";
  const adminTab=document.getElementById("adminTab");
  const backupsTab=document.getElementById("backupsTab");
  if(adminTab) adminTab.classList.toggle("hidden",!isAdmin);
  if(backupsTab) backupsTab.classList.toggle("hidden",!isAdmin);

  const adminOnly=[
    "catName","catAbbr","addCatBtn","cancelCatEditBtn",
    "adminUsername","adminPassword","adminRole","saveUserBtn",
    "vesselName","addVesselBtn","cancelVesselEditBtn"
  ];
  adminOnly.forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.disabled=!isAdmin;
  });

  if(!isAdmin && document.querySelector('.tab.active[data-tab="admin"]')){
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    document.querySelectorAll("[id^='tab-']").forEach(div=>div.classList.add("hidden"));
    document.querySelector('.tab[data-tab="overview"]').classList.add("active");
    document.getElementById("tab-overview").classList.remove("hidden");
  }
}

/* ============================
   Login
   ============================ */
document.getElementById("loginBtn").onclick=async()=>{
  const u=document.getElementById("loginUsername").value.trim();
  const p=document.getElementById("loginPassword").value;
  const errDiv=document.getElementById("loginError"); errDiv.textContent="";
  try{
    await apiFetch("/api/login",{method:"POST",body:JSON.stringify({username:u,password:p})});
    document.getElementById("loginCard").classList.add("hidden");
    document.getElementById("loginUsername").value="";
    document.getElementById("loginPassword").value="";
    await refreshSession(); await afterAnySessionChange();
  }catch(e){
    errDiv.textContent=(e.error==="invalid_credentials")?"Invalid username or password.":"Login failed.";
  }
};

/* Tabs */
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click",()=>{
    if(tab.classList.contains("hidden")) return;
    const t=tab.dataset.tab;
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    document.querySelectorAll("[id^='tab-']").forEach(div=>div.classList.add("hidden"));
    tab.classList.add("active");
    document.getElementById(`tab-${t}`).classList.remove("hidden");
  });
});

/* ============================
   Backups Tab (NEW)
   ============================ */
async function loadBackupsPage(){
  const errDiv=document.getElementById("backupsError");
  const tbody=document.querySelector("#backupsTable tbody");
  if(!errDiv||!tbody) return;
  errDiv.textContent=""; tbody.innerHTML="";

  try{
    const files=await apiFetch("/api/backups");
    if(!files.length){
      tbody.innerHTML=`<tr><td colspan="2">No backups found.</td></tr>`;
      return;
    }
    files.forEach(f=>{
      const dl = `${API_BASE}/api/backups/download/${encodeURIComponent(f)}`;
      tbody.insertAdjacentHTML("beforeend",`
        <tr>
          <td>${f}</td>
          <td>
            <a href="${dl}" target="_blank"><button type="button" class="secondary">Download</button></a>
            <button type="button" class="restore-backup" data-file="${f}">Restore</button>
            <button type="button" class="danger delete-backup" data-file="${f}">Delete</button>
          </td>
        </tr>
      `);
    });

    document.querySelectorAll(".restore-backup").forEach(btn=>{
      btn.onclick=async()=>{
        const file=btn.dataset.file;
        if(!confirm(`Restore backup ${file}? This will overwrite current Excel.`)) return;
        try{
          await apiFetch(`/api/backups/restore/${encodeURIComponent(file)}`,{method:"POST"});
          alert("Backup restored. Refreshing data...");
          await reloadAllViews();
        }catch{ alert("Restore failed."); }
      };
    });

    document.querySelectorAll(".delete-backup").forEach(btn=>{
      btn.onclick=async()=>{
        const file=btn.dataset.file;
        if(!confirm(`Delete backup ${file}? This cannot be undone.`)) return;
        try{
          await apiFetch(`/api/backups/delete/${encodeURIComponent(file)}`,{method:"DELETE"});
          await loadBackupsPage();
        }catch{ alert("Delete failed."); }
      };
    });

  }catch(e){
    errDiv.textContent=(e.error==="admin_required")
      ?"Admin only."
      :"Failed to load backups.";
  }
}

document.getElementById("refreshBackupsBtn").onclick=loadBackupsPage;

/* ============================
   Your existing functions
   (UNCHANGED — keep your logic)
   ============================ */
async function loadDirectoryOptions(){ /* ... keep your original code ... */ }
function openDirPopup(type){ /* ... keep your original code ... */ }
function closeDirPopup(){ /* ... keep your original code ... */ }
async function loadDirectoryPage(){ /* ... keep your original code ... */ }
async function loadVessels(){ /* ... keep your original code ... */ }
async function loadCategories(){ /* ... keep your original code ... */ }
async function loadUsersAdmin(){ /* ... keep your original code ... */ }
async function loadAllRequisitions(){ /* ... keep your original code ... */ }
async function loadAllLandings(){ /* ... keep your original code ... */ }
async function loadOverviewRequisitions(){ /* ... keep your original code ... */ }
async function loadOverviewLandings(){ /* ... keep your original code ... */ }
async function loadDeliveredRequisitions(){ /* ... keep your original code ... */ }
async function loadDeliveredLandings(){ /* ... keep your original code ... */ }
async function fillCancelledTables(){ /* ... keep your original code ... */ }
async function updateSummaryCounts(){ /* ... keep your original code ... */ }
async function loadOverviewTotalsFilters(){ /* ... keep your original code ... */ }

async function reloadAllViews(){
  await loadDirectoryOptions();
  await loadCategories();
  await loadVessels();
  await loadDirectoryPage();
  await loadUsersAdmin();
  await loadAllRequisitions();
  await loadAllLandings();
  await loadOverviewRequisitions();
  await loadOverviewLandings();
  await loadDeliveredRequisitions();
  await loadDeliveredLandings();
  await fillCancelledTables();
  await updateSummaryCounts();
  await loadOverviewTotalsFilters();
  await loadBackupsPage();
}
async function afterAnySessionChange(){ await reloadAllViews(); }

/* Init */
(async function init(){
  await loadCurrencies();
  await refreshSession();
  await reloadAllViews();
})();
</script>

</body>
</html>
