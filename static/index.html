<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AMT Procurement</title>
  <style>
    :root{
      --bg:#0b1020; --card:#121a33; --card2:#0f1730; --muted:#8ea0c6; --text:#e7ecf5;
      --accent:#4cc9f0; --accent2:#80ffdb; --danger:#ff6b6b; --ok:#8aff8a; --warn:#ffd166;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#070b18,#0b1020);color:var(--text)}
    header{
      position:sticky;top:0;z-index:10;
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 18px;background:rgba(10,15,30,.92);backdrop-filter:blur(8px);
      border-bottom:1px solid #1f2a4d;
    }
    header .brand{font-weight:800;letter-spacing:.5px}
    nav{display:flex;gap:8px;flex-wrap:wrap}
    nav button{
      background:transparent;color:var(--text);border:1px solid #22315c;
      padding:7px 10px;border-radius:10px;cursor:pointer;font-weight:600;
    }
    nav button.active{background:var(--accent);color:#03111d;border-color:transparent}
    .right{display:flex;gap:8px;align-items:center}
    .pill{padding:4px 8px;border-radius:999px;background:#1a2550;color:var(--muted);font-size:12px}
    .btn{
      background:var(--accent);border:none;color:#04111a;font-weight:700;
      padding:8px 12px;border-radius:10px;cursor:pointer;
    }
    .btn.secondary{background:#22315c;color:var(--text)}
    .btn.danger{background:var(--danger);color:#1a0202}
    main{padding:18px;max-width:1400px;margin:0 auto}
    .grid{display:grid;gap:12px}
    .grid.cards{grid-template-columns:repeat(4,minmax(0,1fr))}
    @media (max-width:1100px){.grid.cards{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:600px){.grid.cards{grid-template-columns:1fr}}
    .card{
      background:var(--card);border:1px solid #1f2a4d;border-radius:var(--radius);
      padding:14px;box-shadow:0 10px 25px rgba(0,0,0,.25);
    }
    .card h3{margin:0 0 8px 0;font-size:15px;color:var(--muted);font-weight:700}
    .big{font-size:26px;font-weight:900}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row > *{flex:1}
    label{font-size:12px;color:var(--muted);font-weight:700}
    input,select,textarea{
      width:100%;padding:8px 9px;border-radius:9px;border:1px solid #22315c;
      background:var(--card2);color:var(--text);outline:none;
    }
    textarea{min-height:70px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid #1f2a4d;vertical-align:top}
    th{color:var(--muted);text-align:left;font-weight:800}
    tr:hover td{background:#0e1733}
    .tag{font-size:11px;padding:2px 7px;border-radius:999px;background:#1a2550;display:inline-block}
    .tag.ok{background:rgba(138,255,138,.12);color:var(--ok)}
    .tag.warn{background:rgba(255,209,102,.12);color:var(--warn)}
    .tag.danger{background:rgba(255,107,107,.12);color:var(--danger)}
    .actions{display:flex;gap:6px}
    .actions .btn{padding:5px 7px;font-size:12px}
    .section{display:none}
    .section.active{display:block}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .toolbar .btn{padding:7px 10px}
    .split{display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
    @media(max-width:900px){.split{grid-template-columns:1fr}}
    dialog{
      border:none;border-radius:14px;padding:0;background:var(--card);color:var(--text);
      width:min(720px,95vw);
    }
    dialog::backdrop{background:rgba(0,0,0,.6)}
    .modal-head{padding:12px 14px;border-bottom:1px solid #1f2a4d;font-weight:800}
    .modal-body{padding:14px}
    .modal-foot{padding:12px 14px;border-top:1px solid #1f2a4d;display:flex;justify-content:flex-end;gap:8px}
    .empty{padding:14px;color:var(--muted);text-align:center}
  </style>
</head>
<body>
<header>
  <div class="brand">AMT Procurement</div>
  <nav id="tabs"></nav>
  <div class="right">
    <span id="userPill" class="pill">Not logged in</span>
    <button id="loginBtn" class="btn secondary">Login</button>
    <button id="logoutBtn" class="btn danger" style="display:none;">Logout</button>
  </div>
</header>

<main>
  <!-- OVERVIEW -->
  <section id="sec-overview" class="section active">
    <div class="grid cards">
      <div class="card">
        <h3>Total Paid (USD)</h3>
        <div id="ovPaid" class="big">0</div>
        <div class="muted" id="ovPaidCount">0 items</div>
      </div>
      <div class="card">
        <h3>Total Unpaid (USD)</h3>
        <div id="ovUnpaid" class="big">0</div>
        <div class="muted" id="ovUnpaidCount">0 items</div>
      </div>
      <div class="card">
        <h3>Open Requisitions</h3>
        <div id="ovOpenReq" class="big">0</div>
        <div class="muted">not delivered</div>
      </div>
      <div class="card">
        <h3>Open Landings</h3>
        <div id="ovOpenLand" class="big">0</div>
        <div class="muted">not delivered</div>
      </div>
    </div>

    <div class="split" style="margin-top:12px;">
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <h2 style="margin:0;">Recent Requisitions</h2>
          <div class="toolbar">
            <select id="filterMonth"></select>
            <select id="filterVessel"></select>
            <select id="filterCategory"></select>
            <button class="btn secondary" id="resetFilters">Reset</button>
          </div>
        </div>
        <div id="recentReqWrap"></div>
      </div>
      <div class="card">
        <h2 style="margin-top:0;">Top 5 Suppliers (Paid USD)</h2>
        <div id="topSuppliersWrap"></div>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <h2 style="margin-top:0;">Recent Landed Items</h2>
      <div id="recentLandWrap"></div>
    </div>
  </section>

  <!-- REQUISITIONS -->
  <section id="sec-requisitions" class="section">
    <div class="toolbar">
      <button class="btn" id="addReqBtn">+ Add Requisition</button>
    </div>
    <div id="reqTableWrap"></div>
  </section>

  <!-- LANDINGS -->
  <section id="sec-landings" class="section">
    <div class="toolbar">
      <button class="btn" id="addLandBtn">+ Add Landed Item</button>
    </div>
    <div id="landTableWrap"></div>
  </section>

  <!-- DIRECTORY -->
  <section id="sec-directory" class="section">
    <div class="toolbar">
      <button class="btn" id="addDirBtn">+ Add Contact</button>
      <select id="dirTypeFilter" style="max-width:220px;">
        <option value="">All types</option>
        <option value="supplier">Suppliers</option>
        <option value="workshop">Workshops</option>
      </select>
    </div>
    <div id="dirTableWrap"></div>
  </section>

  <!-- DELIVERED -->
  <section id="sec-delivered" class="section">
    <div class="card">
      <h2 style="margin-top:0;">Delivered Items</h2>
      <div id="deliveredWrap"></div>
    </div>
  </section>

  <!-- ADMIN -->
  <section id="sec-admin" class="section">
    <div class="split">
      <div class="card">
        <h2 style="margin-top:0;">Categories</h2>
        <div class="row">
          <div>
            <label>Name</label>
            <input id="catName" placeholder="e.g. Spare Parts"/>
          </div>
          <div>
            <label>Abbr</label>
            <input id="catAbbr" placeholder="e.g. SP"/>
          </div>
          <div style="flex:0.4;">
            <label>&nbsp;</label>
            <button class="btn" id="addCatBtn">Add</button>
          </div>
        </div>
        <div id="catTableWrap" style="margin-top:8px;"></div>
      </div>

      <div class="card">
        <h2 style="margin-top:0;">Vessels</h2>
        <div class="row">
          <div>
            <label>Name</label>
            <input id="vesName" placeholder="e.g. Lady Youmna"/>
          </div>
          <div style="flex:0.4;">
            <label>&nbsp;</label>
            <button class="btn" id="addVesBtn">Add</button>
          </div>
        </div>
        <div id="vesTableWrap" style="margin-top:8px;"></div>
      </div>
    </div>

    <div class="split" style="margin-top:12px;">
      <div class="card">
        <h2 style="margin-top:0;">Users</h2>
        <div class="row">
          <div><label>Username</label><input id="newUser" placeholder="username"/></div>
          <div><label>Password</label><input id="newPass" type="password" placeholder="password"/></div>
          <div><label>Role</label>
            <select id="newRole">
              <option value="user">user</option>
              <option value="viewer">viewer</option>
              <option value="finance">finance</option>
              <option value="admin">admin</option>
            </select>
          </div>
          <div style="flex:0.4;"><label>&nbsp;</label><button class="btn" id="addUserBtn">Add</button></div>
        </div>
        <div id="userTableWrap" style="margin-top:8px;"></div>
      </div>

      <div class="card">
        <h2 style="margin-top:0;">Backups / Upload</h2>
        <div class="toolbar">
          <button class="btn" id="downloadBackupBtn">Download backup</button>
          <input id="uploadInput" type="file" accept=".xlsx" style="max-width:240px;"/>
          <button class="btn secondary" id="uploadBtn">Upload & overwrite</button>
        </div>
        <div id="backupsTableWrap"></div>
      </div>
    </div>
  </section>
</main>

<!-- LOGIN modal -->
<dialog id="loginModal">
  <div class="modal-head">Login</div>
  <div class="modal-body">
    <div class="row">
      <div>
        <label>Username</label>
        <input id="loginUser" placeholder="admin"/>
      </div>
      <div>
        <label>Password</label>
        <input id="loginPass" type="password" placeholder="admin123"/>
      </div>
    </div>
    <div id="loginErr" class="muted" style="margin-top:8px;color:var(--danger);font-weight:700;"></div>
  </div>
  <div class="modal-foot">
    <button class="btn secondary" onclick="loginModal.close()">Cancel</button>
    <button class="btn" id="doLoginBtn">Login</button>
  </div>
</dialog>

<!-- REQ modal -->
<dialog id="reqModal">
  <div class="modal-head" id="reqModalTitle">Add Requisition</div>
  <div class="modal-body">
    <input type="hidden" id="reqId"/>
    <div class="row">
      <div><label>Number*</label><input id="reqNumber"/></div>
      <div><label>Vessel*</label><select id="reqVessel"></select></div>
      <div><label>Category*</label><select id="reqCategory"></select></div>
    </div>
    <div class="row">
      <div><label>Supplier*</label><input id="reqSupplier"/></div>
      <div><label>Date Ordered*</label><input id="reqDate" type="date"/></div>
      <div><label>Expected</label><input id="reqExpected" type="date"/></div>
    </div>
    <div class="row">
      <div><label>Amount*</label><input id="reqAmount" type="number" step="0.01"/></div>
      <div><label>Currency*</label><select id="reqCurrency"></select></div>
      <div><label>Status</label>
        <select id="reqStatus">
          <option value="open">open</option>
          <option value="ordered">ordered</option>
          <option value="received">received</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div><label>PO#</label><input id="reqPO"/></div>
      <div><label>Urgency</label>
        <select id="reqUrgency">
          <option value="normal">normal</option>
          <option value="urgent">urgent</option>
        </select>
      </div>
      <div class="row" style="gap:6px;">
        <div><label>Paid</label><select id="reqPaid"><option value="0">No</option><option value="1">Yes</option></select></div>
        <div><label>Delivered</label><select id="reqDelivered"><option value="0">No</option><option value="1">Yes</option></select></div>
      </div>
    </div>
    <div><label>Remarks</label><textarea id="reqRemarks"></textarea></div>
    <div id="reqErr" style="margin-top:8px;color:var(--danger);font-weight:700;"></div>
  </div>
  <div class="modal-foot">
    <button class="btn secondary" onclick="reqModal.close()">Cancel</button>
    <button class="btn" id="saveReqBtn">Save</button>
  </div>
</dialog>

<!-- LAND modal -->
<dialog id="landModal">
  <div class="modal-head" id="landModalTitle">Add Landed Item</div>
  <div class="modal-body">
    <input type="hidden" id="landId"/>
    <div class="row">
      <div><label>Vessel*</label><select id="landVessel"></select></div>
      <div><label>Description*</label><input id="landItem"/></div>
      <div><label>Workshop*</label><input id="landWorkshop"/></div>
    </div>
    <div class="row">
      <div><label>Expected</label><input id="landExpected" type="date"/></div>
      <div><label>Landed Date</label><input id="landDate" type="date"/></div>
      <div><label>Status</label>
        <select id="landStatus">
          <option value="open">open</option>
          <option value="landed">landed</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div><label>Amount*</label><input id="landAmount" type="number" step="0.01"/></div>
      <div><label>Currency*</label><select id="landCurrency"></select></div>
      <div class="row" style="gap:6px;">
        <div><label>Paid</label><select id="landPaid"><option value="0">No</option><option value="1">Yes</option></select></div>
        <div><label>Delivered</label><select id="landDelivered"><option value="0">No</option><option value="1">Yes</option></select></div>
      </div>
    </div>
    <div id="landErr" style="margin-top:8px;color:var(--danger);font-weight:700;"></div>
  </div>
  <div class="modal-foot">
    <button class="btn secondary" onclick="landModal.close()">Cancel</button>
    <button class="btn" id="saveLandBtn">Save</button>
  </div>
</dialog>

<!-- DIR modal -->
<dialog id="dirModal">
  <div class="modal-head">Add Contact</div>
  <div class="modal-body">
    <div class="row">
      <div><label>Type*</label>
        <select id="dirType">
          <option value="supplier">supplier</option>
          <option value="workshop">workshop</option>
        </select>
      </div>
      <div><label>Name*</label><input id="dirName"/></div>
    </div>
    <div class="row">
      <div><label>Email</label><input id="dirEmail"/></div>
      <div><label>Phone</label><input id="dirPhone"/></div>
      <div><label>Address</label><input id="dirAddress"/></div>
    </div>
    <div id="dirErr" style="margin-top:8px;color:var(--danger);font-weight:700;"></div>
  </div>
  <div class="modal-foot">
    <button class="btn secondary" onclick="dirModal.close()">Cancel</button>
    <button class="btn" id="saveDirBtn">Save</button>
  </div>
</dialog>

<script>
  // -----------------------
  // Global state
  // -----------------------
  const API = location.origin; // same-host
  let sessionUser = null;
  let reqs = [];
  let lands = [];
  let cats = [];
  let vessels = [];
  let currencies = [];
  let directory = [];

  const TABS = [
    {id:"overview", label:"Overview"},
    {id:"requisitions", label:"Requisitions"},
    {id:"landings", label:"Landings"},
    {id:"directory", label:"Directory"},
    {id:"delivered", label:"Delivered"},
    {id:"admin", label:"Admin", adminOnly:true},
  ];

  // -----------------------
  // Helpers
  // -----------------------
  const $ = (id)=>document.getElementById(id);

  async function apiFetch(path, opts={}){
    const res = await fetch(API+path, {
      credentials:"include",
      headers: {"Content-Type":"application/json", ...(opts.headers||{})},
      ...opts,
    });
    let data = null;
    try{ data = await res.json(); }catch(e){}
    if(!res.ok){
      const msg = data?.error || res.statusText;
      throw new Error(msg);
    }
    return data;
  }

  function fmtUSD(x){
    return (Number(x)||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  }

  function qs(sel, root=document){ return root.querySelector(sel); }
  function qsa(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }

  function setOptions(sel, items, valueKey="name", labelKey="name", includeAll=false){
    sel.innerHTML="";
    if(includeAll) sel.append(new Option("All", ""));
    for(const it of items){
      sel.append(new Option(it[labelKey], it[valueKey]));
    }
  }

  // -----------------------
  // Tabs + session
  // -----------------------
  function buildTabs(){
    const tabsEl = $("tabs");
    tabsEl.innerHTML="";
    for(const t of TABS){
      const b = document.createElement("button");
      b.textContent = t.label;
      b.onclick = ()=>showTab(t.id);
      b.id = "tab-"+t.id;
      tabsEl.appendChild(b);
    }
  }

  function showTab(id){
    qsa(".section").forEach(s=>s.classList.remove("active"));
    $("sec-"+id).classList.add("active");
    qsa("nav button").forEach(b=>b.classList.remove("active"));
    $("tab-"+id).classList.add("active");
  }

  async function loadSession(){
    try{
      sessionUser = await apiFetch("/api/session");
      $("userPill").textContent = sessionUser.username + " (" + sessionUser.role + ")";
      $("loginBtn").style.display="none";
      $("logoutBtn").style.display="inline-block";
    }catch(e){
      sessionUser = null;
      $("userPill").textContent = "Not logged in";
      $("loginBtn").style.display="inline-block";
      $("logoutBtn").style.display="none";
    }
    // hide admin tab if not admin
    const isAdmin = sessionUser?.role==="admin";
    $("tab-admin").style.display = isAdmin ? "inline-block" : "none";
    if(!isAdmin && $("sec-admin").classList.contains("active")){
      showTab("overview");
    }
  }

  // -----------------------
  // Load data
  // -----------------------
  async function loadLookups(){
    [cats, vessels, currencies] = await Promise.all([
      apiFetch("/api/categories"),
      apiFetch("/api/vessels"),
      apiFetch("/api/currencies").then(d=>d.currencies),
    ]);

    // fill dropdowns used in modals + filters
    setOptions($("reqCategory"), cats, "abbr", "abbr");
    setOptions($("filterCategory"), cats, "abbr", "abbr", true);
    setOptions($("reqVessel"), vessels, "name","name");
    setOptions($("landVessel"), vessels, "name","name");
    setOptions($("filterVessel"), vessels, "name","name", true);
    setOptions($("reqCurrency"), currencies.map(c=>({name:c})));
    setOptions($("landCurrency"), currencies.map(c=>({name:c})));

    // month filter
    const months=["All", "01","02","03","04","05","06","07","08","09","10","11","12"];
    $("filterMonth").innerHTML="";
    months.forEach((m,i)=>{
      $("filterMonth").append(new Option(m==="All"?"All months":m, m==="All"?"":m));
    });
  }

  async function loadAll(){
    [reqs, lands, directory] = await Promise.all([
      apiFetch("/api/requisitions"),
      apiFetch("/api/landings"),
      apiFetch("/api/directory"),
    ]);
    // newest first
    reqs.sort((a,b)=>String(b.date_ordered||"").localeCompare(String(a.date_ordered||"")));
    lands.sort((a,b)=>String(b.landed_date||"").localeCompare(String(a.landed_date||"")));
  }

  // -----------------------
  // Rendering
  // -----------------------
  function renderRequisitions(){
    if(!reqs.length){
      $("reqTableWrap").innerHTML='<div class="empty">No requisitions yet.</div>'; return;
    }
    $("reqTableWrap").innerHTML = `
      <div class="card" style="padding:0;">
        <table>
          <thead>
            <tr>
              <th>No.</th><th>Vessel</th><th>Cat</th><th>Supplier</th>
              <th>Date</th><th>Expected</th>
              <th>Amount (orig)</th><th>USD</th>
              <th>Paid</th><th>Delivered</th><th>Status</th><th>PO#</th><th>Remarks</th><th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${reqs.map(r=>`
              <tr>
                <td>${r.number||""}</td>
                <td>${r.vessel||""}</td>
                <td>${r.category||""}</td>
                <td>${r.supplier||""}</td>
                <td>${r.date_ordered||""}</td>
                <td>${r.expected||""}</td>
                <td>${fmtUSD(r.amount_original)} ${r.currency||"USD"}</td>
                <td>${fmtUSD(r.amount_usd)}</td>
                <td>${r.paid?'<span class="tag ok">Yes</span>':'<span class="tag">No</span>'}</td>
                <td>${r.delivered?'<span class="tag ok">Yes</span>':'<span class="tag">No</span>'}</td>
                <td>${r.status||""}</td>
                <td>${r.po_number||""}</td>
                <td>${r.remarks||""}</td>
                <td>
                  <div class="actions">
                    <button class="btn secondary" onclick="openReqModal(${r.id})">Edit</button>
                    <button class="btn secondary" onclick="togglePaidReq(${r.id})">Paid</button>
                    ${sessionUser?.role==="admin" ? `<button class="btn danger" onclick="deleteReq(${r.id})">Del</button>`:""}
                  </div>
                </td>
              </tr>`).join("")}
          </tbody>
        </table>
      </div>`;
  }

  function renderLandings(){
    if(!lands.length){
      $("landTableWrap").innerHTML='<div class="empty">No landed items yet.</div>'; return;
    }
    $("landTableWrap").innerHTML = `
      <div class="card" style="padding:0;">
        <table>
          <thead>
            <tr>
              <th>Vessel</th><th>Description</th><th>Workshop</th>
              <th>Expected</th><th>Landed</th>
              <th>Amount (orig)</th><th>USD</th>
              <th>Paid</th><th>Delivered</th><th>Status</th><th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${lands.map(r=>`
              <tr>
                <td>${r.vessel||""}</td>
                <td>${r.item||""}</td>
                <td>${r.workshop||""}</td>
                <td>${r.expected||""}</td>
                <td>${r.landed_date||""}</td>
                <td>${fmtUSD(r.amount_original)} ${r.currency||"USD"}</td>
                <td>${fmtUSD(r.amount_usd)}</td>
                <td>${r.paid?'<span class="tag ok">Yes</span>':'<span class="tag">No</span>'}</td>
                <td>${r.delivered?'<span class="tag ok">Yes</span>':'<span class="tag">No</span>'}</td>
                <td>${r.status||""}</td>
                <td>
                  <div class="actions">
                    <button class="btn secondary" onclick="openLandModal(${r.id})">Edit</button>
                    <button class="btn secondary" onclick="togglePaidLand(${r.id})">Paid</button>
                    ${sessionUser?.role==="admin" ? `<button class="btn danger" onclick="deleteLand(${r.id})">Del</button>`:""}
                  </div>
                </td>
              </tr>`).join("")}
          </tbody>
        </table>
      </div>`;
  }

  function renderDirectory(){
    let rows = directory;
    const tf = $("dirTypeFilter").value;
    if(tf) rows = rows.filter(r=>String(r.type||"").toLowerCase()===tf);
    if(!rows.length){
      $("dirTableWrap").innerHTML='<div class="empty">No contacts.</div>'; return;
    }
    $("dirTableWrap").innerHTML = `
      <div class="card" style="padding:0;">
        <table>
          <thead><tr><th>Type</th><th>Name</th><th>Email</th><th>Phone</th><th>Address</th></tr></thead>
          <tbody>
          ${rows.map(r=>`
            <tr>
              <td>${r.type||""}</td>
              <td>${r.name||""}</td>
              <td>${r.email||""}</td>
              <td>${r.phone||""}</td>
              <td>${r.address||""}</td>
            </tr>`).join("")}
          </tbody>
        </table>
      </div>`;
  }

  function renderDelivered(){
    const deliveredReq = reqs.filter(r=>r.delivered);
    const deliveredLand = lands.filter(r=>r.delivered);
    const combined = [
      ...deliveredReq.map(r=>({kind:"REQ", date:r.date_ordered, vessel:r.vessel, desc:r.number, usd:r.amount_usd})),
      ...deliveredLand.map(r=>({kind:"LAND", date:r.landed_date, vessel:r.vessel, desc:r.item, usd:r.amount_usd})),
    ].sort((a,b)=>String(b.date||"").localeCompare(String(a.date||"")));
    if(!combined.length){
      $("deliveredWrap").innerHTML='<div class="empty">Nothing delivered yet.</div>'; return;
    }
    $("deliveredWrap").innerHTML=`
      <table>
        <thead><tr><th>Type</th><th>Date</th><th>Vessel</th><th>Description</th><th>USD</th></tr></thead>
        <tbody>${combined.map(r=>`
          <tr><td>${r.kind}</td><td>${r.date||""}</td><td>${r.vessel||""}</td><td>${r.desc||""}</td><td>${fmtUSD(r.usd)}</td></tr>
        `).join("")}</tbody>
      </table>`;
  }

  function renderAdminTables(){
    // categories
    $("catTableWrap").innerHTML = cats.length ? `
      <table><thead><tr><th>Abbr</th><th>Name</th><th></th></tr></thead><tbody>
      ${cats.map(c=>`
        <tr><td>${c.abbr}</td><td>${c.name}</td>
        <td class="actions">
          <button class="btn danger" onclick="deleteCat(${c.id})">Del</button>
        </td></tr>`).join("")}
      </tbody></table>` : '<div class="empty">No categories.</div>';

    // vessels
    $("vesTableWrap").innerHTML = vessels.length ? `
      <table><thead><tr><th>Name</th><th></th></tr></thead><tbody>
      ${vessels.map(v=>`
        <tr><td>${v.name}</td>
        <td class="actions">
          <button class="btn danger" onclick="deleteVes(${v.id})">Del</button>
        </td></tr>`).join("")}
      </tbody></table>` : '<div class="empty">No vessels.</div>';

    // users
    loadUsers();
    loadBackups();
  }

  async function loadUsers(){
    try{
      const users = await apiFetch("/api/users");
      $("userTableWrap").innerHTML = users.length ? `
        <table><thead><tr><th>Username</th><th>Role</th><th></th></tr></thead><tbody>
        ${users.map(u=>`
          <tr><td>${u.username}</td><td>${u.role}</td>
          <td class="actions">
            ${u.username!=="admin"?`<button class="btn danger" onclick="deleteUser('${u.username}')">Del</button>`:""}
          </td></tr>`).join("")}
        </tbody></table>`:'<div class="empty">No users.</div>';
    }catch(e){
      $("userTableWrap").innerHTML='<div class="empty">Cannot load users.</div>';
    }
  }

  async function loadBackups(){
    try{
      const backups = await apiFetch("/api/backups");
      $("backupsTableWrap").innerHTML = backups.length ? `
        <table><thead><tr><th>Name</th><th>Created</th><th>Size</th><th></th></tr></thead><tbody>
        ${backups.map(b=>`
          <tr>
            <td>${b.name}</td>
            <td>${b.created_at}</td>
            <td>${(b.size/1024).toFixed(1)} KB</td>
            <td class="actions">
              <button class="btn secondary" onclick="restoreBackup('${b.name}')">Restore</button>
              <button class="btn danger" onclick="deleteBackup('${b.name}')">Del</button>
            </td>
          </tr>`).join("")}
        </tbody></table>` : '<div class="empty">No backups yet.</div>';
    }catch(e){
      $("backupsTableWrap").innerHTML='<div class="empty">Cannot load backups.</div>';
    }
  }

  function renderOverview(){
    // apply filters to reqs + lands for paid totals
    let fReqs = [...reqs], fLands = [...lands];
    const m = $("filterMonth").value;
    const v = $("filterVessel").value;
    const c = $("filterCategory").value;
    if(m){
      fReqs = fReqs.filter(r=>String(r.date_ordered||"").slice(5,7)===m);
      fLands = fLands.filter(r=>String(r.landed_date||"").slice(5,7)===m);
    }
    if(v){
      fReqs = fReqs.filter(r=>r.vessel===v);
      fLands = fLands.filter(r=>r.vessel===v);
    }
    if(c){
      fReqs = fReqs.filter(r=>r.category===c);
    }

    const paidItems = [...fReqs, ...fLands].filter(r=>r.paid);
    const unpaidItems = [...fReqs, ...fLands].filter(r=>!r.paid);
    const paidSum = paidItems.reduce((s,r)=>s+Number(r.amount_usd||0),0);
    const unpaidSum = unpaidItems.reduce((s,r)=>s+Number(r.amount_usd||0),0);

    $("ovPaid").textContent = fmtUSD(paidSum);
    $("ovUnpaid").textContent = fmtUSD(unpaidSum);
    $("ovPaidCount").textContent = paidItems.length + " items";
    $("ovUnpaidCount").textContent = unpaidItems.length + " items";

    $("ovOpenReq").textContent = reqs.filter(r=>!r.delivered).length;
    $("ovOpenLand").textContent = lands.filter(r=>!r.delivered).length;

    // recent requisitions table (top 8)
    const recent = fReqs.slice(0,8);
    $("recentReqWrap").innerHTML = recent.length?`
      <table>
        <thead><tr><th>No.</th><th>Vessel</th><th>Supplier</th><th>Date</th><th>USD</th><th>Paid</th></tr></thead>
        <tbody>${recent.map(r=>`
          <tr><td>${r.number}</td><td>${r.vessel}</td><td>${r.supplier}</td><td>${r.date_ordered}</td><td>${fmtUSD(r.amount_usd)}</td>
          <td>${r.paid?"Yes":"No"}</td></tr>`).join("")}</tbody>
      </table>`:'<div class="empty">No requisitions for these filters.</div>';

    // recent landings (top 8)
    const recentL = fLands.slice(0,8);
    $("recentLandWrap").innerHTML = recentL.length?`
      <table>
        <thead><tr><th>Vessel</th><th>Description</th><th>Workshop</th><th>Landed</th><th>USD</th><th>Paid</th></tr></thead>
        <tbody>${recentL.map(r=>`
          <tr><td>${r.vessel}</td><td>${r.item}</td><td>${r.workshop}</td><td>${r.landed_date||""}</td><td>${fmtUSD(r.amount_usd)}</td>
          <td>${r.paid?"Yes":"No"}</td></tr>`).join("")}</tbody>
      </table>`:'<div class="empty">No landed items for these filters.</div>';

    // top suppliers by paid USD (reqs only)
    const paidReqs = fReqs.filter(r=>r.paid);
    const bySup = {};
    for(const r of paidReqs){
      bySup[r.supplier] = (bySup[r.supplier]||0) + Number(r.amount_usd||0);
    }
    const top5 = Object.entries(bySup).sort((a,b)=>b[1]-a[1]).slice(0,5);
    $("topSuppliersWrap").innerHTML = top5.length?`
      <table><thead><tr><th>Supplier</th><th>Paid USD</th></tr></thead>
      <tbody>${top5.map(([s,val])=>`
        <tr><td>${s}</td><td>${fmtUSD(val)}</td></tr>`).join("")}</tbody></table>`:'<div class="empty">No paid suppliers yet.</div>';
  }

  async function refreshUI(){
    await loadAll();
    renderRequisitions();
    renderLandings();
    renderDirectory();
    renderDelivered();
    renderOverview();
    if(sessionUser?.role==="admin") renderAdminTables();
  }

  // -----------------------
  // Actions - Requisitions
  // -----------------------
  window.openReqModal = (id=null)=>{
    $("reqErr").textContent="";
    $("reqId").value=id||"";
    $("reqModalTitle").textContent = id?"Edit Requisition":"Add Requisition";
    if(id){
      const r=reqs.find(x=>x.id===id);
      $("reqNumber").value=r.number||"";
      $("reqVessel").value=r.vessel||"";
      $("reqCategory").value=r.category||"";
      $("reqSupplier").value=r.supplier||"";
      $("reqDate").value=r.date_ordered||"";
      $("reqExpected").value=r.expected||"";
      $("reqAmount").value=r.amount_original||0;
      $("reqCurrency").value=r.currency||"USD";
      $("reqStatus").value=r.status||"open";
      $("reqPO").value=r.po_number||"";
      $("reqRemarks").value=r.remarks||"";
      $("reqUrgency").value=r.urgency||"normal";
      $("reqPaid").value=r.paid?1:0;
      $("reqDelivered").value=r.delivered?1:0;
    }else{
      qsa("#reqModal input, #reqModal textarea").forEach(i=>{ if(i.type!=="hidden") i.value="";});
      $("reqStatus").value="open"; $("reqUrgency").value="normal";
      $("reqPaid").value=0; $("reqDelivered").value=0;
    }
    reqModal.showModal();
  };

  $("saveReqBtn").onclick = async ()=>{
    try{
      const id = $("reqId").value;
      const payload = {
        number: $("reqNumber").value.trim(),
        vessel: $("reqVessel").value,
        category: $("reqCategory").value,
        supplier: $("reqSupplier").value.trim(),
        date_ordered: $("reqDate").value,
        expected: $("reqExpected").value,
        amount: Number($("reqAmount").value||0),
        currency: $("reqCurrency").value,
        status: $("reqStatus").value,
        po_number: $("reqPO").value.trim(),
        remarks: $("reqRemarks").value.trim(),
        urgency: $("reqUrgency").value,
        paid: $("reqPaid").value==="1",
        delivered: $("reqDelivered").value==="1",
      };
      if(!payload.number||!payload.vessel||!payload.category||!payload.supplier||!payload.date_ordered||payload.amount<=0){
        $("reqErr").textContent="Please fill all required fields (*)";
        return;
      }
      if(id){
        await apiFetch("/api/requisitions/"+id,{method:"PATCH",body:JSON.stringify(payload)});
      }else{
        await apiFetch("/api/requisitions",{method:"POST",body:JSON.stringify(payload)});
      }
      reqModal.close();
      await refreshUI(); // âœ… this fixes amount not reflecting
    }catch(e){
      $("reqErr").textContent = e.message;
    }
  };

  window.togglePaidReq = async(id)=>{
    try{ await apiFetch(`/api/requisitions/${id}/toggle_paid`,{method:"PATCH"}); await refreshUI(); }catch(e){alert(e.message);}
  };
  window.deleteReq = async(id)=>{
    if(!confirm("Delete requisition?")) return;
    try{ await apiFetch(`/api/requisitions/${id}`,{method:"DELETE"}); await refreshUI(); }catch(e){alert(e.message);}
  };

  // -----------------------
  // Actions - Landings
  // -----------------------
  window.openLandModal = (id=null)=>{
    $("landErr").textContent="";
    $("landId").value=id||"";
    $("landModalTitle").textContent = id?"Edit Landed Item":"Add Landed Item";
    if(id){
      const r=lands.find(x=>x.id===id);
      $("landVessel").value=r.vessel||"";
      $("landItem").value=r.item||"";
      $("landWorkshop").value=r.workshop||"";
      $("landExpected").value=r.expected||"";
      $("landDate").value=r.landed_date||"";
      $("landAmount").value=r.amount_original||0;
      $("landCurrency").value=r.currency||"USD";
      $("landStatus").value=r.status||"open";
      $("landPaid").value=r.paid?1:0;
      $("landDelivered").value=r.delivered?1:0;
    }else{
      qsa("#landModal input").forEach(i=>{ if(i.type!=="hidden") i.value="";});
      $("landStatus").value="open"; $("landPaid").value=0; $("landDelivered").value=0;
    }
    landModal.showModal();
  };

  $("saveLandBtn").onclick = async ()=>{
    try{
      const id = $("landId").value;
      const payload = {
        vessel: $("landVessel").value,
        item: $("landItem").value.trim(),
        workshop: $("landWorkshop").value.trim(),
        expected: $("landExpected").value,
        landed_date: $("landDate").value,
        amount: Number($("landAmount").value||0),
        currency: $("landCurrency").value,
        status: $("landStatus").value,
        paid: $("landPaid").value==="1",
        delivered: $("landDelivered").value==="1",
      };
      if(!payload.vessel||!payload.item||!payload.workshop||payload.amount<=0){
        $("landErr").textContent="Please fill required fields (*)";
        return;
      }
      if(id){
        await apiFetch("/api/landings/"+id,{method:"PATCH",body:JSON.stringify(payload)});
      }else{
        await apiFetch("/api/landings",{method:"POST",body:JSON.stringify(payload)});
      }
      landModal.close();
      await refreshUI();
    }catch(e){ $("landErr").textContent=e.message; }
  };

  window.togglePaidLand = async(id)=>{
    try{ await apiFetch(`/api/landings/${id}/toggle_paid`,{method:"PATCH"}); await refreshUI(); }catch(e){alert(e.message);}
  };
  window.deleteLand = async(id)=>{
    if(!confirm("Delete landed item?")) return;
    try{ await apiFetch(`/api/landings/${id}`,{method:"DELETE"}); await refreshUI(); }catch(e){alert(e.message);}
  };

  // -----------------------
  // Actions - Directory
  // -----------------------
  $("saveDirBtn").onclick = async()=>{
    try{
      const payload = {
        type:$("dirType").value,
        name:$("dirName").value.trim(),
        email:$("dirEmail").value.trim(),
        phone:$("dirPhone").value.trim(),
        address:$("dirAddress").value.trim(),
      };
      if(!payload.type||!payload.name){ $("dirErr").textContent="Type and name are required"; return; }
      await apiFetch("/api/directory",{method:"POST",body:JSON.stringify(payload)});
      dirModal.close();
      await refreshUI();
    }catch(e){ $("dirErr").textContent=e.message; }
  };

  // -----------------------
  // Admin actions
  // -----------------------
  $("addCatBtn").onclick = async()=>{
    try{
      await apiFetch("/api/categories",{method:"POST",body:JSON.stringify({
        name:$("catName").value.trim(),
        abbr:$("catAbbr").value.trim()
      })});
      $("catName").value=""; $("catAbbr").value="";
      await loadLookups(); await refreshUI();
    }catch(e){alert(e.message);}
  };
  window.deleteCat = async(id)=>{
    if(!confirm("Delete category?")) return;
    try{ await apiFetch("/api/categories/"+id,{method:"DELETE"}); await loadLookups(); await refreshUI(); }catch(e){alert(e.message);}
  };

  $("addVesBtn").onclick = async()=>{
    try{
      await apiFetch("/api/vessels",{method:"POST",body:JSON.stringify({name:$("vesName").value.trim()})});
      $("vesName").value="";
      await loadLookups(); await refreshUI();
    }catch(e){alert(e.message);}
  };
  window.deleteVes = async(id)=>{
    if(!confirm("Delete vessel?")) return;
    try{ await apiFetch("/api/vessels/"+id,{method:"DELETE"}); await loadLookups(); await refreshUI(); }catch(e){alert(e.message);}
  };

  $("addUserBtn").onclick = async()=>{
    try{
      await apiFetch("/api/users",{method:"POST",body:JSON.stringify({
        username:$("newUser").value.trim(),
        password:$("newPass").value,
        role:$("newRole").value
      })});
      $("newUser").value=""; $("newPass").value=""; $("newRole").value="user";
      await loadUsers();
    }catch(e){alert(e.message);}
  };
  window.deleteUser = async(username)=>{
    if(!confirm("Delete user "+username+"?")) return;
    try{ await apiFetch("/api/users/"+username,{method:"DELETE"}); await loadUsers(); }catch(e){alert(e.message);}
  };

  // backups
  $("downloadBackupBtn").onclick = ()=>{
    window.open(API+"/api/backup","_blank");
  };
  $("uploadBtn").onclick = async()=>{
    const f = $("uploadInput").files[0];
    if(!f){ alert("Select .xlsx file"); return; }
    if(!f.name.toLowerCase().endsWith(".xlsx")){ alert("Only .xlsx"); return; }
    if(!confirm("This will OVERWRITE current database. Continue?")) return;
    const fd = new FormData();
    fd.append("file", f);
    const res = await fetch(API+"/api/upload",{method:"POST",credentials:"include",body:fd});
    const data = await res.json().catch(()=>({}));
    if(!res.ok){ alert(data.error||"Upload failed"); return; }
    $("uploadInput").value="";
    await loadLookups(); await refreshUI();
  };
  window.restoreBackup = async(name)=>{
    if(!confirm("Restore backup "+name+"? This overwrites current DB.")) return;
    try{ await apiFetch("/api/backups/"+encodeURIComponent(name)+"/restore",{method:"POST"}); await loadLookups(); await refreshUI(); }
    catch(e){alert(e.message);}
  };
  window.deleteBackup = async(name)=>{
    if(!confirm("Delete backup "+name+"?")) return;
    try{ await apiFetch("/api/backups/"+encodeURIComponent(name),{method:"DELETE"}); await loadBackups(); }
    catch(e){alert(e.message);}
  };

  // -----------------------
  // Login / logout
  // -----------------------
  $("loginBtn").onclick = ()=>{ $("loginErr").textContent=""; loginModal.showModal(); };
  $("doLoginBtn").onclick = async()=>{
    try{
      await apiFetch("/api/login",{method:"POST",body:JSON.stringify({
        username:$("loginUser").value.trim(),
        password:$("loginPass").value
      })});
      loginModal.close();
      await loadSession();
      await refreshUI();
    }catch(e){
      $("loginErr").textContent="Login failed";
    }
  };
  $("logoutBtn").onclick = async()=>{
    await apiFetch("/api/logout",{method:"POST"}).catch(()=>{});
    await loadSession();
    await refreshUI();
  };

  // -----------------------
  // Wire buttons / filters
  // -----------------------
  $("addReqBtn").onclick = ()=>openReqModal();
  $("addLandBtn").onclick = ()=>openLandModal();
  $("addDirBtn").onclick = ()=>{ $("dirErr").textContent=""; qsa("#dirModal input").forEach(i=>i.value=""); dirModal.showModal(); };
  $("dirTypeFilter").onchange = renderDirectory;

  $("filterMonth").onchange = renderOverview;
  $("filterVessel").onchange = renderOverview;
  $("filterCategory").onchange = renderOverview;
  $("resetFilters").onclick = ()=>{
    $("filterMonth").value=""; $("filterVessel").value=""; $("filterCategory").value="";
    renderOverview();
  };

  // -----------------------
  // Init
  // -----------------------
  (async function init(){
    buildTabs();
    showTab("overview");
    await loadSession();
    await loadLookups();
    await refreshUI();
  })();
</script>
</body></html>